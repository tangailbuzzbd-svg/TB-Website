<!DOCTYPE html><html lang="bn"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>টাঙ্গাইলবাজ - অনলাইন শপিং</title>
    <!-- FAVICON UPDATE: Added the new provided logo URL as the favicon -->
    <link rel="icon" type="image/png" href="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/gdrg_upscaled%20(1).png?raw=true">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&amp;family=Poppins:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.maateen.me/solaiman-lipi/font.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS custom theme configuration
        tailwind.config = {
            // ENABLE DARK MODE VIA CLASS TOGGLE
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3a86ff',
                        secondary: '#ff006e',
                        accent: '#8338ec',
                        light: '#f8f9fa',
                        dark: '#212529',
                        success: '#28a745',
                        'theme-purple': '#6a0dad',
                        'theme-pink': '#e5367a',
                        'theme-blue': '#4a7bed',
                        'theme-light': '#f5f7fa',
                        'price-black': '#000000',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'SolaimanLipi', 'Noto Sans Bengali', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1s ease-in-out',
                        'slide-in-up': 'slideInUp 0.8s ease-out',
                        'spin': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                          spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                }
            }
        }
    </script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for invoice generation (Placeholder - implementation pending) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        html, body {
            overflow-x: hidden;
            height: 100%;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'Poppins', 'SolaimanLipi', 'Noto Sans Bengali', sans-serif;
        }
        html[lang="bn"] body {
            font-family: 'SolaimanLipi', 'Poppins', 'Noto Sans Bengali', sans-serif !important;
        }
        img {
            max-width: 100%;
            height: auto;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        html.dark .language-option-active {
            background-color: rgba(74, 123, 237, 0.25);
            color: #cbd5f5;
        }
        .drawer-overlay, .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .drawer {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .drawer.left {
             transform: translateX(-100%);
        }
        .drawer.bottom {
            transform: translateY(100%);
        }
        .drawer.active {
            transform: translateX(0);
        }
        .drawer.bottom.active {
            transform: translateY(0);
        }
        #product-image-container:hover #product-image {
            transform-origin: var(--x-pos) var(--y-pos);
            transform: scale(2);
        }
        .text-dark { color: #111827; }
        html.dark .text-dark { color: #e5e7eb !important; }
        html.dark .text-price-black { color: #f3f4f6 !important; }
        html.dark .text-black { color: #f3f4f6 !important; }
        html.dark .text-gray-900 { color: #f3f4f6 !important; }
        html.dark .text-gray-800 { color: #e5e7eb !important; }
        .flash-sale-countdown {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.03em;
        }
        .rating-star:hover, .rating-star.selected {
            color: #fca311; /* Amber/Yellow for selection/hover */
        }
        .tracker-step-container {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
            margin-top: 1.5rem;
            padding: 1.6rem 1.4rem;
            border-radius: 1.5rem;
            border: 1px solid rgba(148, 163, 184, 0.25);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(129, 140, 248, 0.06), rgba(14, 165, 233, 0.05));
            box-shadow: 0 18px 36px -24px rgba(15, 23, 42, 0.65);
            backdrop-filter: blur(10px);
        }

        html.dark .tracker-step-container {
            border-color: rgba(148, 163, 184, 0.3);
            background: linear-gradient(135deg, rgba(17, 24, 39, 0.92), rgba(59, 130, 246, 0.18), rgba(236, 72, 153, 0.12));
            box-shadow: 0 26px 46px -28px rgba(2, 6, 23, 0.85);
        }

        .tracker-node {
            --circle-size: 48px;
            position: relative;
            display: grid;
            grid-template-columns: var(--circle-size) 1fr;
            gap: 1.1rem;
            align-items: flex-start;
        }

        .tracker-node__indicator {
            position: relative;
            width: var(--circle-size);
            min-height: var(--circle-size);
        }

        .tracker-circle {
            position: relative;
            width: var(--circle-size);
            height: var(--circle-size);
            border-radius: 9999px;
            border: 2px solid rgba(148, 163, 184, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.05rem;
            background: rgba(255, 255, 255, 0.96);
            color: rgba(71, 85, 105, 0.85);
            box-shadow: 0 16px 32px -20px rgba(15, 23, 42, 0.6);
        }

        .tracker-circle i {
            font-size: 1.05rem;
        }

        html.dark .tracker-circle {
            background: rgba(17, 24, 39, 0.92);
            color: rgba(148, 163, 184, 0.85);
            border-color: rgba(148, 163, 184, 0.38);
            box-shadow: 0 18px 34px -22px rgba(0, 0, 0, 0.85);
        }

        .tracker-badge {
            position: absolute;
            right: -0.4rem;
            bottom: -0.35rem;
            width: 22px;
            height: 22px;
            border-radius: 9999px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(34, 197, 94, 0.9));
            color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            box-shadow: 0 10px 18px -12px rgba(16, 185, 129, 0.75);
        }

        .tracker-node__indicator .tracker-line {
            position: absolute;
            left: calc(var(--circle-size) / 2 - 1px);
            top: calc(var(--circle-size) + 0.4rem);
            bottom: calc(-1.75rem);
            width: 2px;
            border-radius: 999px;
            background: linear-gradient(180deg, rgba(148, 163, 184, 0.3), rgba(148, 163, 184, 0));
        }

        .tracker-node:last-of-type .tracker-line {
            display: none;
        }

        .tracker-content {
            padding-top: 0.2rem;
        }

        .tracker-title {
            margin: 0;
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
        }

        html.dark .tracker-title {
            color: #e2e8f0;
        }

        .tracker-subtitle {
            margin: 0.2rem 0 0;
            font-size: 0.88rem;
            color: #64748b;
        }

        html.dark .tracker-subtitle {
            color: #94a3b8;
        }

        .tracker-date {
            margin: 0.6rem 0 0;
            font-size: 0.72rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #1e293b;
            opacity: 0.75;
        }

        html.dark .tracker-date {
            color: #cbd5f5;
            opacity: 0.7;
        }

        .tracker-node--complete .tracker-circle {
            border-color: rgba(34, 197, 94, 0.55);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(34, 197, 94, 0.9));
            color: #ffffff;
            box-shadow: 0 22px 40px -22px rgba(16, 185, 129, 0.75);
        }

        .tracker-node--complete .tracker-line {
            background: linear-gradient(180deg, rgba(34, 197, 94, 0.85), rgba(59, 130, 246, 0.75));
        }

        .tracker-node--complete .tracker-title {
            color: #15803d;
        }

        html.dark .tracker-node--complete .tracker-title {
            color: #4ade80;
        }

        .tracker-node--upcoming .tracker-circle {
            background: rgba(255, 255, 255, 0.96);
            color: rgba(148, 163, 184, 0.75);
        }

        html.dark .tracker-node--upcoming .tracker-circle {
            background: rgba(17, 24, 39, 0.92);
            color: rgba(148, 163, 184, 0.65);
        }

        .tracker-node--current .tracker-circle {
            border-color: rgba(37, 99, 235, 0.5);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.92), rgba(14, 165, 233, 0.9));
            color: #ffffff;
            box-shadow: 0 24px 44px -24px rgba(37, 99, 235, 0.75);
        }

        .tracker-node--current .tracker-circle::after {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 9999px;
            border: 2px solid rgba(59, 130, 246, 0.35);
            animation: trackerPulse 1.9s ease-in-out infinite;
        }

        .tracker-node--current .tracker-line {
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.9), rgba(14, 165, 233, 0.75));
        }

        .tracker-node--current .tracker-title {
            color: #1d4ed8;
        }

        html.dark .tracker-node--current .tracker-title {
            color: #60a5fa;
        }

        .tracker-node--current .tracker-subtitle {
            color: #1d4ed8;
        }

        html.dark .tracker-node--current .tracker-subtitle {
            color: #60a5fa;
        }

        @keyframes trackerPulse {
            0% {
                opacity: 0.45;
                transform: scale(0.92);
            }
            50% {
                opacity: 0;
                transform: scale(1.18);
            }
            100% {
                opacity: 0;
                transform: scale(1.28);
            }
        }
        .language-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .toggle-checkbox {
            display: none;
        }
        .toggle-slider {
            --toggle-width: 78px;
            --toggle-height: 26px;
            --knob-size: 22px;
            position: relative;
            width: var(--toggle-width);
            height: var(--toggle-height);
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            cursor: pointer;
            transition: background-color 0.35s ease, box-shadow 0.35s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 3px 8px rgba(79, 70, 229, 0.15);
            color: rgba(255, 255, 255, 0.65);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.08em;
            font-size: 8.5px;
        }
        .toggle-slider .label-en,
        .toggle-slider .label-bn {
            transition: color 0.35s ease;
            z-index: 1;
        }
        .toggle-knob {
            position: absolute;
            width: var(--knob-size);
            height: var(--knob-size);
            top: calc((var(--toggle-height) - var(--knob-size)) / 2);
            left: 2px;
            border-radius: 9999px;
            background-color: #ffffff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.35s ease;
            overflow: hidden;
        }
        .toggle-knob img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .toggle-checkbox:checked + .toggle-slider {
            background-image: linear-gradient(90deg, rgba(99, 102, 241, 0.9), rgba(168, 85, 247, 0.9), rgba(236, 72, 153, 0.9));
            box-shadow: 0 5px 12px rgba(79, 70, 229, 0.26);
        }
        .toggle-checkbox:checked + .toggle-slider .label-en {
            color: rgba(255, 255, 255, 0.85);
        }
        .toggle-checkbox:checked + .toggle-slider .label-bn {
            color: #ffd54f;
        }
        .flash-sale-animated-bg {
            position: relative;
            overflow: hidden;
            background-image: linear-gradient(120deg, rgba(74, 123, 237, 0.95), rgba(106, 13, 173, 0.95), rgba(229, 54, 122, 0.95));
            background-size: 260% 260%;
            animation: flashGradientShift 7s ease-in-out infinite;
        }
        .flash-sale-animated-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0));
            opacity: 0.35;
            mix-blend-mode: screen;
            pointer-events: none;
            z-index: 0;
        }
        .flash-sale-animated-bg > :not(.flash-sale-overlay-text) {
            position: relative;
            z-index: 1;
        }
        .flash-sale-overlay-text {
            position: absolute;
            inset: -8% -4%;
            display: flex;
            gap: 1.8rem;
            align-items: center;
            pointer-events: none;
            transform: rotate(-10deg);
            z-index: 0;
        }
        .flash-sale-overlay-text span {
            font-weight: 700;
            font-size: clamp(0.85rem, 2.2vw, 1.5rem);
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.12);
            white-space: nowrap;
            animation: flashTextMarquee 18s linear infinite;
        }
        .flash-sale-overlay-text span:nth-child(2) {
            animation-delay: -9s;
        }
        .flash-sale-heading-animated {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            padding: 0.45rem 1.35rem;
            border-radius: 9999px;
            background: linear-gradient(90deg, rgba(255, 94, 98, 0.92), rgba(255, 200, 82, 0.96), rgba(255, 94, 98, 0.92));
            background-size: 220% 100%;
            color: #fff;
            box-shadow: 0 8px 22px rgba(255, 142, 90, 0.35);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            animation: flashRibbonGlow 3s linear infinite;
        }
        .flash-sale-heading-animated::before {
            content: '';
            position: absolute;
            inset: -20%;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.25), transparent 60%),
                        radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.18), transparent 65%);
            opacity: 0.65;
            filter: blur(18px);
            z-index: -1;
        }
        .flash-sale-heading-animated span[data-lang] {
            font-weight: 800;
            font-size: clamp(1.4rem, 1.8vw + 0.55rem, 2.2rem);
            text-shadow: 0 2px 4px rgba(129, 22, 68, 0.35);
        }
        .flash-sale-heading-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.18);
            box-shadow: inset 0 0 12px rgba(255, 255, 255, 0.35);
            font-size: 1.25rem;
            animation: flashBoltTwinkle 1.1s ease-in-out infinite alternate;
        }
        .flash-sale-heading-animated .flash-sale-heading-icon:last-of-type {
            animation-delay: 0.4s;
        }
        html.dark .flash-sale-heading-animated {
            box-shadow: 0 8px 22px rgba(255, 167, 68, 0.45);
        }
        @keyframes flashRibbonGlow {
            0% {
                background-position: 0% 50%;
                box-shadow: 0 8px 22px rgba(255, 142, 90, 0.35);
            }
            50% {
                background-position: 100% 50%;
                box-shadow: 0 8px 28px rgba(255, 184, 77, 0.45);
            }
            100% {
                background-position: 0% 50%;
                box-shadow: 0 8px 22px rgba(255, 142, 90, 0.35);
            }
        }
        @keyframes flashBoltTwinkle {
            0% {
                transform: scale(0.9) rotate(-8deg);
                filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.45));
            }
            100% {
                transform: scale(1.1) rotate(8deg);
                filter: drop-shadow(0 0 10px rgba(255, 222, 89, 0.85));
            }
        }
        @keyframes flashGradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        @keyframes flashTextMarquee {
            0% {
                transform: translate3d(0, 0, 0);
            }
            100% {
                transform: translate3d(-50%, 0, 0);
            }
        }
        .toggle-checkbox:not(:checked) + .toggle-slider .label-en {
            color: #ffd54f;
        }
        .toggle-checkbox:not(:checked) + .toggle-slider .label-bn {
            color: rgba(255, 255, 255, 0.85);
        }
        .toggle-checkbox:checked + .toggle-slider .toggle-knob {
            transform: translateX(calc(var(--toggle-width) - var(--knob-size) - 4px));
        }
        html.dark .toggle-slider {
            background-color: rgba(17, 24, 39, 0.6);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.4);
        }
        html.dark .toggle-checkbox:not(:checked) + .toggle-slider .label-bn,
        html.dark .toggle-checkbox:checked + .toggle-slider .label-en {
            color: rgba(209, 213, 219, 0.85);
        }
        html.dark .toggle-knob {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        /* Auth drawer styling */
        .auth-card {
            position: relative;
            background: #f9fafb;
            border: 1px solid #e2e8f0;
            border-radius: 1.125rem;
            padding: 1.75rem;
            box-shadow: 0 18px 36px -28px rgba(15, 23, 42, 0.4);
            max-width: 420px;
            width: 100%;
            margin: 0 auto;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 6px;
            border-radius: 1.125rem 0 0 1.125rem;
            background: linear-gradient(180deg, #2563eb, #9333ea);
        }

        html.dark .auth-card {
            background: #111827;
            border-color: #1f2937;
            box-shadow: 0 20px 40px -28px rgba(0, 0, 0, 0.7);
        }

        html.dark .auth-card::before {
            background: linear-gradient(180deg, #4f46e5, #ec4899);
        }

        .auth-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .auth-header h4 {
            margin: 0;
            color: #0f172a;
        }

        html.dark .auth-header h4 {
            color: #e2e8f0;
        }

        .auth-subtitle {
            margin: 0;
            font-size: 0.9rem;
            color: #475569;
        }

        html.dark .auth-subtitle {
            color: #cbd5f5;
        }

        .auth-hero-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 9999px;
            background: #eef2ff;
            color: #2563eb;
            font-size: 1rem;
        }

        html.dark .auth-hero-icon {
            background: rgba(37, 99, 235, 0.16);
            color: #93c5fd;
        }

        .auth-tabs {
            display: flex;
            gap: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }

        html.dark .auth-tabs {
            border-bottom-color: #1f2937;
        }

        .auth-tab {
            position: relative;
            flex: 1;
            border: none;
            background: transparent;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .auth-tab i {
            font-size: 0.85rem;
        }

        .auth-tab:hover {
            color: #2563eb;
        }

        html.dark .auth-tab {
            color: #94a3b8;
        }

        html.dark .auth-tab:hover {
            color: #93c5fd;
        }

        .auth-tab-active {
            color: #2563eb;
        }

        .auth-tab-active::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -0.55rem;
            height: 3px;
            border-radius: 999px;
            background: #2563eb;
        }

        html.dark .auth-tab-active {
            color: #a5b4fc;
        }

        html.dark .auth-tab-active::after {
            background: #6366f1;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 1.75rem 0 1.25rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #94a3b8;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }

        html.dark .auth-divider {
            color: #cbd5f5;
        }

        html.dark .auth-divider::before,
        html.dark .auth-divider::after {
            background: #1f2937;
        }

        .auth-social-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.65rem;
            width: 100%;
            padding: 0.7rem 1rem;
            border-radius: 0.75rem;
            border: 1px solid #d0d7e2;
            background: #ffffff;
            font-weight: 600;
            color: #0f172a;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .auth-social-btn:hover {
            border-color: #2563eb;
            background: #eef2ff;
        }

        html.dark .auth-social-btn {
            background: #1f2937;
            border-color: #334155;
            color: #e2e8f0;
        }

        html.dark .auth-social-btn:hover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.12);
        }

        .auth-social-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2rem;
            height: 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .auth-social-icon.google {
            color: #ea4335;
        }

        .auth-social-icon.facebook {
            color: #1877f2;
        }

        html.dark .auth-social-icon.google {
            color: #f7998f;
        }

        html.dark .auth-social-icon.facebook {
            color: #93c5fd;
        }

        .auth-meta-note {
            font-size: 0.78rem;
            text-align: center;
            color: #64748b;
        }

        html.dark .auth-meta-note {
            color: #cbd5f5;
        }

        .auth-link {
            color: #2563eb;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        html.dark .auth-link {
            color: #93c5fd;
        }

        .auth-error {
            min-height: 1.125rem;
            color: #dc2626;
            font-weight: 600;
        }

        html.dark .auth-error {
            color: #fca5a5;
        }

        /* Mobile layout refinements */
        @media (max-width: 640px) {
            header .container {
                gap: 0.75rem;
            }

            #banner-slider {
                min-height: 200px;
                height: auto;
            }

            #right-promo-link {
                min-height: 200px;
                height: auto;
            }

            .modal-overlay > div {
                width: calc(100% - 2rem);
                max-height: 90vh;
                overflow-y: auto;
            }

            footer {
                padding-top: 2.5rem;
                padding-bottom: 2.5rem;
            }
        }

        @media (max-width: 480px) {
            #top-category-strip .bg-white {
                padding: 0.75rem;
            }

            .flash-sale-animated-bg > * {
                text-align: left;
            }
        }

        @media (min-width: 400px) and (max-width: 639.98px) {
            #product-list {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
        }
</style>
</head>
<body class="bg-theme-light text-dark font-sans leading-relaxed transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
    
    <!-- Blocked User Banner -->
    <div id="blocked-account-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white text-center p-3 z-[9999] font-semibold"></div>
    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-20 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform translate-x-[150%] opacity-0">
        <p id="toast-message">পণ্য কার্টে যোগ করা হয়েছে!</p>
    </div>

    <!-- Variant Selection Modal (for product cards) -->
    <div id="variant-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[115] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-theme-purple" data-lang="select-variants">অপশন নির্বাচন করুন</h3>
                <button onclick="closeVariantModal()" class="text-gray-500 hover:text-gray-800 text-3xl">×</button>
            </div>
            <div id="variant-modal-product" class="flex items-center gap-3 mb-4">
                <img id="vm-product-image" class="w-14 h-14 rounded-xl object-cover" src="" alt="" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">
                <div class="min-w-0">
                    <div id="vm-product-name" class="text-sm font-semibold text-theme-purple truncate"></div>
                    <div id="vm-product-price" class="text-xs text-gray-500"></div>
                </div>
            </div>
            <div id="variant-modal-options" class="space-y-4">
                <div id="vm-size-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="size">সাইজ:</label>
                    <div class="flex flex-wrap gap-2" id="vm-size-variants-container"></div>
                </div>
                <div id="vm-storage-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="storage">স্টোরেজ:</label>
                    <div class="flex flex-wrap gap-2" id="vm-storage-variants-container"></div>
                </div>
                <div id="vm-color-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="color">রঙ:</label>
                    <div class="flex flex-wrap gap-2" id="vm-color-variants-container"></div>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-2">
                <button id="vm-add-btn" class="w-full bg-theme-blue text-white py-2 rounded-full font-bold hover:bg-theme-purple transition-colors" data-lang="add-to-cart">কার্টে যোগ করুন</button>
                <button id="vm-buy-btn" class="w-full bg-white border border-theme-blue text-theme-blue py-2 rounded-full font-bold hover:bg-gray-100 transition-colors" data-lang="buy-now">এখনই কিনুন</button>
            </div>
        </div>
    </div>


    <!-- Header Section -->
    <header class="bg-gradient-to-r from-theme-blue to-theme-purple text-white py-2 sticky top-0 z-40 shadow-2xl flex-shrink-0">
        <div class="container mx-auto px-4 flex flex-col md:flex-row items-stretch md:items-center md:justify-between gap-3 md:gap-4">
            <!-- Left side: Hamburger (mobile) and Logo -->
            <div class="flex items-center w-full md:w-auto gap-3 sm:gap-4">
                <!-- Hamburger Menu for Mobile -->
                <button id="hamburger-btn" class="md:hidden text-2xl text-white" aria-label="Menu" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center text-2xl font-bold transform hover:scale-105 transition-transform cursor-pointer" onclick="renderAllProducts()">
                    <!-- LOGO STYLING UPDATE: Wrap icon in white circle -->
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center p-1 shadow-md mr-2 flex-shrink-0">
                         <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/gdrg_upscaled%20(1).png?raw=true" alt="TangailBuzz Logo Icon" class="h-full w-full object-contain">
                    </div>
                    <span class="text-white text-lg sm:text-xl font-semibold tracking-wide leading-tight">TangailBuzz</span>
                    <!-- END LOGO STYLING UPDATE -->
                </div>
            </div>

            <!-- Center: Navigation (Desktop) -->
            <nav class="hidden md:flex">
                <ul class="flex items-center space-x-6">
                    <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="home">হোম</a></li> <!-- Adjusted text color -->
                    <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="products">পণ্য</a></li> <!-- Adjusted text color -->
                    <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="categories">ক্যাটাগরি</a></li> <!-- Adjusted text color -->
                    <li><a href="javascript:void(0);" onclick="showOffers()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="offers">অফার</a></li> <!-- Adjusted text color -->
                    <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('flash-sale-section')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="flash-sale-nav">ফ্ল্যাশ সেল</a></li>
                    <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('mega-sale-section')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="mega-sale-nav">মেগা সেল</a></li>
                </ul>
            </nav>

            <!-- Right side: Actions -->
            <div class="flex w-full md:w-auto items-center justify-end gap-3 sm:gap-4 flex-wrap md:flex-nowrap">
                <!-- Search -->
                <div class="hidden md:block relative flex-grow md:flex-grow-0">
                    <div class="flex items-stretch rounded-full overflow-hidden shadow-md bg-white dark:bg-gray-900"> <!-- Search BG remains white/dark -->
                        <input type="text" id="search-input" placeholder="পণ্য খুঁজুন..." class="flex-1 min-w-0 px-4 py-2 outline-none focus:ring-2 focus:ring-theme-pink bg-transparent text-sm text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400">
                        <button id="search-button" class="px-4 bg-theme-pink text-white hover:bg-theme-purple transition-colors shrink-0">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Live search results (desktop) -->
                    <div id="search-results-desktop" class="absolute top-full left-0 w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg rounded-b-lg z-50 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
                </div>

                <!-- Dark Mode Toggle -->
                 <!-- Adjusted styles for gradient header -->
                <button id="dark-mode-toggle" class="hidden md:flex md:flex-col items-center text-white text-xl p-2 rounded-full hover:bg-white/20 transition-colors" aria-label="Toggle Dark Mode" title="Dark Mode" data-lang-title="dark-mode" data-lang-aria-label="dark-mode">
                    <i class="fas fa-sun" id="dark-mode-icon"></i>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="dark-mode">ডার্ক মোড</span> <!-- Adjusted text color -->
                </button>

                <!-- Language Toggle -->
                <div class="hidden md:block">
                    <div class="language-toggle-container">
                        <input type="checkbox" id="lang-switch" class="toggle-checkbox" checked>
                        <label for="lang-switch" class="toggle-slider" aria-label="Language Toggle" data-lang-aria-label="language-label">
                            <span class="label-en">EN</span>
                            <span class="label-bn">BN</span>
                            <div class="toggle-knob">
                                <img id="flag-icon" src="https://flagcdn.com/w40/bd.png" alt="Bangladesh Flag">
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Support (Header) -->
                 <!-- Adjusted styles for gradient header -->
                <div id="emergency-contact-header" class="hidden md:flex relative transform hover:scale-110 transition-transform cursor-pointer flex-col items-center" title="Support" aria-label="Support" data-lang-title="emergency-contact" data-lang-aria-label="emergency-contact">
                    <i class="fas fa-headset text-white text-2xl"></i> <!-- Adjusted text color -->
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="emergency-contact">সাপোর্ট</span> <!-- Adjusted text color -->
                </div>
                
                 <!-- Adjusted styles for gradient header -->
                <div id="profile-icon" class="hidden md:flex relative transform hover:scale-110 transition-transform cursor-pointer flex-col items-center" onclick="openDrawer('profile-drawer')" title="Profile" aria-label="Profile" data-lang-title="profile" data-lang-aria-label="profile">
                    <i class="fas fa-user-circle text-white text-2xl"></i> <!-- Adjusted text color -->
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="profile">প্রোফাইল</span> <!-- Adjusted text color -->
                </div>
                 <!-- Adjusted styles for gradient header -->
                <div class="hidden md:flex relative transform hover:scale-110 transition-transform cursor-pointer flex-col items-center" onclick="showPage('wishlist-page')" title="Wishlist" aria-label="Wishlist" data-lang-title="wishlist" data-lang-aria-label="wishlist">
                    <i class="fas fa-heart text-white text-2xl"></i> <!-- Adjusted text color -->
                    <span id="wishlist-count-badge" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="wishlist">উইশলিস্ট</span> <!-- Adjusted text color -->
                </div>
                 <!-- Adjusted styles for gradient header -->
                <div class="hidden md:flex relative transform hover:scale-110 transition-transform cursor-pointer flex-col items-center" onclick="showPage('cart-page')" title="Cart" aria-label="Cart" data-lang-title="cart-short" data-lang-aria-label="cart-short">
                    <i class="fas fa-shopping-cart text-white text-2xl"></i> <!-- Adjusted text color -->
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="cart-short">কার্ট</span> <!-- Adjusted text color -->
                </div>
            </div>
        </div>
        <!-- Search bar for mobile -->
    <div class="md:hidden mt-2 px-4">
            <div class="relative w-full">
                <div class="flex items-stretch rounded-full overflow-hidden shadow-md bg-white dark:bg-gray-900"> <!-- Search BG remains white/dark -->
                    <input type="text" id="search-input-mobile" placeholder="পণ্য খুঁজুন..." class="flex-1 min-w-0 px-4 py-2 outline-none focus:ring-2 focus:ring-theme-pink bg-transparent text-sm text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400">
                    <button id="search-button-mobile" class="px-4 bg-theme-pink text-white hover:bg-theme-purple transition-colors shrink-0">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <!-- Live search results (mobile) -->
                <div id="search-results-mobile" class="absolute top-full left-0 w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg rounded-b-lg z-50 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
            </div>
        </div>
    </header>

    <!-- Global Breadcrumb (shown on details page) -->
    <div id="global-breadcrumb" class="hidden border-b border-gray-200 dark:border-gray-800 bg-gray-50/60 dark:bg-gray-900/60">
        <div class="container mx-auto px-4 py-2">
            <nav id="global-breadcrumb-path" class="text-sm flex flex-wrap items-center text-gray-600 dark:text-gray-300 gap-1"></nav>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeDrawer()"></div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-theme-purple" data-lang="payment-method">পেমেন্ট পদ্ধতি নির্বাচন করুন</h3>
                <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-800 text-3xl">×</button>
            </div>
            <!-- Shipping Address Selection -->
            <div id="shipping-address-section" class="mb-6 p-4 border rounded-xl bg-gray-50 dark:bg-gray-900/40">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">শিপিং ঠিকানা</h4>
                        <p id="selected-address-display" class="text-sm text-gray-600 dark:text-gray-300">কোনো ঠিকানা নির্বাচন করা হয়নি</p>
                    </div>
                    <button id="change-address-btn" class="px-3 py-1.5 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm hover:bg-gray-100">পরিবর্তন</button>
                </div>
                <div id="address-select-panel" class="hidden mt-3">
                    <div id="address-select-list" class="space-y-2 max-h-48 overflow-auto"></div>
                    <div class="mt-3 flex gap-2">
                        <button id="use-selected-address-btn" class="w-full px-3 py-2 rounded-full bg-theme-blue text-white font-semibold hover:bg-theme-purple">নির্বাচিত ঠিকানা ব্যবহার করুন</button>
                        <button id="manage-addresses-shortcut" class="w-full px-3 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold hover:bg-gray-300">পরিচালনা করুন</button>
                    </div>
                </div>
            </div>
            <div id="payment-options" class="space-y-4">
                <!-- Main Payment Options -->
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Mobile Banking" class="w-5 h-5 accent-theme-blue">
                    <span class="ml-4 font-semibold" data-lang="mobile-banking">মোবাইল ব্যাংকিং</span>
                </label>
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Cash on Delivery" class="w-5 h-5 accent-theme-blue" checked="">
                    <span class="ml-4 font-semibold" data-lang="cod">ক্যাশ অন ডেলিভারি</span>
                </label>

                <!-- Sub Payment Options for Mobile Banking (hidden by default) -->
                <div id="mobile-banking-options" class="hidden pl-8 space-y-3 pt-3">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Bkash" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Bkash</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Nagad" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Nagad</span>
                    </label>
                </div>
            </div>
            <div class="mt-8">
                <button id="confirm-order-btn" class="w-full bg-theme-pink text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg" data-lang="confirm-order">অর্ডার নিশ্চিত করুন</button>
            </div>
        </div>
    </div>
    
    <!-- Order Success Modal -->
    <div id="order-success-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[110] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
             <div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-4xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-6" data-lang="order-placed-success">আপনার অর্ডারটি সফলভাবে সম্পন্ন হয়েছে!</h3>
            <p id="payment-instruction" class="mt-4 text-gray-600"></p>
            <div class="mt-8">
                <button id="close-success-modal" class="w-full bg-theme-blue text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg">বন্ধ করুন</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (Replaces window.confirm) -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[120] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl text-center">
            <h3 id="confirm-title" class="text-2xl font-bold text-red-600 mb-4">নিশ্চিত করুন</h3>
            <p id="confirm-message" class="text-gray-600">আপনি কি নিশ্চিত যে আপনি এগোতে চান?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-full font-semibold hover:bg-gray-400 transition-colors">বাতিল</button>
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-full font-semibold hover:bg-red-700 transition-colors">নিশ্চিত</button>
            </div>
        </div>
    </div>


    <!-- Mobile Navigation Drawer (Left) -->
    <div id="nav-drawer" class="drawer left fixed top-0 left-0 h-full w-full sm:w-72 bg-white dark:bg-gray-800 shadow-lg z-50 p-6">
        <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">×</button>
    <h3 class="text-2xl font-bold text-theme-purple mb-8">মেনু</h3>
        <nav>
            <ul class="space-y-4">
                <li><a href="javascript:void(0);" onclick="renderAllProducts(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="home">হোম</a></li>
                <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="products">পণ্য</a></li>
                <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="categories">ক্যাটাগরি</a></li>
                <li><a href="javascript:void(0);" onclick="showPage('home-page'); closeDrawer(); setTimeout(() => scrollToElement('mega-sale-section'), 200);" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="mega-sale-nav">মেগা সেল</a></li>
                <li><a href="javascript:void(0);" onclick="showOffers(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="offers">অফার</a></li>
            </ul>
            <div class="mt-6">
                <button id="dark-mode-toggle-mobile" type="button" class="w-full flex items-center justify-between px-4 py-3 rounded-xl border border-gray-200 bg-white text-gray-700 font-semibold shadow-sm hover:border-theme-blue hover:text-theme-blue transition-colors" title="Dark Mode" data-lang-title="dark-mode" data-lang-aria-label="dark-mode" aria-label="Dark Mode">
                    <span data-lang="dark-mode">ডার্ক মোড</span>
                    <i id="dark-mode-icon-mobile" class="fas fa-sun text-theme-blue text-lg"></i>
                </button>
            </div>
            <div class="mt-10">
                <p class="text-sm font-semibold text-gray-500 uppercase tracking-wide" data-lang="language-menu-heading">ভাষা নির্বাচন করুন</p>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    <button type="button" class="language-option px-4 py-2 rounded-full border border-theme-blue text-theme-blue font-semibold transition-colors hover:bg-theme-blue hover:text-white" data-lang-option="bn">
                        <span data-lang="language-bangla">বাংলা</span>
                        <i class="fas fa-check lang-active-indicator text-white hidden"></i>
                    </button>
                    <button type="button" class="language-option px-4 py-2 rounded-full border border-theme-blue text-theme-blue font-semibold transition-colors hover:bg-theme-blue hover:text-white" data-lang-option="en">
                        <span data-lang="language-english">ইংরেজি</span>
                        <i class="fas fa-check lang-active-indicator text-white hidden"></i>
                    </button>
                </div>
            </div>
        </nav>
    </div>

    <!-- Mobile Categories Drawer -->
    <div id="mobile-categories-drawer" class="drawer bottom fixed bottom-0 left-0 right-0 z-50 max-h-[80vh] bg-white dark:bg-gray-900 rounded-t-3xl shadow-2xl flex flex-col">
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center gap-3">
                <button id="mobile-categories-back" type="button" class="hidden p-2 rounded-full bg-gray-100 text-gray-600 hover:text-gray-900 dark:bg-gray-800 dark:text-gray-200 dark:hover:text-white transition-colors" data-lang-aria-label="back-to-categories" aria-label="Back to categories">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h3 id="mobile-categories-title" class="text-lg font-semibold text-theme-purple" data-lang="all-categories">All Categories</h3>
            </div>
            <button type="button" class="text-2xl text-gray-500 hover:text-gray-800 dark:text-gray-300 dark:hover:text-white transition-colors" onclick="closeDrawer()" aria-label="Close">
                ×
            </button>
        </div>
        <div class="p-5 overflow-y-auto flex-1 space-y-5">
            <div id="mobile-categories-list" class="grid grid-cols-2 gap-3"></div>
            <div id="mobile-subcategories-container" class="hidden space-y-4">
                <p id="mobile-subcategories-lead" class="text-sm text-gray-500 dark:text-gray-300" data-lang="choose-subcategory">Choose a subcategory</p>
                <div id="mobile-subcategories-list" class="grid grid-cols-1 gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Cart Drawer (Right) -->
    <div id="cart-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-2xl font-bold text-theme-purple" data-lang="cart">আপনার কার্ট</h3>
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">×</button>
        </div>
        <div id="cart-items" class="p-6 space-y-6 flex-grow overflow-y-auto">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        <div id="cart-summary" class="p-6 border-t space-y-2">
            
            <!-- Available Coupons section removed as requested -->
            
            <!-- Summary -->
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="subtotal">মোট:</span>
                <span id="cart-subtotal" class="text-dark">৳0.00</span>
            </div>
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="delivery-charge">ডেলিভারি চার্জ:</span>
                <span id="delivery-charge" class="text-dark">৳0.00</span>
            </div>
            <div id="discount-row" class="hidden flex justify-between items-center text-md font-medium text-green-600">
                <span data-lang="discount">ডিসকাউন্ট:</span>
                <span id="cart-discount"></span>
            </div>
            <div class="flex justify-between items-center text-xl font-semibold border-t pt-2 mt-2">
                <span data-lang="total-inclusive-vat">মোট (ভ্যাটসহ)</span>
                <span id="cart-total" class="text-theme-blue">৳0.00</span>
            </div>
             <!-- Coupon Form -->
            <div class="mt-4">
                <form id="coupon-form" class="w-full">
                    <div class="flex w-full overflow-hidden rounded-md border border-gray-300 bg-white dark:bg-gray-800">
                        <input type="text" id="coupon-input" placeholder="কুপন কোড" class="flex-grow px-3 py-2 text-sm sm:text-base bg-transparent border-0 focus:outline-none focus:ring-0 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400" data-lang-placeholder="coupon-placeholder">
                        <button type="submit" id="apply-coupon-btn" class="bg-theme-blue text-white px-4 py-2 text-sm sm:text-base font-semibold hover:bg-theme-purple transition-colors" data-lang="apply-coupon">প্রয়োগ</button>
                    </div>
                </form>
            </div>
            <button id="checkout-btn" class="w-full bg-theme-blue text-white py-4 rounded-md font-bold hover:bg-theme-purple transition-colors shadow-lg mt-4" data-lang="checkout">চেকআউট করুন</button>
        </div>
    </div>
    
    <!-- Profile Drawer (Right) -->
    <div id="profile-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 overflow-y-auto">
        <div class="p-6 relative space-y-8">
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl leading-none" aria-label="Close drawer">×</button>
            <h3 id="profile-drawer-title" class="text-3xl font-bold text-theme-purple text-center" data-lang="your-account">আপনার অ্যাকাউন্ট</h3>

            <div id="auth-options" class="space-y-6">
                <div class="auth-card space-y-6">
                    <header class="auth-header">
                        <span class="auth-hero-icon" aria-hidden="true">
                            <i class="fas fa-shield-alt"></i>
                        </span>
                        <div class="space-y-1">
                            <h4 id="auth-card-heading" class="text-2xl font-bold" data-lang="auth-login-heading">পুনরায় স্বাগতম</h4>
                            <p id="auth-subtitle" class="auth-subtitle" data-lang="auth-login-subtitle">অর্ডার, উইশলিস্ট ও ঠিকানা পরিচালনা করতে লগইন করুন।</p>
                        </div>
                    </header>
                    <div class="auth-tabs" role="tablist">
                        <button type="button" class="auth-tab auth-tab-active" data-auth-tab="login" aria-selected="true">
                            <i class="fas fa-sign-in-alt"></i>
                            <span data-lang="auth-login-tab">লগইন</span>
                        </button>
                        <button type="button" class="auth-tab" data-auth-tab="register" aria-selected="false">
                            <i class="fas fa-user-plus"></i>
                            <span data-lang="auth-register-tab">রেজিস্টার</span>
                        </button>
                        <button type="button" class="auth-tab" data-auth-tab="reset" aria-selected="false">
                            <i class="fas fa-unlock-alt"></i>
                            <span data-lang="auth-reset-tab">রিসেট</span>
                        </button>
                    </div>

                    <div class="space-y-6">
                        <form id="login-form" class="space-y-4 text-left">
                            <div class="space-y-1">
                                <label for="login-email" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="email">ইমেইল</label>
                                <input id="login-email" type="email" autocomplete="email" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <div class="space-y-1">
                                <label for="login-password" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="password">পাসওয়ার্ড</label>
                                <input id="login-password" type="password" autocomplete="current-password" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <button type="submit" class="w-full py-3 rounded-lg bg-theme-blue text-white font-semibold hover:bg-theme-purple transition-colors" data-lang="login">লগইন করুন</button>
                            <div class="flex flex-wrap items-center justify-between gap-3 text-xs sm:text-sm text-gray-600 dark:text-gray-300">
                                <div class="flex items-center gap-2">
                                    <span data-lang="auth-new-here">নতুন সদস্য?</span>
                                    <button id="show-register-form" type="button" class="auth-link" data-lang="create-account">অ্যাকাউন্ট তৈরি করুন</button>
                                </div>
                                <button id="show-reset-form" type="button" class="auth-link" data-lang="forgot-password">পাসওয়ার্ড ভুলে গেছেন?</button>
                            </div>
                        </form>

                        <form id="register-form" class="hidden space-y-4 text-left">
                            <div class="space-y-1">
                                <label for="register-name" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="full-name">পূর্ণ নাম</label>
                                <input id="register-name" type="text" autocomplete="name" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <div class="space-y-1">
                                <label for="register-mobile" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="mobile-number">মোবাইল নম্বর</label>
                                <input id="register-mobile" type="tel" autocomplete="tel" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue">
                            </div>
                            <div class="space-y-1">
                                <label for="register-location" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="location">অবস্থান</label>
                                <input id="register-location" type="text" autocomplete="address-level2" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue">
                            </div>
                            <div class="space-y-1">
                                <label for="register-email" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="email">ইমেইল</label>
                                <input id="register-email" type="email" autocomplete="email" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <div class="space-y-1">
                                <label for="register-password" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="password">পাসওয়ার্ড</label>
                                <input id="register-password" type="password" autocomplete="new-password" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <button type="submit" class="w-full py-3 rounded-lg bg-theme-blue text-white font-semibold hover:bg-theme-purple transition-colors" data-lang="register">রেজিস্টার করুন</button>
                            <p class="text-xs sm:text-sm text-center text-gray-600 dark:text-gray-300">
                                <span data-lang="auth-have-account">ইতোমধ্যে অ্যাকাউন্ট আছে?</span>
                                <button id="show-login-form" type="button" class="auth-link" data-lang="login">লগইন করুন</button>
                            </p>
                        </form>

                        <form id="reset-form" class="hidden space-y-4 text-left">
                            <p class="text-sm text-gray-600 dark:text-gray-300" data-lang="reset-password-desc">আপনার নিবন্ধিত ইমেইল দিন, আমরা একটি রিসেট লিঙ্ক পাঠাবো।</p>
                            <div class="space-y-1">
                                <label for="reset-email" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="email">ইমেইল</label>
                                <input id="reset-email" type="email" autocomplete="email" class="w-full px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                            </div>
                            <button type="submit" class="w-full py-3 rounded-lg bg-theme-blue text-white font-semibold hover:bg-theme-purple transition-colors" data-lang="send-reset-link">রিসেট লিঙ্ক পাঠান</button>
                            <button id="show-login-from-reset" type="button" class="auth-link mx-auto block text-sm" data-lang="back-to-login">লগইনে ফিরে যান</button>
                        </form>
                    </div>

                    <div class="auth-divider">
                        <span id="auth-social-divider" data-lang="auth-social-divider">অথবা চালিয়ে যান</span>
                    </div>

                    <div class="grid gap-3">
                        <button id="login-google-btn" type="button" class="auth-social-btn">
                            <span class="auth-social-icon google"><i class="fab fa-google"></i></span>
                            <span data-lang="login-google">গুগল দিয়ে লগইন করুন</span>
                        </button>
                        <button id="login-facebook-btn" type="button" class="auth-social-btn">
                            <span class="auth-social-icon facebook"><i class="fab fa-facebook-f"></i></span>
                            <span data-lang="login-facebook">ফেসবুক দিয়ে লগইন করুন</span>
                        </button>
                    </div>

                    <p id="auth-security-note" class="auth-meta-note" data-lang="auth-security-note">আপনার তথ্য এনক্রিপ্টেড এবং নিরাপদে সংরক্ষিত থাকে।</p>
                    <p id="auth-error" class="auth-error text-center"></p>
                </div>
            </div>

            <div id="user-profile-view" class="hidden space-y-6">
                <div class="flex flex-col items-center text-center space-y-3">
                    <img id="user-photo" src="https://placehold.co/96x96/6a0dad/white?text=User" alt="User avatar" class="w-24 h-24 rounded-full object-cover shadow-md">
                    <div class="space-y-1 text-sm text-gray-600 dark:text-gray-300">
                        <p id="user-name" class="text-lg font-semibold text-gray-900 dark:text-gray-100"></p>
                        <p id="user-email"></p>
                        <p id="user-mobile"></p>
                        <p id="user-location"></p>
                    </div>
                </div>

                <button id="mobile-profile-toggle" type="button" class="mobile-profile-toggle md:hidden w-full flex items-center justify-between px-4 py-2 rounded-xl bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold" aria-expanded="false">
                    <span data-lang="account-options">অ্যাকাউন্ট অপশন</span>
                    <i class="fas fa-plus text-xs transition-transform"></i>
                </button>

                <div id="profile-quick-actions" class="md:hidden grid grid-cols-2 gap-3">
                    <button type="button" class="profile-quick-action flex flex-col items-center justify-center gap-2 px-3 py-3 rounded-2xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm text-xs font-semibold text-gray-700 dark:text-gray-100 transition-colors hover:border-theme-blue hover:text-theme-blue" data-action="edit" data-lang-title="edit-profile" data-lang-aria-label="edit-profile">
                        <i class="fas fa-user-cog text-lg text-theme-blue"></i>
                        <span data-lang="edit-profile">প্রোফাইল সম্পাদনা</span>
                    </button>
                    <button type="button" class="profile-quick-action flex flex-col items-center justify-center gap-2 px-3 py-3 rounded-2xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm text-xs font-semibold text-gray-700 dark:text-gray-100 transition-colors hover:border-theme-blue hover:text-theme-blue" data-action="orders" data-lang-title="my-orders" data-lang-aria-label="my-orders">
                        <i class="fas fa-boxes text-lg text-theme-blue"></i>
                        <span data-lang="my-orders">আমার অর্ডার</span>
                    </button>
                    <button type="button" class="profile-quick-action flex flex-col items-center justify-center gap-2 px-3 py-3 rounded-2xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm text-xs font-semibold text-gray-700 dark:text-gray-100 transition-colors hover:border-theme-blue hover:text-theme-blue" data-action="addresses" data-lang-title="manage-address" data-lang-aria-label="manage-address">
                        <i class="fas fa-map-marker-alt text-lg text-theme-blue"></i>
                        <span data-lang="manage-address">ঠিকানা ম্যানেজ করুন</span>
                    </button>
                    <button type="button" class="profile-quick-action flex flex-col items-center justify-center gap-2 px-3 py-3 rounded-2xl bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 shadow-sm text-xs font-semibold text-gray-700 dark:text-gray-100 transition-colors hover:border-theme-blue hover:text-theme-blue" data-action="support" data-lang-title="emergency-contact" data-lang-aria-label="emergency-contact">
                        <i class="fas fa-headset text-lg text-theme-blue"></i>
                        <span data-lang="emergency-contact">সাপোর্ট</span>
                    </button>
                </div>

                <div id="profile-full-section" class="space-y-4 hidden md:block">
                    <div class="space-y-3">
                        <button id="edit-profile-btn" type="button" class="w-full px-4 py-3 rounded-full bg-theme-blue text-white font-semibold hover:bg-theme-purple transition-colors" data-lang="edit-profile">প্রোফাইল সম্পাদনা</button>
                        <button id="my-orders-btn-profile" type="button" class="w-full px-4 py-3 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-lang="my-orders">আমার অর্ডার</button>
                        <button id="manage-addresses-btn" type="button" class="w-full px-4 py-3 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors" data-lang="manage-address">ঠিকানা ম্যানেজ করুন</button>
                    </div>
                    <div class="space-y-3">
                        <button id="logout-btn" type="button" class="w-full px-4 py-3 rounded-full bg-theme-pink text-white font-semibold hover:bg-theme-purple transition-colors" data-lang="logout">লগ আউট</button>
                        <button id="delete-account-btn" type="button" class="w-full px-4 py-3 rounded-full bg-red-100 text-red-600 font-semibold hover:bg-red-200 transition-colors" data-lang="delete-account">অ্যাকাউন্ট মুছুন</button>
                    </div>
                </div>
            </div>

            <form id="edit-profile-form" class="hidden space-y-5 text-left">
                <div class="flex items-center gap-4">
                    <img id="edit-photo-preview" src="https://placehold.co/96x96/6a0dad/white?text=User" alt="Profile preview" class="w-16 h-16 rounded-full object-cover shadow">
                    <div class="space-y-2">
                        <label class="inline-flex items-center gap-2 px-3 py-2 border border-dashed border-gray-300 dark:border-gray-600 rounded-full bg-white dark:bg-gray-700 text-sm font-semibold cursor-pointer hover:border-theme-blue">
                            <i class="fas fa-upload text-theme-blue"></i>
                            <span data-lang="upload-photo">ছবি আপলোড করুন</span>
                            <input id="edit-photo-input" type="file" accept="image/*" class="hidden">
                        </label>
                        <button id="remove-photo-btn" type="button" class="text-sm text-red-600 hover:underline" data-lang="remove-photo">ছবি সরান</button>
                    </div>
                </div>
                <div>
                    <label for="edit-name-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="full-name">পূর্ণ নাম</label>
                    <input id="edit-name-input" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue" required>
                </div>
                <div>
                    <label for="edit-mobile-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="mobile-number">মোবাইল নম্বর</label>
                    <input id="edit-mobile-input" type="tel" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue">
                </div>
                <div>
                    <label for="edit-location-input" class="block text-sm font-semibold text-gray-700 dark:text-gray-200" data-lang="location">অবস্থান</label>
                    <input id="edit-location-input" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-theme-blue">
                </div>
                <div class="flex gap-3 pt-2">
                    <button id="save-profile-btn" type="submit" class="flex-1 py-3 rounded-full bg-theme-blue text-white font-semibold hover:bg-theme-purple transition-colors flex items-center justify-center gap-2">
                        <span class="btn-text" data-lang="save-changes">পরিবর্তন সংরক্ষণ করুন</span>
                        <span class="loader-small hidden"></span>
                    </button>
                    <button id="cancel-edit-btn" type="button" class="flex-1 py-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-lang="cancel">বাতিল</button>
                </div>
            </form>

            <section id="addresses-section" class="hidden space-y-4 text-left">
                <header class="space-y-1">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100" data-lang="saved-addresses">সংরক্ষিত ঠিকানাসমূহ</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-300" data-lang="manage-address-help">আপনার ডেলিভারি ঠিকানাগুলো পরিচালনা করুন।</p>
                </header>
                <div id="addresses-list" class="space-y-3"></div>
                <form id="address-form" class="space-y-4 p-4 border border-gray-200 dark:border-gray-700 rounded-2xl bg-gray-50 dark:bg-gray-900/40">
                    <h5 id="address-form-title" class="text-base font-semibold text-gray-900 dark:text-gray-100" data-lang="address-form-title">নতুন ঠিকানা যোগ করুন</h5>
                    <input type="hidden" id="address-id-hidden">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="full-name">পূর্ণ নাম</label>
                            <input id="addr-name" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="mobile-number">মোবাইল নম্বর</label>
                            <input id="addr-mobile" type="tel" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="address-line1">ঠিকানা লাইন ১</label>
                            <input id="addr-line1" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="address-line2-optional">ঠিকানা লাইন ২ (ঐচ্ছিক)</label>
                            <input id="addr-line2" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700">
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="city">শহর</label>
                                <input id="addr-city" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-200" data-lang="area-district">এলাকা/জেলা</label>
                                <input id="addr-area" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700">
                            </div>
                        </div>
                    </div>
                    <label class="inline-flex items-center gap-2">
                        <input id="addr-default" type="checkbox" class="w-4 h-4">
                        <span class="text-sm text-gray-700 dark:text-gray-200" data-lang="set-as-default">ডিফল্ট হিসেবে নির্ধারণ করুন</span>
                    </label>
                    <div class="flex gap-3 pt-2">
                        <button id="save-address-btn" type="submit" class="flex-1 py-2 bg-theme-blue text-white rounded-full font-semibold hover:bg-theme-purple transition-colors" data-lang="save-address">ঠিকানা সংরক্ষণ করুন</button>
                        <button id="cancel-address-btn" type="button" class="flex-1 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 rounded-full font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" data-lang="cancel">বাতিল</button>
                    </div>
                </form>
            </section>
        </div>
    </div>

    <!-- Full Page: Cart -->
    <section id="cart-page" class="page hidden max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-theme-purple" data-lang="cart">আপনার কার্ট</h2>
            <button onclick="showPage('home-page')" class="text-theme-blue hover:text-theme-pink transition-colors text-sm sm:text-base" data-lang="back-to-products">সকল পণ্যে ফিরে যান</button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Items -->
            <div class="lg:col-span-2 space-y-4" id="cart-page-items">
                <!-- Will mirror cart items rendering -->
            </div>
            <!-- Summary -->
            <aside class="lg:col-span-1">
                <div class="p-5 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm space-y-4">
                    <h3 class="text-xl font-bold text-theme-purple" data-lang="order-summary">অর্ডার সারাংশ</h3>
                    <!-- Coupon Apply under Order Summary heading -->
                    <form id="cart-page-coupon-form" class="w-full">
                        <div class="flex w-full overflow-hidden rounded-md border border-gray-300 bg-white dark:bg-gray-800">
                            <input type="text" id="cart-page-coupon-input" class="flex-grow px-3 py-2 text-sm sm:text-base bg-transparent border-0 focus:outline-none focus:ring-0 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400" data-lang-placeholder="coupon-placeholder" placeholder="কুপন কোড">
                            <button type="submit" class="bg-theme-blue text-white px-4 py-2 text-sm sm:text-base font-semibold hover:bg-theme-purple transition-colors" data-lang="apply-coupon">প্রয়োগ</button>
                        </div>
                    </form>
                    <p id="cart-page-coupon-applied" class="hidden text-xs text-green-600"></p>
                    <!-- Available Coupons section removed on cart page as requested -->
                    <div class="flex justify-between text-sm">
                        <span data-lang="subtotal">মোট:</span>
                        <span id="cart-page-subtotal" class="text-dark">৳0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span data-lang="delivery-charge">ডেলিভারি চার্জ:</span>
                        <span id="cart-page-delivery" class="text-dark">৳0.00</span>
                    </div>
                    <div id="cart-page-discount-row" class="hidden flex justify-between text-sm text-green-600">
                        <span data-lang="discount">ডিসকাউন্ট:</span>
                        <span id="cart-page-discount">- ৳0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-semibold border-t pt-2 mt-2">
                        <span data-lang="total-inclusive-vat">মোট (ভ্যাটসহ)</span>
                        <span id="cart-page-total" class="text-theme-blue">৳0.00</span>
                    </div>
                    <button id="cart-page-checkout-btn" class="w-full bg-theme-blue text-white py-3 rounded-md font-bold hover:bg-theme-purple transition-colors shadow-lg" data-lang="checkout">চেকআউট করুন</button>
                </div>
            </aside>
        </div>
    </section>


    <!-- Main Content Container -->
    <main id="main-content-container" class="flex-1 overflow-x-hidden pb-24 md:pb-0">

        <!-- Home Page -->
        <div id="home-page" class="page">
            <!-- Top Category Strip (Under Header, Above Banner) -->
            <section id="top-category-strip" class="container mx-auto px-4 pt-4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
                    <div id="top-category-strip-list" class="flex gap-2 sm:gap-3 lg:gap-4 px-4 py-3 overflow-x-auto items-center scrollbar-thin">
                        <!-- Dynamic category buttons will render here -->
                    </div>
                </div>
            </section>
            <!-- Hero/Banner Composite (2-part layout) -->
            <section class="container mx-auto px-4 py-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                    <!-- Left: Main Banner Slider -->
                    <div class="lg:col-span-2">
                        <div id="banner-slider" class="relative overflow-hidden w-full rounded-2xl shadow-xl h-[200px] sm:h-[240px] lg:h-[260px]">
                            <!-- Slides Container -->
                            <div id="slides-container" class="flex transition-transform duration-500 ease-in-out h-full">
                                <!-- Banners will be loaded from Firebase here -->
                            </div>

                            <!-- Slider Navigation Buttons -->
                            <button id="prev-btn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="next-btn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>

                            <!-- Slider Indicators -->
                            <div id="slider-indicators" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                                <!-- Indicators are dynamically generated -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Promo Tile (tall) -->
                    <aside class="lg:col-span-1">
                        <a id="right-promo-link" href="javascript:void(0)" onclick="scrollToElement('categories')" class="group block relative overflow-hidden rounded-2xl shadow-xl h-[220px] sm:h-[260px]">
                            <img id="right-promo-img" src="https://images.unsplash.com/photo-1524594081293-190a2fe0baae?q=80&amp;w=1200&amp;auto=format&amp;fit=crop" alt="Promo: Smart prices on accessories" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/ddd/000?text=Promo';">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-black/30 transition-colors"></div>
                            <div class="absolute bottom-4 left-4 right-4 text-white drop-shadow space-y-1">
                                <h3 id="right-promo-title" class="text-lg sm:text-2xl font-extrabold hidden"></h3>
                                <p id="right-promo-subtitle" class="text-xs sm:text-base font-semibold hidden"></p>
                            </div>
                        </a>
                    </aside>
                </div>
            </section>
            
            <!-- Hero Section removed: merged into composite above to match design -->
        
            <!-- Flash Sale Section -->
            <section id="flash-sale-section" class="container mx-auto px-4 pt-0.5 pb-1 hidden">
                <div class="relative rounded-[13px] shadow-md overflow-hidden">
                    <div class="relative overflow-hidden bg-gradient-to-r from-theme-blue via-theme-purple to-theme-pink text-white flash-sale-animated-bg">
                        <div class="absolute -top-3.5 -right-3.5 h-16 w-16 rounded-full bg-white/10 blur-lg"></div>
                        <div class="absolute -bottom-4 -left-4 h-20 w-20 rounded-full bg-black/10 blur-lg"></div>
                        <div class="flash-sale-overlay-text" aria-hidden="true">
                            <span>FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE •</span>
                            <span>FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE • FLASH SALE •</span>
                        </div>
                        <div class="relative px-3.5 sm:px-4.5 py-1.5 flex flex-col gap-1.25 sm:flex-row sm:items-center sm:justify-between">
                            <div class="flex flex-col gap-1.1 max-w-xl">
                                <span class="inline-flex items-center gap-1.75 bg-white/15 border border-white/25 backdrop-blur-sm text-sm sm:text-base font-semibold uppercase tracking-wide px-3 py-0.85 rounded-full">🔥 <span data-lang="flash-sale-badge">ফ্ল্যাশ</span></span>
                                <p id="flash-sale-subheading" class="text-white text-base sm:text-lg leading-relaxed font-semibold" data-lang="flash-sale-subheading">সময় সীমিত অফার চলছে—শেষ হওয়ার আগেই কিনে ফেলুন!</p>
                            </div>
                            <div class="flex items-center gap-2.5 bg-white/15 border border-white/25 rounded-lg px-3.5 py-1 backdrop-blur">
                                <div class="flex flex-col leading-tight">
                                    <span id="flash-sale-countdown-label" class="text-sm sm:text-base font-semibold uppercase text-white/90" data-lang="flash-sale-countdown-label">শেষ হতে বাকি</span>
                                    <span id="flash-sale-master-countdown" class="flash-sale-countdown text-xl sm:text-3xl font-extrabold tracking-tight">00:00:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white/90 dark:bg-gray-900/80 px-2.5 sm:px-3.5 py-1.5 sm:py-2 space-y-1">
                        <div id="flash-sale-empty" class="text-center text-gray-600 dark:text-gray-200 text-[10px] sm:text-xs hidden" data-lang="flash-sale-empty">এখন কোনো ফ্ল্যাশ ডিল নেই। আবারও দেখে যান।</div>
                        <div id="flash-sale-grid" class="grid grid-cols-1 gap-1.5 sm:grid-cols-2 lg:grid-cols-4"></div>
                    </div>
                </div>
            </section>

            <!-- Mega Sale Section -->
            <section id="mega-sale-section" class="container mx-auto px-4 pb-6 sm:pb-10 hidden">
                <div class="rounded-3xl shadow-xl overflow-hidden bg-white dark:bg-gray-900 border border-theme-purple/10">
                    <div class="bg-gradient-to-r from-theme-purple/10 via-theme-blue/10 to-theme-pink/10 px-5 sm:px-8 py-6 sm:py-7 flex flex-col md:flex-row md:items-center md:justify-between gap-5">
                        <div class="space-y-2.5 max-w-2xl">
                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-theme-purple/10 text-theme-purple text-xs sm:text-sm font-semibold uppercase tracking-wide">
                                ⭐ <span data-lang="mega-sale-badge">মেগা সেল</span>
                            </span>
                            <div class="space-y-1.5">
                                <h2 id="mega-sale-heading" class="text-2xl sm:text-3xl font-extrabold text-theme-purple" data-lang="mega-sale-heading">মেগা সেল</h2>
                                <p id="mega-sale-subheading" class="text-gray-600 dark:text-gray-300 text-sm sm:text-base leading-relaxed" data-lang="mega-sale-subheading">সপ্তাহের সবচেয়ে বড় ডিসকাউন্টগুলো—স্টক শেষ হওয়ার আগেই সংগ্রহ করুন।</p>
                            </div>
                        </div>
                        <div class="self-start md:self-center">
                            <span class="inline-flex items-center gap-2 px-3.5 py-1.5 rounded-full bg-theme-blue text-white text-xs sm:text-sm font-semibold shadow-lg">
                                <i class="fas fa-percent"></i>
                                <span data-lang="mega-sale-highlight">বিশেষ নির্বাচন</span>
                            </span>
                        </div>
                    </div>
                    <div class="px-5 sm:px-8 py-6 sm:py-7">
                        <div id="mega-sale-empty" class="text-center text-gray-500 dark:text-gray-300 text-sm sm:text-base hidden" data-lang="mega-sale-empty">এখন কোনো মেগা ডিল নেই। আবার দেখে যান।</div>
                        <div id="mega-sale-grid" class="grid grid-cols-1 gap-5 sm:gap-6 md:grid-cols-2 lg:grid-cols-4"></div>
                    </div>
                </div>
            </section>

            <!-- Featured Products Section -->
            <section id="products" class="container mx-auto px-4 py-10 sm:py-16">
                <!-- NEW: Breadcrumb and Sub-Category Header -->
                <div id="category-header" class="hidden mb-8 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md border dark:border-gray-700">
                    <div id="breadcrumb" class="text-sm text-gray-500 dark:text-gray-400 mb-4"></div>
                    <h2 id="current-category-title" class="text-3xl md:text-4xl font-bold mb-4 text-theme-purple text-center" data-lang="featured-products">বৈশিষ্ট্যযুক্ত পণ্য</h2>
                    <div id="subcategory-buttons" class="flex flex-wrap gap-3 justify-center">
                        <!-- Sub-category buttons will appear here -->
                    </div>
                </div>
                <!-- END NEW: Breadcrumb and Sub-Category Header -->

                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5 sm:gap-6 lg:gap-8 min-h-[300px]">
                    <div class="loader"></div>
                </div>
            </section>

            <!-- Categories Section -->
            <section id="categories" class="container mx-auto px-4 py-10 sm:py-16">
                <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center mb-8 sm:mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-16 sm:after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="shop-by-category">ক্যাটাগরি অনুসারে কেনাকাটা করুন</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-5 sm:gap-6 lg:gap-8">
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('electronics')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-mobile-alt"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-electronics">ইলেকট্রনিক্স</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('fashion')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-tshirt"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-fashion">ফ্যাশন</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('home-garden')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-home"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-home-garden">হোম অ্যান্ড গার্ডেন</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('health-beauty')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-health-beauty">স্বাস্থ্য ও সৌন্দর্য</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('sports')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-dumbbell"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-sports">খেলাধুলা ও আউটডোর</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('books')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-books">বই ও স্টেশনারি</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('kids')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-baby"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-kids">বাচ্চা ও খেলনা</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-5 sm:p-6 lg:p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('cars')">
                        <div class="text-3xl sm:text-4xl lg:text-5xl text-theme-blue mb-3"><i class="fas fa-car-side"></i></div>
                        <h3 class="text-lg sm:text-xl font-semibold" data-lang="cat-cars">গাড়ি ও বাইক</h3>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="bg-gray-200 dark:bg-gray-800 py-10 sm:py-16">
                <div class="container mx-auto px-4">
                    <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold text-center mb-8 sm:mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-16 sm:after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="why-choose-us">আমাদেরকে কেন বেছে নিবেন</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-5 sm:gap-6 lg:gap-8 max-w-5xl mx-auto">
                        <div class="p-5 sm:p-6 text-center animate-slide-in-up bg-white dark:bg-gray-900/40 rounded-2xl shadow-sm">
                            <div class="text-4xl sm:text-5xl text-theme-pink mb-3"><i class="fas fa-truck"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-delivery-title">দ্রুত ডেলিভারি</h3>
                            <p class="text-gray-600" data-lang="feature-delivery-desc">আমরা ২-৩ কার্যদিবসের মধ্যে আপনার দোরগোড়ায় পণ্য পৌঁছে দিই।</p>
                        </div>
                        <div class="p-5 sm:p-6 text-center animate-slide-in-up bg-white dark:bg-gray-900/40 rounded-2xl shadow-sm">
                            <div class="text-4xl sm:text-5xl text-theme-pink mb-3"><i class="fas fa-shield-alt"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-payment-title">নিরাপদ পেমেন্ট</h3>
                            <p class="text-gray-600" data-lang="feature-payment-desc">আপনার নিরাপত্তা ও গোপনীয়তার জন্য সকল লেনদেন এনক্রিপ্টেড।</p>
                        </div>
                        <div class="p-5 sm:p-6 text-center animate-slide-in-up bg-white dark:bg-gray-900/40 rounded-2xl shadow-sm">
                            <div class="text-4xl sm:text-5xl text-theme-pink mb-3"><i class="fas fa-undo"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-return-title">সহজ রিটার্ন</h3>
                            <p class="text-gray-600" data-lang="feature-return-desc">পছন্দ না হলে ৩০ দিনের মধ্যে পণ্য ফেরত দিন এবং সম্পূর্ণ মূল্য ফেরত পান।</p>
                        </div>
                        <div class="p-5 sm:p-6 text-center animate-slide-in-up bg-white dark:bg-gray-900/40 rounded-2xl shadow-sm">
                            <div class="text-4xl sm:text-5xl text-theme-pink mb-3"><i class="fas fa-headset"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-support-title">২৪/৭ সাপোর্ট</h3>
                            <p class="text-gray-600" data-lang="feature-support-desc">আমাদের গ্রাহক সহায়তা দল দিনরাত আপনার জন্য উপলব্ধ।</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- About Us Page -->
        <div id="about-us-page" class="hidden page">
             <section id="about-us" class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="about-heading">আমাদের সম্পর্কে</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-10">
                    <div class="space-y-4">
                        <h3 class="text-2xl font-bold text-theme-purple" data-lang="about-tagline-title">TangailBuzz: আপনার বিশ্বস্ত অনলাইন শপিং গন্তব্য</h3>
                        <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300" data-lang="about-tagline-body">
                            TangailBuzz একটি প্রতিশ্রুতিশীল ই-কমার্স প্ল্যাটফর্ম, যা ক্রেতা-কেন্দ্রিক পরিষেবা প্রদানের মাধ্যমে বাংলাদেশের অনলাইন শপিং-এর অভিজ্ঞতাকে নতুন মাত্রা দিতে বদ্ধপরিকর।
                        </p>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-theme-blue" data-lang="about-commitment-title">আমাদের অঙ্গীকার: মান, সাশ্রয় ও সহজলভ্যতা</h3>
                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-commitment-body">
                            আমরা বিশ্বাস করি, মানসম্মত পণ্য কেনা প্রতিটি মানুষের অধিকার। এই নীতিতে বিশ্বাস রেখে, TangailBuzz সর্বোচ্চ মানসম্মত পণ্যগুলো সাশ্রয়ী মূল্যে আপনার কাছে পৌঁছে দিতে অঙ্গীকারবদ্ধ। আমরা পণ্যের গুণগত মান নিয়ে কোনো আপস করি না, যাতে আপনি সম্পূর্ণ আস্থা ও সন্তুষ্টি নিয়ে কেনাকাটা করতে পারেন।
                        </p>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-theme-blue" data-lang="about-mission-title">আমাদের লক্ষ্য: সহজ, নির্ভরযোগ্য ও আনন্দদায়ক শপিং</h3>
                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-mission-lead">
                            আমাদের প্রধান লক্ষ্য হলো কেনাকাটার প্রক্রিয়াটিকে অত্যন্ত সহজ, নিরাপদ, নির্ভরযোগ্য এবং আনন্দদায়ক করে তোলা।
                        </p>
                        <ul class="space-y-3">
                            <li class="p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-sm">
                                <h4 class="font-semibold text-theme-purple" data-lang="about-mission-effortless-title">সহজ কেনাকাটা</h4>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-mission-effortless-body">
                                    আমাদের প্ল্যাটফর্মটি ব্যবহারকারী-বান্ধব (user-friendly) করে ডিজাইন করা হয়েছে, যাতে পণ্য খুঁজে বের করা থেকে শুরু করে অর্ডার নিশ্চিত করা পর্যন্ত পুরো প্রক্রিয়াটি মসৃণ ও স্বচ্ছন্দ হয়।
                                </p>
                            </li>
                            <li class="p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-sm">
                                <h4 class="font-semibold text-theme-purple" data-lang="about-mission-home-title">ঘরে বসে শপিং</h4>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-mission-home-body">
                                    বাংলাদেশের যেকোনো প্রান্তের মানুষ যেন ঘরে বসেই তাদের পছন্দের সেরা পণ্যটি কোনো ঝামেলা ছাড়াই কিনতে পারেন, তা নিশ্চিত করাই আমাদের প্রধান উদ্দেশ্য।
                                </p>
                            </li>
                            <li class="p-4 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-sm">
                                <h4 class="font-semibold text-theme-purple" data-lang="about-mission-trusted-title">বিশ্বস্ত অভিজ্ঞতা</h4>
                                <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-mission-trusted-body">
                                    আমরা শুধুমাত্র পণ্য সরবরাহ করি না, বরং একটি সম্পূর্ণ বিশ্বস্ত শপিং অভিজ্ঞতা নিশ্চিত করি—যার মধ্যে রয়েছে দ্রুত ডেলিভারি, সহজ রিটার্ন প্রক্রিয়া এবং সার্বক্ষণিক গ্রাহক সহায়তা।
                                </p>
                            </li>
                        </ul>
                    </div>

                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8 md:gap-12 p-6 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-inner">
                        <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true" alt="Md Eousuf Ali" class="w-32 h-32 rounded-full object-cover shadow-lg">
                        <div class="space-y-4">
                            <h3 class="text-2xl font-bold text-theme-purple" data-lang="about-founder-title">প্রতিষ্ঠাতা: MD EOUSUF ALI – এক দূরদর্শী স্বপ্নদ্রষ্টা</h3>
                            <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-founder-body">
                                MD EOUSUF ALI শুধুমাত্র TangailBuzz-এর প্রতিষ্ঠাতা নন, তিনি ডিজিটাল মাধ্যমে সামাজিক ও অর্থনৈতিক পরিবর্তনের একজন স্থপতি। তাঁর যাত্রা শুরু হয়েছিল একটি সরল কিন্তু গভীর প্রত্যয় নিয়ে: বাংলাদেশের প্রতিটি মানুষের কাছে যেন উন্নত মানের পণ্য সহজলভ্য হয়, তা নিশ্চিত করা।
                            </p>
                            <div class="space-y-3">
                                <h4 class="font-semibold text-theme-blue" data-lang="about-founder-pillars-title">তাঁর দূরদর্শিতার মূল দিকগুলো</h4>
                                <ul class="space-y-3">
                                    <li class="bg-white/60 dark:bg-gray-800/60 p-4 rounded-2xl shadow">
                                        <h5 class="font-semibold text-theme-purple" data-lang="about-founder-pillar-tech-title">টেকনোলজি ও মানুষের সংযোগ</h5>
                                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-founder-pillar-tech-body">
                                            তিনি প্রযুক্তির ব্যবহারকে কেবল বাণিজ্য নয়, বরং সাধারণ মানুষের জীবনযাত্রার একটি অংশ করার স্বপ্ন দেখেছিলেন।
                                        </p>
                                    </li>
                                    <li class="bg-white/60 dark:bg-gray-800/60 p-4 rounded-2xl shadow">
                                        <h5 class="font-semibold text-theme-purple" data-lang="about-founder-pillar-goal-title">উন্নয়নের লক্ষ্য</h5>
                                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-founder-pillar-goal-body">
                                            তাঁর লক্ষ্য কেবল ব্যবসা করা নয়, বরং একটি স্বচ্ছ ও নির্ভরযোগ্য শপিং ইকোসিস্টেম তৈরি করা যা ক্রেতা ও বিক্রেতা উভয়কেই উপকৃত করবে।
                                        </p>
                                    </li>
                                    <li class="bg-white/60 dark:bg-gray-800/60 p-4 rounded-2xl shadow">
                                        <h5 class="font-semibold text-theme-purple" data-lang="about-founder-pillar-drive-title">অদম্য স্পৃহা</h5>
                                        <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-founder-pillar-drive-body">
                                            তাঁর অদম্য চেষ্টা, কঠোর পরিশ্রম এবং গ্রাহক-কেন্দ্রিক মনোভাবই TangailBuzz-কে আজকের অবস্থানে এনেছে। তিনি এই প্ল্যাটফর্মটিকে কেবল একটি ই-কমার্স সাইট নয়, বরং বিশ্বাস এবং গুণমানের প্রতিশ্রুতির প্রতীক হিসেবে প্রতিষ্ঠা করেছেন।
                                        </p>
                                    </li>
                                </ul>
                            </div>
                            <p class="text-gray-700 dark:text-gray-300 leading-relaxed" data-lang="about-founder-conclusion">
                                MD EOUSUF ALI-এর নেতৃত্ব TangailBuzz-কে কেবল একটি শপিং প্ল্যাটফর্ম নয়, বরং বাংলাদেশের ই-কমার্স জগতে একটি অনুপ্রেরণামূলক ব্র্যান্ড হিসেবে প্রতিষ্ঠিত করেছে।
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Product Details Page -->
        <div id="product-details-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl">
                    <button onclick="renderAllProducts()" class="mb-6 px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> <span data-lang="back-to-products">সকল পণ্যে ফিরে যান</span>
                    </button>
                    <div class="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
                        <!-- Main Product Image & Thumbnails -->
                        <div class="w-full lg:w-1/2 flex flex-col items-center space-y-4">
                             <div id="product-image-container" class="relative w-full rounded-2xl shadow-lg overflow-hidden">
                                 <!-- Mouse events for handleImageZoom use 'var(--x-pos)' and 'var(--y-pos)' set in JS/CSS -->
                                <img id="product-image" class="w-full h-auto object-contain transition-transform duration-200 ease-out" src="" alt="Product Image">
                            </div>
                            <!-- Thumbnail Images -->
                            <div id="thumbnail-container" class="flex space-x-2 overflow-x-auto w-full justify-center">
                                <!-- Thumbnails will be added here dynamically -->
                            </div>
                        </div>
                        <div class="w-full lg:w-1/2 space-y-4">
                            <div id="product-sale-highlight" class="space-y-2 hidden">
                                <div id="product-sale-badges" class="flex flex-wrap items-center gap-2"></div>
                                <div id="product-sale-countdown-wrapper" class="hidden inline-flex items-center gap-2 bg-theme-purple/10 text-theme-purple px-3 py-2 rounded-full">
                                    <i class="fas fa-clock text-sm"></i>
                                    <span id="product-sale-countdown-label" class="text-xs font-semibold uppercase tracking-[0.25em]"></span>
                                    <span id="product-sale-countdown" class="text-sm font-bold"></span>
                                </div>
                            </div>
                            <h2 id="product-title-details" class="text-3xl md:text-4xl font-bold text-theme-purple"></h2>
                            <p id="product-brand-details" class="text-sm text-gray-500"></p>
                            <!-- NEW: Product Model ID Display -->
                            <p id="product-model-details" class="text-sm text-gray-600 font-medium flex items-center">
                                <i class="fas fa-tag mr-2"></i> 
                                <span id="model-text"></span>
                            </p>
                            <!-- END NEW: Product Model ID Display -->
                            <!-- NEW: Warranty Display below Brand/Model -->
                            <p id="product-warranty-details" class="text-sm text-green-600 font-semibold flex items-center">
                                <!-- Icon and Text updated via JS -->
                                <i class="fas fa-shield-alt mr-2"></i> 
                                <span id="warranty-text"></span>
                            </p>
                            <!-- END NEW: Warranty Display -->
                            <div class="flex items-center text-sm my-1">
                                <div id="product-rating-details" class="text-sm mr-1"></div>
                                <div id="product-stars-details" class="flex items-center"></div>
                                <div id="product-rating-count-details" class="text-xs text-gray-500 ml-2"></div>
                            </div>
                            <div id="product-price-details" class="flex items-center space-x-2"></div>
                            <!-- Stock indicator -->
                            <p id="product-stock-details" class="text-sm font-medium"></p>
                            
                            <!-- Variants: Size, Storage, Color -->
                            <div id="product-options" class="space-y-4">
                                <div id="size-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="size">সাইজ:</label>
                                    <div class="flex flex-wrap gap-2" id="size-variants-container"></div>
                                </div>
                                <div id="storage-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="storage">স্টোরেজ:</label>
                                    <div class="flex flex-wrap gap-2" id="storage-variants-container"></div>
                                </div>
                                <div id="color-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="color">রঙ:</label>
                                    <div class="flex flex-wrap gap-2" id="color-variants-container"></div>
                                </div>
                            </div>
                            
                            <!-- Return policy and secure payments -->
                            <div id="product-info-details" class="space-y-2 text-gray-600">
                                <!-- Details will be rendered here dynamically -->
                            </div>

                            <div class="mt-6 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="add-to-cart-details" class="add-to-cart w-full bg-theme-blue text-white text-xs md:text-sm py-1.5 px-3 md:py-2 md:px-4 rounded-full hover:bg-theme-purple transition-colors shadow" data-lang="add-to-cart">কার্টে যোগ করুন</button>
                                    <button class="buy-now w-full bg-white border border-theme-blue text-theme-blue text-xs md:text-sm py-1.5 px-3 md:py-2 md:px-4 rounded-full hover:bg-gray-100 transition-colors shadow" data-lang="buy-now">এখনই কিনুন</button>
                                </div>
                                <button id="wishlist-details" class="wishlist text-gray-400 hover:text-theme-pink text-3xl transition-colors self-start"><i class="far fa-heart"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-description">পণ্যের বিবরণ</h3>
                        <p id="product-full-description" class="text-gray-700 dark:text-gray-300 leading-relaxed mt-4"></p>
                    </div>
                    
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-specifications">পণ্যের স্পেসিফিকেশন</h3>
                        <div id="product-specifications" class="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl mt-4"></div>
                    </div>

                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-reviews">পণ্যের রিভিউ</h3>
                        <div id="product-reviews" class="space-y-4 mt-4"></div>
                        
                        <!-- NEW: Review Submission Form -->
                        <div class="mt-8 p-6 bg-gray-100 dark:bg-gray-700 rounded-xl shadow-inner">
                            <h4 class="text-xl font-bold text-theme-blue mb-4" data-lang="write-a-review">একটি রিভিউ দিন</h4>
                            <form id="review-form">
                                <input type="hidden" id="review-product-id" name="productId">
                                <div id="review-login-prompt" class="text-center p-4 border border-red-300 bg-red-50 text-red-700 rounded-lg hidden">
                                    <p data-lang="review-login-prompt">অনুগ্রহ করে লগইন করুন রিভিউ দেওয়ার জন্য।</p>
                                </div>
                                <div id="review-controls">
                                    <div class="mb-4">
                                        <label class="block text-sm font-semibold mb-2" data-lang="your-rating">আপনার রেটিং:</label>
                                        <div id="rating-stars" class="flex text-2xl space-x-1">
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="1"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="2"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="3"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="4"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="5"></i>
                                            <input type="hidden" id="review-rating" name="rating" required="" value="0">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="review-comment" class="block text-sm font-semibold mb-2" data-lang="your-comment">আপনার মন্তব্য:</label>
                                        <textarea id="review-comment" name="comment" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-800" required=""></textarea>
                                    </div>
                                    <button type="submit" id="submit-review-btn" class="bg-theme-pink text-white py-2 px-6 rounded-full font-bold hover:bg-theme-purple transition-colors" data-lang="submit-review">রিভিউ জমা দিন</button>
                                </div>
                            </form>
                        </div>
                        <!-- END NEW: Review Submission Form -->
                    </div>

                    <!-- Related Products Section -->
                    <div id="related-products-section" class="mt-16 hidden">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">Related Products</h3>
                        <div id="related-product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Wishlist Page -->
        <div id="wishlist-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="your-wishlist">আপনার উইশলিস্ট</h2>
                <div id="wishlist-items" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8">
                    <!-- Wishlist items will be dynamically inserted here -->
                </div>
            </section>
        </div>
        
        <!-- My Orders Page -->
        <div id="my-orders-page" class="hidden page">
             <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="my-orders">My Orders</h2>
                <div id="orders-list" class="space-y-8">
                    <!-- Orders will be dynamically inserted here -->
                </div>
             </section>
        </div>
        
        <!-- Emergency Chat Page -->
        <div id="emergency-chat-page" class="hidden page">
            <section class="container mx-auto px-4 py-4 md:py-16">
                <div class="bg-white dark:bg-gray-800 p-6 pb-[env(safe-area-inset-bottom)] rounded-3xl shadow-xl max-w-2xl mx-auto flex flex-col min-h-0 h-[80dvh] md:h-[70vh]">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 class="text-2xl font-bold text-theme-purple">জরুরী যোগাযোগ</h2>
                        <button onclick="showPage('home-page')" class="text-theme-blue hover:text-theme-pink transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Chat Messages Container -->
                    <div id="chat-messages" class="min-h-0 flex-grow overflow-y-auto space-y-4 p-4 mb-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-center text-gray-500">Loading chat...</p>
                    </div>
                    
                    <!-- Chat Input Form -->
                    <form id="chat-form" class="flex space-x-3">
                        <input type="text" id="chat-input" placeholder="আপনার বার্তা লিখুন..." class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700" required="">
                        <button type="submit" id="send-chat-btn" class="bg-theme-blue text-white w-12 h-12 rounded-full hover:bg-theme-purple transition-colors shadow-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <p id="chat-error" class="text-red-500 text-xs mt-2"></p>
                </div>
            </section>
        </div>


        <!-- FAQ Page -->
        <div id="faq-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">সচরাচর জিজ্ঞাসিত প্রশ্নাবলী (FAQ)</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমি কীভাবে অর্ডার করব?</h3>
                        <p class="text-gray-700 dark:text-gray-300">আপনার পছন্দের পণ্যটি নির্বাচন করুন, 'কার্টে যোগ করুন' বাটনে ক্লিক করুন এবং আপনার অর্ডারটি সম্পন্ন করতে চেকআউট প্রক্রিয়া অনুসরণ করুন।</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">ডেলিভারি হতে কত সময় লাগে?</h3>
                        <p class="text-gray-700 dark:text-gray-300">সাধারণত আমরা ২-৩ কার্যদিবসের মধ্যে ডেলিভারি সম্পন্ন করি। তবে, নির্দিষ্ট এলাকার উপর ভিত্তি করে কিছুটা সময় বেশিও লাগতে পারে।</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমি কি ক্যাশ অন ডেলিভারি (COD) পেমেন্ট করতে পারব?</h3>
                        <p class="text-gray-700 dark:text-gray-300">হ্যাঁ, আমরা ক্যাশ অন ডেলিভারি (COD) এবং অনলাইন পেমেন্ট উভয়ই গ্রহণ করি।</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমার অর্ডার ট্র্যাক করার উপায় কী?</h3>
                        <p class="text-gray-700 dark:text-gray-300">আপনার অর্ডার নিশ্চিত হলে, আমরা আপনাকে একটি ট্র্যাকিং নম্বর সহ একটি ইমেল পাঠাব। আপনি আমাদের ওয়েবসাইটে সেই ট্র্যাকিং নম্বর ব্যবহার করে আপনার অর্ডার ট্র্যাক করতে পারবেন।</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Return Policy Page -->
        <div id="return-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">রিটার্ন নীতি</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        যদি আপনি আপনার কেনা পণ্যে অসন্তুষ্ট হন, তবে আপনি ডেলিভারির ৩০ দিনের মধ্যে এটি ফেরত দিতে পারবেন। পণ্যটি অব্যবহৃত এবং এর মূল প্যাকেজিংয়ে থাকতে হবে।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">ফেরতের প্রক্রিয়া:</h3>
                    <ol class="list-decimal list-inside text-gray-700 dark:text-gray-300 space-y-2">
                        <li>গ্রাহক সেবার সাথে যোগাযোগ করুন এবং ফেরতের কারণ জানান।</li>
                        <li>আমাদের দল আপনার অনুরোধ পর্যালোচনা করবে এবং একটি রিটার্ন নম্বর প্রদান করবে।</li>
                        <li>নির্ধারিত ঠিকানায় পণ্যটি সঠিকভাবে প্যাকিং করে ফেরত পাঠান।</li>
                        <li>পণ্যটি আমাদের হাতে পৌঁছানোর পর, আমরা আপনার টাকা ফেরত দেওয়ার প্রক্রিয়া শুরু করব।</li>
                    </ol>
                </div>
            </section>
        </div>

        <!-- Shipping Info Page -->
        <div id="shipping-info-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">শিপিং তথ্য</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <h3 class="text-xl font-bold text-theme-purple">ডেলিভারি সময়:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        শহরের মধ্যে: ২-৩ কার্যদিবস <br>
                        শহরের বাইরে: ৫-৭ কার্যদিবস
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">শিপিং খরচ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ডেলিভারি খরচ আপনার এলাকার উপর নির্ভর করে ভিন্ন হতে পারে। অর্ডার করার সময় চেকআউট পেজে সঠিক খরচ দেখতে পাবেন।
                    </p>
                </div>
            </section>
        </div>

        <!-- Privacy Policy Page -->
        <div id="privacy-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">গোপনীয়তা নীতি</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz আপনার ব্যক্তিগত তথ্যের গোপনীয়তা রক্ষা করতে প্রতিশ্রুতিবদ্ধ। আমরা আপনার ব্যক্তিগত তথ্য শুধুমাত্র আপনার অর্ডার প্রক্রিয়া করা এবং আমাদের পরিষেবা উন্নত করার জন্য ব্যবহার করি।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">তথ্য সংগ্রহ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আমরা আপনার নাম, ঠিকানা, ইমেল এবং ফোন নম্বর সংগ্রহ করি যখন আপনি একটি অ্যাকাউন্ট তৈরি করেন বা একটি অর্ডার দেন।
                    </p>
                </div>
            </section>
        </div>

        <!-- Terms and Conditions Page -->
        <div id="terms-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">শর্তাবলী</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz ব্যবহার করে, আপনি নিম্নলিখিত শর্তাবলীতে সম্মত হন।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">অ্যাকাউন্ট ব্যবহার:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আপনার অ্যাকাউন্টের তথ্যের গোপনীয়তা রক্ষা করার জন্য আপনি সম্পূর্ণরূপে দায়ী।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">পণ্যের বিবরণ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আমরা ওয়েবসাইটে পণ্যের সঠিক বিবরণ সরবরাহ করার চেষ্টা করি। তবে, কোনো ভুল বা অমিল হলে আমরা তার জন্য দায়ী থাকব না।
                    </p>
                </div>
            </section>
        </div>

        <!-- Support Page -->
        <div id="support-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="max-w-3xl mx-auto text-center mb-12">
                    <h2 class="text-3xl sm:text-4xl font-bold text-theme-purple" data-lang="support-title">Get Support</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Live Chat Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-blue text-white flex items-center justify-center mb-4">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-live-chat">Live Chat</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-live-chat-desc">তাৎক্ষণিক সাপোর্টের জন্য</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-live-chat-hours">সময়: সকাল ১০টা - রাত ৮টা</p>
                        <button onclick="showPage('emergency-chat-page')" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-pink text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-start-chat">Start Chat</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <!-- Email Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-purple text-white flex items-center justify-center mb-4">
                            <i class="fas fa-envelope-open-text"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-email">Email Support</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-email-desc">বিস্তারিত সমস্যা বা অভিযোগের জন্য</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-email-sla">রিপ্লাইয়ের সময়: ২৪ ঘণ্টার মধ্যে</p>
                        <a href="mailto:tangailbuzz.bd@gmail.com" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-blue text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-send-email">Send Email</span>
                            <i class="fas fa-paper-plane"></i>
                        </a>
                    </div>

                    <!-- Phone Call Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-pink text-white flex items-center justify-center mb-4">
                            <i class="fas fa-phone-volume"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-phone">Phone Call</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-phone-desc">শুধুমাত্র জরুরি পেমেন্ট বা অর্ডার সংক্রান্ত সমস্যার জন্য</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-phone-hours">সময়: সকাল ১০টা - সন্ধ্যা ৬টা</p>
                        <a href="tel:+8801863205976" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-blue text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-call-now">Call Now</span>
                            <i class="fas fa-phone"></i>
                        </a>
                    </div>
                </div>
            </section>
        </div>


    <!-- Footer -->
    <footer class="bg-dark text-white py-12 flex-shrink-0">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <!-- Column 1 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">TangailBuzz</h3>
                    <p class="text-gray-400 text-sm" data-lang="footer-tagline">সাশ্রয়ী মূল্যে মানসম্মত পণ্যের জন্য আপনার বিশ্বস্ত অনলাইন কেনাকাটার গন্তব্য।</p>
                    <div class="flex gap-4 mt-4">
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <!-- Column 2 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="footer-important-links">গুরুত্বপূর্ণ লিঙ্ক</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-home">হোম</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('products')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-products">Products</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('categories')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-categories">Categories</a></li>
                        <li><a href="javascript:void(0);" onclick="showOffers()" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-offers">Offers</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('about-us-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-about">About Us</a></li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="footer-col-customer-service">Customer Service</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="showPage('faq-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-faq">FAQ</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('return-policy-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-return-policy">Return Policy</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('shipping-info-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-shipping-info">Shipping Info</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('privacy-policy-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-privacy-policy">Privacy Policy</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('terms-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-terms">Terms &amp; Conditions</a></li>
                    </ul>
                </div>

                <!-- Column 4 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="footer-col-contact">Contact Us</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                         <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-theme-pink"></i>
                            <a href="https://www.google.com/maps/search/?api=1&amp;query=Tangail+Sadar" target="_blank" rel="noopener noreferrer" class="hover:text-theme-pink transition-colors">tangail sadar, tangail</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-2 text-theme-pink"></i>
                            <a href="tel:+8801863205976" class="hover:text-theme-pink transition-colors">+8801863205976</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-theme-pink"></i>
                            <a href="mailto:tangailbuzz.bd@gmail.com" class="hover:text-theme-pink transition-colors">tangailbuzz.bd@gmail.com</a>
                        </li>
                    </ul>
                </div>
            </div>

             <div class="mt-8 pt-8 border-t border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-center" data-lang="footer-we-accept">We Accept</h3>
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/unnamed.webp?raw=true" alt="bKash" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/nagad.jpg?raw=true" alt="Nagad" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/rocket.png?raw=true" alt="Rocket" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/surecash.png?raw=true" alt="SureCash" class="h-8 object-contain">
                </div>
            </div>

             <div class="text-center pt-8 border-t border-gray-700 mt-8">
                <p class="text-gray-400 text-xs" data-lang="footer-copyright">© 2024 TangailBuzz. All rights reserved.</p>
             </div>
        </div>
    </footer>

    <nav id="mobile-footer-nav" class="md:hidden fixed bottom-0 left-0 right-0 z-30 bg-white/95 dark:bg-gray-900/95 backdrop-blur border-t border-gray-200 dark:border-gray-700 shadow-xl">
        <div class="grid grid-cols-4">
            <button id="mobile-nav-home" type="button" data-mobile-nav="home" class="mobile-nav-btn flex flex-col items-center justify-center gap-1 py-2 text-xs font-semibold text-gray-500 transition-colors" data-lang-aria-label="home" aria-label="Home" aria-pressed="true">
                <i class="fas fa-home text-lg"></i>
                <span data-lang="home">হোম</span>
            </button>
            <button id="mobile-nav-categories" type="button" data-mobile-nav="categories" class="mobile-nav-btn flex flex-col items-center justify-center gap-1 py-2 text-xs font-semibold text-gray-500 transition-colors" data-lang-aria-label="categories" aria-label="Categories" aria-pressed="false">
                <i class="fas fa-th-large text-lg"></i>
                <span data-lang="categories">ক্যাটাগরি</span>
            </button>
            <button id="mobile-nav-cart" type="button" data-mobile-nav="cart" class="mobile-nav-btn relative flex flex-col items-center justify-center gap-1 py-2 text-xs font-semibold text-gray-500 transition-colors" data-lang-aria-label="cart" aria-label="Cart" aria-pressed="false">
                <i class="fas fa-shopping-cart text-lg"></i>
                <span id="mobile-cart-count" class="absolute -top-1 -right-3 bg-theme-pink text-white text-[10px] font-bold w-4 h-4 rounded-full flex items-center justify-center hidden">0</span>
                <span data-lang="cart-short">কার্ট</span>
            </button>
            <button id="mobile-nav-profile" type="button" data-mobile-nav="profile" class="mobile-nav-btn flex flex-col items-center justify-center gap-1 py-2 text-xs font-semibold text-gray-500 transition-colors" data-lang-aria-label="account" aria-label="Account" aria-pressed="false">
                <i class="fas fa-user-circle text-lg"></i>
                <span data-lang="profile">প্রোফাইল</span>
            </button>
        </div>
    </nav>

    </main> <!-- End Main Content Container -->

    <!-- Firebase SDK Scripts (Modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, FacebookAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, deleteUser, signInWithCustomToken, signInAnonymously, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider, reauthenticateWithPopup, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, updateDoc, increment, deleteField, collection, addDoc, serverTimestamp, getDocs, writeBatch, runTransaction, query, where, arrayUnion, orderBy, limit, FieldPath } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
    // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBIRNr3X-_xOHQ6ITW3pXgqgcjhP2xEEEA",
            authDomain: "tangailbuzz47.firebaseapp.com",
            projectId: "tangailbuzz47",
            storageBucket: "tangailbuzz47.firebasestorage.app",
            messagingSenderId: "1017968115713",
            appId: "1:1017968115713:web:967a0e13107d8816b44000",
            measurementId: "G-7HYDCZTN2H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

    let currentUser = null;
        let currentUserData = null; // To hold Firestore data for the user
        let userOrders = [];
        let userDocUnsubscribe = () => {};
    // Language preference configuration
    const SUPPORTED_LANGUAGES = ['en', 'bn'];
        const DEFAULT_LANGUAGE = 'bn';
        const LANGUAGE_STORAGE_KEY = 'tb_language';
        let currentLanguage = DEFAULT_LANGUAGE;
        try {
            const storedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY) || localStorage.getItem('lang');
            if (storedLanguage && SUPPORTED_LANGUAGES.includes(storedLanguage)) {
                currentLanguage = storedLanguage;
            }
        } catch (error) {
            console.warn('Language preference load failed:', error);
        }
        const LANGUAGE_FLAG_ASSETS = {
            bn: { src: 'https://flagcdn.com/w40/bd.png', alt: 'Bangladesh Flag' },
            en: { src: 'https://flagcdn.com/w40/gb.png', alt: 'United Kingdom Flag' }
        };
        function applyLanguageAttributes(lang) {
            const html = document.documentElement;
            const normalized = SUPPORTED_LANGUAGES.includes(lang) ? lang : DEFAULT_LANGUAGE;
            html.setAttribute('lang', normalized === 'bn' ? 'bn' : 'en');
            html.classList.toggle('lang-bn', normalized === 'bn');
            html.classList.toggle('lang-en', normalized === 'en');
        }
        applyLanguageAttributes(currentLanguage);
        let localCartCache = new Map();
        let localWishlistCache = new Set();
    let productsData = []; // Will be populated from Firestore
    const flashSaleCountdowns = new Map();
    let flashSaleIntervalId = null;
    let productDetailsFlashTimerId = null;
    let productsUnsubscribe = () => {};

    const FLASH_FLAG_KEYS = ['flashSale', 'flash_sale', 'flashsell', 'flashSell', 'flash_selling', 'flash_sale_enabled', 'flashSaleEnabled'];
    const FLASH_PRICE_KEYS = ['flashPrice', 'flash_price', 'flashsale_price', 'flashSalePrice'];
    const FLASH_START_KEYS = ['flashStart', 'flash_start', 'flashSaleStart', 'flashsale_start', 'flashSaleStartTime'];
    const FLASH_END_KEYS = ['flashEnd', 'flash_end', 'flashSaleEnd', 'flashsale_end', 'flashSaleEndTime'];
    const FLASH_DURATION_KEYS = ['flashDurationHours', 'flash_duration_hours', 'flashLengthHours', 'flash_sale_duration'];
    const REGULAR_PRICE_KEYS = ['mainPrice', 'mainprice', 'price', 'regularPrice', 'regular_price', 'mrp', 'basePrice', 'base_price', 'sellingPrice', 'selling_price'];
    const OFFER_PRICE_KEYS = ['offerPrice', 'offerprice', 'salePrice', 'sale_price', 'discountPrice', 'discount_price', 'specialPrice', 'special_price'];
    const OFFER_FLAG_KEYS = ['isOnOffer', 'isonoffer', 'offer', 'hasOffer', 'isOffer', 'offerActive', 'discountActive'];
    const MEGA_FLAG_KEYS = ['megaSale', 'mega_sale', 'megaSell', 'mega_sell', 'megaDeal', 'mega_deal', 'megaSaleEnabled', 'mega_sale_enabled', 'megaOffer'];
    const MEGA_LABEL_KEYS = ['megaSaleLabel', 'mega_sale_label', 'megaLabel', 'mega_label', 'megaSellLabel'];
    const MEGA_DISCOUNT_THRESHOLD = 25; // Percentage fallback when no explicit flag present

    const getNormalizedString = (value) => {
        if (value === undefined || value === null) return '';
        if (typeof value === 'string') return value.trim();
        if (typeof value === 'number' && Number.isFinite(value)) return String(value);
        return '';
    };

    const resolveBooleanField = (obj, keys) => {
        for (const key of keys) {
            const candidate = obj?.[key];
            if (typeof candidate === 'boolean') return candidate;
            if (typeof candidate === 'number') return candidate === 1;
            if (typeof candidate === 'string') {
                const normalized = candidate.trim().toLowerCase();
                if (['true', '1', 'yes', 'on', 'enabled'].includes(normalized)) return true;
                if (['false', '0', 'no', 'off', 'disabled'].includes(normalized)) return false;
            }
        }
        return false;
    };

    const resolveBooleanFieldDetailed = (obj, keys) => {
        for (const key of keys) {
            const candidate = obj?.[key];
            if (typeof candidate === 'boolean') {
                return { value: candidate, explicit: true };
            }
            if (typeof candidate === 'number' && Number.isFinite(candidate)) {
                return { value: candidate === 1, explicit: true };
            }
            if (typeof candidate === 'string') {
                const normalized = candidate.trim().toLowerCase();
                if (['true', '1', 'yes', 'on', 'enabled', 'enable', 'active'].includes(normalized)) {
                    return { value: true, explicit: true };
                }
                if (['false', '0', 'no', 'off', 'disabled', 'disable', 'inactive'].includes(normalized)) {
                    return { value: false, explicit: true };
                }
            }
        }
        return { value: false, explicit: false };
    };

    const resolveNumberField = (obj, keys) => {
        for (const key of keys) {
            const candidate = obj?.[key];
            if (candidate === undefined || candidate === null) continue;
            const parsed = Number(candidate);
            if (!Number.isNaN(parsed)) {
                return parsed;
            }
            if (typeof candidate === 'string') {
                const sanitized = candidate.replace(/[^0-9.,-]/g, '').replace(/,/g, '');
                if (sanitized) {
                    const fallbackParsed = Number(sanitized);
                    if (!Number.isNaN(fallbackParsed)) {
                        return fallbackParsed;
                    }
                }
            }
        }
        return null;
    };

    const getFirstAvailableValue = (obj, keys) => {
        for (const key of keys) {
            if (obj && Object.prototype.hasOwnProperty.call(obj, key)) {
                return obj[key];
            }
        }
        return null;
    };

    const parseFirestoreDate = (input) => {
        if (!input) return null;
        if (input instanceof Date) return new Date(input.getTime());
        if (typeof input?.toDate === 'function') {
            try {
                return input.toDate();
            } catch (_) {
                return null;
            }
        }
        if (typeof input === 'number' && Number.isFinite(input)) {
            return new Date(input);
        }
        if (typeof input === 'string') {
            const trimmed = input.trim();
            if (!trimmed) return null;
            const numeric = Number(trimmed);
            if (!Number.isNaN(numeric) && trimmed.length <= 13) {
                return new Date(numeric);
            }
            const parsed = Date.parse(trimmed);
            if (!Number.isNaN(parsed)) {
                return new Date(parsed);
            }
        }
        if (typeof input === 'object' && typeof input.seconds === 'number') {
            const ms = input.seconds * 1000 + (input.nanoseconds || 0) / 1e6;
            return new Date(ms);
        }
        return null;
    };

    const formatCountdown = (ms) => {
        if (!Number.isFinite(ms) || ms <= 0) {
            return '00:00:00';
        }
        const totalSeconds = Math.floor(ms / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        const pad = (value) => String(Math.max(0, value)).padStart(2, '0');
        if (days > 0) {
            return `${days}d ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }
        const totalHours = Math.floor(totalSeconds / 3600);
        return `${pad(totalHours)}:${pad(minutes)}:${pad(seconds)}`;
    };

    const escapeHtml = (input) => {
        if (input === undefined || input === null) return '';
        return String(input)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    };

    function clearProductDetailsFlashTimer() {
        if (productDetailsFlashTimerId) {
            clearInterval(productDetailsFlashTimerId);
            productDetailsFlashTimerId = null;
        }
    }
    
    // --- Presence: Live visitor heartbeat (for Admin dashboard live view) ---
    try {
        const getTabSessionId = () => {
            let sid = sessionStorage.getItem('tb_tab_id');
            if (!sid) {
                sid = (self.crypto?.randomUUID?.() || Math.random().toString(36).slice(2)) + '-' + Date.now();
                sessionStorage.setItem('tb_tab_id', sid);
            }
            return sid;
        };
        const presenceSessionId = getTabSessionId();
        const presenceRef = doc(collection(db, 'presence'), presenceSessionId);
        let presenceAnonAttempted = false;

        const detectPresenceDeviceInfo = () => {
            const ua = navigator.userAgent || '';
            const uaData = navigator.userAgentData;
            const platform = uaData?.platform || navigator.platform || '';
            let deviceType = 'Desktop';
            if (/iPad|Tablet/i.test(ua)) {
                deviceType = 'Tablet';
            } else if (/Mobi|Android/i.test(ua)) {
                deviceType = 'Mobile';
            }

            const browser = (() => {
                if (/edg/i.test(ua)) return 'Microsoft Edge';
                if (/chrome|crios/i.test(ua) && !/edg/i.test(ua)) return 'Google Chrome';
                if (/safari/i.test(ua) && !/chrome|crios/i.test(ua)) return 'Apple Safari';
                if (/firefox|fxios/i.test(ua)) return 'Mozilla Firefox';
                return uaData?.brands?.[0]?.brand || 'Unknown Browser';
            })();

            const os = (() => {
                if (/windows nt 10/i.test(ua)) return 'Windows 10/11';
                if (/windows nt 6\.3/i.test(ua)) return 'Windows 8.1';
                if (/windows nt 6\.2/i.test(ua)) return 'Windows 8';
                if (/windows nt 6\.1/i.test(ua)) return 'Windows 7';
                if (/mac os x 10[._]15/i.test(ua)) return 'macOS Catalina';
                if (/mac os x/i.test(ua)) return 'macOS';
                if (/iphone|ipad|ipod/i.test(ua)) return 'iOS';
                if (/android/i.test(ua)) return 'Android';
                if (/linux/i.test(ua)) return 'Linux';
                return platform || 'Unknown OS';
            })();

            const brand = uaData?.brands?.find(b => b?.brand && b.brand !== 'Not A(Brand)')?.brand || null;
            const labelParts = [];
            if (deviceType && deviceType !== 'Desktop') labelParts.push(deviceType);
            if (os) labelParts.push(os);
            if (browser) labelParts.push(browser);

            return {
                userAgent: ua,
                platform,
                brand,
                deviceType,
                browser,
                os,
                label: labelParts.join(' | ') || ua,
                language: navigator.language || null
            };
        };

        const presenceDeviceInfo = detectPresenceDeviceInfo();
        let presenceLocationData = null;
        let presenceLocationFetchPromise = null;
        let presenceLocationLastAttempt = 0;

        const sanitizeLocationValue = (value) => {
            if (value === undefined || value === null) return null;
            if (typeof value === 'number') {
                return Number.isFinite(value) ? value : null;
            }
            if (typeof value === 'string') {
                const trimmed = value.trim();
                return trimmed === '' ? null : trimmed;
            }
            return null;
        };

        const normalizePresenceLocation = (raw) => {
            if (!raw || typeof raw !== 'object') return null;
            const normalized = {};

            const assignString = (key, ...candidates) => {
                for (const candidate of candidates) {
                    const value = sanitizeLocationValue(candidate);
                    if (typeof value === 'string') {
                        normalized[key] = value;
                        return;
                    }
                }
            };

            const assignNumber = (key, ...candidates) => {
                for (const candidate of candidates) {
                    const value = sanitizeLocationValue(candidate);
                    if (typeof value === 'number') {
                        normalized[key] = value;
                        return;
                    }
                    if (typeof value === 'string') {
                        const parsed = Number(value);
                        if (!Number.isNaN(parsed)) {
                            normalized[key] = parsed;
                            return;
                        }
                    }
                }
            };

            assignString('ip', raw.ip, raw.ipAddress, raw.query, raw.IPv4, raw.ipv4, raw.ipv6, raw.IPv6);
            assignString('city', raw.city, raw.city_name, raw.cityName);
            assignString('region', raw.region, raw.region_name, raw.regionName, raw.state, raw.state_name, raw.stateProv, raw.state_prov, raw.prov, raw.province);
            assignString('country', raw.country_name, raw.country, raw.countryName, raw.country_long);
            assignString('timezone', raw.timezone, raw.timezone_name, raw.time_zone?.name, raw.time_zone_name, raw.timezone_abbr);
            assignString('org', raw.org, raw.asn, raw.asn_org, raw.connection?.isp, raw.isp, raw.org_name, raw.company, raw.isp_name);
            assignNumber('latitude', raw.latitude, raw.lat, raw.lat_decimal);
            assignNumber('longitude', raw.longitude, raw.lon, raw.lng, raw.lon_decimal);

            const locationParts = [normalized.city, normalized.region, normalized.country].filter(Boolean);
            if (locationParts.length > 0) {
                normalized.display = locationParts.join(', ');
            } else if (normalized.country) {
                normalized.display = normalized.country;
            }

            if (Object.keys(normalized).length === 0) {
                return null;
            }
            return normalized;
        };

        const fetchJsonWithTimeout = async (url, options = {}, timeoutMs = 5000) => {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const response = await fetch(url, { cache: 'no-store', ...options, signal: controller.signal });
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }
                return await response.json();
            } finally {
                clearTimeout(id);
            }
        };

        const fetchPresenceLocation = async (force = false) => {
            const hasGoodLocation = Boolean(
                presenceLocationData &&
                presenceLocationData.ip &&
                (presenceLocationData.display || presenceLocationData.city || presenceLocationData.region || presenceLocationData.country)
            );

            if (!force && hasGoodLocation) {
                return presenceLocationData;
            }
            if (!force && presenceLocationFetchPromise) {
                return presenceLocationFetchPromise;
            }

            const now = Date.now();
            if (!force && presenceLocationLastAttempt && now - presenceLocationLastAttempt < 15000) {
                return presenceLocationData;
            }
            presenceLocationLastAttempt = now;

            const providers = [
                async () => {
                    const payload = await fetchJsonWithTimeout('https://ipapi.co/json/', { headers: { 'Accept': 'application/json' } });
                    if (!payload || payload.error) return null;
                    return normalizePresenceLocation(payload);
                },
                async () => {
                    const payload = await fetchJsonWithTimeout('https://ipwho.is/', { headers: { 'Accept': 'application/json' } });
                    if (payload && payload.success === false) return null;
                    return normalizePresenceLocation(payload);
                },
                async () => {
                    const payload = await fetchJsonWithTimeout('https://geolocation-db.com/json/', { headers: { 'Accept': 'application/json' } });
                    return normalizePresenceLocation(payload);
                },
                async () => {
                    const payload = await fetchJsonWithTimeout('https://ipwhois.app/json/', { headers: { 'Accept': 'application/json' } });
                    if (payload && payload.success === false) return null;
                    return normalizePresenceLocation(payload);
                },
                async () => {
                    const payload = await fetchJsonWithTimeout('https://freeipapi.com/api/json', { headers: { 'Accept': 'application/json' } });
                    return normalizePresenceLocation(payload);
                },
                async () => {
                    const payload = await fetchJsonWithTimeout('https://api.ipify.org?format=json', { headers: { 'Accept': 'application/json' } });
                    return normalizePresenceLocation(payload);
                }
            ];

            const runProviders = async () => {
                for (const provider of providers) {
                    try {
                        const result = await provider();
                        if (result) {
                            presenceLocationData = result;
                            return result;
                        }
                    } catch (err) {
                        console.warn('Presence geo provider failed', err);
                    }
                }
                return presenceLocationData;
            };

            if (force) {
                return runProviders();
            }

            presenceLocationFetchPromise = runProviders();
            try {
                return await presenceLocationFetchPromise;
            } finally {
                presenceLocationFetchPromise = null;
            }
        };
        const ensurePresenceAuth = async () => {
            if (auth.currentUser || presenceAnonAttempted) {
                return;
            }
            presenceAnonAttempted = true;
            try {
                await signInAnonymously(auth);
            } catch (err) {
                presenceAnonAttempted = false;
                console.warn('Anonymous sign-in for presence failed', err);
                throw err;
            }
        };

        const sendPresence = async (initial = false) => {
            try {
                const payload = {
                    sessionId: presenceSessionId,
                    uid: auth.currentUser?.uid || null,
                    isLoggedIn: !!auth.currentUser,
                    userAgent: navigator.userAgent,
                    path: location.pathname + location.search + location.hash,
                    referrer: document.referrer || null,
                    lastActive: serverTimestamp(),
                    ...(initial ? { startedAt: serverTimestamp() } : {})
                };

                if (presenceDeviceInfo) {
                    payload.device = presenceDeviceInfo;
                }

                let locationPayload = presenceLocationData;
                const hasDetails = Boolean(locationPayload && (locationPayload.display || locationPayload.city || locationPayload.region || locationPayload.country));
                const needsRefresh = !locationPayload || !locationPayload.ip || !hasDetails;
                if (needsRefresh) {
                    try {
                        locationPayload = await fetchPresenceLocation();
                    } catch (err) {
                        console.warn('Presence location fetch failed', err);
                    }
                } else {
                    // Keep the cached location warm without blocking the heartbeat.
                    fetchPresenceLocation().catch(() => {});
                }

                if (locationPayload) {
                    presenceLocationData = locationPayload;
                    payload.location = locationPayload;
                    if (locationPayload.ip) {
                        payload.ip = locationPayload.ip;
                        payload.ipAddress = locationPayload.ip;
                    }
                }

                await setDoc(presenceRef, payload, { merge: true });
            } catch (e) {
                if (e?.code === 'permission-denied') {
                    try {
                        await ensurePresenceAuth();
                        return sendPresence(initial);
                    } catch (_) {
                        // fall through to warn user if anonymous sign-in also fails
                    }
                }
                console.warn('Presence heartbeat failed', e);
            }
        };

        // Initial ping
    ensurePresenceAuth().catch(() => {}).finally(() => { sendPresence(true); });

        // Refresh on auth changes
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                ensurePresenceAuth().catch(() => {});
            }
            sendPresence(false);
        });

        // Heartbeat while visible
    let hbId = null;
    const startHB = () => { if (hbId) clearInterval(hbId); hbId = setInterval(() => sendPresence(false), 10000); };
        const stopHB = () => { if (hbId) { clearInterval(hbId); hbId = null; } };
        if (document.visibilityState === 'visible') startHB();
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') { sendPresence(false); startHB(); }
            else { sendPresence(false); stopHB(); }
        });
        // On pagehide/blur try a final update
    window.addEventListener('pagehide', () => { sendPresence(false); stopHB(); clearFlashSaleTimerInterval(); });
    window.addEventListener('beforeunload', () => { sendPresence(false); stopHB(); clearFlashSaleTimerInterval(); });
    } catch (e) {
        console.warn('Presence setup failed', e);
    }
    let renderContext = null; // Controls render behavior for specific pages (e.g., 'wishlist')
        let currentDisplayedProducts = [];
        let selectedVariants = {};
        let discountAmount = 0;
        let appliedCouponCode = null;
        let currentAuthForm = 'login';
    let confirmResolver = null; // Used for the custom confirmation modal
        let chatUnsubscribe = () => {}; // For real-time chat updates
        let allCoupons = []; // Stores all active coupon data
        // Addresses & shipping selection
        let selectedShippingAddressId = null;
        let selectedShippingAddress = null;
    // Sorting & Filtering State
    let currentSortOption = 'popularity'; // 'price-asc' | 'price-desc' | 'popularity' | 'rating' | 'newest'
    let activeFilters = { brands: new Set(), priceMin: null, priceMax: null, sizes: new Set(), colors: new Set() };
    let lastBaseProducts = [];
        // --- Pagination State ---
        let currentPage = 1;           // current page index (1-based)
        const PAGE_SIZE = 30;          // items per page
        let lastRenderKey = '';        // to reset page when base set changes
        // --- End Pagination State ---
        
        // --- Category Tracking State ---
        let currentCategory = null; // Tracks current main category filter
        let currentSubCategory = null; // Tracks current sub category filter
    let mobileCategoriesActiveCategory = null; // Tracks currently focused main category in mobile drawer
        // --- End Category Tracking State ---
        
        // --- User Blocking Logic ---
        let isCurrentUserBlocked = false;
        let unsubscribeUserStatus = () => {};

        const translations = {
            en: {
                'deliver-to': 'Deliver to',
                'home': 'Home',
                'products': 'Products',
                'categories': 'Categories',
                'offers': 'Offers',
                'flash-sale-nav': 'Flash Sale',
                'mega-sale-nav': 'Mega Sale',
                'add-product-nav': 'Add Product',
                'search-placeholder': 'Search for products...', 'featured-products': 'Featured Products', 'shop-by-category': 'Shop by Category', 'cat-electronics': 'Electronics', 'cat-fashion': 'Fashion', 'cat-home-garden': 'Home & Garden', 'cat-health-beauty': 'Health & Beauty', 'cat-sports': 'Sports & Outdoors', 'cat-books': 'Books & Stationery', 'cat-kids': 'Kids & Toys', 'cat-cars': 'Cars & Bikes', 'why-choose-us': 'Why Choose Us', 'feature-delivery-title': 'Fast Delivery', 'feature-delivery-desc': 'We deliver to your doorstep within 2-3 business days.', 'feature-payment-title': 'Secure Payment', 'feature-payment-desc': 'All transactions are encrypted for your security and privacy.', 'feature-return-title': 'Easy Returns', 'feature-return-desc': 'Return products within 30 days for a full refund if you\'re not satisfied.', 'feature-support-title': '24/7 Support', 'feature-support-desc': 'Our customer support team is available for you day and night.', 'add-to-cart': 'Add to Cart', 'added-to-cart': 'Added!', 'no-products': 'No products found matching your criteria.', 'back-to-products': 'Back to All Products', 'returnable': '30-Day Returnable', 'not-returnable': 'Not Returnable', 'secure-payments': 'Secure Payments', 'size': 'Size:', 'storage': 'Storage:', 'color': 'Color:', 'product-description': 'Product Description', 'product-specifications': 'Product Specifications', 'specifications': 'Specification', 'value': 'Value', 'no-specs': 'No specifications available for this product.', 'product-reviews': 'Product Reviews', 'no-reviews': 'There are no reviews for this product yet.', 'cart': 'Your Cart', 'cart-empty': 'Your cart is empty.', 'total': 'Total:', 'checkout': 'Checkout', 'your-wishlist': 'Your Wishlist', 'wishlist-empty': 'Your wishlist is empty. Add some products!', 'your-account': 'Your Account', 'signin-google': 'Sign in with Google', 'logout': 'Logout', 'toast-cart-added': 'Product added to cart!', 'toast-wishlist-added': 'Product added to wishlist!', 'toast-wishlist-removed': 'Product removed from wishlist!', 'toast-login-success': 'Successfully logged in!', 'toast-logout-success': 'Successfully logged out!',
                'toast-register-success': 'Account created successfully!', 'login': 'Login', 'register': 'Register Account', 'auth-login-heading': 'Welcome Back', 'auth-register-heading': 'Create Your Account', 'auth-reset-heading': 'Reset Password', 'auth-login-subtitle': 'Sign in to manage your orders, wishlist, and saved addresses.', 'auth-register-subtitle': 'Create a free TangailBuzz account in minutes.', 'auth-reset-subtitle': 'Enter your email and we will send a secure reset link.', 'auth-login-tab': 'Log In', 'auth-register-tab': 'Sign Up', 'auth-reset-tab': 'Reset', 'auth-social-divider': 'Or Continue With', 'auth-security-note': 'Your credentials are encrypted and never shared.', 'auth-new-here': 'New Here?', 'auth-have-account': 'Already Have an Account?', 'create-account': 'Create Account', 'forgot-password': 'Forgot Password?', 'reset-password-desc': 'Enter your registered email so we can send a secure reset link.', 'send-reset-link': 'Send Reset Link', 'back-to-login': 'Back to Login', 'login-google': 'Sign In with Google', 'login-facebook': 'Sign In with Facebook', 'full-name': 'Full Name', 'mobile-number': 'Mobile Number', 'location': 'Location', 'upload-photo': 'Upload Photo', 'remove-photo': 'Remove Photo', 'save-changes': 'Save Changes', 'cancel': 'Cancel', 'account-options': 'Account Options', 'edit-profile': 'Edit Profile', 'manage-address': 'Manage Addresses', 'delete-account': 'Delete Account', 'saved-addresses': 'Saved Addresses', 'manage-address-help': 'Manage your delivery addresses.', 'address-form-title': 'Add New Address', 'address-line1': 'Address Line 1', 'address-line2-optional': 'Address Line 2 (Optional)', 'city': 'City', 'area-district': 'Area / District', 'set-as-default': 'Set as Default', 'save-address': 'Save Address', 'toast-select-variant': 'Please select all required options!', 'select-variants': 'Select Options', 'buy-now': 'Buy Now', 'payment-method': 'Select Payment Method', 'cod': 'Cash on Delivery', 'online-payment': 'Online Payment', 'confirm-order': 'Confirm Order', 'order-placed-success': 'Your order has been placed successfully!', 'order-placed-fail': 'Failed to place order. Please try again.', 'cart-is-empty': 'Your cart is empty. Cannot checkout.', 'mobile-banking': 'Mobile Banking', 'payment-instruction-bkash': 'Please send {amount} Taka to this Bkash number: +8801863205976 from your app.', 'payment-instruction-nagad': 'Please send {amount} Taka to this Nagad number: +8801863205976 from your app.', 'payment-instruction-cod': 'Our delivery person will collect the payment upon delivery.', 'profile-updated': 'Profile updated successfully!', 'profile-update-fail': 'Failed to update profile.', 'toast-storage-permission-error': 'Storage permission denied. Check Firebase rules.', 'toast-update-profile': 'Please update your location and mobile number in your profile before ordering.', 'emergency-contact': 'Support', 'message-sent': 'Message sent successfully!', 'out-of-stock': 'Out of Stock', 'toast-out-of-stock': 'Sorry, this product is currently out of stock.', 'subtotal': 'Subtotal', 'delivery-charge': 'Delivery Charge', 'my-orders': 'My Orders',
                'delete-account-confirm': 'Are you sure you want to delete your account? This action cannot be undone. All data will be lost.',
                'account-deleted': 'Your account has been successfully deleted.',
                'delete-account-failed': 'Failed to delete account. Please try again.',
                'confirm-delete-title': '⚠️ Permanently Delete Account',
                'chat-unauthorized': 'Please log in to start a conversation with the admin.',
                'chat-send': 'Send',
                'chat-placeholder': 'Type your message...',
                'toast-abusive-language': 'Abusive language is not allowed.',
                'account-blocked': 'Your account is blocked. You cannot place orders or send messages.',
                'account-blocked-banner': 'Your account has been blocked by an administrator. Please contact support.',
                'toast-account-blocked-action': 'Action failed: Your account is blocked.',
                'coupon-placeholder': 'Coupon Code', 'apply-coupon': 'Apply', 'discount': 'Discount', 'order-summary': 'Order Summary', 'total-inclusive-vat': 'Total (Inclusive of VAT)',
                'toast-coupon-applied': 'Coupon applied successfully!', 'toast-coupon-invalid': 'Invalid or expired coupon code.',
                'toast-coupon-used': 'You have already used this coupon.', 'toast-coupon-min-purchase': 'Minimum purchase of ৳{amount} required.',
                'warranty': '{text} Warranty', // Updated key for text string
                'no-warranty': 'No Warranty', // Updated key
                'model-id': 'Product ID: {id}', // FIX: Changed 'Model:' to 'Product ID:'
                'available-coupons': 'Available Coupons', 'min-spend': 'Min Spend', 'discount-value': 'Discount', 'tap-to-copy': 'Tap to Copy', 'copied': 'Copied!',
                'all-products': 'All Products',
                'all-categories': 'All Categories',
                'choose-subcategory': 'Choose a subcategory',
                'back-to-categories': 'Back to categories',
                'browse-everything': 'Browse everything in one place',
                'current-category-title': '{category}',
                'sub-category-filter': 'Filter by Sub-Category:',
                'write-a-review': 'Write a Review',
                'your-rating': 'Your Rating:',
                'your-comment': 'Your Comment:',
                'submit-review': 'Submit Review',
                'review-login-prompt': 'Please log in to submit a review.',
                'review-success': 'Review submitted successfully! Thank you.',
                'review-failed': 'Failed to submit review. Please try again.',
                // Category helpers
                'all-in-category': 'All in',
                // Footer
                'footer-tagline': 'Your trusted online shopping destination for quality products at fair prices.',
                'footer-important-links': 'Important Links',
                'footer-nav-home': 'Home',
                'footer-nav-products': 'Products',
                'footer-nav-categories': 'Categories',
                'footer-nav-offers': 'Offers',
                'footer-nav-about': 'About Us',
                'footer-col-customer-service': 'Customer Service',
                'footer-faq': 'FAQ',
                'footer-return-policy': 'Return Policy',
                'footer-shipping-info': 'Shipping Info',
                'footer-privacy-policy': 'Privacy Policy',
                'footer-terms': 'Terms & Conditions',
                'footer-col-contact': 'Contact Us',
                'footer-we-accept': 'We Accept',
                'footer-copyright': '© 2025 TangailBuzz. All rights reserved.',
                // Header short labels
                'dark-mode': 'Dark Mode',
                'profile': 'Profile',
                'wishlist': 'Wishlist',
                'cart-short': 'Cart',
                'remove': 'Remove',
                // Hero
                'hero-title': 'Find your style. Shop the buzz.',
                'hero-subtitle': 'Exclusive deals, fast delivery, and trusted products across electronics, fashion, and more.',
                'hero-cta-shop': 'Shop Now',
                'hero-cta-browse': 'Browse Categories',
                'hero-badge': 'Fresh arrivals daily',
                // Support page
                'support-title': 'Get Support',
                'support-live-chat': 'Live Chat',
                'support-live-chat-desc': 'For instant support',
                'support-live-chat-hours': 'Hours: 10:00 AM - 8:00 PM',
                'support-start-chat': 'Start Chat',
                'support-email': 'Email Support',
                'support-email-desc': 'For detailed issues or complaints',
                'support-email-sla': 'Response time: within 24 hours',
                'support-send-email': 'Send Email',
                'support-phone': 'Phone Call',
                'support-phone-desc': 'For urgent payment or order issues only',
                'support-phone-hours': 'Hours: 10:00 AM - 6:00 PM',
                'support-call-now': 'Call Now',
                'flash-sale-heading': 'Flash Sale',
                'flash-sale-subheading': 'Limited-time deals are counting down!',
                'flash-sale-empty': 'No flash deals right now. Check back soon!',
                'flash-sale-badge': 'FLASH',
                'flash-sale-upcoming': 'UPCOMING',
                'flash-sale-ended': 'Ended',
                'flash-sale-countdown-label': 'Ends in',
                'flash-sale-countdown-starts': 'Starts in',
                'flash-sale-coming-soon': 'Coming Soon',
                'mega-sale-heading': 'Mega Sale',
                'mega-sale-subheading': 'Handpicked blockbuster deals you can’t miss.',
                'mega-sale-empty': 'No mega deals right now. Check back again.',
                'mega-sale-badge': 'Mega Sale',
                'mega-sale-highlight': 'Curated Picks',
                'language-label': 'Language',
                'language-menu-heading': 'Choose Language',
                'language-english': 'English',
                'language-bangla': 'Bangla',
                'language-switch-toast': 'Language switched to {language}',
                'download-invoice': 'Download Invoice',
                'invoice-download-success': 'Invoice downloaded successfully!',
                'invoice-download-error': 'Unable to download invoice right now.',
                'invoice-missing-order': 'We could not find the order for this invoice.',
                'about-heading': 'About Us',
                'about-tagline-title': 'TangailBuzz: Your Trusted Online Shopping Destination',
                'about-tagline-body': 'TangailBuzz is a committed e-commerce platform reshaping online shopping in Bangladesh with customer-first service and inspiring value.',
                'about-commitment-title': 'Our Commitment: Quality, Affordability, and Accessibility',
                'about-commitment-body': 'We believe quality products should be within everyone’s reach. That is why our promise is to deliver authentic goods at fair prices with complete peace of mind.',
                'about-mission-title': 'Our Mission: Simple, Reliable, and Joyful Shopping',
                'about-mission-lead': 'We focus on making every step of shopping effortless, secure, and delightful for every customer.',
                'about-mission-effortless-title': 'Effortless Shopping',
                'about-mission-effortless-body': 'The TangailBuzz experience is designed to feel intuitive from discovery to checkout, so you can shop without friction.',
                'about-mission-home-title': 'Shop From Home',
                'about-mission-home-body': 'Wherever you are in Bangladesh, TangailBuzz lets you order trusted products from the comfort of your home.',
                'about-mission-trusted-title': 'A Trusted Experience',
                'about-mission-trusted-body': 'Beyond products, we deliver confidence with quick delivery, easy returns, and always-on customer care.',
                'about-founder-title': 'Founder: MD EOUSUF ALI – A Visionary Leader',
                'about-founder-body': 'MD EOUSUF ALI is more than the founder of TangailBuzz; he is an architect of social and economic impact through digital innovation. His journey began with a clear promise: to make quality products accessible to every household in Bangladesh.',
                'about-founder-pillars-title': 'The Pillars of His Vision',
                'about-founder-pillar-tech-title': 'Bridging Technology and People',
                'about-founder-pillar-tech-body': 'He envisioned technology as a bridge that improves everyday life, not just a tool for commerce.',
                'about-founder-pillar-goal-title': 'A Goal Beyond Business',
                'about-founder-pillar-goal-body': 'He is committed to building a transparent, reliable shopping ecosystem that benefits both buyers and sellers.',
                'about-founder-pillar-drive-title': 'Relentless Drive',
                'about-founder-pillar-drive-body': 'His persistence and customer-first mindset have shaped TangailBuzz into a symbol of trust and quality.',
                'about-founder-conclusion': 'Under his leadership, TangailBuzz stands as an inspiring brand in Bangladesh’s e-commerce landscape.',
            },
            bn: {
                'deliver-to': 'ডেলিভারি লোকেশন', 'home': 'হোম', 'products': 'পণ্য', 'categories': 'ক্যাটাগরি', 'offers': 'অফার', 'search-placeholder': 'পণ্য খুঁজুন...', 'featured-products': 'বৈশিষ্ট্যযুক্ত পণ্য', 'shop-by-category': 'ক্যাটাগরি অনুসারে কেনাকাটা করুন', 'cat-electronics': 'ইলেকট্রনিক্স', 'cat-fashion': 'ফ্যাশন', 'cat-home-garden': 'হোম অ্যান্ড গার্ডেন', 'cat-health-beauty': 'স্বাস্থ্য ও সৌন্দর্য', 'cat-sports': 'খেলাধুলা ও আউটডোর', 'cat-books': 'বই ও স্টেশনারি', 'cat-kids': 'বাচ্চা ও খেলনা', 'cat-cars': 'গাড়ি ও বাইক', 'why-choose-us': 'আমাদেরকে কেন বেছে নিবেন', 'feature-delivery-title': 'দ্রুত ডেলিভারি', 'feature-delivery-desc': 'আমরা ২-৩ কার্যদিবসের মধ্যে আপনার দোরগোড়ায় পণ্য পৌঁছে দিই।', 'feature-payment-title': 'নিরাপদ পেমেন্ট', 'feature-payment-desc': 'আপনার নিরাপত্তা ও গোপনীয়তার জন্য সকল লেনদেন এনক্রিপ্টেড।', 'feature-return-title': 'সহজ রিটার্ন', 'feature-return-desc': 'পছন্দ না হলে ৩০ দিনের মধ্যে পণ্য ফেরত দিন এবং সম্পূর্ণ মূল্য ফেরত পান।', 'feature-support-title': '২৪/৭ সাপোর্ট', 'feature-support-desc': 'আমাদের গ্রাহক সহায়তা দল দিনরাত আপনার জন্য উপলব্ধ।', 'add-to-cart': 'কার্টে যোগ করুন', 'added-to-cart': 'যোগ হয়েছে!', 'no-products': 'আপনার অনুসন্ধানের সাথে মেলে এমন কোনো পণ্য পাওয়া যায়নি।', 'back-to-products': 'সকল পণ্যে ফিরে যান', 'returnable': '৩০-দিনের মধ্যে ফেরতযোগ্য', 'not-returnable': 'ফেরতযোগ্য নয়', 'secure-payments': 'নিরাপদ পেমেন্ট', 'size': 'সাইজ:', 'storage': 'স্টোরেজ:', 'color': 'রঙ:', 'product-description': 'পণ্যের বিবরণ', 'product-specifications': 'পণ্যের স্পেসিফিকেশন', 'specifications': 'স্পেসিফিকেশন', 'value': 'মান', 'no-specs': 'এই পণ্যের জন্য কোন স্পেসিফিকেশন উপলব্ধ নেই।', 'product-reviews': 'পণ্যের রিভিউ', 'no-reviews': 'এই পণ্যের জন্য এখনো কোনো রিভিউ নেই।', 'cart': 'আপনার কার্ট', 'cart-empty': 'আপনার কার্ট খালি।', 'total': 'মোট মূল্য:', 'checkout': 'চেকআউট করুন', 'your-wishlist': 'আপনার উইশলিস্ট', 'wishlist-empty': 'আপনার উইশলিস্ট খালি। কিছু পণ্য যোগ করুন!', 'your-account': 'আপনার অ্যাকাউন্ট', 'signin-google': 'Google দিয়ে সাইন ইন করুন', 'logout': 'লগআউট', 'toast-cart-added': 'পণ্য কার্টে যোগ করা হয়েছে!', 'toast-wishlist-added': 'পণ্য উইশলিস্টে যোগ করা হয়েছে!', 'toast-wishlist-removed': 'পণ্য উইশলিস্ট থেকে সরানো হয়েছে!', 'toast-login-success': 'সফলভাবে লগইন হয়েছে!', 'toast-logout-success': 'সফলভাবে লগআউট হয়েছে!',
                'toast-register-success': 'অ্যাকাউন্ট সফলভাবে তৈরি হয়েছে!', 'login': 'লগইন', 'register': 'অ্যাকাউন্ট রেজিস্টার', 'auth-login-heading': 'পুনরায় স্বাগতম', 'auth-register-heading': 'আপনার অ্যাকাউন্ট তৈরি করুন', 'auth-reset-heading': 'পাসওয়ার্ড রিসেট করুন', 'auth-login-subtitle': 'অর্ডার, উইশলিস্ট ও ঠিকানা পরিচালনা করতে লগইন করুন।', 'auth-register-subtitle': 'কয়েক মিনিটেই বিনামূল্যে TangailBuzz অ্যাকাউন্ট তৈরি করুন।', 'auth-reset-subtitle': 'আপনার ইমেইল দিন, আমরা একটি নিরাপদ রিসেট লিঙ্ক পাঠাবো।', 'auth-login-tab': 'লগইন', 'auth-register-tab': 'রেজিস্টার', 'auth-reset-tab': 'রিসেট', 'auth-social-divider': 'অথবা চালিয়ে যান', 'auth-security-note': 'আপনার তথ্য এনক্রিপ্টেড এবং নিরাপদে সংরক্ষিত থাকে।', 'auth-new-here': 'নতুন সদস্য?', 'auth-have-account': 'ইতোমধ্যে অ্যাকাউন্ট আছে?', 'create-account': 'অ্যাকাউন্ট তৈরি করুন', 'forgot-password': 'পাসওয়ার্ড ভুলে গেছেন?', 'reset-password-desc': 'আপনার নিবন্ধিত ইমেইল দিন, আমরা একটি নিরাপদ রিসেট লিঙ্ক পাঠাবো।', 'send-reset-link': 'রিসেট লিঙ্ক পাঠান', 'back-to-login': 'লগইনে ফিরে যান', 'login-google': 'গুগল দিয়ে লগইন করুন', 'login-facebook': 'ফেসবুক দিয়ে লগইন করুন', 'full-name': 'পূর্ণ নাম', 'mobile-number': 'মোবাইল নম্বর', 'location': 'অবস্থান', 'upload-photo': 'ছবি আপলোড করুন', 'remove-photo': 'ছবি সরান', 'save-changes': 'পরিবর্তন সংরক্ষণ করুন', 'cancel': 'বাতিল', 'account-options': 'অ্যাকাউন্ট অপশন', 'edit-profile': 'প্রোফাইল সম্পাদনা', 'manage-address': 'ঠিকানা ম্যানেজ করুন', 'delete-account': 'অ্যাকাউন্ট মুছুন', 'saved-addresses': 'সংরক্ষিত ঠিকানাসমূহ', 'manage-address-help': 'আপনার ডেলিভারি ঠিকানাগুলো পরিচালনা করুন।', 'address-form-title': 'নতুন ঠিকানা যোগ করুন', 'address-line1': 'ঠিকানা লাইন ১', 'address-line2-optional': 'ঠিকানা লাইন ২ (ঐচ্ছিক)', 'city': 'শহর', 'area-district': 'এলাকা/জেলা', 'set-as-default': 'ডিফল্ট হিসেবে নির্ধারণ করুন', 'save-address': 'ঠিকানা সংরক্ষণ করুন', 'toast-select-variant': 'অনুগ্রহ করে সব অপশন সিলেক্ট করুন!', 'select-variants': 'অপশন নির্বাচন করুন', 'buy-now': 'এখনই কিনুন', 'payment-method': 'পেমেন্ট পদ্ধতি নির্বাচন করুন', 'cod': 'ক্যাশ অন ডেলিভারি', 'online-payment': 'অনলাইন পেমেন্ট', 'confirm-order': 'অর্ডার নিশ্চিত করুন', 'order-placed-success': 'আপনার অর্ডারটি সফলভাবে সম্পন্ন হয়েছে!', 'order-placed-fail': 'অর্ডার করতে ব্যর্থ হয়েছে। আবার চেষ্টা করুন।', 'cart-is-empty': 'আপনার কার্ট খালি। চেকআউট করা সম্ভব নয়।', 'mobile-banking': 'মোবাইল ব্যাংকিং', 'payment-instruction-bkash': 'অনুগ্রহ করে আপনার অ্যাপ থেকে এই বিকাশ নম্বরে ৳{amount} পাঠান: +8801863205976।', 'payment-instruction-nagad': 'অনুগ্রহ করে আপনার অ্যাপ থেকে এই নগদ নম্বরে ৳{amount} পাঠান: +8801863205976।', 'payment-instruction-cod': 'আমাদের ডেলিভারি প্রতিনিধি পণ্য পৌঁছানোর সময় আপনার থেকে টাকা সংগ্রহ করবে।', 'profile-updated': 'প্রোফাইল সফলভাবে আপডেট হয়েছে!', 'profile-update-fail': 'প্রোফাইল আপডেট করতে ব্যর্থ হয়েছে।', 'toast-storage-permission-error': 'স্টোরেজ পারমিশন সমস্যা। অনুগ্রহ করে Firebase রুলস চেক করুন।', 'toast-update-profile': 'অর্ডার করার পূর্বে অনুগ্রহ করে আপনার প্রোফাইলে ঠিকানা ও মোবাইল নম্বর আপডেট করুন।', 'emergency-contact': 'সাপোর্ট', 'message-sent': 'আপনার বার্তা সফলভাবে পাঠানো হয়েছে!', 'out-of-stock': 'স্টক শেষ', 'toast-out-of-stock': 'দুঃখিত, এই পণ্যটি বর্তমানে স্টক আউট।', 'subtotal': 'মোট', 'delivery-charge': 'ডেলিভারি চার্জ', 'my-orders': 'আমার অর্ডার',
                'delete-account-confirm': 'আপনি কি নিশ্চিত যে আপনি আপনার অ্যাকাউন্টটি মুছে ফেলতে চান? এই কাজটি ফিরিয়ে আনা যাবে না। আপনার সমস্ত ডেটা হারানো হবে।',
                'account-deleted': 'আপনার অ্যাকাউন্ট সফলভাবে মুছে ফেলা হয়েছে।',
                'delete-account-failed': 'অ্যাকাউন্ট মুছে ফেলার চেষ্টা ব্যর্থ হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।',
                'confirm-delete-title': '⚠️ স্থায়ীভাবে অ্যাকাউন্ট মুছুন',
                'chat-unauthorized': 'অ্যাডমিনের সাথে কথা বলার জন্য দয়া করে লগইন করুন।',
                'chat-send': 'পাঠান',
                'chat-placeholder': 'আপনার বার্তা লিখুন...',
                'toast-abusive-language': 'আপত্তিকর ভাষা ব্যবহার করা যাবে না।',
                'account-blocked': 'আপনার অ্যাকাউন্ট ব্লক করা হয়েছে। আপনি অর্ডার বা মেসেজ করতে পারবেন না।',
                'account-blocked-banner': 'আপনার অ্যাকাউন্ট অ্যাডমিন দ্বারা ব্লক করা হয়েছে। সহায়তার জন্য সাপোর্টে যোগাযোগ করুন।',
                'toast-account-blocked-action': 'প্রক্রিয়া সম্পন্ন হয়নি: আপনার অ্যাকাউন্ট ব্লক করা হয়েছে।',
                'coupon-placeholder': 'কুপন কোড', 'apply-coupon': 'প্রয়োগ', 'discount': 'ডিসকাউন্ট', 'order-summary': 'অর্ডার সারাংশ', 'total-inclusive-vat': 'মোট (ভ্যাটসহ)',
                'toast-coupon-applied': 'কুপন সফলভাবে প্রয়োগ করা হয়েছে!', 'toast-coupon-invalid': 'অবৈধ বা মেয়াদোত্তীর্ণ কুপন কোড।',
                'toast-coupon-used': 'আপনি ইতিমধ্যে এই কুপন ব্যবহার করেছেন।', 'toast-coupon-min-purchase': 'এই কুপনটি ব্যবহার করতে সর্বনিম্ন ৳{amount} কেনাকাটা করতে হবে।',
                'warranty': '{text} ওয়ারেন্টি', // Updated key for text string
                'no-warranty': 'কোনো ওয়ারেন্টি নেই', // Updated key
                'model-id': 'প্রোডাক্ট আইডি: {id}', // FIX: Changed 'মডেল আইডি:' to 'প্রোডাক্ট আইডি:'
                'available-coupons': 'উপলব্ধ কুপন', 'min-spend': 'সর্বনিম্ন খরচ', 'discount-value': 'ডিসকাউন্ট', 'tap-to-copy': 'কপি করুন', 'copied': 'কপি হয়েছে!',
                'all-products': 'সকল পণ্য',
                'all-categories': 'সব ক্যাটাগরি',
                'choose-subcategory': 'সাব ক্যাটাগরি নির্বাচন করুন',
                'back-to-categories': 'ক্যাটাগরিতে ফিরে যান',
                'browse-everything': 'এক জায়গায় সবকিছু দেখুন',
                // Hero
                'hero-title': 'আপনার স্টাইল খুঁজুন। শপ করুন বাজ়ে।',
                'hero-subtitle': 'ইলেকট্রনিক্স, ফ্যাশনসহ নানা ক্যাটাগরিতে বিশেষ অফার, দ্রুত ডেলিভারি ও বিশ্বস্ত পণ্য।',
                'hero-cta-shop': 'এখনই কেনাকাটা',
                'hero-cta-browse': 'ক্যাটাগরি দেখুন',
                'hero-badge': 'প্রতিদিন নতুন কালেকশন',
                'current-category-title': '{category} ক্যাটাগরি',
                'sub-category-filter': 'সাব-ক্যাটাগরি অনুযায়ী ফিল্টার করুন:',
                'write-a-review': 'একটি রিভিউ দিন',
                'your-rating': 'আপনার রেটিং:',
                'your-comment': 'আপনার মন্তব্য:',
                'submit-review': 'রিভিউ জমা দিন',
                'review-login-prompt': 'অনুগ্রহ করে রিভিউ দেওয়ার জন্য লগইন করুন।',
                'review-success': 'রিভিউ সফলভাবে জমা দেওয়া হয়েছে! ধন্যবাদ।',
                'review-failed': 'রিভিউ জমা দিতে ব্যর্থ হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।',
                // Category helpers
                'all-in-category': 'সকল',
                // Footer
                'footer-tagline': 'সাশ্রয়ী মূল্যে মানসম্মত পণ্যের জন্য আপনার বিশ্বস্ত অনলাইন কেনাকাটার গন্তব্য।',
                'footer-important-links': 'গুরুত্বপূর্ণ লিঙ্ক',
                'footer-nav-home': 'হোম',
                'footer-nav-products': 'পণ্য',
                'footer-nav-categories': 'ক্যাটাগরি',
                'footer-nav-offers': 'অফার',
                'footer-nav-about': 'আমাদের সম্পর্কে',
                'footer-col-customer-service': 'গ্রাহক সেবা',
                'footer-faq': 'FAQ',
                'footer-return-policy': 'রিটার্ন নীতি',
                'footer-shipping-info': 'শিপিং তথ্য',
                'footer-privacy-policy': 'গোপনীয়তা নীতি',
                'footer-terms': 'শর্তাবলী',
                'footer-col-contact': 'যোগাযোগ করুন',
                'footer-we-accept': 'আমরা গ্রহণ করি',
                'footer-copyright': '© ২০২৫ TangailBuzz। সর্বস্বত্ব সংরক্ষিত।',
                // Header short labels
                'flash-sale-nav': 'ফ্ল্যাশ সেল',
                'mega-sale-nav': 'মেগা সেল',
                'add-product-nav': 'পণ্য যোগ করুন',
                'dark-mode': 'ডার্ক মোড',
                'profile': 'প্রোফাইল',
                'wishlist': 'উইশলিস্ট',
                'cart-short': 'কার্ট',
                'remove': 'সরান',
                // Support page
                'support-title': 'সাপোর্ট',
                'support-live-chat': 'লাইভ চ্যাট',
                'support-live-chat-desc': 'তাৎক্ষণিক সাপোর্টের জন্য',
                'support-live-chat-hours': 'সময়: সকাল ১০টা - রাত ৮টা',
                'support-start-chat': 'চ্যাট শুরু করুন',
                'support-email': 'ইমেইল সাপোর্ট',
                'support-email-desc': 'বিস্তারিত সমস্যা বা অভিযোগের জন্য',
                'support-email-sla': 'রিপ্লাইয়ের সময়: ২৪ ঘণ্টার মধ্যে',
                'support-send-email': 'ইমেইল পাঠান',
                'support-phone': 'ফোন কল',
                'support-phone-desc': 'শুধুমাত্র জরুরি পেমেন্ট বা অর্ডার সংক্রান্ত সমস্যার জন্য',
                'support-phone-hours': 'সময়: সকাল ১০টা - সন্ধ্যা ৬টা',
                'support-call-now': 'এখনই কল করুন',
                'flash-sale-heading': 'ফ্ল্যাশ সেল',
                'flash-sale-subheading': 'সময় সীমিত অফার চলছে—শেষ হওয়ার আগেই কিনে ফেলুন!',
                'flash-sale-empty': 'এখন কোনো ফ্ল্যাশ ডিল নেই। আবারও দেখে যান।',
                'flash-sale-badge': 'ফ্ল্যাশ',
                'flash-sale-upcoming': 'আসছে',
                'flash-sale-ended': 'শেষ',
                'flash-sale-countdown-label': 'শেষ হতে বাকি',
                'flash-sale-countdown-starts': 'শুরু হতে বাকি',
                'flash-sale-coming-soon': 'শীঘ্রই আসছে',
                'mega-sale-heading': 'মেগা সেল',
                'mega-sale-subheading': 'সপ্তাহের সবচেয়ে বড় ডিসকাউন্ট—স্টক শেষ হওয়ার আগেই সংগ্রহ করুন।',
                'mega-sale-empty': 'এখন কোনো মেগা ডিল নেই। আবার দেখে যান।',
                'mega-sale-badge': 'মেগা সেল',
                'mega-sale-highlight': 'বিশেষ নির্বাচন',
                'language-label': 'ভাষা',
                'language-menu-heading': 'ভাষা নির্বাচন করুন',
                'language-english': 'ইংরেজি',
                'language-bangla': 'বাংলা',
                'language-switch-toast': '{language} ভাষা চালু হয়েছে',
                'download-invoice': 'ইনভয়েস ডাউনলোড করুন',
                'invoice-download-success': 'ইনভয়েস সফলভাবে ডাউনলোড হয়েছে!',
                'invoice-download-error': 'এখন ইনভয়েস ডাউনলোড করা যাচ্ছে না।',
                'invoice-missing-order': 'এই অর্ডারের ইনভয়েসের তথ্য পাওয়া যায়নি।',
                'about-heading': 'আমাদের সম্পর্কে',
                'about-tagline-title': 'TangailBuzz: আপনার বিশ্বস্ত অনলাইন শপিং গন্তব্য',
                'about-tagline-body': 'TangailBuzz একটি প্রতিশ্রুতিশীল ই-কমার্স প্ল্যাটফর্ম, যা ক্রেতা-কেন্দ্রিক পরিষেবা প্রদানের মাধ্যমে বাংলাদেশের অনলাইন শপিং-এর অভিজ্ঞতাকে নতুন মাত্রা দিতে বদ্ধপরিকর।',
                'about-commitment-title': 'আমাদের অঙ্গীকার: মান, সাশ্রয় ও সহজলভ্যতা',
                'about-commitment-body': 'আমরা বিশ্বাস করি, মানসম্মত পণ্য কেনা প্রতিটি মানুষের অধিকার। এই নীতিতে বিশ্বাস রেখে, TangailBuzz সর্বোচ্চ মানসম্মত পণ্যগুলো সাশ্রয়ী মূল্যে আপনার কাছে পৌঁছে দিতে অঙ্গীকারবদ্ধ। আমরা পণ্যের গুণগত মান নিয়ে কোনো আপস করি না, যাতে আপনি সম্পূর্ণ আস্থা ও সন্তুষ্টি নিয়ে কেনাকাটা করতে পারেন।',
                'about-mission-title': 'আমাদের লক্ষ্য: সহজ, নির্ভরযোগ্য ও আনন্দদায়ক শপিং',
                'about-mission-lead': 'আমাদের প্রধান লক্ষ্য হলো কেনাকাটার প্রক্রিয়াটিকে অত্যন্ত সহজ, নিরাপদ, নির্ভরযোগ্য এবং আনন্দদায়ক করে তোলা।',
                'about-mission-effortless-title': 'সহজ কেনাকাটা',
                'about-mission-effortless-body': 'আমাদের প্ল্যাটফর্মটি ব্যবহারকারী-বান্ধব (user-friendly) করে ডিজাইন করা হয়েছে, যাতে পণ্য খুঁজে বের করা থেকে শুরু করে অর্ডার নিশ্চিত করা পর্যন্ত পুরো প্রক্রিয়াটি মসৃণ ও স্বচ্ছন্দ হয়।',
                'about-mission-home-title': 'ঘরে বসে শপিং',
                'about-mission-home-body': 'বাংলাদেশের যেকোনো প্রান্তের মানুষ যেন ঘরে বসেই তাদের পছন্দের সেরা পণ্যটি কোনো ঝামেলা ছাড়াই কিনতে পারেন, তা নিশ্চিত করাই আমাদের প্রধান উদ্দেশ্য।',
                'about-mission-trusted-title': 'বিশ্বস্ত অভিজ্ঞতা',
                'about-mission-trusted-body': 'আমরা শুধুমাত্র পণ্য সরবরাহ করি না, বরং একটি সম্পূর্ণ বিশ্বস্ত শপিং অভিজ্ঞতা নিশ্চিত করি—যার মধ্যে রয়েছে দ্রুত ডেলিভারি, সহজ রিটার্ন প্রক্রিয়া এবং সার্বক্ষণিক গ্রাহক সহায়তা।',
                'about-founder-title': 'প্রতিষ্ঠাতা: MD EOUSUF ALI – এক দূরদর্শী স্বপ্নদ্রষ্টা',
                'about-founder-body': 'MD EOUSUF ALI শুধুমাত্র TangailBuzz-এর প্রতিষ্ঠাতা নন, তিনি ডিজিটাল মাধ্যমে সামাজিক ও অর্থনৈতিক পরিবর্তনের একজন স্থপতি। তাঁর যাত্রা শুরু হয়েছিল একটি সরল কিন্তু গভীর প্রত্যয় নিয়ে: বাংলাদেশের প্রতিটি মানুষের কাছে যেন উন্নত মানের পণ্য সহজলভ্য হয়, তা নিশ্চিত করা।',
                'about-founder-pillars-title': 'তাঁর দূরদর্শিতার মূল দিকগুলো',
                'about-founder-pillar-tech-title': 'টেকনোলজি ও মানুষের সংযোগ',
                'about-founder-pillar-tech-body': 'তিনি প্রযুক্তির ব্যবহারকে কেবল বাণিজ্য নয়, বরং সাধারণ মানুষের জীবনযাত্রার একটি অংশ করার স্বপ্ন দেখেছিলেন।',
                'about-founder-pillar-goal-title': 'উন্নয়নের লক্ষ্য',
                'about-founder-pillar-goal-body': 'তাঁর লক্ষ্য কেবল ব্যবসা করা নয়, বরং একটি স্বচ্ছ ও নির্ভরযোগ্য শপিং ইকোসিস্টেম তৈরি করা যা ক্রেতা ও বিক্রেতা উভয়কেই উপকৃত করবে।',
                'about-founder-pillar-drive-title': 'অদম্য স্পৃহা',
                'about-founder-pillar-drive-body': 'তাঁর অদম্য চেষ্টা, কঠোর পরিশ্রম এবং গ্রাহক-কেন্দ্রিক মনোভাবই TangailBuzz-কে আজকের অবস্থানে এনেছে। তিনি এই প্ল্যাটফর্মটিকে কেবল একটি ই-কমার্স সাইট নয়, বরং বিশ্বাস এবং গুণমানের প্রতিশ্রুতির প্রতীক হিসেবে প্রতিষ্ঠা করেছেন।',
                'about-founder-conclusion': 'MD EOUSUF ALI-এর নেতৃত্ব TangailBuzz-কে কেবল একটি শপিং প্ল্যাটফর্ম নয়, বরং বাংলাদেশের ই-কমার্স জগতে একটি অনুপ্রেরণামূলক ব্র্যান্ড হিসেবে প্রতিষ্ঠিত করেছে।',
            }
        };

        function resolveLocalizedString(keyOrText, vars = {}, locale = currentLanguage) {
            const preferred = translations[locale] || {};
            const englishFallback = translations.en || {};
            const banglaFallback = translations.bn || {};
            let template = typeof keyOrText === 'string' && preferred[keyOrText] !== undefined ? preferred[keyOrText]
                : typeof keyOrText === 'string' && englishFallback[keyOrText] !== undefined ? englishFallback[keyOrText]
                : typeof keyOrText === 'string' && banglaFallback[keyOrText] !== undefined ? banglaFallback[keyOrText]
                : keyOrText;
            if (typeof template !== 'string') {
                return '';
            }
            return template.replace(/\{([^}]+)\}/g, (_, token) => (vars[token] !== undefined ? vars[token] : `{${token}}`));
        }

        function getLanguageLabel(languageCode, locale = currentLanguage) {
            const normalized = SUPPORTED_LANGUAGES.includes(languageCode) ? languageCode : DEFAULT_LANGUAGE;
            const labelKey = normalized === 'bn' ? 'language-bangla' : 'language-english';
            const fallback = normalized === 'bn' ? 'বাংলা' : 'English';
            const localized = resolveLocalizedString(labelKey, {}, locale);
            return localized || fallback;
        }

        const DOMElements = {
            toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'), productList: document.getElementById('product-list'), flashSaleSection: document.getElementById('flash-sale-section'), flashSaleGrid: document.getElementById('flash-sale-grid'), flashSaleEmpty: document.getElementById('flash-sale-empty'), flashSaleMasterCountdown: document.getElementById('flash-sale-master-countdown'), flashSaleCountdownLabel: document.getElementById('flash-sale-countdown-label'), megaSaleSection: document.getElementById('mega-sale-section'), megaSaleGrid: document.getElementById('mega-sale-grid'), megaSaleEmpty: document.getElementById('mega-sale-empty'), cartCount: document.getElementById('cart-count'), mobileCartCount: document.getElementById('mobile-cart-count'), cartItems: document.getElementById('cart-items'), cartSubtotal: document.getElementById('cart-subtotal'), deliveryCharge: document.getElementById('delivery-charge'), cartTotal: document.getElementById('cart-total'), wishlistItems: document.getElementById('wishlist-items'), authOptions: document.getElementById('auth-options'), 
            userProfileView: document.getElementById('user-profile-view'), userPhoto: document.getElementById('user-photo'), userName: document.getElementById('user-name'), userEmail: document.getElementById('user-email'), userMobile: document.getElementById('user-mobile'), userLocation: document.getElementById('user-location'),
            authCardHeading: document.getElementById('auth-card-heading'), authSubtitle: document.getElementById('auth-subtitle'), authHeroIcon: document.querySelector('.auth-hero-icon i'), authTabs: Array.from(document.querySelectorAll('.auth-tab')),
            loginBtn: document.getElementById('login-google-btn'), loginFacebookBtn: document.getElementById('login-facebook-btn'), logoutBtn: document.getElementById('logout-btn'), 
            editProfileBtn: document.getElementById('edit-profile-btn'), editProfileForm: document.getElementById('edit-profile-form'), saveProfileBtn: document.getElementById('save-profile-btn'), cancelEditBtn: document.getElementById('cancel-edit-btn'),
            profileFullSection: document.getElementById('profile-full-section'), mobileProfileToggleBtn: document.getElementById('mobile-profile-toggle'),
            profileQuickActions: Array.from(document.querySelectorAll('.profile-quick-action')),
            myOrdersBtnProfile: document.getElementById('my-orders-btn-profile'), 
            ordersList: document.getElementById('orders-list'),
            editPhotoPreview: document.getElementById('edit-photo-preview'), editPhotoInput: document.getElementById('edit-photo-input'), editNameInput: document.getElementById('edit-name-input'), editMobileInput: document.getElementById('edit-mobile-input'), editLocationInput: document.getElementById('edit-location-input'),
            searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), searchInputMobile: document.getElementById('search-input-mobile'), searchButtonMobile: document.getElementById('search-button-mobile'), slidesContainer: document.getElementById('slides-container'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), indicatorContainer: document.getElementById('slider-indicators'), drawerOverlay: document.getElementById('drawer-overlay'), rightPromoImg: document.getElementById('right-promo-img'), rightPromoTitle: document.getElementById('right-promo-title'), rightPromoSubtitle: document.getElementById('right-promo-subtitle'), rightPromoLink: document.getElementById('right-promo-link'),
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), showRegisterLink: document.getElementById('show-register-form'), showLoginLink: document.getElementById('show-login-form'), authError: document.getElementById('auth-error'), profileDrawerTitle: document.getElementById('profile-drawer-title'),
            resetForm: document.getElementById('reset-form'), resetEmail: document.getElementById('reset-email'), showResetLink: document.getElementById('show-reset-form'), showLoginFromResetLink: document.getElementById('show-login-from-reset'),
            paymentModal: document.getElementById('payment-modal'), checkoutBtn: document.getElementById('checkout-btn'), confirmOrderBtn: document.getElementById('confirm-order-btn'),
            orderSuccessModal: document.getElementById('order-success-modal'), paymentInstruction: document.getElementById('payment-instruction'), closeSuccessModalBtn: document.getElementById('close-success-modal'),
            discountRow: document.getElementById('discount-row'),
            cartDiscount: document.getElementById('cart-discount'),
            deleteAccountBtn: document.getElementById('delete-account-btn'),
            
            // Confirmation Modal Elements
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),

            // Chat Elements
            emergencyContactBtn: document.getElementById('emergency-contact-btn'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            chatError: document.getElementById('chat-error'),
            
            // Blocked User Banner
            blockedBanner: document.getElementById('blocked-account-banner'),

            // Coupon Elements
            couponForm: document.getElementById('coupon-form'),
            couponInput: document.getElementById('coupon-input'),
            
            // Dark Mode Elements
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            darkModeIcon: document.getElementById('dark-mode-icon'),
            darkModeToggleMobile: document.getElementById('dark-mode-toggle-mobile'),
            darkModeIconMobile: document.getElementById('dark-mode-icon-mobile'),
            mobileFooterNav: document.getElementById('mobile-footer-nav'),
            mobileNavHomeBtn: document.getElementById('mobile-nav-home'),
            mobileNavCategoriesBtn: document.getElementById('mobile-nav-categories'),
            mobileNavCartBtn: document.getElementById('mobile-nav-cart'),
            mobileNavProfileBtn: document.getElementById('mobile-nav-profile'),
            mobileCategoriesDrawer: document.getElementById('mobile-categories-drawer'),
            mobileCategoriesTitle: document.getElementById('mobile-categories-title'),
            mobileCategoriesBackBtn: document.getElementById('mobile-categories-back'),
            mobileCategoriesList: document.getElementById('mobile-categories-list'),
            mobileSubcategoriesContainer: document.getElementById('mobile-subcategories-container'),
            mobileSubcategoriesList: document.getElementById('mobile-subcategories-list'),
            mobileSubcategoriesLead: document.getElementById('mobile-subcategories-lead'),

            // New Category Elements
            categoryHeader: document.getElementById('category-header'),
            breadcrumb: document.getElementById('breadcrumb'),
            currentCategoryTitle: document.getElementById('current-category-title'),
            subcategoryButtons: document.getElementById('subcategory-buttons'),
            // Address management elements
            manageAddressesBtn: document.getElementById('manage-addresses-btn'),
            addressesSection: document.getElementById('addresses-section'),
            addressesList: document.getElementById('addresses-list'),
            addressForm: document.getElementById('address-form'),
            addressFormTitle: document.getElementById('address-form-title'),
            addrIdHidden: document.getElementById('address-id-hidden'),
            addrName: document.getElementById('addr-name'),
            addrMobile: document.getElementById('addr-mobile'),
            addrLine1: document.getElementById('addr-line1'),
            addrLine2: document.getElementById('addr-line2'),
            addrCity: document.getElementById('addr-city'),
            addrArea: document.getElementById('addr-area'),
            addrDefault: document.getElementById('addr-default'),
            cancelAddressBtn: document.getElementById('cancel-address-btn'),
            // Payment modal address elements
            shippingAddressSection: document.getElementById('shipping-address-section'),
            selectedAddressDisplay: document.getElementById('selected-address-display'),
            changeAddressBtn: document.getElementById('change-address-btn'),
            addressSelectPanel: document.getElementById('address-select-panel'),
            addressSelectList: document.getElementById('address-select-list'),
            useSelectedAddressBtn: document.getElementById('use-selected-address-btn'),
            manageAddressesShortcut: document.getElementById('manage-addresses-shortcut'),
            // Global breadcrumb elements
            globalBreadcrumb: document.getElementById('global-breadcrumb'),
            globalBreadcrumbPath: document.getElementById('global-breadcrumb-path'),
        };

        let initialTheme = 'light';
        try {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark' || storedTheme === 'light') {
                initialTheme = storedTheme;
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                initialTheme = 'dark';
            }
        } catch (error) {
            console.warn('Theme preference load failed:', error);
        }
        applyDarkMode(initialTheme);

        let baseMobileNavKey = 'home';
        let currentMobileNavKey = 'home';

        // --- Error Handling & UI Helpers ---
        // Safe toast display with localization fallback.
        if (typeof window.showToast !== 'function') {
            window.showToast = function(messageKeyOrText, isSuccess = true, vars = {}) {
                try {
                    const el = DOMElements.toast;
                    const msgEl = DOMElements.toastMessage;
                    if (!el || !msgEl) {
                        // Fallback to alert for environments without toast DOM
                        if (typeof messageKeyOrText === 'string') {
                            console[isSuccess ? 'log' : 'warn'](messageKeyOrText);
                        }
                        return;
                    }
                    const text = resolveLocalizedString(messageKeyOrText, vars);
                    msgEl.textContent = text;
                    el.classList.remove('hidden');
                    el.classList.toggle('bg-green-600', !!isSuccess);
                    el.classList.toggle('bg-red-600', !isSuccess);
                    clearTimeout(el._hideTimer);
                    el._hideTimer = setTimeout(() => el.classList.add('hidden'), 2500);
                } catch (e) {
                    console.warn('Toast failed:', e);
                }
            }
        }

        // Centralized error logger
        function logError(context, error) {
            try {
                console.error(`[${context}]`, error);
            } catch {}
        }

        // Generic async wrapper to standardize UI state and error reporting
        async function safeAsync(fn, { onStart, onSuccess, onError, onFinally } = {}) {
            try {
                onStart && onStart();
                const res = await fn();
                onSuccess && onSuccess(res);
                return res;
            } catch (err) {
                onError && onError(err);
                // Default surface
                showToast(err?.message || 'Something went wrong. Please try again.', false);
                throw err;
            } finally {
                onFinally && onFinally();
            }
        }

        // Disable/enable a button safely while an async task runs
        async function withDisabled(btn, task) {
            if (!btn) return task();
            const prevDisabled = btn.disabled;
            btn.disabled = true;
            try { return await task(); } finally { btn.disabled = prevDisabled; }
        }

        // Global guards for uncaught errors
        if (!window.__globalErrorHandlersInstalled) {
            window.__globalErrorHandlersInstalled = true;
            window.addEventListener('error', (e) => {
                logError('window.onerror', e?.error || e?.message || e);
            });
            window.addEventListener('unhandledrejection', (e) => {
                logError('unhandledrejection', e?.reason || e);
                showToast('An unexpected error occurred.', false);
            });
        }
        
        // --- Dark Mode Logic ---

        function applyDarkMode(mode) {
            const html = document.documentElement;
            const isDark = mode === 'dark';
            
            if (isDark) {
                html.classList.add('dark');
                if (DOMElements.darkModeIcon) {
                    DOMElements.darkModeIcon.className = 'fas fa-moon';
                }
                if (DOMElements.darkModeIconMobile) {
                    DOMElements.darkModeIconMobile.className = 'fas fa-moon text-theme-blue text-lg';
                }
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.remove('dark');
                if (DOMElements.darkModeIcon) {
                    DOMElements.darkModeIcon.className = 'fas fa-sun';
                }
                if (DOMElements.darkModeIconMobile) {
                    DOMElements.darkModeIconMobile.className = 'fas fa-sun text-theme-blue text-lg';
                }
                localStorage.setItem('theme', 'light');
            }

            if (DOMElements.darkModeToggle) {
                DOMElements.darkModeToggle.setAttribute('aria-pressed', isDark ? 'true' : 'false');
            }
            if (DOMElements.darkModeToggleMobile) {
                DOMElements.darkModeToggleMobile.setAttribute('aria-pressed', isDark ? 'true' : 'false');
            }
        }

        function toggleDarkMode() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyDarkMode(currentTheme === 'light' ? 'dark' : 'light');
        }
        window.toggleDarkMode = toggleDarkMode;

        
        // --- UI & RENDERING ---

        function showToast(messageKeyOrText, isSuccess = true, vars = {}) {
            const message = resolveLocalizedString(messageKeyOrText, vars);
            DOMElements.toastMessage.textContent = message;
            DOMElements.toast.className = `fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform transition-transform duration-500 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            DOMElements.toast.classList.remove('translate-x-[150%]', 'opacity-0');
            DOMElements.toast.classList.add('translate-x-0', 'opacity-100');

            setTimeout(() => {
                DOMElements.toast.classList.remove('translate-x-0', 'opacity-100');
                DOMElements.toast.classList.add('translate-x-[150%]', 'opacity-0');
            }, 3000);
        }
        window.showToast = showToast; // Exported for external use
        
        // --- Blocked UI Functions ---
        function showBlockedUI(messageKey) {
            const banner = DOMElements.blockedBanner;
            if (banner) {
                const text = resolveLocalizedString(messageKey || 'account-blocked-banner');
                banner.textContent = text;
                banner.classList.remove('hidden');
                // Adjust header margin to not overlap
                const headerEl = document.querySelector('header');
                if (headerEl) headerEl.style.marginTop = `${banner.offsetHeight}px`;
            }
            // Disable critical action buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = true;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = true;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = true;
        }
        
        function hideBlockedUI() {
            const banner = DOMElements.blockedBanner;
            if (banner && !banner.classList.contains('hidden')) {
                banner.classList.add('hidden');
                 document.querySelector('header').style.marginTop = `0px`;
            }
             // Re-enable buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = false;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = false;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = false;
        }


        function updateTextContent() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (!key) return;
                const value = resolveLocalizedString(key);
                if (value !== undefined) el.textContent = value;
            });
            document.querySelectorAll('[data-lang-title]').forEach(el => {
                const key = el.dataset.langTitle;
                if (!key) return;
                const value = resolveLocalizedString(key);
                if (value !== undefined) el.title = value;
            });
            document.querySelectorAll('[data-lang-aria-label]').forEach(el => {
                const key = el.dataset.langAriaLabel;
                if (!key) return;
                const value = resolveLocalizedString(key);
                if (value !== undefined) el.setAttribute('aria-label', value);
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (!key) return;
                const value = resolveLocalizedString(key);
                if (value !== undefined) el.placeholder = value;
            });
            if (DOMElements.searchInput) DOMElements.searchInput.placeholder = resolveLocalizedString('search-placeholder');
            if (DOMElements.searchInputMobile) DOMElements.searchInputMobile.placeholder = resolveLocalizedString('search-placeholder');
            if (DOMElements.chatInput) DOMElements.chatInput.placeholder = resolveLocalizedString('chat-placeholder');
        }

        function refreshLanguageUIState() {
            const currentLabel = getLanguageLabel(currentLanguage);
            document.querySelectorAll('[data-lang-option]').forEach(button => {
                const isActive = button.dataset.langOption === currentLanguage;
                button.classList.toggle('language-option-active', isActive);
                const indicator = button.querySelector('.lang-active-indicator');
                if (indicator) indicator.classList.toggle('hidden', !isActive);
                button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                if (button.getAttribute('role') === 'menuitemradio') {
                    button.setAttribute('aria-checked', isActive ? 'true' : 'false');
                }
            });
            const langSwitch = document.getElementById('lang-switch');
            if (langSwitch) {
                langSwitch.checked = currentLanguage === 'bn';
            }
            const flagIcon = document.getElementById('flag-icon');
            if (flagIcon) {
                const flagAsset = LANGUAGE_FLAG_ASSETS[currentLanguage];
                if (flagAsset?.src) flagIcon.src = flagAsset.src;
                if (flagAsset?.alt) flagIcon.alt = flagAsset.alt;
            }
        }

        function setLanguage(languageCode = DEFAULT_LANGUAGE, options = {}) {
            const { silent = false, persist = true, force = false } = options;
            const normalizedInput = typeof languageCode === 'string' ? languageCode.toLowerCase() : languageCode;
            const normalized = SUPPORTED_LANGUAGES.includes(normalizedInput) ? normalizedInput : DEFAULT_LANGUAGE;
            const previousLanguage = currentLanguage;
            currentLanguage = normalized;

            if (persist) {
                try {
                    localStorage.setItem(LANGUAGE_STORAGE_KEY, normalized);
                    localStorage.removeItem('lang');
                } catch (error) {
                    console.warn('Language preference save failed:', error);
                }
            }

            applyLanguageAttributes(normalized);
            updateTextContent();
            renderProducts(currentDisplayedProducts);
            renderFlashSaleSection(productsData);
            renderMegaSaleSection(productsData);
            try { fetchRightPromoFromFirestore && fetchRightPromoFromFirestore(); } catch (_) {}
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (_) {}
            }
            if (currentCategory && typeof renderSubCategories === 'function') {
                try { renderSubCategories(currentCategory); } catch (_) {}
            }
            if (DOMElements.mobileCategoriesDrawer && DOMElements.mobileCategoriesDrawer.classList.contains('active')) {
                if (mobileCategoriesActiveCategory) {
                    showMobileSubcategories(mobileCategoriesActiveCategory);
                } else {
                    renderMobileCategoriesMainView();
                }
            }
            const detailsPage = document.getElementById('product-details-page');
            if (detailsPage && !detailsPage.classList.contains('hidden')) {
                const addToCartBtn = document.getElementById('add-to-cart-details');
                const productId = addToCartBtn ? addToCartBtn.dataset.productId : null;
                if (productId) showProductDetails(productId);
            }

            if (typeof toggleAuthForms === 'function') {
                toggleAuthForms(currentAuthForm);
            }

            refreshLanguageUIState();
            setupHeaderShortcuts();

            const langMenu = document.getElementById('language-menu');
            if (langMenu) {
                langMenu.classList.add('hidden');
            }

            if (!silent && (force || previousLanguage !== normalized)) {
                showToast('language-switch-toast', true, { language: getLanguageLabel(normalized, normalized) });
            }
        }
        window.setLanguage = setLanguage;

        function setupLanguageControls() {
            const langSwitch = document.getElementById('lang-switch');
            if (langSwitch && langSwitch.dataset.boundLanguageSwitch !== 'true') {
                langSwitch.addEventListener('change', (event) => {
                    event.preventDefault();
                    const targetLang = event.target.checked ? 'bn' : 'en';
                    setLanguage(targetLang);
                });
                langSwitch.dataset.boundLanguageSwitch = 'true';
            }

            document.querySelectorAll('[data-lang-option]').forEach(button => {
                if (button.dataset.boundLanguageOption === 'true') return;
                button.addEventListener('click', (event) => {
                    event.preventDefault();
                    const langCode = button.dataset.langOption;
                    if (!langCode) return;
                    setLanguage(langCode);
                    if (typeof closeDrawer === 'function' && button.closest('#nav-drawer')) {
                        closeDrawer();
                    }
                });
                button.dataset.boundLanguageOption = 'true';
            });

            refreshLanguageUIState();
        }

        function setupHeaderShortcuts() {
            const supportBtn = document.getElementById('emergency-contact-header');
            if (supportBtn && supportBtn.dataset.boundShortcut !== 'true') {
                supportBtn.addEventListener('click', () => {
                    try { showPage('support-page'); } catch (error) { console.error('Support shortcut failed:', error); }
                });
                supportBtn.dataset.boundShortcut = 'true';
            }

            const profileBtn = document.getElementById('profile-icon');
            if (profileBtn) {
                if (!profileBtn.dataset.boundShortcut && !profileBtn.hasAttribute('onclick')) {
                    profileBtn.addEventListener('click', () => {
                        try { openDrawer('profile-drawer'); } catch (error) { console.error('Profile shortcut failed:', error); }
                    });
                }
                profileBtn.dataset.boundShortcut = 'true';
            }

            const darkToggle = document.getElementById('dark-mode-toggle');
            if (darkToggle && darkToggle.dataset.boundShortcut !== 'true') {
                darkToggle.addEventListener('click', (event) => {
                    event.preventDefault();
                    try { toggleDarkMode(); } catch (error) { console.error('Dark mode toggle failed:', error); }
                });
                darkToggle.dataset.boundShortcut = 'true';
            }

            const darkToggleMobile = document.getElementById('dark-mode-toggle-mobile');
            if (darkToggleMobile && darkToggleMobile.dataset.boundShortcut !== 'true') {
                darkToggleMobile.addEventListener('click', (event) => {
                    event.preventDefault();
                    try { toggleDarkMode(); } catch (error) { console.error('Dark mode toggle failed:', error); }
                });
                darkToggleMobile.dataset.boundShortcut = 'true';
            }
        }

        function showPage(pageId) {
            // Stop chat listener when leaving the chat page
            if (pageId !== 'emergency-chat-page') {
                chatUnsubscribe(); 
            } else if (currentUser && !currentUser.isAnonymous) {
                // Start chat listener when entering chat page
                handleEmergencyChat();
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                if (pageId === 'wishlist-page') {
                    renderWishlistItems();
                } else if (pageId === 'my-orders-page'){
                    fetchUserOrders();
                } else if (pageId === 'cart-page') {
                    // Coupons list removed; only apply coupon option remains
                } else if (pageId === 'home-page' && currentDisplayedProducts.length === 0) {
                     renderProducts(productsData);
                }
                // Re-apply translations on newly visible page
                updateTextContent();
            }
            if (pageId === 'home-page') {
                baseMobileNavKey = 'home';
            } else if (pageId === 'cart-page') {
                baseMobileNavKey = 'cart';
            } else {
                baseMobileNavKey = null;
            }

            if (!document.querySelector('.drawer.active')) {
                setActiveMobileNav(baseMobileNavKey);
            }
            if (pageId !== 'product-details-page') {
                try { clearProductDetailsFlashTimer(); } catch (_) {}
            }
            // Toggle global breadcrumb visibility - show only on product details
            try {
                const bc = DOMElements.globalBreadcrumb;
                const path = DOMElements.globalBreadcrumbPath;
                if (bc) {
                    if (pageId === 'product-details-page') {
                        bc.classList.remove('hidden');
                    } else {
                        bc.classList.add('hidden');
                        if (path) path.innerHTML = '';
                    }
                }
            } catch {}
            window.scrollTo(0, 0);
        }
        window.showPage = showPage; // Exported to global scope

        function scrollToElement(elementId) {
            document.getElementById(elementId)?.scrollIntoView({ behavior: 'smooth' });
        }
        window.scrollToElement = scrollToElement;

        // Live Search Suggestions (Autocomplete)
        function hideSearchResults() {
            const desktopBox = document.getElementById('search-results-desktop');
            const mobileBox = document.getElementById('search-results-mobile');
            if (desktopBox) { desktopBox.innerHTML = ''; desktopBox.classList.add('hidden'); }
            if (mobileBox) { mobileBox.innerHTML = ''; mobileBox.classList.add('hidden'); }
        }
        // Expose to global for inline handlers used in suggestion items
        window.hideSearchResults = hideSearchResults;

        function handleSearchSuggestions(event) {
            try {
                const target = event.target;
                const query = String(target.value || '').trim().toLowerCase();
                const isDesktop = target.id === 'search-input';
                const boxId = isDesktop ? 'search-results-desktop' : 'search-results-mobile';
                const resultsBox = document.getElementById(boxId);
                if (!resultsBox) return;

                if (!query || query.length < 2 || !Array.isArray(productsData) || productsData.length === 0) {
                    resultsBox.innerHTML = '';
                    resultsBox.classList.add('hidden');
                    return;
                }

                const matches = productsData
                    .filter(p => {
                        const name = (p?.name || '').toLowerCase();
                        const brand = (p?.brand || '').toLowerCase();
                        const cat = (p?.category || '').toLowerCase();
                        const sub = (p?.subCategory || '').toLowerCase();
                        return name.includes(query) || brand.includes(query) || cat.includes(query) || sub.includes(query);
                    })
                    .slice(0, 5);

                if (matches.length === 0) {
                    resultsBox.innerHTML = '';
                    resultsBox.classList.add('hidden');
                    return;
                }

                const itemCls = 'block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200';
                const html = matches.map(p => {
                    const title = (p.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<button type="button" class="${itemCls}" onclick="(function(){ hideSearchResults(); showProductDetails('${p.id}'); })()">${title}</button>`;
                }).join('');

                resultsBox.innerHTML = html;
                resultsBox.classList.remove('hidden');
            } catch (e) { /* noop */ }
        }

        function setActiveMobileNav(activeKey) {
            currentMobileNavKey = typeof activeKey === 'string' ? activeKey : null;
            const mapping = {
                home: DOMElements.mobileNavHomeBtn,
                categories: DOMElements.mobileNavCategoriesBtn,
                cart: DOMElements.mobileNavCartBtn,
                profile: DOMElements.mobileNavProfileBtn,
            };

            Object.entries(mapping).forEach(([key, btn]) => {
                if (!btn) return;
                const isActive = key === currentMobileNavKey;
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                btn.classList.toggle('text-theme-blue', isActive);
                btn.classList.toggle('text-gray-500', !isActive);
                btn.classList.toggle('dark:text-theme-blue', isActive);
                btn.classList.toggle('dark:text-gray-300', !isActive);
            });
        }

        function setupMobileFooterNav() {
            if (!DOMElements.mobileFooterNav) return;
            const { mobileNavHomeBtn, mobileNavCategoriesBtn, mobileNavCartBtn, mobileNavProfileBtn } = DOMElements;

            if (mobileNavHomeBtn && mobileNavHomeBtn.dataset.bound !== 'true') {
                mobileNavHomeBtn.addEventListener('click', () => {
                    closeDrawer();
                    showPage('home-page');
                });
                mobileNavHomeBtn.dataset.bound = 'true';
            }

            if (mobileNavCategoriesBtn && mobileNavCategoriesBtn.dataset.bound !== 'true') {
                mobileNavCategoriesBtn.addEventListener('click', () => {
                    openMobileCategoriesDrawer();
                });
                mobileNavCategoriesBtn.dataset.bound = 'true';
            }

            if (mobileNavCartBtn && mobileNavCartBtn.dataset.bound !== 'true') {
                mobileNavCartBtn.addEventListener('click', () => {
                    openDrawer('cart-drawer');
                });
                mobileNavCartBtn.dataset.bound = 'true';
            }

            if (mobileNavProfileBtn && mobileNavProfileBtn.dataset.bound !== 'true') {
                mobileNavProfileBtn.addEventListener('click', () => {
                    openDrawer('profile-drawer');
                });
                mobileNavProfileBtn.dataset.bound = 'true';
            }

            setupMobileCategoryDrawer();
            setActiveMobileNav(baseMobileNavKey);
        }

        // --- Mobile categories drawer logic ---
        function setMobileCategoriesTitleFromKey(key) {
            const titleEl = DOMElements.mobileCategoriesTitle;
            if (!titleEl) return;
            titleEl.dataset.lang = key;
            titleEl.textContent = resolveLocalizedString(key);
        }

        function setMobileCategoriesTitleText(text) {
            const titleEl = DOMElements.mobileCategoriesTitle;
            if (!titleEl) return;
            delete titleEl.dataset.lang;
            titleEl.textContent = text;
        }

        function renderMobileCategoriesMainView() {
            const listEl = DOMElements.mobileCategoriesList;
            if (!listEl) return;

            mobileCategoriesActiveCategory = null;
            const subContainer = DOMElements.mobileSubcategoriesContainer;
            if (subContainer) subContainer.classList.add('hidden');
            listEl.classList.remove('hidden');

            if (DOMElements.mobileSubcategoriesLead) {
                DOMElements.mobileSubcategoriesLead.dataset.lang = 'choose-subcategory';
                DOMElements.mobileSubcategoriesLead.textContent = resolveLocalizedString('choose-subcategory');
            }

            const cardClass = 'flex flex-col items-center justify-center gap-2 px-4 py-5 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-center text-gray-700 dark:text-gray-100 text-sm font-semibold shadow-sm hover:border-theme-blue hover:text-theme-blue transition-colors';
            const iconWrapClass = 'inline-flex items-center justify-center w-12 h-12 rounded-full bg-theme-purple/10 text-theme-purple dark:bg-theme-blue/10 dark:text-theme-blue text-xl';

            const cards = HEADER_CATEGORY_GROUPS.map(group => {
                const iconClass = getCategoryIconClass(group.id);
                const label = getCategoryLabel(group.id);
                return `<button type="button" class="${cardClass}" data-category="${group.id}"><span class="${iconWrapClass}"><i class="fas ${iconClass}"></i></span><span>${label}</span></button>`;
            }).join('');

            listEl.innerHTML = cards || `<p class="col-span-2 text-center text-sm text-gray-500 dark:text-gray-300">${resolveLocalizedString('categories')}</p>`;

            listEl.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const categoryId = btn.dataset.category;
                    showMobileSubcategories(categoryId);
                });
            });

            if (DOMElements.mobileCategoriesBackBtn) {
                DOMElements.mobileCategoriesBackBtn.classList.add('hidden');
            }
            setMobileCategoriesTitleFromKey('all-categories');
        }

        function showMobileSubcategories(categoryId) {
            const subContainer = DOMElements.mobileSubcategoriesContainer;
            const subList = DOMElements.mobileSubcategoriesList;
            const mainList = DOMElements.mobileCategoriesList;
            if (!subContainer || !subList || !mainList) return;

            const canonical = resolveCategoryId(categoryId);
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            if (!group) {
                filterProducts(canonical);
                closeDrawer();
                return;
            }

            const items = Array.isArray(group.items) ? group.items : [];
            const categoryLabel = getCategoryLabel(canonical);

            if (!items.length) {
                filterProducts(canonical);
                closeDrawer();
                return;
            }

            mobileCategoriesActiveCategory = canonical;
            mainList.classList.add('hidden');
            subContainer.classList.remove('hidden');

            const buttonClass = 'flex items-center gap-3 px-4 py-3 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-sm font-semibold text-gray-700 dark:text-gray-100 shadow-sm hover:border-theme-blue hover:text-theme-blue transition-colors';
            const allWord = translations[currentLanguage]?.['all-in-category'] || (currentLanguage === 'bn' ? 'সকল' : 'All in');
            const allLabel = `${allWord} ${categoryLabel}`;

            const parts = [`<button type="button" class="${buttonClass}" data-subcategory="__all__">${allLabel}</button>`];

            items.forEach(item => {
                const rawValue = item?.value || item?.label?.en || item?.label?.bn;
                if (!rawValue) return;
                const display = item?.label?.[currentLanguage] || item?.label?.en || item?.label?.bn || rawValue;
                const encoded = encodeURIComponent(String(rawValue));
                parts.push(`<button type="button" class="${buttonClass}" data-subcategory="${encoded}">${display}</button>`);
            });

            subList.innerHTML = parts.join('');

            subList.querySelectorAll('[data-subcategory]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.dataset.subcategory;
                    if (value === '__all__') {
                        filterProducts(canonical);
                    } else {
                        const decoded = decodeURIComponent(value);
                        filterSubCategory(canonical, decoded);
                    }
                    closeDrawer();
                });
            });

            if (DOMElements.mobileCategoriesBackBtn) {
                DOMElements.mobileCategoriesBackBtn.classList.remove('hidden');
            }
            if (DOMElements.mobileSubcategoriesLead) {
                DOMElements.mobileSubcategoriesLead.dataset.lang = 'choose-subcategory';
                DOMElements.mobileSubcategoriesLead.textContent = resolveLocalizedString('choose-subcategory');
            }
            setMobileCategoriesTitleText(categoryLabel);
        }

        function setupMobileCategoryDrawer() {
            const backBtn = DOMElements.mobileCategoriesBackBtn;
            if (backBtn && backBtn.dataset.bound !== 'true') {
                backBtn.addEventListener('click', () => {
                    renderMobileCategoriesMainView();
                });
                backBtn.dataset.bound = 'true';
            }
        }

        function openMobileCategoriesDrawer() {
            renderMobileCategoriesMainView();
            openDrawer('mobile-categories-drawer');
        }

        function handleProfileQuickAction(action) {
            if (!action) return;

            switch (action) {
                case 'edit': {
                    const profileDrawer = document.getElementById('profile-drawer');
                    const isDrawerActive = profileDrawer?.classList.contains('active');
                    if (!isDrawerActive) {
                        openDrawer('profile-drawer');
                    }
                    if (!currentUser || currentUser.isAnonymous) {
                        toggleAuthForms('login');
                        return;
                    }
                    if (DOMElements.addressesSection) DOMElements.addressesSection.classList.add('hidden');
                    if (DOMElements.profileDrawerTitle) {
                        DOMElements.profileDrawerTitle.dataset.lang = 'edit-profile';
                        updateTextContent();
                    }
                    if (DOMElements.editProfileBtn) {
                        DOMElements.editProfileBtn.click();
                    }
                    break;
                }
                case 'orders':
                    closeDrawer();
                    showPage('my-orders-page');
                    break;
                case 'addresses':
                    openManageAddresses();
                    break;
                case 'support':
                    closeDrawer();
                    showPage('support-page');
                    break;
                default:
                    break;
            }
        }

        function setupProfileQuickActions() {
            if (DOMElements.mobileProfileToggleBtn && DOMElements.mobileProfileToggleBtn.dataset.bound !== 'true') {
                DOMElements.mobileProfileToggleBtn.addEventListener('click', () => toggleMobileProfileDetails(DOMElements.mobileProfileToggleBtn));
                DOMElements.mobileProfileToggleBtn.dataset.bound = 'true';
            }

            if (Array.isArray(DOMElements.profileQuickActions)) {
                DOMElements.profileQuickActions.forEach((btn) => {
                    if (!btn || btn.dataset.bound === 'true') return;
                    btn.addEventListener('click', () => handleProfileQuickAction(btn.dataset.action));
                    btn.dataset.bound = 'true';
                });
            }
        }

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += `<i class="fas fa-star text-yellow-400"></i>`;
            if (halfStar) starsHtml += `<i class="fas fa-star-half-alt text-yellow-400"></i>`;
            for (let i = 0; i < 5 - fullStars - (halfStar ? 1 : 0); i++) starsHtml += `<i class="far fa-star text-gray-300"></i>`;
            return starsHtml;
        }

        // --- ADDRESS MANAGEMENT & SELECTION ---
        function generateAddressId() {
            return 'addr_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
        }

        function getUserAddresses() {
            return Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
        }

        function getDefaultAddress(addresses) {
            const arr = Array.isArray(addresses) ? addresses : [];
            return arr.find(a => a && a.isDefault) || null;
        }

        function openManageAddresses() {
            if (!currentUser || currentUser.isAnonymous) { openDrawer('profile-drawer'); return; }
            openDrawer('profile-drawer');
            if (DOMElements.profileDrawerTitle) {
                DOMElements.profileDrawerTitle.dataset.lang = 'manage-address';
                updateTextContent();
            }
            if (DOMElements.userProfileView) DOMElements.userProfileView.classList.remove('hidden');
            if (DOMElements.editProfileForm) DOMElements.editProfileForm.classList.add('hidden');
            if (DOMElements.addressesSection) DOMElements.addressesSection.classList.remove('hidden');
            renderAddressesList();
            resetAddressForm();
        }
        window.openManageAddresses = openManageAddresses;

        function resetAddressForm() {
            if (!DOMElements.addressForm) return;
            DOMElements.addressFormTitle.textContent = resolveLocalizedString('address-form-title') || 'Add New Address';
            DOMElements.addrIdHidden.value = '';
            DOMElements.addrName.value = '';
            DOMElements.addrMobile.value = '';
            DOMElements.addrLine1.value = '';
            DOMElements.addrLine2.value = '';
            DOMElements.addrCity.value = '';
            DOMElements.addrArea.value = '';
            DOMElements.addrDefault.checked = false;
        }

        function renderAddressesList() {
            const list = DOMElements.addressesList; if (!list) return;
            const addrs = getUserAddresses();
            if (!addrs.length) {
                list.innerHTML = '<p class="text-sm text-gray-500">No saved addresses. Add one below.</p>';
                return;
            }
            list.innerHTML = addrs.map(addr => {
                const title = `${addr.name || ''} ${addr.isDefault ? '<span class=\'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700\'>Default</span>' : ''}`;
                const line = [addr.line1, addr.line2, addr.city, addr.area].filter(Boolean).join(', ');
                return `
                    <div class="p-3 border rounded-xl bg-white dark:bg-gray-800 flex items-start justify-between gap-3">
                        <div>
                            <p class="font-medium">${title}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-300">${line}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-300">📱 ${addr.mobile || ''}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="text-sm px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 edit-address-btn" data-id="${addr.id}">Edit</button>
                            <button class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200 delete-address-btn" data-id="${addr.id}">Delete</button>
                            ${addr.isDefault ? '' : `<button class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200 set-default-address-btn" data-id="${addr.id}">Set Default</button>`}
                        </div>
                    </div>`;
            }).join('');

            list.querySelectorAll('.edit-address-btn').forEach(btn => btn.addEventListener('click', () => {
                const id = btn.dataset.id; const addr = getUserAddresses().find(a => a.id === id); if (!addr) return;
                DOMElements.addressFormTitle.textContent = 'Edit Address';
                DOMElements.addrIdHidden.value = addr.id || '';
                DOMElements.addrName.value = addr.name || '';
                DOMElements.addrMobile.value = addr.mobile || '';
                DOMElements.addrLine1.value = addr.line1 || '';
                DOMElements.addrLine2.value = addr.line2 || '';
                DOMElements.addrCity.value = addr.city || '';
                DOMElements.addrArea.value = addr.area || '';
                DOMElements.addrDefault.checked = !!addr.isDefault;
            }));
            list.querySelectorAll('.delete-address-btn').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.dataset.id; await deleteAddress(id);
            }));
            list.querySelectorAll('.set-default-address-btn').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.dataset.id; await setDefaultAddress(id);
            }));
        }

        async function saveNewAddress(addressData) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const newAddr = { ...addressData };
            let updated = [...addrs, newAddr];
            if (newAddr.isDefault) {
                updated = updated.map(a => ({ ...a, isDefault: a.id === newAddr.id }));
            }
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address saved!', true),
                onError: () => showToast('Failed to save address', false)
            });
        }

        async function updateAddress(addressId, updatedAddressData) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            let updated = addrs.map(a => a.id === addressId ? { ...a, ...updatedAddressData } : a);
            if (updatedAddressData.isDefault) {
                updated = updated.map(a => ({ ...a, isDefault: a.id === addressId }));
            }
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address updated!', true),
                onError: () => showToast('Failed to update address', false)
            });
        }

        async function deleteAddress(addressId) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const updated = addrs.filter(a => a.id !== addressId);
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address deleted', true),
                onError: () => showToast('Failed to delete address', false)
            });
            if (selectedShippingAddressId === addressId) {
                selectedShippingAddressId = null; selectedShippingAddress = null;
            }
        }

        async function setDefaultAddress(addressId) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const updated = addrs.map(a => ({ ...a, isDefault: a.id === addressId }));
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Default address set', true),
                onError: () => showToast('Failed to set default', false)
            });
        }

        function renderSelectedShippingAddress() {
            const box = DOMElements.selectedAddressDisplay; if (!box) return;
            if (selectedShippingAddress) {
                const a = selectedShippingAddress;
                const line = [a.line1, a.line2, a.city, a.area].filter(Boolean).join(', ');
                box.textContent = `${a.name || ''} — ${line} — 📱 ${a.mobile || ''}`;
            } else {
                const addrs = getUserAddresses();
                if (addrs.length > 0) {
                    const def = getDefaultAddress(addrs) || addrs[0];
                    selectedShippingAddress = def; selectedShippingAddressId = def?.id || null;
                    return renderSelectedShippingAddress();
                }
                // Legacy fallback
                if (currentUserData?.location || currentUserData?.mobile) {
                    box.textContent = `${currentUser?.displayName || ''} — ${currentUserData.location || ''} — 📱 ${currentUserData.mobile || ''}`;
                } else {
                    box.textContent = 'No address selected';
                }
            }
        }

        function renderAddressSelectList() {
            const list = DOMElements.addressSelectList; if (!list) return;
            const addrs = getUserAddresses();
            if (!addrs.length) { list.innerHTML = '<p class="text-sm text-gray-500">No saved addresses</p>'; return; }
            list.innerHTML = addrs.map(a => {
                const line = [a.line1, a.line2, a.city, a.area].filter(Boolean).join(', ');
                const checked = a.id === selectedShippingAddressId ? 'checked' : '';
                return `<label class="flex items-start gap-3 p-2 border rounded-lg cursor-pointer">
                    <input type="radio" name="select-address" class="mt-1" value="${a.id}" ${checked} />
                    <div>
                        <p class="font-medium">${a.name || ''} ${a.isDefault ? '<span class=\'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700\'>Default</span>' : ''}</p>
                        <p class="text-sm text-gray-600">${line}</p>
                        <p class="text-sm text-gray-600">📱 ${a.mobile || ''}</p>
                    </div>
                </label>`;
            }).join('');
        }

        function selectAddressById(id) {
            const addrs = getUserAddresses();
            selectedShippingAddressId = id;
            selectedShippingAddress = addrs.find(a => a.id === id) || null;
            renderSelectedShippingAddress();
        }

        // Wire up address UI events
        if (DOMElements.manageAddressesBtn) {
            DOMElements.manageAddressesBtn.addEventListener('click', openManageAddresses);
        }
        if (DOMElements.cancelAddressBtn) {
            DOMElements.cancelAddressBtn.addEventListener('click', () => resetAddressForm());
        }
        if (DOMElements.addressForm) {
            DOMElements.addressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    id: DOMElements.addrIdHidden.value || generateAddressId(),
                    name: DOMElements.addrName.value.trim(),
                    mobile: DOMElements.addrMobile.value.trim(),
                    line1: DOMElements.addrLine1.value.trim(),
                    line2: DOMElements.addrLine2.value.trim(),
                    city: DOMElements.addrCity.value.trim(),
                    area: DOMElements.addrArea.value.trim(),
                    isDefault: !!DOMElements.addrDefault.checked,
                };
                if (!data.name || !data.mobile || !data.line1) { showToast('Please fill required fields', false); return; }
                const editingId = DOMElements.addrIdHidden.value;
                if (editingId) {
                    await updateAddress(editingId, data);
                } else {
                    await saveNewAddress(data);
                }
                resetAddressForm();
                renderAddressesList();
            });
        }
        if (DOMElements.changeAddressBtn) {
            DOMElements.changeAddressBtn.addEventListener('click', () => {
                if (!DOMElements.addressSelectPanel) return;
                DOMElements.addressSelectPanel.classList.toggle('hidden');
                renderAddressSelectList();
            });
        }
        if (DOMElements.useSelectedAddressBtn) {
            DOMElements.useSelectedAddressBtn.addEventListener('click', () => {
                const picked = document.querySelector('input[name="select-address"]:checked');
                if (picked) selectAddressById(picked.value);
                if (DOMElements.addressSelectPanel) DOMElements.addressSelectPanel.classList.add('hidden');
            });
        }
        if (DOMElements.manageAddressesShortcut) {
            DOMElements.manageAddressesShortcut.addEventListener('click', () => {
                closePaymentModal();
                openManageAddresses();
            });
        }
        // --- END ADDRESS MANAGEMENT & SELECTION ---

        function renderProducts(productsToRender) {
            // Keep a reference of the unfiltered list to re-apply on sort/filter changes
            lastBaseProducts = Array.isArray(productsToRender) ? productsToRender.slice() : [];
            // Ensure toolbar and filters UI are present
            ensureListingToolbar();

            // Reset page when base set changes
            const key = Array.isArray(lastBaseProducts) ? lastBaseProducts.map(p => p && p.id).join('|') : '';
            if (key !== lastRenderKey) { currentPage = 1; lastRenderKey = key; }

            // Apply filters (only when a category/subcategory is active), then sorting
            const filtered = applyFilters(lastBaseProducts);
            const sorted = applySorting(filtered);
            currentDisplayedProducts = sorted;

            // Paging calculations
            const total = sorted.length;
            const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const startIdx = (currentPage - 1) * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, total);
            const pageItems = sorted.slice(startIdx, endIdx);

            DOMElements.productList.innerHTML = '';
            if (pageItems.length === 0) {
                 DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">${translations[currentLanguage]['no-products']}</p>`;
                 renderPagination(0);
                 return;
            }
            const fragment = document.createDocumentFragment();
            pageItems.forEach(product => {
                const productCard = document.createElement('div');
                const isWished = localWishlistCache.has(product.id);
                const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
                const imageUrl = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';
                const localeStrings = translations[currentLanguage] || translations.en || {};
                const basePrice = Number(product.basePrice) || Number(product.originalPrice) || Number(product.price) || 0;
                const nowMs = Date.now();
                const flashInfo = (product.flashSale && product.flashSale.enabled) ? product.flashSale : null;
                let displayPrice = Number(product.price) || 0;
                let comparePrice = product.originalPrice && product.originalPrice > displayPrice ? product.originalPrice : null;
                let flashStatus = null;
                if (flashInfo) {
                    const startTs = flashInfo.start instanceof Date ? flashInfo.start.getTime() : null;
                    const endTs = flashInfo.end instanceof Date ? flashInfo.end.getTime() : null;
                    const isActive = (!startTs || startTs <= nowMs) && (!endTs || endTs > nowMs);
                    const isUpcoming = !isActive && startTs && startTs > nowMs;
                    if (isActive) {
                        if (flashInfo.price && flashInfo.price > 0 && flashInfo.price < displayPrice) {
                            if (!comparePrice || comparePrice < basePrice) {
                                comparePrice = basePrice;
                            }
                            displayPrice = flashInfo.price;
                        }
                        flashStatus = 'active';
                    } else if (isUpcoming) {
                        flashStatus = 'upcoming';
                    }
                }

                if (!comparePrice && basePrice && basePrice > displayPrice) {
                    comparePrice = basePrice;
                }

                let discountPercent = null;
                if (comparePrice && comparePrice > displayPrice) {
                    discountPercent = Math.round(((comparePrice - displayPrice) / comparePrice) * 100);
                }

                let priceHtml = `<span class="text-xl font-bold text-price-black">৳${displayPrice.toFixed(2)}</span>`;
                if (discountPercent !== null) {
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-xl font-bold text-price-black">৳${displayPrice.toFixed(2)}</span>
                            <span class="text-sm text-gray-400 line-through">৳${comparePrice.toFixed(2)}</span>
                            <span class="text-xs font-bold text-red-500">-${discountPercent}%</span>
                        </div>`;
                }

                const badgePieces = [];
                if (flashStatus === 'active' || flashStatus === 'upcoming') {
                    const flashKey = flashStatus === 'active' ? 'flash-sale-badge' : 'flash-sale-upcoming';
                    const flashLabel = localeStrings[flashKey] || (flashStatus === 'active' ? 'FLASH' : 'UPCOMING');
                    badgePieces.push(`<span class="inline-flex items-center justify-center uppercase text-[10px] font-semibold tracking-[0.3em] bg-theme-purple text-white px-3 py-1 rounded-full">${flashLabel}</span>`);
                }
                if (product.isOffer && discountPercent !== null && flashStatus !== 'active') {
                    const offerLabel = currentLanguage === 'bn' ? 'অফার' : 'OFFER';
                    badgePieces.push(`<span class="inline-flex items-center justify-center text-[10px] font-semibold tracking-[0.2em] bg-red-500 text-white px-3 py-1 rounded-full">${offerLabel}</span>`);
                }
                const badgesWrapper = badgePieces.length ? `<div class="absolute top-2 left-2 flex flex-col gap-2">${badgePieces.join('')}</div>` : '';

                const isOutOfStock = Number(product.stock) <= 0;
                const cartButtonText = isOutOfStock ? translations[currentLanguage]['out-of-stock'] : translations[currentLanguage]['add-to-cart'];
                const cartButtonClasses = isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-theme-blue hover:bg-theme-purple';
                const cartButtonDisabled = isOutOfStock ? 'disabled' : '';

                productCard.className = 'product-card relative bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden transform transition-transform hover:-translate-y-2 hover:shadow-2xl flex flex-col';
                productCard.dataset.productId = product.id;
                productCard.innerHTML = `
                    <div class="relative">
                        ${badgesWrapper}
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image';">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                         <h3 class="product-title font-semibold text-lg text-dark mb-2 cursor-pointer h-12 overflow-hidden">${product.name}</h3>
                         <div class="flex items-center text-sm mb-2">
                            ${renderStars(product.rating || 0)}
                            <span class="text-xs text-gray-500 ml-2">(${product.ratingCount || 0})</span>
                        </div>
                        <div class="mt-auto">
                            <div class="mt-2 mb-4">${priceHtml}</div>
                            <div class="flex items-center justify-between">
                                <button class="add-to-cart text-white py-2 px-4 rounded-full transition-colors shadow-lg ${cartButtonClasses}" ${cartButtonDisabled} data-product-id="${product.id}">${cartButtonText}</button>
                                <button class="wishlist text-2xl transition-colors" data-product-id="${product.id}"><i class="${heartClass} fa-heart"></i></button>
                            </div>
                        </div>
                    </div>`;
                fragment.appendChild(productCard);
            });
            DOMElements.productList.appendChild(fragment);
            // Update filter UI values for current base set
            try { renderFiltersUI(); } catch (e) {}
            // If viewing all products, show the featured header
            if (currentCategory === null && currentSubCategory === null) {
                DOMElements.currentCategoryTitle.dataset.lang = 'featured-products';
                DOMElements.currentCategoryTitle.textContent = translations[currentLanguage]['featured-products'];
            }
            // Keep the top category strip synced whenever products render
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (e) {}
            }
            // Removed redundant updateCategoryHeader call, which caused the error when dataset was accessed from null.
            // Render pagination controls for current dataset
            renderPagination(total);
        }

        function clearFlashSaleTimerInterval() {
            if (flashSaleIntervalId) {
                clearInterval(flashSaleIntervalId);
                flashSaleIntervalId = null;
            }
        }

        function updateFlashSaleTimers(initialRun = false) {
            if (!flashSaleCountdowns || flashSaleCountdowns.size === 0) {
                clearFlashSaleTimerInterval();
                if (DOMElements.flashSaleMasterCountdown) {
                    DOMElements.flashSaleMasterCountdown.textContent = '--:--:--';
                }
                return;
            }

            const now = Date.now();
            let earliestTarget = null;
            let activeCount = 0;
            let upcomingCount = 0;
            let needsRerender = false;
            const localeStrings = translations[currentLanguage] || translations.en || {};

            flashSaleCountdowns.forEach(entry => {
                if (!entry || !entry.countdownEl) return;

                if (entry.status === 'active') {
                    if (Number.isFinite(entry.endTime)) {
                        const remaining = entry.endTime - now;
                        if (remaining <= 0) {
                            entry.status = 'expired';
                            needsRerender = true;
                            return;
                        }
                        entry.countdownEl.textContent = formatCountdown(remaining);
                        earliestTarget = earliestTarget === null ? entry.endTime : Math.min(earliestTarget, entry.endTime);
                    } else {
                        entry.countdownEl.textContent = '--:--:--';
                    }
                    activeCount += 1;
                } else if (entry.status === 'upcoming') {
                    if (Number.isFinite(entry.startTime)) {
                        const remaining = entry.startTime - now;
                        if (remaining <= 0) {
                            entry.status = 'active';
                            needsRerender = true;
                            return;
                        }
                        entry.countdownEl.textContent = formatCountdown(remaining);
                        earliestTarget = earliestTarget === null ? entry.startTime : Math.min(earliestTarget, entry.startTime);
                    } else {
                        entry.countdownEl.textContent = '--:--:--';
                    }
                    upcomingCount += 1;
                }
            });

            if (needsRerender && !initialRun) {
                renderFlashSaleSection(productsData);
                return;
            }

            const countdownLabelEl = DOMElements.flashSaleCountdownLabel;
            const masterCountdown = DOMElements.flashSaleMasterCountdown;
            const labelKey = activeCount > 0 ? 'flash-sale-countdown-label' : 'flash-sale-countdown-starts';

            if (countdownLabelEl) {
                countdownLabelEl.dataset.lang = labelKey;
                countdownLabelEl.textContent = localeStrings[labelKey] || countdownLabelEl.textContent;
            }

            if (masterCountdown) {
                if (Number.isFinite(earliestTarget) && earliestTarget > now) {
                    masterCountdown.textContent = formatCountdown(earliestTarget - now);
                } else {
                    masterCountdown.textContent = '--:--:--';
                }
            }

            if (flashSaleCountdowns.size === 0 || (activeCount === 0 && upcomingCount === 0)) {
                clearFlashSaleTimerInterval();
            }
        }

        function renderFlashSaleSection(sourceProducts = productsData) {
            const section = DOMElements.flashSaleSection;
            const grid = DOMElements.flashSaleGrid;
            const emptyState = DOMElements.flashSaleEmpty;
            const masterCountdown = DOMElements.flashSaleMasterCountdown;
            const countdownLabelEl = DOMElements.flashSaleCountdownLabel;
            if (!section || !grid || !masterCountdown || !countdownLabelEl) return;

            const localeStrings = translations[currentLanguage] || translations.en || {};
            const productsArray = Array.isArray(sourceProducts) ? sourceProducts : [];
            const now = Date.now();

            flashSaleCountdowns.clear();
            clearFlashSaleTimerInterval();

            const deals = productsArray.map(product => {
                const flashInfo = product?.flashSale;
                if (!flashInfo || flashInfo.enabled !== true) return null;

                const startTime = flashInfo.start instanceof Date ? flashInfo.start.getTime() : null;
                const endTime = flashInfo.end instanceof Date ? flashInfo.end.getTime() : null;
                let status = 'active';
                if (Number.isFinite(endTime) && endTime <= now) {
                    status = 'expired';
                } else if (Number.isFinite(startTime) && startTime > now) {
                    status = 'upcoming';
                }
                if (status === 'expired') return null;

                const flashPriceRaw = Number(flashInfo.price);
                const productPrice = Number(product.price) || 0;
                const displayPrice = flashPriceRaw > 0 ? flashPriceRaw : productPrice;
                const regularBase = Number(product.basePrice) || Number(product.originalPrice) || productPrice;
                const comparePrice = regularBase > displayPrice ? regularBase : null;
                const countdownTarget = status === 'active' ? endTime : (status === 'upcoming' ? startTime : null);

                return {
                    product,
                    status,
                    startTime,
                    endTime,
                    displayPrice,
                    comparePrice,
                    countdownTarget
                };
            }).filter(Boolean);

            if (!deals.length) {
                grid.innerHTML = '';
                if (emptyState) emptyState.classList.add('hidden');
                section.classList.add('hidden');
                masterCountdown.textContent = '--:--:--';
                countdownLabelEl.dataset.lang = 'flash-sale-countdown-label';
                countdownLabelEl.textContent = localeStrings['flash-sale-countdown-label'] || countdownLabelEl.textContent;
                return;
            }

            deals.sort((a, b) => {
                const rank = { active: 0, upcoming: 1 };
                const aRank = rank[a.status] ?? 2;
                const bRank = rank[b.status] ?? 2;
                if (aRank !== bRank) return aRank - bRank;
                const aTarget = Number.isFinite(a.countdownTarget) ? a.countdownTarget : Number.MAX_SAFE_INTEGER;
                const bTarget = Number.isFinite(b.countdownTarget) ? b.countdownTarget : Number.MAX_SAFE_INTEGER;
                return aTarget - bTarget;
            });

            const visibleDeals = deals.slice(0, 4);

            grid.innerHTML = '';
            section.classList.remove('hidden');
            if (emptyState) emptyState.classList.add('hidden');

            let earliestTarget = null;
            visibleDeals.forEach(deal => {
                const { product, status, displayPrice, comparePrice, countdownTarget } = deal;
                const productId = product.id;
                const safeName = escapeHtml(product.name || '');
                const imageUrl = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';
                const ratingHtml = renderStars(product.rating || 0);
                const ratingCount = product.ratingCount || 0;
                const badgeKey = status === 'upcoming' ? 'flash-sale-upcoming' : 'flash-sale-badge';
                const badgeLabel = localeStrings[badgeKey] || (status === 'upcoming' ? 'UPCOMING' : 'FLASH');
                const cardCountdownLabelKey = status === 'upcoming' ? 'flash-sale-countdown-starts' : 'flash-sale-countdown-label';
                const cardCountdownLabel = localeStrings[cardCountdownLabelKey] || (status === 'upcoming' ? 'Starts in' : 'Ends in');
                const isWished = localWishlistCache.has(productId);
                const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
                const isOutOfStock = Number(product.stock) <= 0;
                let buttonLabel;
                let buttonDisabled = '';
                let buttonClasses;
                if (status === 'upcoming') {
                    buttonLabel = localeStrings['flash-sale-coming-soon'] || 'Coming Soon';
                    buttonDisabled = 'disabled';
                    buttonClasses = 'bg-gray-400 cursor-not-allowed';
                } else if (isOutOfStock) {
                    buttonLabel = localeStrings['out-of-stock'] || 'Out of Stock';
                    buttonDisabled = 'disabled';
                    buttonClasses = 'bg-gray-400 cursor-not-allowed';
                } else {
                    buttonLabel = localeStrings['add-to-cart'] || 'Add to Cart';
                    buttonClasses = 'bg-theme-blue hover:bg-theme-purple';
                }

                let priceHtml = `<span class="text-2xl font-bold text-price-black">৳${displayPrice.toFixed(2)}</span>`;
                if (comparePrice && comparePrice > displayPrice) {
                    const discountPercent = Math.round(((comparePrice - displayPrice) / comparePrice) * 100);
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-2xl font-bold text-price-black">৳${displayPrice.toFixed(2)}</span>
                            <span class="text-sm text-gray-400 line-through">৳${comparePrice.toFixed(2)}</span>
                            <span class="text-xs font-bold text-red-500">-${discountPercent}%</span>
                        </div>`;
                }

                const card = document.createElement('article');
                card.className = 'flash-sale-card product-card relative flex flex-col bg-white dark:bg-gray-900 rounded-3xl shadow-lg border border-theme-pink/30 overflow-hidden transform transition-transform hover:-translate-y-2 hover:shadow-2xl';
                card.dataset.productId = productId;
                card.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" alt="${safeName}" class="w-full h-40 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image';">
                        <div class="absolute top-3 left-3 flex flex-col gap-2">
                            <span class="flash-sale-label flash-sale-status-badge inline-flex items-center justify-center uppercase text-[10px] font-semibold tracking-[0.3em] bg-theme-purple text-white px-3 py-1 rounded-full">${badgeLabel}</span>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col gap-3 flex-grow">
                        <div>
                            <h3 class="product-title font-semibold text-base sm:text-lg text-dark dark:text-gray-100 leading-snug cursor-pointer">${safeName}</h3>
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mt-1.5 gap-2">
                                ${ratingHtml}
                                <span>(${ratingCount})</span>
                            </div>
                        </div>
                        <div>${priceHtml}</div>
                        <div class="mt-auto flex items-center justify-between gap-2.5">
                            <button class="flash-sale-action add-to-cart text-white py-2 px-4 rounded-full transition-colors shadow ${buttonClasses}" ${buttonDisabled} data-product-id="${productId}">${buttonLabel}</button>
                            <button class="wishlist text-2xl transition-colors" data-product-id="${productId}"><i class="${heartClass} fa-heart"></i></button>
                        </div>
                        <div class="flex items-center justify-between mt-3 pt-2 border-t border-dashed border-theme-purple/30">
                            <span class="flash-sale-countdown-label-card text-[10px] uppercase tracking-widest text-theme-purple font-semibold">${cardCountdownLabel}</span>
                            <span class="flash-sale-countdown-display flash-sale-countdown text-sm font-bold text-theme-purple">${Number.isFinite(countdownTarget) ? formatCountdown(countdownTarget - now) : '--:--:--'}</span>
                        </div>
                    </div>`;

                grid.appendChild(card);

                const countdownEl = card.querySelector('.flash-sale-countdown-display');
                const statusBadgeEl = card.querySelector('.flash-sale-status-badge');
                const labelEl = card.querySelector('.flash-sale-countdown-label-card');

                flashSaleCountdowns.set(productId, {
                    product,
                    status,
                    startTime: deal.startTime,
                    endTime: deal.endTime,
                    countdownEl,
                    statusBadgeEl,
                    labelEl,
                    countdownTarget
                });

                if (Number.isFinite(countdownTarget)) {
                    earliestTarget = earliestTarget === null ? countdownTarget : Math.min(earliestTarget, countdownTarget);
                }
            });

            const labelKey = visibleDeals.some(d => d.status === 'active') ? 'flash-sale-countdown-label' : 'flash-sale-countdown-starts';
            countdownLabelEl.dataset.lang = labelKey;
            countdownLabelEl.textContent = localeStrings[labelKey] || countdownLabelEl.textContent;

            if (Number.isFinite(earliestTarget)) {
                masterCountdown.textContent = formatCountdown(earliestTarget - now);
            } else {
                masterCountdown.textContent = '--:--:--';
            }

            const hasCountdown = Array.from(flashSaleCountdowns.values()).some(entry => {
                if (!entry) return false;
                const target = entry.status === 'active' ? entry.endTime : entry.startTime;
                return Number.isFinite(target);
            });

            updateFlashSaleTimers(true);

            if (hasCountdown) {
                flashSaleIntervalId = setInterval(() => updateFlashSaleTimers(false), 1000);
            }
        }

        function renderMegaSaleSection(sourceProducts = productsData) {
            const section = DOMElements.megaSaleSection;
            const grid = DOMElements.megaSaleGrid;
            const emptyState = DOMElements.megaSaleEmpty;
            if (!section || !grid || !emptyState) return;

            const localeStrings = translations[currentLanguage] || translations.en || {};
            const productsArray = Array.isArray(sourceProducts) ? sourceProducts : [];

            const deals = productsArray.map(product => {
                const mega = product?.megaSale;
                if (!mega || mega.enabled !== true) return null;
                if (product?.flashSale?.enabled) return null;
                const discount = typeof mega.discountPercent === 'number' ? mega.discountPercent : (product?.discountPercent || 0);
                return { product, mega, discount: Math.max(0, discount || 0) };
            }).filter(Boolean);

            if (!deals.length) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            emptyState.classList.add('hidden');

            deals.sort((a, b) => b.discount - a.discount);
            const visibleDeals = deals.slice(0, 4);

            grid.innerHTML = '';

            visibleDeals.forEach(({ product, mega, discount }) => {
                const productId = product.id;
                const safeName = escapeHtml(product.name || '');
                const imageUrl = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';
                const ratingHtml = renderStars(product.rating || 0);
                const ratingCount = product.ratingCount || 0;
                const isWished = localWishlistCache.has(productId);
                const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
                const isOutOfStock = Number(product.stock) <= 0;
                const badgeText = mega.label || localeStrings['mega-sale-badge'] || 'Mega Sale';
                const priceValue = Number(mega.price ?? product.price) || 0;
                const originalCandidate = Number.isFinite(mega.originalPrice)
                    ? Number(mega.originalPrice)
                    : (Number.isFinite(product.originalPrice) ? Number(product.originalPrice) : null);
                const originalValue = originalCandidate && originalCandidate > priceValue ? originalCandidate : null;

                let priceHtml = `<span class="text-2xl font-bold text-price-black">৳${priceValue.toFixed(2)}</span>`;
                if (originalValue && originalValue > priceValue) {
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-2xl font-bold text-price-black">৳${priceValue.toFixed(2)}</span>
                            <span class="text-sm text-gray-400 line-through">৳${originalValue.toFixed(2)}</span>
                            ${discount ? `<span class="text-xs font-bold text-theme-pink">-${discount}%</span>` : ''}
                        </div>`;
                } else if (discount) {
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-2xl font-bold text-price-black">৳${priceValue.toFixed(2)}</span>
                            <span class="text-xs font-bold text-theme-pink">-${discount}%</span>
                        </div>`;
                }

                const buttonLabel = isOutOfStock ? (localeStrings['out-of-stock'] || 'Out of Stock') : (localeStrings['add-to-cart'] || 'Add to Cart');
                const buttonClasses = isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-theme-blue hover:bg-theme-purple';
                const buttonDisabled = isOutOfStock ? 'disabled' : '';

                const card = document.createElement('article');
                card.className = 'mega-sale-card product-card relative flex flex-col bg-white dark:bg-gray-900 rounded-3xl shadow-lg border border-theme-purple/20 overflow-hidden transform transition-transform hover:-translate-y-2 hover:shadow-2xl';
                card.dataset.productId = productId;
                card.innerHTML = `
                    <div class="relative">
                        <img src="${imageUrl}" alt="${safeName}" class="w-full h-40 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image';">
                        <div class="absolute top-3 left-3 flex flex-col gap-2">
                            <span class="inline-flex items-center gap-2 bg-theme-purple text-white text-[11px] font-semibold tracking-wide px-3 py-1 rounded-full shadow">${badgeText}</span>
                            ${discount ? `<span class="inline-flex items-center gap-1 bg-white/90 text-theme-purple text-[11px] font-semibold px-2.5 py-1 rounded-full shadow-sm">-${discount}%</span>` : ''}
                        </div>
                    </div>
                    <div class="p-4 flex flex-col gap-3 flex-grow">
                        <div>
                            <h3 class="product-title font-semibold text-base sm:text-lg text-dark dark:text-gray-100 leading-snug cursor-pointer">${safeName}</h3>
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400 mt-1.5 gap-2">
                                ${ratingHtml}
                                <span>(${ratingCount})</span>
                            </div>
                        </div>
                        <div>${priceHtml}</div>
                        <div class="mt-auto flex items-center justify-between gap-2.5">
                            <button class="mega-sale-action add-to-cart text-white py-2 px-4 rounded-full transition-colors shadow ${buttonClasses}" ${buttonDisabled} data-product-id="${productId}">${buttonLabel}</button>
                            <button class="wishlist text-2xl transition-colors" data-product-id="${productId}"><i class="${heartClass} fa-heart"></i></button>
                        </div>
                    </div>`;

                grid.appendChild(card);
            });
        }

        // --- CATEGORY & SUB-CATEGORY LOGIC ---

        function getCategoryLabel(cat) {
            if (!cat) return '';
            const canonical = resolveCategoryId(cat);
            const fromGroups = HEADER_CATEGORY_GROUPS.find(group => group.id === canonical);
            if (fromGroups) {
                const localized = fromGroups.label?.[currentLanguage] || fromGroups.label?.en || fromGroups.label?.bn;
                if (localized) return localized;
            }
            // Map common slugs to existing translation keys
            const slug = String(cat).toLowerCase();
            const keyMap = {
                'books-stationery': 'cat-books',
                'sports-outdoors': 'cat-sports',
                'kids-toys': 'cat-kids',
                'home-garden': 'cat-home-garden',
                'health-beauty': 'cat-health-beauty',
                'cars-bikes': 'cat-cars', // in case data uses combined slug
                'cars': 'cat-cars'
            };
            const transKey = keyMap[slug] || `cat-${slug}`;
            const cur = translations[currentLanguage] || {};
            if (cur[transKey]) return cur[transKey];
            // Humanize slug fallback
            return slug.split(/[-_]/g).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        function getSubCategoryLabel(categoryId, subValue) {
            if (!categoryId || !subValue) return subValue || '';
            const canonical = resolveCategoryId(categoryId);
            const resolved = resolveSubCategoryValue(canonical, subValue);
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            const items = Array.isArray(group?.items) ? group.items : [];
            const match = items.find(item => {
                return slugifyCategoryText(item?.value) === slugifyCategoryText(resolved);
            });
            if (match) {
                return match.label?.[currentLanguage] || match.label?.en || match.label?.bn || subValue;
            }
            return resolved;
        }

        // Curated top categories to always show (merged with categories found in products)
        const HEADER_CATEGORY_GROUPS = [
            {
                id: 'electronics',
                label: { en: 'Electronics', bn: 'ইলেকট্রনিক্স' },
                items: [
                    { value: 'Mobile Phone', label: { en: 'Mobile Phone', bn: 'মোবাইল ফোন' } },
                    { value: 'Laptop & Computer', label: { en: 'Laptop & Computer', bn: 'ল্যাপটপ ও কম্পিউটার' } },
                    { value: 'Tablet', label: { en: 'Tablet', bn: 'ট্যাবলেট' } },
                    { value: 'TV & Home Theater', label: { en: 'TV & Home Theater', bn: 'টিভি ও হোম থিয়েটার' } },
                    { value: 'Headphone & Speaker', label: { en: 'Headphone & Speaker', bn: 'হেডফোন ও স্পিকার' } },
                    { value: 'Camera & Accessories', label: { en: 'Camera & Accessories', bn: 'ক্যামেরা ও এক্সেসরিজ' } },
                    { value: 'Wearable Smart Watch', label: { en: 'Wearable Smart Watch', bn: 'স্মার্ট ওয়াচ' } },
                    { value: 'Gaming Console', label: { en: 'Gaming Console', bn: 'গেমিং কনসোল' } }
                ]
            },
            {
                id: 'fashion',
                label: { en: 'Fashion', bn: 'ফ্যাশন' },
                items: [
                    { value: "Men's Clothing", label: { en: "Men's Clothing", bn: 'পুরুষদের পোশাক' } },
                    { value: "Women's Clothing", label: { en: "Women's Clothing", bn: 'নারীদের পোশাক' } },
                    { value: "Kids' Clothing", label: { en: "Kids' Clothing", bn: 'শিশুদের পোশাক' } },
                    { value: 'Shoes & Sandals', label: { en: 'Shoes & Sandals', bn: 'জুতা ও স্যান্ডেল' } },
                    { value: 'Watch & Jewelry', label: { en: 'Watch & Jewelry', bn: 'ঘড়ি ও জুয়েলারি' } },
                    { value: 'Bags & Accessories', label: { en: 'Bags & Accessories', bn: 'ব্যাগ ও এক্সেসরিজ' } },
                    { value: 'Traditional Wear', label: { en: 'Traditional Wear', bn: 'ঐতিহ্যবাহী পোশাক' } }
                ]
            },
            {
                id: 'home-garden',
                label: { en: 'Home & Garden', bn: 'হোম অ্যান্ড গার্ডেন' },
                items: [
                    { value: 'Furniture', label: { en: 'Furniture', bn: 'ফার্নিচার' } },
                    { value: 'Kitchen Items', label: { en: 'Kitchen Items', bn: 'রান্নাঘরের সামগ্রী' } },
                    { value: 'Home Decor', label: { en: 'Home Decor', bn: 'হোম ডেকর' } },
                    { value: 'Lighting', label: { en: 'Lighting', bn: 'লাইটিং' } },
                    { value: 'Garden Tools', label: { en: 'Garden Tools', bn: 'বাগানের যন্ত্র' } },
                    { value: 'Home Appliances', label: { en: 'Home Appliances', bn: 'হোম অ্যাপ্লায়েন্স' } },
                    { value: 'Storage & Organizer', label: { en: 'Storage & Organizer', bn: 'স্টোরেজ ও অর্গানাইজার' } }
                ]
            },
            {
                id: 'health-beauty',
                label: { en: 'Health & Beauty', bn: 'স্বাস্থ্য ও সৌন্দর্য' },
                items: [
                    { value: 'Skincare', label: { en: 'Skincare', bn: 'স্কিনকেয়ার' } },
                    { value: 'Haircare', label: { en: 'Haircare', bn: 'হেয়ারকেয়ার' } },
                    { value: 'Makeup', label: { en: 'Makeup', bn: 'মেকআপ' } },
                    { value: 'Perfume', label: { en: 'Perfume', bn: 'পারফিউম' } },
                    { value: 'Health Supplement', label: { en: 'Health Supplement', bn: 'স্বাস্থ্য সাপ্লিমেন্ট' } },
                    { value: 'Fitness Equipment', label: { en: 'Fitness Equipment', bn: 'ফিটনেস সরঞ্জাম' } },
                    { value: 'Personal Care', label: { en: 'Personal Care', bn: 'পার্সোনাল কেয়ার' } },
                    { value: 'Oral Care', label: { en: 'Oral Care', bn: 'ওরাল কেয়ার' } }
                ]
            },
            {
                id: 'sports-outdoors',
                label: { en: 'Sports & Outdoors', bn: 'খেলাধুলা ও আউটডোর' },
                items: [
                    { value: 'Sports Apparel', label: { en: 'Sports Apparel', bn: 'স্পোর্টস পোশাক' } },
                    { value: 'Sports Shoes', label: { en: 'Sports Shoes', bn: 'স্পোর্টস জুতা' } },
                    { value: 'Fitness Gear', label: { en: 'Fitness Gear', bn: 'ফিটনেস গিয়ার' } },
                    { value: 'Cycles', label: { en: 'Cycles', bn: 'সাইকেল' } },
                    { value: 'Gym Equipment', label: { en: 'Gym Equipment', bn: 'জিম সরঞ্জাম' } },
                    { value: 'Outdoor Camping Gear', label: { en: 'Outdoor Camping Gear', bn: 'ক্যাম্পিং সরঞ্জাম' } },
                    { value: 'Football, Cricket, Badminton Items', label: { en: 'Football, Cricket, Badminton Items', bn: 'ফুটবল, ক্রিকেট, ব্যাডমিন্টন সামগ্রী' } }
                ]
            },
            {
                id: 'books-stationery',
                label: { en: 'Books & Stationery', bn: 'বই ও স্টেশনারি' },
                items: [
                    { value: 'Educational Books', label: { en: 'Educational Books', bn: 'শিক্ষামূলক বই' } },
                    { value: 'Story Books', label: { en: 'Story Books', bn: 'গল্পের বই' } },
                    { value: 'Religious Books', label: { en: 'Religious Books', bn: 'ধর্মীয় বই' } },
                    { value: 'Office Stationery', label: { en: 'Office Stationery', bn: 'অফিস স্টেশনারি' } },
                    { value: 'School Stationery', label: { en: 'School Stationery', bn: 'স্কুল স্টেশনারি' } },
                    { value: 'Notebook & Diary', label: { en: 'Notebook & Diary', bn: 'নোটবুক ও ডায়েরি' } },
                    { value: 'Arts & Crafts Supplies', label: { en: 'Arts & Crafts Supplies', bn: 'আর্টস ও ক্রাফটস' } }
                ]
            },
            {
                id: 'kids-toys',
                label: { en: 'Kids & Toys', bn: 'বাচ্চা ও খেলনা' },
                items: [
                    { value: 'Educational Toys', label: { en: 'Educational Toys', bn: 'শিক্ষামূলক খেলনা' } },
                    { value: 'Soft Toys', label: { en: 'Soft Toys', bn: 'নরম খেলনা' } },
                    { value: 'Dolls & Action Figures', label: { en: 'Dolls & Action Figures', bn: 'পুতুল ও অ্যাকশন ফিগার' } },
                    { value: 'Games & Puzzles', label: { en: 'Games & Puzzles', bn: 'গেমস ও পাজল' } },
                    { value: 'Outdoor Toys', label: { en: 'Outdoor Toys', bn: 'বাইরের খেলনা' } },
                    { value: 'Remote Control Toys', label: { en: 'Remote Control Toys', bn: 'রিমোট কন্ট্রোল খেলনা' } },
                    { value: 'Lego & Building Blocks', label: { en: 'Lego & Building Blocks', bn: 'লেগো ও ব্লক' } }
                ]
            },
            {
                id: 'cars',
                label: { en: 'Cars & Bikes', bn: 'গাড়ি ও বাইক' },
                items: [
                    { value: 'Car Accessories', label: { en: 'Car Accessories', bn: 'গাড়ির এক্সেসরিজ' } },
                    { value: 'Bike Accessories', label: { en: 'Bike Accessories', bn: 'বাইকের এক্সেসরিজ' } },
                    { value: 'Helmets & Riding Gear', label: { en: 'Helmets & Riding Gear', bn: 'হেলমেট ও রাইডিং গিয়ার' } },
                    { value: 'Tires & Wheels', label: { en: 'Tires & Wheels', bn: 'টায়ার ও হুইল' } },
                    { value: 'Car Care Products', label: { en: 'Car Care Products', bn: 'গাড়ির যত্ন সামগ্রী' } },
                    { value: 'Motor Oil & Lubricants', label: { en: 'Motor Oil & Lubricants', bn: 'মটর তেল ও লুব্রিক্যান্ট' } },
                    { value: 'Electric Scooters & Bikes', label: { en: 'Electric Scooters & Bikes', bn: 'ইলেকট্রিক স্কুটার ও বাইক' } }
                ]
            }
        ];

        const CATEGORY_SYNONYM_OVERRIDES = {
            'electronics': ['electronics', 'Electronic Devices', 'ইলেকট্রনিক্স'],
            'fashion': ['fashion', 'Clothing', 'ফ্যাশন'],
            'home-garden': ['home & garden', 'home and garden', 'home', 'garden'],
            'health-beauty': ['health & beauty', 'beauty', 'স্বাস্থ্য ও সৌন্দর্য'],
            'sports-outdoors': ['sports', 'sports & outdoors', 'outdoor', 'খেলাধুলা'],
            'books-stationery': ['books', 'books & stationery', 'stationery', 'বই'],
            'kids-toys': ['kids', 'kids & toys', 'toys', 'খেলনা'],
            'cars': ['cars & bikes', 'cars', 'bikes', 'automotive', 'car']
        };

        function slugifyCategoryText(text) {
            return String(text || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
        }

        const CATEGORY_ALIAS_MAP = (() => {
            const map = {};
            const register = (canonical, value) => {
                if (!canonical || !value) return;
                const key = slugifyCategoryText(value);
                if (!key) return;
                map[key] = canonical;
            };
            HEADER_CATEGORY_GROUPS.forEach(group => {
                const canonical = group.id;
                register(canonical, canonical);
                register(canonical, group.label?.en);
                register(canonical, group.label?.bn);
                if (Array.isArray(group.aliases)) {
                    group.aliases.forEach(alias => register(canonical, alias));
                }
            });
            Object.entries(CATEGORY_SYNONYM_OVERRIDES).forEach(([canonical, values]) => {
                values.forEach(value => register(canonical, value));
            });
            return map;
        })();

        function resolveCategoryId(raw) {
            if (!raw) return null;
            const slug = slugifyCategoryText(raw);
            return CATEGORY_ALIAS_MAP[slug] || raw;
        }

        function getCategoryMatchValues(categoryId) {
            const canonical = resolveCategoryId(categoryId);
            if (!canonical) return [];
            const values = new Set();
            values.add(canonical);
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            if (group) {
                if (group.label?.en) values.add(group.label.en);
                if (group.label?.bn) values.add(group.label.bn);
                if (Array.isArray(group.aliases)) {
                    group.aliases.forEach(alias => values.add(alias));
                }
            }
            (CATEGORY_SYNONYM_OVERRIDES[canonical] || []).forEach(alias => values.add(alias));
            return Array.from(values);
        }

        function matchesCategoryName(value, categoryId) {
            if (!value || !categoryId) return false;
            const normalized = slugifyCategoryText(value);
            return getCategoryMatchValues(categoryId).some(candidate => slugifyCategoryText(candidate) === normalized);
        }

        function resolveSubCategoryValue(categoryId, input) {
            const canonical = resolveCategoryId(categoryId);
            if (!canonical || !input) return input;
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            if (!group) return input;
            const slug = slugifyCategoryText(input);
            const match = group.items.find(item => {
                return [item?.value, item?.label?.en, item?.label?.bn].some(v => slugifyCategoryText(v) === slug);
            });
            return match ? match.value : input;
        }

        function getSubCategoryMatchValues(categoryId, subValue) {
            const canonical = resolveCategoryId(categoryId);
            const base = resolveSubCategoryValue(canonical, subValue);
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            if (!group) return [base];
            const slug = slugifyCategoryText(base);
            const match = group.items.find(item => slugifyCategoryText(item.value) === slug);
            if (!match) return [base];
            const set = new Set();
            set.add(match.value);
            if (match.label?.en) set.add(match.label.en);
            if (match.label?.bn) set.add(match.label.bn);
            return Array.from(set);
        }

        function matchesSubCategoryName(value, categoryId, targetValue) {
            if (!value || !categoryId || !targetValue) return false;
            const normalized = slugifyCategoryText(value);
            return getSubCategoryMatchValues(categoryId, targetValue).some(candidate => slugifyCategoryText(candidate) === normalized);
        }

        // Font Awesome icon mapping for categories (use small icon size)
        function getCategoryIconClass(cat) {
            const slug = String(cat || '').toLowerCase();
            const map = {
                'electronics': 'fa-tv',
                'fashion': 'fa-tshirt',
                'groceries': 'fa-shopping-basket',
                'beauty': 'fa-spa',
                'home-garden': 'fa-home',
                'kids-toys': 'fa-puzzle-piece',
                'sports-outdoors': 'fa-football-ball',
                'books-stationery': 'fa-book',
                'automotive': 'fa-car',
                'cars': 'fa-car',
                'health-beauty': 'fa-heartbeat',
                'accessories': 'fa-star',
                'footwear': 'fa-shoe-prints',
                'watches': 'fa-clock',
                'jewelry': 'fa-gem',
                'bags': 'fa-shopping-bag',
                'appliances': 'fa-plug'
            };
            return map[slug] || 'fa-tags';
        }

        function updateCategoryHeader(category, subCategory = null) {
            const categoryName = category ? getCategoryLabel(category) : '';
            const subCategoryName = subCategory ? getSubCategoryLabel(category, subCategory) : '';
            
            currentCategory = category;
            currentSubCategory = subCategory;
            
            let title = translations[currentLanguage]['featured-products'];
            
            if (category) {
                title = subCategoryName ? subCategoryName : categoryName;
            }

            if (DOMElements.categoryHeader) {
                DOMElements.categoryHeader.classList.toggle('hidden', !category);
            }

            DOMElements.currentCategoryTitle.textContent = title;
            if (category) {
                delete DOMElements.currentCategoryTitle.dataset.lang;
            } else {
                DOMElements.currentCategoryTitle.dataset.lang = 'featured-products';
            }

            // Update Breadcrumb
            let breadcrumbHtml = `<a href="javascript:void(0);" onclick="renderAllProducts()" class="text-theme-blue hover:underline">${translations[currentLanguage]['all-products']}</a>`;
            
            if (category) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <a href="javascript:void(0);" onclick="filterProducts('${category}')" class="text-theme-blue hover:underline">${categoryName}</a>`;
            }
            if (subCategory) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <span class="font-semibold text-dark dark:text-gray-100">${subCategoryName}</span>`;
            }
            if (DOMElements.breadcrumb) {
                DOMElements.breadcrumb.innerHTML = breadcrumbHtml;
            }
            
            // Render subcategory buttons if a main category is selected
            if (category) {
                renderSubCategories(category);
            } else {
                DOMElements.subcategoryButtons.innerHTML = '';
            }
            // Refresh the top category strip active state
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (e) {}
            }
        }
        
        function renderSubCategories(category) {
            const container = DOMElements.subcategoryButtons;
            if (!container) return;

            const canonical = resolveCategoryId(category);
            const group = HEADER_CATEGORY_GROUPS.find(g => g.id === canonical);
            const subCategories = Array.isArray(group?.items) ? group.items : [];

            if (subCategories.length === 0) {
                container.innerHTML = '';
                return;
            }

            const allActive = currentSubCategory === null;
            const categoryName = getCategoryLabel(canonical);
            const allWord = translations[currentLanguage]['all-in-category'] || (currentLanguage === 'bn' ? 'সকল' : 'All in');
            const allLabel = `${allWord} ${categoryName}`;

            const buttonBase = 'px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold rounded-full hover:bg-gray-300 transition-colors';
            const activeClass = ' variant-btn-active bg-theme-blue/30 text-theme-purple dark:text-theme-blue';

            let buttonsHtml = `<button class="${buttonBase}${allActive ? activeClass : ''}" onclick="filterProducts('${canonical}')">${allLabel}</button>`;

            buttonsHtml += subCategories.map(item => {
                const value = item?.value || item?.label?.en || item?.label?.bn || '';
                if (!value) return '';
                const label = item?.label?.[currentLanguage] || item?.label?.en || item?.label?.bn || value;
                const safeValue = String(value).replace(/'/g, "\\'");
                const isActive = slugifyCategoryText(currentSubCategory) === slugifyCategoryText(value);
                return `<button class="${buttonBase}${isActive ? activeClass : ''}" onclick="filterSubCategory('${canonical}', '${safeValue}')">${label}</button>`;
            }).join('');

            container.innerHTML = buttonsHtml;
        }

        // --- END CATEGORY & SUB-CATEGORY LOGIC ---

        // --- SORTING & FILTERING UI/LOGIC ---
        function ensureListingToolbar() {
            try {
                const list = DOMElements.productList;
                if (!list || !list.parentNode) return;
                if (!document.getElementById('products-toolbar')) {
                    const toolbar = document.createElement('div');
                    toolbar.id = 'products-toolbar';
                    toolbar.className = 'flex flex-wrap items-center justify-between gap-3 mb-4';
                    toolbar.innerHTML = `
                        <div class="flex items-center gap-2">
                          <label for="sort-select" class="text-sm text-gray-600">Sort:</label>
                          <select id="sort-select" class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="popularity">Popularity</option>
                            <option value="rating">Rating (High to Low)</option>
                            <option value="price-asc">Price: Low to High</option>
                            <option value="price-desc">Price: High to Low</option>
                            <option value="newest">Newest</option>
                          </select>
                        </div>
                                                <div class="flex items-center gap-2">
                                                    <button id="toggle-filters-btn" class="px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700">Filters</button>
                                                    <button id="clear-filters-btn" class="px-2 py-1 text-sm text-red-600 hover:text-red-700" onclick="clearAllFilters()">Clear</button>
                                                </div>
                    `;
                    list.parentNode.insertBefore(toolbar, list);

                    const panel = document.createElement('div');
                    panel.id = 'filters-panel';
                    panel.className = 'hidden border rounded-xl p-4 mb-4 bg-white dark:bg-gray-900';
                    panel.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div>
                            <h4 class="font-semibold mb-2">Brand</h4>
                            <div id="filter-brands" class="space-y-1 max-h-48 overflow-auto"></div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Price</h4>
                            <div class="flex items-center gap-2">
                              <input id="filter-price-min" type="number" placeholder="Min" class="px-2 py-1 rounded border w-24" />
                              <span>-</span>
                              <input id="filter-price-max" type="number" placeholder="Max" class="px-2 py-1 rounded border w-24" />
                            </div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Sizes</h4>
                            <div id="filter-sizes" class="flex flex-wrap gap-2"></div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Colors</h4>
                            <div id="filter-colors" class="flex flex-wrap gap-2"></div>
                          </div>
                        </div>
                    `;
                    list.parentNode.insertBefore(panel, list);

                    const sortSelect = document.getElementById('sort-select');
                    sortSelect.value = currentSortOption;
                    sortSelect.addEventListener('change', () => {
                        currentSortOption = sortSelect.value;
                        renderProducts(lastBaseProducts);
                    });

                    const toggleBtn = document.getElementById('toggle-filters-btn');
                    toggleBtn.addEventListener('click', () => {
                        const p = document.getElementById('filters-panel');
                        if (!p) return;
                        const active = !!currentCategory || !!currentSubCategory;
                        if (!active) {
                            showToast('Select a category to use filters.', false);
                            return;
                        }
                        p.classList.toggle('hidden');
                    });

                    // Clear button uses global handler via inline onclick
                }
                // Always ensure the product list uses a responsive grid with 6 columns on large screens
                try {
                    // Ensure 5-column layout on large screens
                    list.classList.remove('lg:grid-cols-6');
                    list.classList.add('grid','gap-4','sm:gap-6','grid-cols-2','sm:grid-cols-3','md:grid-cols-4','lg:grid-cols-5');
                } catch {}

                // Ensure a pagination container exists after the product list
                let pagination = document.getElementById('pagination-controls');
                if (!pagination) {
                    pagination = document.createElement('div');
                    pagination.id = 'pagination-controls';
                    pagination.className = 'mt-6 flex items-center justify-center gap-3 flex-wrap';
                    list.insertAdjacentElement('afterend', pagination);
                }
            } catch (e) { console.warn('ensureListingToolbar failed', e); }
        }

        function resetFiltersOnCategoryChange(options = {}) {
            let showMsg = false;
            let hidePanel = true;
            if (typeof options === 'boolean') {
                showMsg = options;
            } else if (options && typeof options === 'object') {
                showMsg = !!options.showMsg;
                hidePanel = options.hidePanel !== false;
            }
            activeFilters = { brands: new Set(), priceMin: null, priceMax: null, sizes: new Set(), colors: new Set() };
            const panel = document.getElementById('filters-panel');
            if (panel && hidePanel) panel.classList.add('hidden');
            if (showMsg) showToast('Filters cleared');
        }

        window.clearAllFilters = () => {
            resetFiltersOnCategoryChange({ showMsg: false, hidePanel: false });
            activeFilters = { brands: new Set(), priceMin: null, priceMax: null, sizes: new Set(), colors: new Set() };
            renderProducts(lastBaseProducts);
            renderFiltersUI();
            const panel = document.getElementById('filters-panel');
            if (panel) panel.classList.remove('hidden');
            showToast('Filters cleared');
        };

        function deriveAvailableFilters(base) {
            const brands = new Set();
            const sizes = new Set();
            const colors = new Set();
            let minPrice = Infinity, maxPrice = -Infinity;
            (base || []).forEach(p => {
                if (p.brand) brands.add(String(p.brand));
                (Array.isArray(p.sizes) ? p.sizes : []).forEach(s => sizes.add(String(s)));
                (Array.isArray(p.colors) ? p.colors : []).forEach(c => colors.add(String(c)));
                const price = Number(p.price) || 0;
                if (price > 0) { minPrice = Math.min(minPrice, price); maxPrice = Math.max(maxPrice, price); }
            });
            if (!isFinite(minPrice)) minPrice = 0;
            if (!isFinite(maxPrice)) maxPrice = 0;
            return { brands: Array.from(brands).sort(), sizes: Array.from(sizes), colors: Array.from(colors), minPrice, maxPrice };
        }

        function renderFiltersUI() {
            const active = !!currentCategory || !!currentSubCategory;
            const panel = document.getElementById('filters-panel');
            const toggleBtn = document.getElementById('toggle-filters-btn');
            if (!panel || !toggleBtn) return;
            toggleBtn.disabled = !active;
            if (!active) { panel.classList.add('hidden'); return; }

            const { brands, sizes, colors, minPrice, maxPrice } = deriveAvailableFilters(lastBaseProducts);
            const brandsEl = document.getElementById('filter-brands');
            const sizesEl = document.getElementById('filter-sizes');
            const colorsEl = document.getElementById('filter-colors');
            const minEl = document.getElementById('filter-price-min');
            const maxEl = document.getElementById('filter-price-max');
            if (!brandsEl || !sizesEl || !colorsEl || !minEl || !maxEl) return;

            brandsEl.innerHTML = brands.map(b => {
                const id = `brand-${b.replace(/\W+/g,'-')}`;
                const checked = activeFilters.brands.has(b) ? 'checked' : '';
                return `<label class="flex items-center gap-2 text-sm"><input type="checkbox" class="brand-chk" id="${id}" value="${b}" ${checked}/> <span>${b}</span></label>`;
            }).join('') || '<p class="text-sm text-gray-500">No brands</p>';

            sizesEl.innerHTML = sizes.map(s => {
                const act = activeFilters.sizes.has(s);
                return `<button data-size="${s}" class="px-3 py-1 rounded-full border ${act ? 'bg-theme-pink text-white border-theme-pink' : 'bg-white dark:bg-gray-800 text-gray-700 border-gray-300'}">${s}</button>`;
            }).join('') || '<p class="text-sm text-gray-500">No sizes</p>';

            colorsEl.innerHTML = colors.map(c => {
                const act = activeFilters.colors.has(c);
                return `<button data-color="${c}" class="px-3 py-1 rounded-full border ${act ? 'bg-theme-pink text-white border-theme-pink' : 'bg-white dark:bg-gray-800 text-gray-700 border-gray-300'}">${c}</button>`;
            }).join('') || '<p class="text-sm text-gray-500">No colors</p>';

            minEl.placeholder = minPrice ? String(minPrice) : '0';
            maxEl.placeholder = maxPrice ? String(maxPrice) : '0';
            minEl.value = activeFilters.priceMin ?? '';
            maxEl.value = activeFilters.priceMax ?? '';

            brandsEl.querySelectorAll('input.brand-chk').forEach(chk => chk.addEventListener('change', (e) => {
                const v = e.target.value;
                if (e.target.checked) activeFilters.brands.add(v); else activeFilters.brands.delete(v);
                renderProducts(lastBaseProducts);
                renderFiltersUI();
            }));
            sizesEl.querySelectorAll('button[data-size]').forEach(btn => btn.addEventListener('click', () => {
                const v = btn.dataset.size;
                if (activeFilters.sizes.has(v)) activeFilters.sizes.delete(v); else activeFilters.sizes.add(v);
                renderProducts(lastBaseProducts);
                renderFiltersUI();
            }));
            colorsEl.querySelectorAll('button[data-color]').forEach(btn => btn.addEventListener('click', () => {
                const v = btn.dataset.color;
                if (activeFilters.colors.has(v)) activeFilters.colors.delete(v); else activeFilters.colors.add(v);
                renderProducts(lastBaseProducts);
                renderFiltersUI();
            }));
            const onPriceChange = () => {
                const minV = parseFloat(minEl.value);
                const maxV = parseFloat(maxEl.value);
                activeFilters.priceMin = isNaN(minV) ? null : minV;
                activeFilters.priceMax = isNaN(maxV) ? null : maxV;
                renderProducts(lastBaseProducts);
                renderFiltersUI();
            };
            minEl.onchange = onPriceChange;
            maxEl.onchange = onPriceChange;
        }

        function applyFilters(list) {
            if (!currentCategory && !currentSubCategory) return list;
            return (list || []).filter(p => {
                if (activeFilters.brands.size > 0 && (!p.brand || !activeFilters.brands.has(String(p.brand)))) return false;
                const price = Number(p.price) || 0;
                if (activeFilters.priceMin !== null && price < activeFilters.priceMin) return false;
                if (activeFilters.priceMax !== null && price > activeFilters.priceMax) return false;
                if (activeFilters.sizes.size > 0) {
                    const sizes = new Set(Array.isArray(p.sizes) ? p.sizes.map(String) : []);
                    let ok = false; activeFilters.sizes.forEach(s => { if (sizes.has(s)) ok = true; });
                    if (!ok) return false;
                }
                if (activeFilters.colors.size > 0) {
                    const colors = new Set(Array.isArray(p.colors) ? p.colors.map(String) : []);
                    let ok = false; activeFilters.colors.forEach(c => { if (colors.has(c)) ok = true; });
                    if (!ok) return false;
                }
                return true;
            });
        }

        function applySorting(list) {
            const arr = Array.isArray(list) ? list.slice() : [];
            switch (currentSortOption) {
                case 'price-asc':
                    return arr.sort((a,b) => (Number(a.price)||0) - (Number(b.price)||0));
                case 'price-desc':
                    return arr.sort((a,b) => (Number(b.price)||0) - (Number(a.price)||0));
                case 'rating':
                    return arr.sort((a,b) => (Number(b.rating)||0) - (Number(a.rating)||0));
                case 'newest':
                    return arr.sort((a,b) => {
                        const at = a.createdAt ? (a.createdAt.seconds || a.createdAt) : 0;
                        const bt = b.createdAt ? (b.createdAt.seconds || b.createdAt) : 0;
                        if (bt !== at) return bt - at;
                        const rc = (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0);
                        if (rc !== 0) return rc;
                        return (Number(b.price)||0) - (Number(a.price)||0);
                    });
                case 'popularity':
                default:
                    return arr.sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
            }
        }
        
        // Simple pagination renderer (Prev/Next + range display)
        function renderPagination(totalItems) {
            try {
                const container = document.getElementById('pagination-controls');
                if (!container) return;
                const total = Number(totalItems) || 0;
                const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const start = total === 0 ? 0 : (currentPage - 1) * PAGE_SIZE + 1;
                const end = Math.min(currentPage * PAGE_SIZE, total);

                // Professional styling for the pagination block
                container.className = 'mt-8 p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/60 shadow-sm flex flex-col items-center gap-3';

                container.innerHTML = `
                    <div class="flex items-center justify-center gap-3">
                        <button id="page-prev" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-angle-left"></i>
                            <span class="hidden sm:inline">Prev</span>
                        </button>
                        <span class="text-lg font-semibold">Page ${currentPage} of ${totalPages}</span>
                        <button id="page-next" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="hidden sm:inline">Next</span>
                            <i class="fa-solid fa-angle-right"></i>
                        </button>
                    </div>
                    <button id="page-top" class="inline-flex items-center gap-2 mt-1 px-4 py-2 rounded-full bg-theme-pink text-white hover:bg-theme-purple shadow">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>Back to Top</span>
                    </button>
                `;

                const prevBtn = document.getElementById('page-prev');
                const nextBtn = document.getElementById('page-next');
                const topBtn = document.getElementById('page-top');
                if (prevBtn) {
                    prevBtn.disabled = currentPage <= 1;
                    prevBtn.onclick = () => {
                        if (currentPage > 1) {
                            currentPage -= 1;
                            renderProducts(currentDisplayedProducts);
                            try { document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' }); } catch {}
                        }
                    };
                }
                if (nextBtn) {
                    nextBtn.disabled = currentPage >= totalPages;
                    nextBtn.onclick = () => {
                        if (currentPage < totalPages) {
                            currentPage += 1;
                            renderProducts(currentDisplayedProducts);
                            try { document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' }); } catch {}
                        }
                    };
                }
                if (topBtn) {
                    topBtn.onclick = () => {
                        try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch { window.scrollTo(0,0); }
                    };
                }
            } catch (e) { console.warn('renderPagination failed', e); }
        }
        // --- END SORTING & FILTERING UI/LOGIC ---
        
        // --- TOP CATEGORY STRIP (DYNAMIC) ---
        function renderTopCategoryStrip() {
            const listEl = document.getElementById('top-category-strip-list');
            if (!listEl) return;

            const chipBase = 'shrink-0 inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-semibold border transition-colors whitespace-nowrap';
            const activeCls = 'bg-theme-pink text-white border-theme-pink shadow-md';
            const idleCls = 'bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-theme-pink/10 hover:text-theme-purple';
            const subIdleCls = 'bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-theme-blue/10 hover:text-theme-blue';
            const subActiveCls = 'bg-theme-blue text-white border-theme-blue shadow-md';

            const buttons = [];
            const allActive = !currentCategory;
            const activeCategoryId = currentCategory ? resolveCategoryId(currentCategory) : null;

            buttons.push(`
                <button type="button" class="${chipBase} ${allActive ? activeCls : idleCls}" onclick="renderAllProducts()">
                    <i class="fas fa-layer-group text-xs"></i>
                    <span>${translations[currentLanguage]['all-products'] || 'All Products'}</span>
                </button>
            `);

            const renderCategoryButton = (group, isActiveOverride = false) => {
                const isActive = isActiveOverride || activeCategoryId === resolveCategoryId(group.id);
                const iconClass = getCategoryIconClass(group.id);
                const label = group.label?.[currentLanguage] || group.label?.en || group.label?.bn || group.id;
                return `
                    <button type="button" class="${chipBase} ${isActive ? activeCls : idleCls}" onclick="filterProducts('${group.id}')" aria-pressed="${isActive}">
                        <i class="fas ${iconClass} text-xs"></i>
                        <span>${label}</span>
                    </button>
                `;
            };

            if (!activeCategoryId) {
                HEADER_CATEGORY_GROUPS.forEach(group => {
                    buttons.push(renderCategoryButton(group, false));
                });
            } else {
                const activeGroup = HEADER_CATEGORY_GROUPS.find(g => g.id === activeCategoryId);
                if (activeGroup) {
                    buttons.push(renderCategoryButton(activeGroup, true));
                } else {
                    HEADER_CATEGORY_GROUPS.forEach(group => {
                        buttons.push(renderCategoryButton(group, false));
                    });
                }
            }

            if (currentCategory) {
                const group = HEADER_CATEGORY_GROUPS.find(g => g.id === resolveCategoryId(currentCategory));
                if (group && Array.isArray(group.items) && group.items.length > 0) {
                    buttons.push(`<span class="shrink-0 text-gray-400 dark:text-gray-500 text-lg">›</span>`);
                    group.items.forEach(item => {
                        const value = item?.value || item?.label?.en || item?.label?.bn;
                        if (!value) return;
                        const label = item?.label?.[currentLanguage] || item?.label?.en || item?.label?.bn || value;
                        const safeValue = String(value).replace(/'/g, "\\'");
                        const isActive = slugifyCategoryText(currentSubCategory) === slugifyCategoryText(value);
                        buttons.push(`
                            <button type="button" class="${chipBase} ${isActive ? subActiveCls : subIdleCls}" onclick="filterSubCategory('${resolveCategoryId(currentCategory)}', '${safeValue}')" aria-pressed="${isActive}">
                                <i class="fas fa-angle-right text-xs"></i>
                                <span>${label}</span>
                            </button>
                        `);
                    });
                }
            }

            renderFiltersUI();
            listEl.innerHTML = buttons.join('');
        }
        // --- END TOP CATEGORY STRIP ---
        
        // --- REVIEW LOGIC ---
        
        // Global state to track selected rating
        let currentRating = 0;
        
        function setupReviewForm(productId) {
            const form = document.getElementById('review-form');
            const loginPrompt = document.getElementById('review-login-prompt');
            const reviewControls = document.getElementById('review-controls');
            const ratingStars = document.getElementById('rating-stars');
            const ratingInput = document.getElementById('review-rating');

            if (!currentUser || currentUser.isAnonymous) {
                loginPrompt.classList.remove('hidden');
                reviewControls.classList.add('hidden');
                return;
            }

            loginPrompt.classList.add('hidden');
            reviewControls.classList.remove('hidden');
            
            document.getElementById('review-product-id').value = productId;
            currentRating = 0;
            ratingInput.value = 0;
            updateStarDisplay(ratingStars, 0);

            // Clear previous comment if any
            document.getElementById('review-comment').value = '';
        }

        function handleStarClick(e) {
            const star = e.target.closest('.rating-star');
            if (!star) return;

            const rating = parseInt(star.dataset.rating);
            currentRating = rating;
            document.getElementById('review-rating').value = rating;
            updateStarDisplay(star.parentElement, rating);
        }

        function updateStarDisplay(container, rating) {
            Array.from(container.children).forEach(star => {
                if (star.classList.contains('rating-star')) {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= rating) {
                        star.classList.remove('far', 'text-gray-400');
                        star.classList.add('fas', 'selected');
                    } else {
                        star.classList.remove('fas', 'selected');
                        star.classList.add('far', 'text-gray-400');
                    }
                }
            });
        }
        
        async function submitReview(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;

            const productId = document.getElementById('review-product-id').value;
            const rating = parseInt(document.getElementById('review-rating').value);
            const comment = document.getElementById('review-comment').value.trim();

            if (rating === 0 || comment.length < 5) {
                showToast('Please provide a rating and a valid comment (min 5 chars).', false);
                return;
            }

            const productDocRef = doc(db, 'products', productId);
            const productSnap = await getDoc(productDocRef);
            
            if (!productSnap.exists()) {
                showToast('Product not found in database.', false);
                return;
            }

            const productData = productSnap.data();
            const existingReviews = productData.reviews || [];
            const currentRatingCount = productData.ratingCount || 0;
            const currentTotalRating = (productData.rating * currentRatingCount) || 0; // rating is already average

            const newReview = {
                author: currentUser.displayName || currentUser.email || 'Anonymous',
                rating: rating,
                comment: comment,
                // FIX: Changed serverTimestamp() to new Date() as it's inside arrayUnion
                timestamp: new Date() 
            };

            const newRatingCount = currentRatingCount + 1;
            const newTotalRating = currentTotalRating + rating;
            const newAverageRating = newTotalRating / newRatingCount;

            try {
                await updateDoc(productDocRef, {
                    reviews: arrayUnion(newReview),
                    rating: parseFloat(newAverageRating.toFixed(1)), // Keep 1 decimal place
                    ratingCount: newRatingCount
                });
                
                // Manually update the local product data (in productsData array) for immediate UI refresh
                const productIndex = productsData.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    productsData[productIndex].reviews = [...existingReviews, newReview];
                    productsData[productIndex].rating = parseFloat(newAverageRating.toFixed(1));
                    productsData[productIndex].ratingCount = newRatingCount;
                }
                
                // Re-render product details with new data
                showProductDetails(productId);
                showToast('review-success', true);
                
            } catch (error) {
                console.error("Error submitting review:", error);
                showToast('review-failed', false);
            }
        }
        
        // --- END REVIEW LOGIC ---


        function handleProductCardClick(e) {
            const target = e.target;
            const productCard = target.closest('.product-card');
            if (!productCard) return;

            const productId = productCard.dataset.productId;
            
            if (target.closest('.add-to-cart')) {
                try {
                    const product = (productsData || []).find(p => p.id === productId);
                    const required = product ? getRequiredVariants(product) : [];
                    if (required.length > 0) {
                        // Open quick-select modal instead of redirecting to details
                        openVariantModal(productId, 'add');
                        return;
                    }
                } catch (err) { console.log('Variant check failed', err); }
                addToCartInDb(productId, true).catch(err => console.log(err));
            } else if (target.closest('.wishlist')) {
                toggleWishlistInDb(productId);
            } else if (target.closest('img') || target.closest('.product-title')) {
                showProductDetails(productId);
            }
        }
        
        async function showProductDetails(productId, skuEnc = '', modelEnc = '', nameEnc = '') {
            try {
                selectedVariants = {};
                const fallbackSku = skuEnc ? decodeURIComponent(skuEnc) : '';
                const fallbackModel = modelEnc ? decodeURIComponent(modelEnc) : '';
                const fallbackName = nameEnc ? decodeURIComponent(nameEnc) : '';

                let product = Array.isArray(productsData) ? productsData.find(p => p.id === productId) : null;
                if (!product && window.db && typeof window.db === 'object') {
                    try {
                        const ref = doc(db, 'products', String(productId));
                        const snap = await getDoc(ref);
                        if (snap && snap.exists()) {
                            product = { id: snap.id, ...snap.data() };
                            // Cache it for later to speed up next visit
                            if (Array.isArray(productsData)) {
                                productsData.push(product);
                            }
                        }
                    } catch (e) {
                        console.warn('Fallback fetch product failed', e);
                    }
                    // If still not found, try queries by SKU / modelID / name
                    if (!product) {
                        try {
                            if (fallbackSku) {
                                const q1 = query(collection(db, 'products'), where('sku', '==', fallbackSku));
                                const qs1 = await getDocs(q1);
                                if (!qs1.empty) {
                                    const d = qs1.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackSku) {
                                const q1b = query(collection(db, 'products'), where('SKU', '==', fallbackSku));
                                const qs1b = await getDocs(q1b);
                                if (!qs1b.empty) {
                                    const d = qs1b.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackModel) {
                                const q2 = query(collection(db, 'products'), where('modelID', '==', fallbackModel));
                                const qs2 = await getDocs(q2);
                                if (!qs2.empty) {
                                    const d = qs2.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackName) {
                                const q3 = query(collection(db, 'products'), where('name', '==', fallbackName));
                                const qs3 = await getDocs(q3);
                                if (!qs3.empty) {
                                    const d = qs3.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (product && Array.isArray(productsData)) {
                                productsData.push(product);
                            }
                        } catch (e) {
                            console.warn('Fallback query by fields failed', e);
                        }
                    }
                }
                if (!product) {
                    if (typeof showToast === 'function') showToast('Product not found', false);
                    return;
                }

            const detailsPage = document.getElementById('product-details-page');
            if(!detailsPage) return;

            const saleHighlightWrap = detailsPage.querySelector('#product-sale-highlight');
            const saleBadgeWrap = detailsPage.querySelector('#product-sale-badges');
            const saleCountdownWrap = detailsPage.querySelector('#product-sale-countdown-wrapper');
            const saleCountdownLabelEl = detailsPage.querySelector('#product-sale-countdown-label');
            const saleCountdownValueEl = detailsPage.querySelector('#product-sale-countdown');

            if (saleHighlightWrap) saleHighlightWrap.classList.add('hidden');
            if (saleBadgeWrap) saleBadgeWrap.innerHTML = '';
            if (saleCountdownWrap) saleCountdownWrap.classList.add('hidden');
            if (saleCountdownLabelEl) {
                delete saleCountdownLabelEl.dataset.lang;
                saleCountdownLabelEl.textContent = '';
            }
            if (saleCountdownValueEl) saleCountdownValueEl.textContent = '';
            clearProductDetailsFlashTimer();

            const localeStringsForDetails = translations[currentLanguage] || translations.en || {};
            const saleBadges = [];
            const flashInfoDetails = (product.flashSale && product.flashSale.enabled) ? product.flashSale : null;
            const megaInfoDetails = (product.megaSale && product.megaSale.enabled) ? product.megaSale : null;
            let detailFlashStatus = null;
            let detailFlashTarget = null;

            const toMs = (value) => {
                if (!value) return null;
                if (value instanceof Date) return value.getTime();
                if (typeof value?.toDate === 'function') {
                    try { return value.toDate().getTime(); } catch (_) { return null; }
                }
                if (typeof value === 'number' && Number.isFinite(value)) return value;
                if (typeof value === 'string') {
                    const parsed = Date.parse(value);
                    return Number.isNaN(parsed) ? null : parsed;
                }
                if (typeof value === 'object' && typeof value.seconds === 'number') {
                    return value.seconds * 1000 + (value.nanoseconds || 0) / 1e6;
                }
                return null;
            };

            if (flashInfoDetails) {
                const startMs = toMs(flashInfoDetails.start);
                const endMs = toMs(flashInfoDetails.end);
                const nowMs = Date.now();
                const isActive = (!startMs || startMs <= nowMs) && (!endMs || endMs > nowMs);
                const isUpcoming = !!startMs && startMs > nowMs;

                if (isActive) {
                    detailFlashStatus = 'active';
                    detailFlashTarget = Number.isFinite(endMs) ? endMs : null;
                } else if (isUpcoming) {
                    detailFlashStatus = 'upcoming';
                    detailFlashTarget = Number.isFinite(startMs) ? startMs : null;
                }

                if (detailFlashStatus) {
                    const flashLabelKey = detailFlashStatus === 'upcoming' ? 'flash-sale-upcoming' : 'flash-sale-badge';
                    const flashLabel = escapeHtml(flashInfoDetails.label || resolveLocalizedString(flashLabelKey));
                    saleBadges.push(`
                        <span class="inline-flex items-center justify-center uppercase text-[11px] font-semibold tracking-[0.3em] bg-theme-purple text-white px-3 py-1 rounded-full shadow">${flashLabel}</span>
                    `);
                }
            }

            if (megaInfoDetails) {
                const megaLabel = escapeHtml(megaInfoDetails.label || resolveLocalizedString('mega-sale-badge') || 'Mega Sale');
                saleBadges.push(`
                    <span class="inline-flex items-center gap-2 bg-theme-blue text-white text-[11px] font-semibold tracking-wide px-3 py-1 rounded-full shadow">${megaLabel}</span>
                `);
                if (Number.isFinite(megaInfoDetails.discountPercent) && megaInfoDetails.discountPercent > 0) {
                    saleBadges.push(`
                        <span class="inline-flex items-center bg-white text-theme-blue text-xs font-semibold px-2.5 py-1 rounded-full shadow-sm border border-theme-blue/30">-${Math.round(megaInfoDetails.discountPercent)}%</span>
                    `);
                }
            }

            if (saleBadgeWrap && saleBadges.length) {
                saleBadgeWrap.innerHTML = saleBadges.join('');
            }

            if (detailFlashStatus && saleCountdownWrap && saleCountdownLabelEl && saleCountdownValueEl) {
                const labelKey = detailFlashStatus === 'active' ? 'flash-sale-countdown-label' : 'flash-sale-countdown-starts';
                saleCountdownLabelEl.dataset.lang = labelKey;
                saleCountdownLabelEl.textContent = localeStringsForDetails[labelKey] || resolveLocalizedString(labelKey);

                if (Number.isFinite(detailFlashTarget)) {
                    const updateCountdown = () => {
                        const diff = detailFlashTarget - Date.now();
                        if (diff <= 0) {
                            saleCountdownValueEl.textContent = '00:00:00';
                            clearProductDetailsFlashTimer();
                            return;
                        }
                        saleCountdownValueEl.textContent = formatCountdown(diff);
                    };
                    updateCountdown();
                    saleCountdownWrap.classList.remove('hidden');
                    productDetailsFlashTimerId = setInterval(updateCountdown, 1000);
                } else {
                    saleCountdownValueEl.textContent = '--:--:--';
                    saleCountdownWrap.classList.remove('hidden');
                }
            }

            if (saleHighlightWrap) {
                const hasBadgeMarkup = saleBadges.length > 0 && saleBadgeWrap && saleBadgeWrap.innerHTML.trim().length > 0;
                const hasCountdown = saleCountdownWrap && !saleCountdownWrap.classList.contains('hidden');
                saleHighlightWrap.classList.toggle('hidden', !(hasBadgeMarkup || hasCountdown));
            }
            
            // Update global breadcrumb: Home > Category > Subcategory > Product Name
            try {
                const bc = DOMElements.globalBreadcrumb;
                const path = DOMElements.globalBreadcrumbPath;
                if (bc && path) {
                    const homeLabel = (translations?.[currentLanguage]?.['home']) || 'Home';
                    const cat = product.category || null;
                    const sub = product.subCategory || null;
                    const catLabel = cat ? getCategoryLabel(cat) : null;
                    const safeCat = cat ? String(cat).replace(/'/g, "\\'") : '';
                    const safeSub = sub ? String(sub).replace(/'/g, "\\'") : '';
                    let html = `<a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"renderAllProducts && renderAllProducts(); showPage('home-page');\">${homeLabel}</a>`;
                    if (cat) {
                        html += ` <span class=\"mx-2 text-gray-400\">›</span> <a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"filterProducts && filterProducts('${safeCat}');\">${catLabel}</a>`;
                    }
                    if (sub) {
                        html += ` <span class=\"mx-2 text-gray-400\">›</span> <a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"filterSubCategory && filterSubCategory('${safeCat}','${safeSub}');\">${sub}</a>`;
                    }
                    html += ` <span class=\"mx-2 text-gray-400\">›</span> <span class=\"font-semibold text-gray-900 dark:text-gray-100\">${(product.name||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
                    path.innerHTML = html;
                    bc.classList.remove('hidden');
                }
            } catch (e) { console.warn('breadcrumb update failed', e); }
            
            // Populate product details
            const isWished = localWishlistCache.has(product.id);
            const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
            
            const productTitleEl = detailsPage.querySelector('#product-title-details');
            if (productTitleEl) productTitleEl.textContent = product.name || "Product Name";
            
            const productBrandEl = detailsPage.querySelector('#product-brand-details');
            if (productBrandEl) productBrandEl.textContent = product.brand || "Brand";

            // --- Model ID Logic ---
            const productModelEl = detailsPage.querySelector('#product-model-details');
            const modelID = product.modelID || null; 

            if (productModelEl) {
                let displayModelID = '';
                if (modelID && modelID.trim() !== '') {
                    displayModelID = translations[currentLanguage]['model-id'].replace('{id}', modelID);
                    productModelEl.classList.remove('hidden');
                } else {
                    productModelEl.classList.add('hidden');
                }
                // FIX: Use translation key string and replace {id} with modelID
                productModelEl.querySelector('#model-text').textContent = translations[currentLanguage]['model-id'].replace('{id}', modelID);
            }
            // --- END Model ID Logic ---

            // --- Warranty Logic (remains as string fetch) ---
            const productWarrantyEl = detailsPage.querySelector('#product-warranty-details');
            const warrantyTextFromDB = product.warrantyText || null; 

            if (productWarrantyEl) {
                let displayWarranty = translations[currentLanguage]['no-warranty'];
                let isWarrantyPresent = false;
                
                if (warrantyTextFromDB && warrantyTextFromDB.trim() !== '') {
                    displayWarranty = translations[currentLanguage]['warranty'].replace('{text}', warrantyTextFromDB);
                    isWarrantyPresent = true;
                }
                
                productWarrantyEl.querySelector('#warranty-text').textContent = displayWarranty;
                
                if (isWarrantyPresent) {
                    productWarrantyEl.classList.add('text-green-600');
                    productWarrantyEl.classList.remove('text-red-500');
                } else {
                    productWarrantyEl.classList.add('text-red-500');
                    productWarrantyEl.classList.remove('text-green-600');
                }
            }
            // --- END Warranty Logic ---


            const productImageEl = detailsPage.querySelector('#product-image');
            if (productImageEl) productImageEl.src = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';

            const productRatingEl = detailsPage.querySelector('#product-rating-details');
            if (productRatingEl) productRatingEl.textContent = product.rating || 0;

            const productStarsEl = detailsPage.querySelector('#product-stars-details');
            if (productStarsEl) productStarsEl.innerHTML = renderStars(product.rating || 0);

            const productRatingCountEl = detailsPage.querySelector('#product-rating-count-details');
            if (productRatingCountEl) productRatingCountEl.textContent = `(${product.ratingCount || 0})`;

            // Stock display with low-stock visual indicator
            const stockEl = detailsPage.querySelector('#product-stock-details');
            if (stockEl) {
                const stockNum = Number(product.stock) || 0;
                stockEl.classList.remove('text-green-600','text-amber-600','text-red-600');
                if (stockNum <= 0) {
                    stockEl.textContent = translations?.[currentLanguage]?.['out-of-stock'] || 'Out of Stock';
                    stockEl.classList.add('text-red-600');
                } else if (stockNum < 5) {
                    stockEl.textContent = `Only ${stockNum} left!`;
                    stockEl.classList.add('text-amber-600');
                } else {
                    stockEl.textContent = `In stock: ${stockNum}`;
                    stockEl.classList.add('text-green-600');
                }
            }
            
            const addToCartBtn = detailsPage.querySelector('#add-to-cart-details');
            if (addToCartBtn) addToCartBtn.dataset.productId = productId;
            
            const wishlistBtn = detailsPage.querySelector('#wishlist-details');
            if (wishlistBtn) wishlistBtn.dataset.productId = productId;

            const wishlistIcon = detailsPage.querySelector('#wishlist-details i');
            if (wishlistIcon) wishlistIcon.className = `${heartClass} fa-heart`;

            const productDescriptionEl = detailsPage.querySelector('#product-full-description');
            if (productDescriptionEl) productDescriptionEl.textContent = product.fullDescription || product.description || 'No detailed description available.';


            const isOutOfStock = Number(product.stock) <= 0;
            const buyNowBtn = detailsPage.querySelector('.buy-now');

            if (isOutOfStock) {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['out-of-stock'];
                    addToCartBtn.disabled = true;
                    addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.remove('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = true;
                    buyNowBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.remove('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            } else {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['add-to-cart'];
                    addToCartBtn.disabled = false;
                    addToCartBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.add('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = false;
                    buyNowBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.add('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            }

            renderThumbnails(product.thumbnails || []);
            renderSpecifications(product.specifications || {});
            renderReviews(product.reviews || []);
            renderPriceDetails(product);
            renderInfoDetails(product);
            renderAllVariants(product);
            setupReviewForm(productId); // Setup review form
            // Render related products based on this product
            try { renderRelatedProducts(product); } catch (e) { console.warn('related products render failed', e); }

            showPage('product-details-page');
            updateTextContent();
            } catch (err) {
                console.error('showProductDetails failed', err);
                if (typeof showToast === 'function') showToast('Failed to open product', false);
            }
    }
    // Expose to global for inline onclick usage in product cards and suggestions
    window.showProductDetails = showProductDetails;

    function renderThumbnails(thumbnails) {
            const container = document.getElementById('thumbnail-container');
            container.innerHTML = thumbnails.map(src => 
                `<img src="${src}" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:ring-2 hover:ring-theme-pink transition-all" onclick="document.getElementById('product-image').src='${src}'">`
            ).join('');
        }
        
        function renderSpecifications(specifications) {
            const container = document.getElementById('product-specifications');
            if (!container) return;

            // Empty state
            if (!specifications || Object.keys(specifications).length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-specs">${translations[currentLanguage]['no-specs']}</p>`;
                return;
            }

            // Humanize label: replace _, - with space and Title Case each word; fix common acronyms
            const humanize = (str) => {
                const raw = (str || '')
                    .toString()
                    .replace(/[_-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                const title = raw.replace(/\b\w/g, (c) => c.toUpperCase());
                const keyLower = raw.toLowerCase();
                const acronyms = { ram: 'RAM', ssd: 'SSD', hdd: 'HDD', cpu: 'CPU', gpu: 'GPU', usb: 'USB', rom: 'ROM' };
                if (acronyms[keyLower]) return acronyms[keyLower];
                return title;
            };

            // Normalize values and preferred order
            const normalizeVal = (v) => {
                if (Array.isArray(v)) return v.filter(Boolean).join(', ');
                if (v && typeof v === 'object') return Object.values(v).filter(Boolean).join(', ');
                return v ?? '';
            };

            const preferredOrder = ['storage', 'processor', 'cpu', 'color', 'battery', 'ram', 'display'];
            const entriesRaw = Object.entries(specifications)
                .map(([k, v]) => [k, normalizeVal(v)])
                .filter(([, v]) => String(v).trim() !== '');

            const entries = entriesRaw.sort((a, b) => {
                const ia = preferredOrder.indexOf(a[0].toLowerCase());
                const ib = preferredOrder.indexOf(b[0].toLowerCase());
                if (ia === -1 && ib === -1) return a[0].localeCompare(b[0]);
                if (ia === -1) return 1;
                if (ib === -1) return -1;
                return ia - ib;
            });

            container.innerHTML = `
                <div class="overflow-hidden">
                    <dl class="divide-y divide-gray-200 dark:divide-gray-600">
                        ${entries.map(([key, value]) => `
                            <div class="grid grid-cols-12 gap-3 py-3">
                                <dt class="col-span-4 font-semibold text-gray-800 dark:text-gray-100">${humanize(key)}</dt>
                                <dd class="col-span-8 text-gray-700 dark:text-gray-300">${value}</dd>
                            </div>
                        `).join('')}
                    </dl>
                </div>
            `;
        }

        function renderReviews(reviews) {
            const container = document.getElementById('product-reviews');
            if (!container) return;
            if (!reviews || reviews.length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-reviews">${translations[currentLanguage]['no-reviews']}</p>`;
                return;
            }

            container.innerHTML = reviews.map(review => {
                // Check if timestamp is a Firestore Timestamp object (has toDate()) or a native Date object
                let dateString = 'N/A';
                if (review.timestamp?.toDate) {
                     dateString = review.timestamp.toDate().toLocaleDateString('en-GB');
                } else if (review.timestamp instanceof Date) {
                    dateString = review.timestamp.toLocaleDateString('en-GB');
                }

                return `
                    <div class="border-b pb-4">
                        <div class="flex items-center mb-2">
                            <div class="flex items-center mr-4">
                                ${renderStars(review.rating)}
                            </div>
                            <p class="font-bold text-gray-800">${review.author || 'Anonymous'}</p>
                            <span class="text-xs text-gray-500 ml-auto">${dateString}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300">${review.comment || ''}</p>
                    </div>
                `;
            }).join('');
        }

        // Render Related Products based on same subCategory or category
        function renderRelatedProducts(product) {
            const section = document.getElementById('related-products-section');
            const listEl = document.getElementById('related-product-list');
            if (!section || !listEl) return;
            try {
                if (!productsData || productsData.length === 0) {
                    section.classList.add('hidden');
                    listEl.innerHTML = '';
                    return;
                }
                let pool = [];
                if (product?.subCategory) {
                    pool = productsData.filter(p => p?.subCategory === product.subCategory);
                }
                if ((!pool || pool.length === 0) && product?.category) {
                    pool = productsData.filter(p => p?.category === product.category);
                }
                pool = (pool || []).filter(p => p && p.id !== product.id);
                if (pool.length === 0) {
                    section.classList.add('hidden');
                    listEl.innerHTML = '';
                    return;
                }
                // Randomize and limit
                const picks = pool.slice().sort(() => Math.random() - 0.5).slice(0, 5);
                listEl.innerHTML = picks.map(p => {
                    const img = p.imageUrl || p.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                    const price = Number(p.price || 0);
                    const isOffer = p.isOffer && Number(p.originalPrice) > Number(p.price);
                    const priceHtml = isOffer
                        ? `<div class="flex items-baseline gap-1"><span class="font-semibold text-price-black">৳${price.toFixed(0)}</span><span class="text-xs text-gray-400 line-through">৳${Number(p.originalPrice||0).toFixed(0)}</span></div>`
                        : `<span class="font-semibold text-price-black">৳${price.toFixed(0)}</span>`;
                    return `
                        <div class="rounded-2xl border bg-white dark:bg-gray-800 overflow-hidden hover:shadow transition cursor-pointer" onclick="showProductDetails('${p.id}')">
                            <div class="aspect-square overflow-hidden bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
                                <img src="${img}" alt="${(p.name||'').replace(/"/g,'&quot;')}" class="w-full h-full object-cover">
                            </div>
                            <div class="p-3">
                                <p class="text-sm font-medium line-clamp-2 mb-1">${p.name || ''}</p>
                                <div class="text-sm">${priceHtml}</div>
                            </div>
                        </div>`;
                }).join('');
                section.classList.remove('hidden');
            } catch (e) {
                console.warn('renderRelatedProducts failed', e);
                try { section.classList.add('hidden'); } catch {}
            }
        }

        function renderPriceDetails(product) {
            const priceElement = document.getElementById('product-price-details');
            const price = product.price || 0;
            
            // CHECK if the product is on offer (same logic as renderProducts)
            if (product.isOffer && product.originalPrice > product.price) {
                const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                priceElement.innerHTML = `
                    <div class="flex items-baseline gap-2 flex-wrap">
                        <span class="text-2xl font-bold text-price-black">৳${price.toFixed(2)}</span>
                        <span class="text-lg text-gray-400 line-through">৳${product.originalPrice.toFixed(2)}</span>
                        <span class="text-sm font-bold text-red-500">(-${discountPercent}%)</span>
                    </div>`;
            } else {
                // If not on offer, only show the main price (which is stored in product.price in this case)
                priceElement.innerHTML = `<span class="text-2xl font-bold text-price-black">৳${price.toFixed(2)}</span>`;
            }
        }

        function renderInfoDetails(product) {
            const infoDetails = document.getElementById('product-info-details');
            const returnableText = product.isReturnable ? translations[currentLanguage]['returnable'] : translations[currentLanguage]['not-returnable'];
            const returnableIcon = product.isReturnable ? 'fas fa-undo text-green-500' : 'fas fa-ban text-red-500';
            infoDetails.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="${returnableIcon}"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">${returnableText}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-lock text-green-500"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300" data-lang="secure-payments">${translations[currentLanguage]['secure-payments']}</span>
                </div>`;
        }

        function renderAllVariants(product) {
            renderVariantOptions('size', product.sizes);
            renderVariantOptions('storage', product.storage);
            renderVariantOptions('color', product.colors);
        }

        function renderVariantOptions(variantType, options) {
            const containerDiv = document.getElementById(`${variantType}-options`);
            if (!options || options.length === 0) {
                containerDiv.classList.add('hidden');
                return;
            }
            containerDiv.classList.remove('hidden');
            const container = document.getElementById(`${variantType}-variants-container`);
            container.innerHTML = options.map(option => {
                if (variantType === 'color') {
                    return `<button class="w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: ${String(option).toLowerCase()}" data-variant-type="color" data-value="${option}"></button>`;
                }
                return `<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors text-dark" data-variant-type="${variantType}" data-value="${option}">${option}</button>`;
            }).join('');
        }
        function handleVariantSelection(e) {
            const button = e.target.closest('button[data-variant-type]');
            if (!button) return;

            const { variantType, value } = button.dataset;
            const container = button.parentElement;
            
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.remove(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            });
            button.classList.add(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            
            selectedVariants[variantType] = value;

            // Clear missing highlight when user selects a variant
            const labelEl = document.querySelector(`#${variantType}-options label`);
            if (labelEl) labelEl.classList.remove('text-red-600', 'animate-pulse');
        }

        // Helper: highlight missing variant fields and scroll to options
        function highlightMissingVariantUI(missingTypes = []) {
            try {
                missingTypes.forEach(type => {
                    const labelEl = document.querySelector(`#${type}-options label`);
                    const wrapper = document.getElementById(`${type}-options`);
                    if (wrapper) wrapper.classList.remove('hidden');
                    if (labelEl) labelEl.classList.add('text-red-600', 'animate-pulse');
                });
                const opts = document.getElementById('product-options');
                if (opts) opts.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (err) { console.log('Variant highlight failed:', err); }
        }

        // --- Firestore Database Logic ---
        
        function fetchProductsFromFirestore() {
            productsUnsubscribe();
            return new Promise((resolve, reject) => {
                let initialResolved = false;
                try {
                    const productsRef = collection(db, "products");
                    productsUnsubscribe = onSnapshot(productsRef, (querySnapshot) => {
                        try {
                            productsData = querySnapshot.docs.map(docSnap => {
                                const data = docSnap.data() || {};
                                const modelID = data.model1 || data.model || docSnap.id;

                                let categoryValue = data.category ?? data.Category ?? data.cat ?? data.categoryName ?? 'general';
                                if (typeof categoryValue === 'string') categoryValue = categoryValue.trim().toLowerCase();

                                let rawSub = data.subCategory ?? data.subcategory ?? data.sub_category ?? data.subCat ?? data.subcat ?? data.sub ?? null;
                                let normalizedSub = null;
                                if (Array.isArray(rawSub)) {
                                    normalizedSub = rawSub.length ? String(rawSub[0]).trim().toLowerCase() : null;
                                } else if (typeof rawSub === 'string') {
                                    const first = rawSub.split(',')[0];
                                    normalizedSub = first ? first.trim().toLowerCase() : null;
                                } else if (rawSub && typeof rawSub === 'object' && rawSub.name) {
                                    normalizedSub = String(rawSub.name).trim().toLowerCase();
                                }

                                let basePrice = resolveNumberField(data, REGULAR_PRICE_KEYS);
                                if (!(basePrice > 0)) basePrice = null;

                                let offerPrice = resolveNumberField(data, OFFER_PRICE_KEYS);
                                if (!(offerPrice > 0)) offerPrice = null;

                                const hasOfferFlag = resolveBooleanField(data, OFFER_FLAG_KEYS);
                                const flashEnabled = resolveBooleanField(data, FLASH_FLAG_KEYS);
                                let flashPrice = resolveNumberField(data, FLASH_PRICE_KEYS);
                                if (!(flashPrice > 0)) flashPrice = null;

                                const flashStartRaw = getFirstAvailableValue(data, FLASH_START_KEYS);
                                const flashEndRaw = getFirstAvailableValue(data, FLASH_END_KEYS);
                                let flashStartDate = parseFirestoreDate(flashStartRaw);
                                let flashEndDate = parseFirestoreDate(flashEndRaw);
                                const flashDurationHours = resolveNumberField(data, FLASH_DURATION_KEYS);
                                if (!flashEndDate && flashDurationHours && flashDurationHours > 0 && flashStartDate instanceof Date) {
                                    flashEndDate = new Date(flashStartDate.getTime() + flashDurationHours * 3600000);
                                }

                                const nowTs = Date.now();
                                const flashStartTs = flashStartDate instanceof Date ? flashStartDate.getTime() : null;
                                const flashEndTs = flashEndDate instanceof Date ? flashEndDate.getTime() : null;
                                const flashIsActive = flashEnabled && (!flashStartTs || flashStartTs <= nowTs) && (!flashEndTs || flashEndTs > nowTs);
                                const flashIsUpcoming = flashEnabled && !flashIsActive && flashStartTs && flashStartTs > nowTs;

                                let effectivePrice = basePrice && basePrice > 0 ? basePrice : null;
                                let originalPriceValue = null;
                                let isOffer = false;

                                if (flashIsActive && flashPrice && flashPrice > 0) {
                                    if (basePrice && basePrice > flashPrice) {
                                        originalPriceValue = basePrice;
                                    }
                                    effectivePrice = flashPrice;
                                    isOffer = !!originalPriceValue;
                                } else if (hasOfferFlag && offerPrice && basePrice && offerPrice < basePrice) {
                                    effectivePrice = offerPrice;
                                    originalPriceValue = basePrice;
                                    isOffer = true;
                                } else if (!effectivePrice && offerPrice && offerPrice > 0) {
                                    effectivePrice = offerPrice;
                                    if (basePrice && basePrice > offerPrice) {
                                        originalPriceValue = basePrice;
                                        isOffer = true;
                                    }
                                } else if (!effectivePrice && flashPrice && flashPrice > 0) {
                                    effectivePrice = flashPrice;
                                    if (basePrice && basePrice > flashPrice) {
                                        originalPriceValue = basePrice;
                                        isOffer = true;
                                    }
                                }

                                if (!effectivePrice || effectivePrice <= 0) {
                                    const fallbackPrice = Number(data.price) || Number(data.Price) || 0;
                                    effectivePrice = basePrice || offerPrice || flashPrice || fallbackPrice || 0;
                                }

                                if (!originalPriceValue && basePrice && basePrice > effectivePrice) {
                                    originalPriceValue = basePrice;
                                    if (basePrice !== effectivePrice) {
                                        isOffer = true;
                                    }
                                }

                                const flashSale = flashEnabled ? {
                                    enabled: true,
                                    price: flashPrice,
                                    start: flashStartDate || null,
                                    end: flashEndDate || null,
                                    isActive: flashIsActive,
                                    isUpcoming: flashIsUpcoming,
                                    label: getNormalizedString(data.flashSaleLabel || data.flash_sale_label || data.flashsellLabel || data.flashSellLabel || '') || null
                                } : null;

                                const discountReference = originalPriceValue || (basePrice && basePrice > effectivePrice ? basePrice : null);
                                let discountPercent = 0;
                                if (discountReference && discountReference > 0 && discountReference > effectivePrice) {
                                    discountPercent = Math.round(((discountReference - effectivePrice) / discountReference) * 100);
                                }
                                discountPercent = Math.max(0, discountPercent);

                                const megaConfig = (data.megaSale && typeof data.megaSale === 'object') ? data.megaSale : {};
                                const megaFlagInfo = resolveBooleanFieldDetailed(data, MEGA_FLAG_KEYS);
                                const megaConfigInfo = resolveBooleanFieldDetailed(megaConfig, ['enabled']);
                                const explicitMegaTrue = (megaFlagInfo.explicit && megaFlagInfo.value) || (megaConfigInfo.explicit && megaConfigInfo.value);
                                const explicitMegaFalse = (megaFlagInfo.explicit && !megaFlagInfo.value) || (megaConfigInfo.explicit && !megaConfigInfo.value);
                                const megaLabelRaw = getNormalizedString(
                                    getFirstAvailableValue(megaConfig, ['label', 'title', 'badge']) ??
                                    getFirstAvailableValue(data, MEGA_LABEL_KEYS)
                                );
                                const megaConfigDiscount = resolveNumberField(megaConfig, ['discountPercent', 'discount', 'percent']);
                                const megaConfigPrice = resolveNumberField(megaConfig, ['price', 'dealPrice', 'salePrice']);
                                const megaConfigOriginal = resolveNumberField(megaConfig, ['originalPrice', 'compareAt', 'original']);

                                const effectiveDiscountPercent = Number.isFinite(megaConfigDiscount)
                                    ? megaConfigDiscount
                                    : discountPercent;
                                const effectiveMegaPrice = Number.isFinite(megaConfigPrice)
                                    ? megaConfigPrice
                                    : Number(effectivePrice) || 0;
                                const effectiveMegaOriginal = Number.isFinite(megaConfigOriginal)
                                    ? megaConfigOriginal
                                    : (discountReference || null);

                                const megaSaleEnabled = explicitMegaTrue || (!explicitMegaFalse && discountPercent >= MEGA_DISCOUNT_THRESHOLD && isOffer);
                                const megaSale = megaSaleEnabled ? {
                                    ...megaConfig,
                                    enabled: true,
                                    label: megaLabelRaw || megaConfig.label || null,
                                    discountPercent: Number.isFinite(effectiveDiscountPercent) ? effectiveDiscountPercent : null,
                                    price: Number.isFinite(effectiveMegaPrice) ? effectiveMegaPrice : null,
                                    originalPrice: Number.isFinite(effectiveMegaOriginal) ? effectiveMegaOriginal : null
                                } : null;

                                return {
                                    id: docSnap.id,
                                    modelID,
                                    name: data.name || "No Name Provided",
                                    brand: data.brand || "No Brand",
                                    price: Number(effectivePrice) || 0,
                                    basePrice: basePrice || originalPriceValue || Number(effectivePrice) || 0,
                                    originalPrice: originalPriceValue && originalPriceValue > effectivePrice ? originalPriceValue : null,
                                    isOffer,
                                    rating: data.rating || 0,
                                    ratingCount: data.ratingCount || 0,
                                    image: data.imageUrl || '',
                                    imageUrl: data.imageUrl || '',
                                    description: data.details || '',
                                    fullDescription: data.details || '',
                                    category: categoryValue,
                                    subCategory: normalizedSub,
                                    isReturnable: data.isRefundable === true,
                                    specifications: data.specification || {},
                                    reviews: data.reviews || [],
                                    thumbnails: data.thumbnails || [],
                                    sizes: data.variants && typeof data.variants.size === 'string' ? data.variants.size.split(',').map(s => s.trim()) : (Array.isArray(data.sizes) ? data.sizes : []),
                                    storage: data.storage || [],
                                    colors: data.variants && typeof data.variants.color === 'string' ? data.variants.color.split(',').map(c => c.trim()) : (Array.isArray(data.colors) ? data.colors : []),
                                    stock: data.stock !== undefined ? Number(data.stock) : 1,
                                    warrantyText: data.warranty || null,
                                    flashSale,
                                    megaSale,
                                    discountPercent
                                };
                            });

                            renderFlashSaleSection(productsData);
                            renderMegaSaleSection(productsData);

                            if (productsData.length === 0) {
                                DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found in the database.</p>`;
                            } else {
                                renderProducts(productsData);
                            }

                            try { updateCartUI(); } catch (_) {}
                        } catch (processingError) {
                            console.error("Error processing product snapshot: ", processingError);
                            DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-red-500">Error processing products. Check console for details.</p>`;
                        } finally {
                            if (!initialResolved) {
                                initialResolved = true;
                                resolve();
                            }
                        }
                    }, (error) => {
                        console.error("Error fetching products from Firestore: ", error);
                        renderFlashSaleSection([]);
                        renderMegaSaleSection([]);
                        DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products. Check console for details.</p>`;
                        if (!initialResolved) {
                            initialResolved = true;
                            reject(error);
                        }
                    });
                } catch (setupError) {
                    console.error("Error initializing product listener: ", setupError);
                    DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products. Check console for details.</p>`;
                    reject(setupError);
                }
            });
        }
        
        async function fetchBannersFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "banners"));
                const banners = querySnapshot.docs.map(doc => doc.data());
                banners.sort((a, b) => (a.order || 0) - (b.order || 0)); // Sort banners by order

                DOMElements.slidesContainer.innerHTML = '';
                banners.forEach(banner => {
                    const slide = document.createElement('div');
                    slide.className = 'w-full flex-shrink-0 aspect-[3/1]';
                    const link = banner.url || banner.link || banner.href || '';
                    if (link) {
                        const isExternal = /^https?:\/\//i.test(link);
                        slide.innerHTML = `
                            <a href="${link}" ${isExternal ? 'target="_blank" rel="noopener"' : ''} class="block w-full h-full">
                                <img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover" />
                            </a>`;
                    } else {
                        slide.innerHTML = `<img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover">`;
                    }
                    DOMElements.slidesContainer.appendChild(slide);
                });

                initializeSlider(); 
            } catch (error) {
                console.error("Error fetching banners:", error);
                initializeSlider(); // Initialize slider even if fetch fails to handle static/empty state
            }
        }

        // Load Right Promo Tile from Firestore
    async function fetchRightPromoFromFirestore() {
            try {
                // Expect a collection 'sidePromos' with fields: imageUrl, title, subtitle, link(url), alt, active(bool), order(number)
                const snap = await getDocs(collection(db, 'sidePromos'));
                let promos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Filter active first if present
                promos = promos.filter(p => p.active !== false);
                // Sort by order if provided
                promos.sort((a, b) => (a.order || 0) - (b.order || 0));
                const promo = promos[0];
                if (!promo) {
                    // No promo in Firestore: hide any default texts
                    const titleEl0 = DOMElements.rightPromoTitle;
                    const subEl0 = DOMElements.rightPromoSubtitle;
                    if (titleEl0) { titleEl0.textContent = ''; titleEl0.classList.add('hidden'); }
                    if (subEl0) { subEl0.textContent = ''; subEl0.classList.add('hidden'); }
                    return;
                }

                const img = DOMElements.rightPromoImg;
                const titleEl = DOMElements.rightPromoTitle;
                const subEl = DOMElements.rightPromoSubtitle;
                const linkEl = DOMElements.rightPromoLink;
                if (!img || !titleEl || !subEl || !linkEl) return;

                if (promo.imageUrl) {
                    img.src = promo.imageUrl;
                }
                img.alt = promo.alt || promo.title || 'Promo';

                // Language-aware fields (use bn-specific if available)
                const isBn = (typeof currentLanguage !== 'undefined' && currentLanguage === 'bn');
                const titleBn = promo.title_bn || promo.titleBn || promo.titleBangla;
                const subtitleBn = promo.subtitle_bn || promo.subtitleBn || promo.subtitleBangla;
                const title = (isBn && titleBn) ? titleBn : (promo.title || titleBn || '');
                const subtitle = (isBn && subtitleBn) ? subtitleBn : (promo.subtitle || subtitleBn || '');
                if (title && String(title).trim()) {
                    titleEl.textContent = title;
                    titleEl.classList.remove('hidden');
                } else {
                    titleEl.textContent = '';
                    titleEl.classList.add('hidden');
                }
                if (subtitle && String(subtitle).trim()) {
                    subEl.textContent = subtitle;
                    subEl.classList.remove('hidden');
                } else {
                    subEl.textContent = '';
                    subEl.classList.add('hidden');
                }

                const link = promo.url || promo.link || promo.href;
                if (link) {
                    const isExternal = /^https?:\/\//i.test(link);
                    linkEl.setAttribute('href', link);
                    // Remove default scroll onclick when we have a real link
                    linkEl.onclick = null;
                    if (isExternal) {
                        linkEl.setAttribute('target', '_blank');
                        linkEl.setAttribute('rel', 'noopener');
                    } else {
                        linkEl.removeAttribute('target');
                        linkEl.removeAttribute('rel');
                    }
                } else {
                    // Keep internal scroll behavior if no link was provided
                    linkEl.setAttribute('href', 'javascript:void(0)');
                    linkEl.onclick = () => scrollToElement('categories');
                }
            } catch (err) {
                console.error('Error fetching right promo:', err);
                // Keep defaults silently
            }
        }

        function setupFirestoreListeners(user) {
            userDocUnsubscribe();

            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, 'users', user.uid);
                
                userDocUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        setDoc(userDocRef, { email: user.email, name: user.displayName, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', isBlocked: false }, { merge: true });
                        currentUserData = { cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false };
                        return;
                    }
                    const data = docSnap.data() || {};
                    currentUserData = data;
                    if (!Array.isArray(currentUserData.addresses)) currentUserData.addresses = [];
                    
                    // --- Check Block Status ---
                    isCurrentUserBlocked = data.isBlocked || false;
                    if (isCurrentUserBlocked) {
                        showBlockedUI('account-blocked-banner');
                    } else {
                        hideBlockedUI();
                    }
                    // --- End Check Block Status ---

                    updateProfileModalUI(user, data);
                    // Keep addresses UI in sync
                    try { renderAddressesList(); } catch (_) {}
                    // Reconcile selected shipping address if needed
                    try {
                        const addrs = currentUserData.addresses || [];
                        if (!selectedShippingAddressId && addrs.length > 0) {
                            const def = getDefaultAddress(addrs);
                            selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                            selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                        } else if (selectedShippingAddressId) {
                            selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                            if (!selectedShippingAddress && addrs.length > 0) {
                                const def = getDefaultAddress(addrs);
                                selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                                selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                            }
                        }
                        renderSelectedShippingAddress();
                    } catch (_) {}

                    localWishlistCache.clear();
                    const wishlistData = data.wishlist || {};
                    Object.keys(wishlistData).forEach(productId => {
                        if (wishlistData[productId]) {
                           localWishlistCache.add(productId);
                        }
                    });
                    updateWishlistUI();

                    localCartCache.clear();
                    const cartData = data.cart || {};
                    Object.keys(cartData).forEach(cartItemId => {
                        localCartCache.set(cartItemId, cartData[cartItemId]);
                    });
                    updateCartUI();
                }, (error) => {
                    console.error("Error in snapshot listener:", error);
                });
            } else {
                currentUserData = null;
                isCurrentUserBlocked = false; // Reset block status on logout
                hideBlockedUI();
                localCartCache.clear();
                localWishlistCache.clear();
                updateCartUI();
                updateWishlistUI();
                updateProfileModalUI(null);
                selectedShippingAddressId = null;
                selectedShippingAddress = null;
            }
        }
        
        function getRequiredVariants(product) {
            const required = [];
            if (product.sizes && product.sizes.length > 0) required.push('size');
            if (product.storage && product.storage.length > 0) required.push('storage');
            if (product.colors && product.colors.length > 0) required.push('color');
            return required;
        }

    async function addToCartInDb(productId, fromCard = false) {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return Promise.reject("User is blocked");
            }
            if (!currentUser || currentUser.isAnonymous) { 
                showToast("Please log in to manage your cart.", false); 
                openDrawer('profile-drawer'); 
                return Promise.reject("User not logged in"); 
            }
            const product = productsData.find(p => p.id === productId);
            if (!product) return Promise.reject("Product not found");
            
            if (Number(product.stock) <= 0) {
                showToast('toast-out-of-stock', false);
                return Promise.reject("Product is out of stock");
            }
            
            const requiredVariants = getRequiredVariants(product);
            
            if (fromCard && requiredVariants.length > 0) {
                 showProductDetails(productId);
                 showToast('toast-select-variant', false);
                 return Promise.reject("Variants not selected");
            }
            
            for(const variant of requiredVariants) {
                if (!selectedVariants[variant]) {
                    showToast('toast-select-variant', false);
                    return Promise.reject("Variants not selected");
                }
            }

            // Only include variant keys that are actually applicable to this product
            const variantFieldMap = { size: 'sizes', storage: 'storage', color: 'colors' };
            const applicableVariantKeys = ['size','storage','color'].filter(k => {
                const fieldName = variantFieldMap[k];
                const val = product[fieldName];
                return Array.isArray(val) ? val.length > 0 : !!val;
            });
            const selectedForProduct = {};
            for (const key of applicableVariantKeys) {
                if (selectedVariants[key]) selectedForProduct[key] = selectedVariants[key];
            }
            // Use distinct codes for variants to avoid collisions (legacy used _S: for both size and storage)
            const codeMap = { size: 'SZ', storage: 'ST', color: 'C' };
            const sortedVariantKeys = Object.keys(selectedForProduct).sort();
            const variantString = sortedVariantKeys.map(key => `_${codeMap[key]}:${selectedForProduct[key]}`).join('');
            const cartItemId = productId + variantString;
            
            const userDocRef = doc(db, 'users', currentUser.uid);
            
            try {
                const currentItem = localCartCache.get(cartItemId);
                if (currentItem) {
                    // Optimistic increment
                    const backupQty = currentItem.quantity || 0;
                    currentItem.quantity = backupQty + 1;
                    localCartCache.set(cartItemId, currentItem);
                    updateCartUI();
                    await updateDoc(userDocRef, new FieldPath('cart', cartItemId, 'quantity'), increment(1));
                } else {
                    const newItemData = {
                        productId: product.id || '',
                        name: product.name || 'Unknown Product',
                        price: product.price || 0,
                        image: product.imageUrl || product.image || 'https://placehold.co/80x80/ccc/000?text=Image',
                        quantity: 1,
                        ...selectedForProduct
                    };
                    // Optimistic add
                    localCartCache.set(cartItemId, newItemData);
                    updateCartUI();
                    await setDoc(userDocRef, { cart: { [cartItemId]: newItemData } }, { merge: true });
                }
                showToast('toast-cart-added');
                return Promise.resolve();
            } catch (error) {
                 console.error("Error adding to cart: ", error);
                 // Rollback optimistic update for add/increment
                 const existing = localCartCache.get(cartItemId);
                 if (existing) {
                    if ((existing.quantity || 0) > 1) {
                        existing.quantity = (existing.quantity || 1) - 1;
                        localCartCache.set(cartItemId, existing);
                    } else {
                        localCartCache.delete(cartItemId);
                    }
                    updateCartUI();
                 }
                 showToast("Error: Could not add to cart", false);
                 return Promise.reject(error);
            }
        }
        window.addToCartInDb = addToCartInDb;
        
        async function removeFromCart(cartItemId) {
            if (!currentUser || currentUser.isAnonymous) {
                showToast("Please log in to manage your cart.", false);
                openDrawer('profile-drawer');
                return;
            }
            const userDocRef = doc(db, 'users', currentUser.uid);
            // Optimistic update
            const backup = localCartCache.get(cartItemId);
            if (backup) {
                localCartCache.delete(cartItemId);
                updateCartUI();
            }
            try {
                await updateDoc(userDocRef, new FieldPath('cart', cartItemId), deleteField());
                // Remove DOM row immediately as a visual confirmation
                const rowSelector = `[data-cart-item-id="${cartItemId}"]`;
                document.querySelectorAll(rowSelector).forEach(el => el.remove());
                // If cache is empty now, show empty state
                if (localCartCache.size === 0) {
                    const emptyHtml = `<p data-lang="cart-empty" class="text-center text-gray-500">${translations[currentLanguage]['cart-empty']}</p>`;
                    const cartEl = DOMElements.cartItems;
                    const pageItems = document.getElementById('cart-page-items');
                    if (cartEl && !cartEl.innerHTML.trim()) cartEl.innerHTML = emptyHtml;
                    if (pageItems && !pageItems.innerHTML.trim()) pageItems.innerHTML = emptyHtml;
                }
            } catch (error) {
                // Rollback on error
                if (backup) {
                    localCartCache.set(cartItemId, backup);
                    updateCartUI();
                }
                console.error("Error removing from cart: ", error);
                showToast("Error: Could not remove item", false);
            }
        }
        window.removeFromCart = removeFromCart;

        async function updateQuantity(cartItemId, change) {
            if (!currentUser || currentUser.isAnonymous) {
                showToast("Please log in to manage your cart.", false);
                openDrawer('profile-drawer');
                return;
            }
            const currentItem = localCartCache.get(cartItemId);
            const currentQuantity = currentItem?.quantity || 0;
            if (currentQuantity + change <= 0) {
                // Optimistic remove when quantity would go to 0 or less
                await removeFromCart(cartItemId);
                return;
            }
            // Optimistic quantity update
            const userDocRef = doc(db, 'users', currentUser.uid);
            const backupQty = currentQuantity;
            if (currentItem) {
                currentItem.quantity = currentQuantity + change;
                localCartCache.set(cartItemId, currentItem);
                updateCartUI();
            }
            try {
                await updateDoc(userDocRef, new FieldPath('cart', cartItemId, 'quantity'), increment(change));
            } catch (error) {
                // Rollback on error
                if (currentItem) {
                    currentItem.quantity = backupQty;
                    localCartCache.set(cartItemId, currentItem);
                    updateCartUI();
                }
                console.error("Error updating quantity: ", error);
                showToast("Error: Could not update quantity", false);
            }
        }
        window.updateQuantity = updateQuantity;
        
        async function toggleWishlistInDb(productId) {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) { showToast("Please log in to manage your wishlist.", false); openDrawer('profile-drawer'); return; }
            const userDocRef = doc(db, 'users', currentUser.uid);
            const isWished = localWishlistCache.has(productId);

            try {
                if (isWished) {
                    await updateDoc(userDocRef, { [`wishlist.${productId}`]: deleteField() });
                } else {
                    await setDoc(userDocRef, { wishlist: { [productId]: true } }, { merge: true });
                }
                showToast(isWished ? 'toast-wishlist-removed' : 'toast-wishlist-added', true);
            } catch (error) {
                console.error("Error updating wishlist: ", error);
                showToast("Error: Could not update wishlist", false);
            }
        }
        
        async function updateCartUI() {
            // Use effective price: prefer item.price, fall back to product price from productsData
            const subtotal = Array.from(localCartCache.entries()).reduce((sum, [cartItemId, item]) => {
                const productRef = getProductRefForCartItem(cartItemId, item);
                const unitPrice = Number(item?.price ?? productRef?.price ?? 0);
                const qty = Number(item?.quantity ?? 0);
                return sum + (unitPrice * qty);
            }, 0);
            
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const total = subtotal + deliveryCharge - discountAmount;
            
            if (DOMElements.cartSubtotal) DOMElements.cartSubtotal.textContent = `৳${subtotal.toFixed(2)}`;
            
            if (discountAmount > 0) {
             if (DOMElements.discountRow) DOMElements.discountRow.classList.remove('hidden');
             if (DOMElements.cartDiscount) DOMElements.cartDiscount.textContent = `- ৳${discountAmount.toFixed(2)}`;
            } else {
              if (DOMElements.discountRow) DOMElements.discountRow.classList.add('hidden');
            }
            
          if (DOMElements.deliveryCharge) DOMElements.deliveryCharge.textContent = `৳${deliveryCharge.toFixed(2)}`;
          if (DOMElements.cartTotal) DOMElements.cartTotal.textContent = `৳${total.toFixed(2)}`;

            // Mirror values to full-page cart if present
            const pageSubtotal = document.getElementById('cart-page-subtotal');
            const pageDelivery = document.getElementById('cart-page-delivery');
            const pageTotal = document.getElementById('cart-page-total');
            const pageDiscountRow = document.getElementById('cart-page-discount-row');
            const pageDiscount = document.getElementById('cart-page-discount');
            if (pageSubtotal) pageSubtotal.textContent = `৳${subtotal.toFixed(2)}`;
            if (pageDelivery) pageDelivery.textContent = `৳${deliveryCharge.toFixed(2)}`;
            if (pageTotal) pageTotal.textContent = `৳${total.toFixed(2)}`;
            if (pageDiscountRow && pageDiscount) {
                if (discountAmount > 0) {
                    pageDiscountRow.classList.remove('hidden');
                    pageDiscount.textContent = `- ৳${discountAmount.toFixed(2)}`;
                } else {
                    pageDiscountRow.classList.add('hidden');
                }
            }

            // Applied coupon message under Order Summary input
            const pageCouponMsg = document.getElementById('cart-page-coupon-applied');
            if (pageCouponMsg) {
                if (appliedCouponCode && discountAmount > 0) {
                    pageCouponMsg.textContent = `Applied ${appliedCouponCode}: - ৳${discountAmount.toFixed(2)}`;
                    pageCouponMsg.classList.remove('hidden');
                } else {
                    pageCouponMsg.classList.add('hidden');
                    pageCouponMsg.textContent = '';
                }
            }

            const totalItems = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
            if (DOMElements.cartCount) DOMElements.cartCount.textContent = totalItems;
            renderCartItems();
        }

      async function getDeliveryCharge(subtotal) {
          if (!currentUser || !currentUserData) return 0;
          if (subtotal <= 0) return 0;
            
            const ordersRef = collection(db, "orders");
            // NOTE: We rely on client-side sorting instead of Firestore orderBy for simplicity/index avoidance
            const q = query(ordersRef, where("userId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            const isFirstOrder = querySnapshot.empty;
            
            const location = (currentUserData?.location || "").toLowerCase();
            const isInTangail = location.includes("tangail");

            if (isInTangail) {
                return isFirstOrder && subtotal > 500 ? 0 : 100;
            } else {
                return isFirstOrder && subtotal > 1000 ? 0 : 200;
            }
        }

        function renderCartItems() {
            const cartEl = DOMElements.cartItems;
            const pageItems = document.getElementById('cart-page-items');
            if (!currentUser || currentUser.isAnonymous) {
                if (cartEl) cartEl.innerHTML = `<p class="text-center text-gray-500">Please log in to see your cart.</p>`;
                if (pageItems) pageItems.innerHTML = `<p class="text-center text-gray-500">Please log in to see your cart.</p>`;
                return;
            }
            
            let cartHtml = '';
            
            if(localCartCache.size === 0){
                // Empty state with smart suggestions from wishlist or featured products
                const emptyMsg = `<p data-lang="cart-empty" class="text-center text-gray-500 mb-4">${translations[currentLanguage]['cart-empty']}</p>`;
                let subheading = '';
                let suggested = [];
                try {
                    const all = Array.isArray(productsData) ? productsData : [];
                    if (localWishlistCache && localWishlistCache.size > 0) {
                        subheading = '<h4 class="text-center font-semibold text-gray-800 dark:text-gray-100 mb-3">Add items from your Wishlist?</h4>';
                        suggested = all.filter(p => p && localWishlistCache.has(p.id));
                    } else {
                        subheading = '<h4 class="text-center font-semibold text-gray-800 dark:text-gray-100 mb-3">Shop our Featured Products</h4>';
                        suggested = all.slice().sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
                    }
                } catch (e) { /* fallback: no suggestions */ }

                // Horizontal row showing up to 6 products
                const row = (suggested && suggested.length > 0) ? (`
                    <div class="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                        ${suggested.slice(0, 6).map(p => {
                            const img = p?.imageUrl || p?.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                            const name = (p?.name || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            const price = Number(p?.price || 0);
                            return `
                                <div class="w-40 flex-shrink-0 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden">
                                    <div class="aspect-square bg-gray-50 dark:bg-gray-900 flex items-center justify-center overflow-hidden">
                                        <img src="${img}" alt="${name}" class="w-full h-full object-cover"/>
                                    </div>
                                    <div class="p-3 flex flex-col gap-2">
                                        <p class="text-sm font-medium line-clamp-2">${name}</p>
                                        <div class="text-sm font-semibold text-price-black">৳${price.toFixed(0)}</div>
                                        <button class="mt-auto inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-full bg-theme-pink text-white hover:bg-theme-purple"
                                            onclick="addToCartInDb && addToCartInDb('${p?.id}', true)">Add to Cart</button>
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>
                `) : '';

                const combinedHtml = `<div class="py-4">${emptyMsg}${subheading}${row}</div>`;
                if (cartEl) cartEl.innerHTML = combinedHtml;
                if (pageItems) pageItems.innerHTML = combinedHtml;
            } else {
                for (const [cartItemId, item] of localCartCache.entries()) {
                    // Build variants text
                    let variantsHtml = '<div class="text-[11px] text-gray-500 mt-0.5">';
                    if (item.size) variantsHtml += `Size: ${item.size} `;
                    if (item.color) variantsHtml += `Color: ${item.color} `;
                    if (item.storage) variantsHtml += `Storage: ${item.storage} `;
                    variantsHtml += '</div>';

                    // Enrich with product data for missing fields and discount/original price
                    const productRef = getProductRefForCartItem(cartItemId, item);
                    const displayName = item?.name || productRef?.name || 'Unknown Product';
                    const displayImage = item?.image || productRef?.imageUrl || productRef?.image || 'https://placehold.co/80x80/ccc/000?text=Image';
                    const unitPrice = Number(item?.price ?? productRef?.price ?? 0);
                    const hasDiscount = !!(productRef && productRef.isOffer && productRef.originalPrice && productRef.originalPrice > unitPrice);
                    const discountPercent = hasDiscount ? Math.round(((Number(productRef.originalPrice) - unitPrice) / Number(productRef.originalPrice)) * 100) : 0;

                    let priceHtml = '';
                    if (hasDiscount) {
                        priceHtml = `
                            <div class="flex items-baseline gap-2 flex-wrap mt-1">
                                <span class="text-base sm:text-md font-bold text-price-black">৳${unitPrice.toFixed(2)}</span>
                                <span class="text-xs text-gray-400 line-through">৳${Number(productRef.originalPrice).toFixed(2)}</span>
                                <span class="text-[10px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded">-${discountPercent}%</span>
                            </div>`;
                    } else {
                        priceHtml = `<div class="mt-1"><span class="text-base sm:text-md font-bold text-price-black">৳${unitPrice.toFixed(2)}</span></div>`;
                    }

                    // Compose each cart row (mobile-first, Temu-like compact)
                    cartHtml += `
                        <div class="rounded-2xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 p-3 sm:p-4 shadow-sm" data-cart-item-id="${cartItemId}">
                            <div class="flex gap-3">
                                <img src="${displayImage}" alt="${displayName}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-[15px] sm:text-base font-semibold text-theme-purple leading-tight break-words">${displayName}</h4>
                                    ${variantsHtml}
                                    ${priceHtml}
                                </div>
                                <button onclick="removeFromCart('${cartItemId}')" class="text-red-500 hover:text-red-600 ml-1 self-start"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQuantity('${cartItemId}', -1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                                    <span class="w-8 text-center text-dark">${item.quantity}</span>
                                    <button onclick="updateQuantity('${cartItemId}', 1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                                </div>
                                <div class="text-[12px] text-gray-500">৳${(unitPrice * (item.quantity || 0)).toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }
                // Also append a Featured Products section below the cart items
                let featuredSection = '';
                try {
                    const all = Array.isArray(productsData) ? productsData : [];
                    const suggested = all.slice().sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
                    if (suggested.length > 0) {
                        const row = `
                            <div class="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                                ${suggested.slice(0, 6).map(p => {
                                    const img = p?.imageUrl || p?.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                                    const name = (p?.name || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                                    const price = Number(p?.price || 0);
                                    return `
                                        <div class="w-40 flex-shrink-0 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden">
                                            <div class="aspect-square bg-gray-50 dark:bg-gray-900 flex items-center justify-center overflow-hidden">
                                                <img src="${img}" alt="${name}" class="w-full h-full object-cover"/>
                                            </div>
                                            <div class="p-3 flex flex-col gap-2">
                                                <p class="text-sm font-medium line-clamp-2">${name}</p>
                                                <div class="text-sm font-semibold text-price-black">৳${price.toFixed(0)}</div>
                                                <button class="mt-auto inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-full bg-theme-pink text-white hover:bg-theme-purple"
                                                    onclick="addToCartInDb && addToCartInDb('${p?.id}', true)">Add to Cart</button>
                                            </div>
                                        </div>`;
                                }).join('')}
                            </div>
                        `;
                        featuredSection = `
                            <div class="mt-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-3">Featured Products</h4>
                                ${row}
                            </div>`;
                    }
                } catch(e) { /* ignore */ }

                const combined = cartHtml + featuredSection;
                if (cartEl) cartEl.innerHTML = combined;
                if (pageItems) pageItems.innerHTML = combined;
            }
        }
        
        function updateWishlistUI() {
            renderProducts(currentDisplayedProducts);
            if (!document.getElementById('wishlist-page').classList.contains('hidden')) {
                renderWishlistItems();
            }
        }

        function renderWishlistItems() {
            DOMElements.wishlistItems.innerHTML = '';
            if (localWishlistCache.size === 0) {
                DOMElements.wishlistItems.innerHTML = `<p class="col-span-full text-center text-gray-500" data-lang="wishlist-empty">${translations[currentLanguage]['wishlist-empty']}</p>`;
                return;
            }
            const wishedProducts = productsData.filter(p => localWishlistCache.has(p.id));
            
            const tempContainer = document.createElement('div');
            // Temporarily re-assign productList to render into our temp container
            const originalProductList = DOMElements.productList;
            DOMElements.productList = tempContainer;
            renderContext = 'wishlist';
            renderProducts(wishedProducts);
            // Inject Remove buttons in place of the wishlist heart
            const tmp = document.createElement('div');
            tmp.innerHTML = tempContainer.innerHTML;
            tmp.querySelectorAll('.product-card').forEach(card => {
                const wishBtn = card.querySelector('.wishlist');
                if (wishBtn) {
                    const pid = wishBtn.getAttribute('data-product-id') || (card.dataset.productId || '');
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-from-wishlist bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600 transition-colors';
                    removeBtn.setAttribute('data-product-id', pid);
                    removeBtn.textContent = translations[currentLanguage]['remove'] || 'Remove';
                    wishBtn.replaceWith(removeBtn);
                }
            });
            DOMElements.wishlistItems.innerHTML = tmp.innerHTML;
            DOMElements.productList = originalProductList; // Reset to original
            renderContext = null;
        }

        // --- CART HELPERS ---
        function getBaseProductId(cartItemId) {
            if (!cartItemId) return '';
            // Find start of variant segment. Support both legacy keys (_S:, _C:) and new keys (_SZ:, _ST:, _C:)
            const indices = [
                cartItemId.indexOf('_SZ:'), // size (new)
                cartItemId.indexOf('_ST:'), // storage (new)
                cartItemId.indexOf('_S:'),  // legacy size/storage
                cartItemId.indexOf('_C:')   // color (legacy and new)
            ].filter(i => i >= 0);
            if (indices.length === 0) return cartItemId;
            const minIdx = Math.min(...indices);
            return cartItemId.slice(0, minIdx);
        }

        function getProductRefForCartItem(cartItemId, item) {
            const pid = item?.productId || getBaseProductId(cartItemId);
            if (!pid) return null;
            return (productsData || []).find(p => p.id === pid) || null;
        }
        // --- END CART HELPERS ---

        // --- AUTHENTICATION ---
        
        async function initialAuthBootstrap() {
            if (window.initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, window.initialAuthToken);
                } catch (error) {
                    console.warn("Custom token sign-in failed. Anonymous sign-in attempt skipped due to potential auth restrictions. Error:", error);
                }
            } else {
                console.log("No initial auth token provided. Skipping anonymous sign-in attempt to avoid errors.");
            }
        }
        
        onAuthStateChanged(auth, user => {
             // Stop listening for previous user's block status
            unsubscribeUserStatus();
            
            if (user && !user.isAnonymous) {
                currentUser = user;
                const userRef = doc(db, 'users', user.uid);
                // Backfill createdAt if missing
                getDoc(userRef).then(snap => {
                    if (snap.exists() && !snap.data()?.createdAt) {
                        updateDoc(userRef, { createdAt: serverTimestamp() }).catch(() => {});
                    }
                }).catch(() => {});
                
                // Listen for real-time changes to the user's block status
                unsubscribeUserStatus = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        isCurrentUserBlocked = userData.isBlocked || false;

                        if (isCurrentUserBlocked) {
                            showBlockedUI('account-blocked-banner');
                        } else {
                            hideBlockedUI();
                        }
                    }
                });

                setupFirestoreListeners(user);
            } else if (user && user.isAnonymous) {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            } else {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            }
        });

        function updateProfileModalUI(user, data = null) {
            const userData = data || currentUserData;
            if (user && !user.isAnonymous) {
                DOMElements.authOptions.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userPhoto.src = user.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.userName.textContent = user.displayName || 'User';
                DOMElements.userEmail.textContent = user.email;
                DOMElements.userMobile.textContent = userData?.mobile ? `📱 ${userData.mobile}` : '';
                // Prefer default saved address for display if available
                const addrs = Array.isArray(userData?.addresses) ? userData.addresses : [];
                if (addrs.length > 0) {
                    const def = getDefaultAddress(addrs) || addrs[0];
                    DOMElements.userLocation.textContent = def?.line1 ? `📍 ${def.line1}${def.city ? ', ' + def.city : ''}` : '';
                } else {
                    DOMElements.userLocation.textContent = userData?.location ? `📍 ${userData.location}` : '';
                }

            } else {
                DOMElements.authOptions.classList.remove('hidden');
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
                const addrSec = DOMElements.addressesSection; if (addrSec) addrSec.classList.add('hidden');
            }
        }
        
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
             if (!docSnap.exists()) {
                 await setDoc(userDocRef, { email: user.email, name: user.displayName, photoURL: user.photoURL, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', addresses: [], isBlocked: false, createdAt: serverTimestamp() });
             } else if (!docSnap.data()?.createdAt) {
                 await updateDoc(userDocRef, { createdAt: serverTimestamp() });
             }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error("Google sign-in error", error);
                if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = "This domain is not authorized. Please add it in your Firebase console.";
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleFacebookLogin() {
            const provider = new FacebookAuthProvider();
            // Optional: request additional scopes
            // provider.addScope('public_profile');
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    await setDoc(userDocRef, { email: user.email || '', name: user.displayName || 'Facebook User', photoURL: user.photoURL || '', cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', addresses: [], isBlocked: false, createdAt: serverTimestamp() });
                } else if (!docSnap.data()?.createdAt) {
                    await updateDoc(userDocRef, { createdAt: serverTimestamp() });
                }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error('Facebook sign-in error', error);
                if (error.code === 'auth/account-exists-with-different-credential') {
                    DOMElements.authError.textContent = 'An account already exists with the same email. Please sign in with the provider you used previously.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = 'This domain is not authorized for Facebook login. Add it in your Firebase console Auth settings.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // Re-authenticate anonymously to maintain connection
                await signInAnonymously(auth);
                closeDrawer();
                showToast('toast-logout-success');
            } catch (error) {
                console.error("Logout error", error);
            }
        }

        function toggleAuthForms(formToShow) {
            const normalized = formToShow === 'register' || formToShow === 'reset' ? formToShow : 'login';
            let effectiveForm = normalized;
            let focusSelector = '#login-email';

            if (DOMElements.authError) {
                DOMElements.authError.textContent = '';
            }

            if (DOMElements.loginForm) DOMElements.loginForm.classList.add('hidden');
            if (DOMElements.registerForm) DOMElements.registerForm.classList.add('hidden');
            if (DOMElements.resetForm) DOMElements.resetForm.classList.add('hidden');

            if (normalized === 'register') {
                if (DOMElements.registerForm) {
                    DOMElements.registerForm.classList.remove('hidden');
                    focusSelector = '#register-name';
                }
                DOMElements.profileDrawerTitle.textContent = resolveLocalizedString('register', {}, currentLanguage) || 'Register';
            } else if (normalized === 'reset') {
                if (DOMElements.resetForm) {
                    const loginEmail = DOMElements.loginForm?.querySelector('#login-email')?.value || '';
                    if (loginEmail && DOMElements.resetEmail) {
                        DOMElements.resetEmail.value = loginEmail;
                    }
                    DOMElements.resetForm.classList.remove('hidden');
                    focusSelector = '#reset-email';
                    DOMElements.profileDrawerTitle.textContent = resolveLocalizedString('auth-reset-heading', {}, currentLanguage) || 'Reset Password';
                } else {
                    if (DOMElements.loginForm) DOMElements.loginForm.classList.remove('hidden');
                    DOMElements.profileDrawerTitle.textContent = resolveLocalizedString('login', {}, currentLanguage) || 'Login';
                    effectiveForm = 'login';
                    focusSelector = '#login-email';
                }
            } else {
                if (DOMElements.loginForm) DOMElements.loginForm.classList.remove('hidden');
                DOMElements.profileDrawerTitle.textContent = resolveLocalizedString('login', {}, currentLanguage) || 'Login';
                focusSelector = '#login-email';
            }

            currentAuthForm = effectiveForm;

            const headingKey = effectiveForm === 'register' ? 'auth-register-heading' : effectiveForm === 'reset' ? 'auth-reset-heading' : 'auth-login-heading';
            const subtitleKey = effectiveForm === 'register' ? 'auth-register-subtitle' : effectiveForm === 'reset' ? 'auth-reset-subtitle' : 'auth-login-subtitle';
            const iconClass = effectiveForm === 'register' ? 'fas fa-user-plus' : effectiveForm === 'reset' ? 'fas fa-key' : 'fas fa-shield-alt';

            if (DOMElements.authCardHeading) {
                DOMElements.authCardHeading.textContent = resolveLocalizedString(headingKey, {}, currentLanguage) || DOMElements.authCardHeading.textContent;
            }
            if (DOMElements.authSubtitle) {
                DOMElements.authSubtitle.textContent = resolveLocalizedString(subtitleKey, {}, currentLanguage) || DOMElements.authSubtitle.textContent;
            }
            if (DOMElements.authHeroIcon) {
                DOMElements.authHeroIcon.className = iconClass;
            }

            if (DOMElements.authTabs && DOMElements.authTabs.length > 0) {
                DOMElements.authTabs.forEach((tab) => {
                    const isActive = tab.dataset?.authTab === effectiveForm;
                    tab.classList.toggle('auth-tab-active', isActive);
                    tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                });
            }

            requestAnimationFrame(() => {
                const targetInput = document.querySelector(focusSelector);
                if (targetInput) {
                    targetInput.focus();
                }
            });
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = DOMElements.registerForm.querySelector('#register-name').value;
            const mobile = DOMElements.registerForm.querySelector('#register-mobile').value;
            const location = DOMElements.registerForm.querySelector('#register-location').value;
            const email = DOMElements.registerForm.querySelector('#register-email').value;
            const password = DOMElements.registerForm.querySelector('#register-password').value;
            DOMElements.authError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                const userDocRef = doc(db, 'users', userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, name, mobile, location, addresses: [], cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false, createdAt: serverTimestamp() });

                closeDrawer();
                showToast('toast-register-success', true); 
            } catch (error) {
                DOMElements.authError.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            // FIX: Corrected DOMEElements to DOMElements
            const email = DOMElements.loginForm.querySelector('#login-email').value;
            const password = DOMElements.loginForm.querySelector('#login-password').value;
            DOMElements.authError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                 // Better messaging for common cases
                 if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                     try {
                         const methods = await fetchSignInMethodsForEmail(auth, email);
                         if (!methods || methods.length === 0) {
                             // No account exists for this email
                             DOMElements.authError.textContent = currentLanguage === 'bn'
                                 ? "আপনার কোন অ্যাকাউন্ট নেই। অনুগ্রহ করে একটি অ্যাকাউন্ট তৈরি করুন।"
                                 : "You don't have an account. Please create one.";
                         } else {
                             // Account exists but password is wrong or signed up with provider
                             if (methods.includes('password')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "পাসওয়ার্ড সঠিক নয়। অনুগ্রহ করে আবার চেষ্টা করুন।"
                                     : "Incorrect password. Please try again.";
                             } else if (methods.includes('google.com') || methods.includes('facebook.com')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "আপনি সোশ্যাল লগইন দিয়ে সাইন আপ করেছেন। অনুগ্রহ করে সেই প্রোভাইডার দিয়ে লগইন করুন।"
                                     : "This email is registered via social login. Please sign in with that provider.";
                             } else {
                                 DOMElements.authError.textContent = error.message;
                             }
                         }
                     } catch (e2) {
                         DOMElements.authError.textContent = currentLanguage === 'bn'
                             ? "লগইন করতে ব্যর্থ হয়েছে। অনুগ্রহ করে তথ্যগুলো যাচাই করুন।"
                             : "Login failed. Please verify your details.";
                     }
                 } else if (error.code === 'auth/user-not-found') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "আপনার কোন অ্যাকাউন্ট নেই। অনুগ্রহ করে একটি অ্যাকাউন্ট তৈরি করুন।"
                         : "You don't have an account. Please create one.";
                 } else if (error.code === 'auth/invalid-email') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "ইমেইল ঠিকানা সঠিক নয়।"
                         : "Invalid email address.";
                 } else {
                     DOMElements.authError.textContent = error.message;
                 }
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            try {
                const email = DOMElements.resetEmail.value.trim();
                DOMElements.authError.textContent = '';
                if (!email) {
                    DOMElements.authError.textContent = 'Please enter your email.';
                    return;
                }
                await sendPasswordResetEmail(auth, email);
                showToast('Password reset email sent! Check your inbox.');
                // Navigate back to login
                toggleAuthForms('login');
            } catch (error) {
                console.error('Password reset error', error);
                if (error.code === 'auth/invalid-email') {
                    DOMElements.authError.textContent = 'Invalid email address.';
                } else if (error.code === 'auth/user-not-found') {
                    DOMElements.authError.textContent = 'No user found with this email.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function reauthenticateForSensitiveAction() {
            // Try to reauthenticate depending on the provider
            const user = auth.currentUser;
            if (!user) throw new Error('No authenticated user');
            const providerId = user.providerData?.[0]?.providerId;

            try {
                if (providerId === 'google.com') {
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'facebook.com') {
                    const provider = new FacebookAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'password') {
                    // Prompt the user for their password
                    const email = user.email;
                    const password = prompt('Please re-enter your password to confirm deletion:');
                    if (!password) throw new Error('Reauthentication cancelled.');
                    const credential = EmailAuthProvider.credential(email, password);
                    await reauthenticateWithCredential(user, credential);
                } else {
                    // Default: try Google popup if available, else fail
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                }
                return true;
            } catch (e) {
                console.error('Reauthentication failed:', e);
                return false;
            }
        }

        async function handleDeleteAccountConfirmed() {
            if (!currentUser) return;
            const user = currentUser;

            const attemptDelete = async () => {
                // 1. Delete Firestore user document
                const userDocRef = doc(db, 'users', user.uid);
                await deleteDoc(userDocRef).catch(() => {}); // tolerate if already missing

                // 2. Delete profile photo from Storage (if exists)
                if (user.photoURL) {
                    const storageRef = ref(storage, `profileImages/${user.uid}`);
                    await deleteObject(storageRef).catch(e => console.log("No profile image found to delete or storage permission denied.", e));
                }

                // 3. Delete the user from Firebase Auth
                await deleteUser(user);
            };

            try {
                await attemptDelete();
                // Show success immediately if delete succeeded, regardless of anon sign-in
                showToast('account-deleted', true);
                closeDrawer();
                // Best-effort: sign in anonymously (do not impact success)
                signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
            } catch (error) {
                console.error("Error deleting account:", error);
                if (error.code === 'auth/requires-recent-login') {
                    const ok = await reauthenticateForSensitiveAction();
                    if (ok) {
                        try {
                            await attemptDelete();
                            showToast('account-deleted', true);
                            closeDrawer();
                            signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
                            return;
                        } catch (e2) {
                            console.error('Delete after reauth failed:', e2);
                        }
                    }
                }
                showToast('delete-account-failed', false);
            }
        }
        
        function handleDeleteAccount() {
            if (!currentUser || currentUser.isAnonymous) return;
            
            showConfirmModal(
                translations[currentLanguage]['delete-account-confirm'],
                translations[currentLanguage]['confirm-delete-title'],
                handleDeleteAccountConfirmed
            );
        }
        
        async function handleProfileUpdate(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;
            
            const saveBtn = DOMElements.saveProfileBtn;
            saveBtn.querySelector('.btn-text').classList.add('hidden');
            saveBtn.querySelector('.loader-small').classList.remove('hidden');
            saveBtn.disabled = true;

            const newName = DOMElements.editNameInput.value;
            const newMobile = DOMElements.editMobileInput.value;
            const newLocation = DOMElements.editLocationInput.value;
            const photoFile = DOMElements.editPhotoInput.files[0];
            const wantRemovePhoto = DOMElements.editPhotoInput.dataset.remove === 'true';

            const authUpdateData = {};
            const firestoreUpdateData = {};

            if (newName !== currentUser.displayName) {
                authUpdateData.displayName = newName;
                firestoreUpdateData.name = newName;
            }
            if (newMobile !== (currentUserData.mobile || '')) {
                firestoreUpdateData.mobile = newMobile;
            }
            if (newLocation !== (currentUserData.location || '')) {
                firestoreUpdateData.location = newLocation;
            }

            try {
                if (photoFile) {
                    const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                    await uploadBytes(storageRef, photoFile);
                    const downloadURL = await getDownloadURL(storageRef);
                    authUpdateData.photoURL = downloadURL;
                    firestoreUpdateData.photoURL = downloadURL;
                } else if (wantRemovePhoto) {
                    // Remove profile image from Storage and clear URLs
                    try {
                        const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                        await deleteObject(storageRef);
                    } catch (e) {
                        console.log('No profile image to delete or permission denied.', e);
                    }
                    authUpdateData.photoURL = null;
                    firestoreUpdateData.photoURL = deleteField();
                }

                if (Object.keys(authUpdateData).length > 0) {
                    await updateProfile(auth.currentUser, authUpdateData);
                }

                if (Object.keys(firestoreUpdateData).length > 0) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userDocRef, firestoreUpdateData);
                }
                
                // Reset file input and remove flag, update profile avatar preview
                DOMElements.editPhotoInput.value = '';
                delete DOMElements.editPhotoInput.dataset.remove;
                if (authUpdateData.photoURL === null) {
                    // Removed photo
                    DOMElements.userPhoto.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                } else if (authUpdateData.photoURL) {
                    DOMElements.userPhoto.src = authUpdateData.photoURL;
                }
                showToast('profile-updated');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
                if (DOMElements.profileDrawerTitle) {
                    DOMElements.profileDrawerTitle.dataset.lang = 'your-account';
                    updateTextContent();
                }

            } catch(error) {
                console.error("Full error object:", error);
                let errorMessageKey = 'profile-update-fail';
                 if (error.code && error.code.includes('storage/unauthorized')) {
                    errorMessageKey = 'toast-storage-permission-error'; 
                }
                showToast(errorMessageKey, false);
            } finally {
                saveBtn.querySelector('.btn-text').classList.remove('hidden');
                saveBtn.querySelector('.loader-small').classList.add('hidden');
                saveBtn.disabled = false;
            }
        }

        // --- DRAWER & MODAL LOGIC ---
        function openDrawer(drawerId) {
            closeDrawer(); // Stop chat listener when closing drawers

            const drawer = document.getElementById(drawerId);
            if (!drawer) return;

            if (drawerId === 'cart-drawer') {
                setActiveMobileNav('cart');
            } else if (drawerId === 'profile-drawer') {
                setActiveMobileNav('profile');
            } else if (drawerId === 'mobile-categories-drawer') {
                setActiveMobileNav('categories');
            } else {
                setActiveMobileNav(baseMobileNavKey);
            }

            if (drawerId === 'profile-drawer') {
                if (!currentUser || currentUser.isAnonymous) {
                    toggleAuthForms('login');
                } else {
                    if (DOMElements.profileDrawerTitle) DOMElements.profileDrawerTitle.dataset.lang = 'your-account';
                    if (DOMElements.userProfileView) DOMElements.userProfileView.classList.remove('hidden');
                    if (DOMElements.editProfileForm) DOMElements.editProfileForm.classList.add('hidden');
                    if (DOMElements.addressesSection) DOMElements.addressesSection.classList.add('hidden');
                    updateTextContent();
                }

                if (DOMElements.profileFullSection && window.innerWidth < 768) {
                    DOMElements.profileFullSection.classList.add('hidden');
                }

                if (DOMElements.mobileProfileToggleBtn) {
                    DOMElements.mobileProfileToggleBtn.setAttribute('aria-expanded', 'false');
                    const icon = DOMElements.mobileProfileToggleBtn.querySelector('i');
                    if (icon) {
                        icon.classList.add('fa-plus');
                        icon.classList.remove('fa-minus');
                    }
                }
            }

            DOMElements.drawerOverlay.classList.remove('hidden');
            drawer.classList.add('active');
            if (drawerId === 'cart-drawer') {
                updateCartUI();
                // Coupons list removed; only apply coupon option remains
            }
        }
        window.openDrawer = openDrawer;

        function toggleMobileProfileDetails(triggerBtn) {
            const section = DOMElements.profileFullSection;
            const toggleButton = triggerBtn || DOMElements.mobileProfileToggleBtn;
            if (!section || !toggleButton) return;

            const willShow = section.classList.contains('hidden');
            if (willShow) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }

            toggleButton.setAttribute('aria-expanded', willShow ? 'true' : 'false');
            const icon = toggleButton.querySelector('i');
            if (icon) {
                icon.classList.toggle('fa-plus', !willShow);
                icon.classList.toggle('fa-minus', willShow);
            }
        }
        window.toggleMobileProfileDetails = toggleMobileProfileDetails;

        function closeDrawer() {
            DOMElements.drawerOverlay.classList.add('hidden');
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('active'));
            setActiveMobileNav(baseMobileNavKey);
            chatUnsubscribe(); // Ensure chat listener stops when drawer closes
        }
        window.closeDrawer = closeDrawer;

        // Custom Confirmation Modal
        function showConfirmModal(message, title, onConfirm) {
            DOMElements.confirmTitle.textContent = title;
            DOMElements.confirmMessage.textContent = message;
            DOMElements.confirmationModal.classList.remove('hidden');
            DOMElements.confirmationModal.classList.add('flex');

            confirmResolver = onConfirm;
        }

        function closeConfirmModal() {
            DOMElements.confirmationModal.classList.add('hidden');
            DOMElements.confirmationModal.classList.remove('flex');
            confirmResolver = null;
        }
        
        function handleConfirmClick() {
            if (confirmResolver) {
                confirmResolver();
            }
            closeConfirmModal();
        }

        function handleCancelClick() {
            closeConfirmModal();
        }

        function openPaymentModal() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to check out.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }
            // Address validation: require at least one saved address or fallback to legacy fields
            const addrs = Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
            if (addrs.length === 0) {
                if (!currentUserData?.location || !currentUserData?.mobile) {
                    showToast('Please add a shipping address in your profile.', false);
                    openDrawer('profile-drawer');
                    // Show addresses section to guide the user
                    try { openManageAddresses(); } catch (_) {}
                    return;
                }
            }
            closeDrawer();
            DOMElements.paymentModal.classList.remove('hidden');
            DOMElements.paymentModal.classList.add('flex');
            // Initialize selected shipping address view
            try {
                if (addrs.length > 0) {
                    if (!selectedShippingAddressId) {
                        const def = getDefaultAddress(addrs);
                        selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                        selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                    }
                } else {
                    selectedShippingAddressId = null;
                    selectedShippingAddress = null;
                }
                renderSelectedShippingAddress();
                renderAddressSelectList();
            } catch (_) {}
        }

        function closePaymentModal() {
            DOMElements.paymentModal.classList.add('hidden');
            DOMElements.paymentModal.classList.remove('flex');
        }
        window.closePaymentModal = closePaymentModal;
        
        // --- Variant Selection Modal Logic ---
        let currentVariantModal = null; // { productId, action: 'add'|'buy', selected: { size, storage, color } }

        function openVariantModal(productId, action = 'add') {
            try {
                const product = (productsData || []).find(p => p.id === productId);
                if (!product) return;
                currentVariantModal = { productId, action, selected: {} };

                // Fill product summary
                const img = document.getElementById('vm-product-image');
                const nameEl = document.getElementById('vm-product-name');
                const priceEl = document.getElementById('vm-product-price');
                if (img) img.src = product.imageUrl || product.image || '';
                if (nameEl) nameEl.textContent = product.name || '';
                if (priceEl) priceEl.textContent = `৳${Number(product.price || 0).toFixed(2)}`;

                // Render options
                renderVariantOptionsModal('size', product.sizes);
                renderVariantOptionsModal('storage', product.storage);
                renderVariantOptionsModal('color', product.colors);

                const modal = document.getElementById('variant-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            } catch (err) { console.log('openVariantModal failed', err); }
        }
        window.openVariantModal = openVariantModal;

        function closeVariantModal() {
            const modal = document.getElementById('variant-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            currentVariantModal = null;
        }
        window.closeVariantModal = closeVariantModal;

        function renderVariantOptionsModal(variantType, options) {
            const wrapper = document.getElementById(`vm-${variantType}-options`);
            const container = document.getElementById(`vm-${variantType}-variants-container`);
            if (!wrapper || !container) return;
            if (!options || options.length === 0) {
                wrapper.classList.add('hidden');
                container.innerHTML = '';
                return;
            }
            wrapper.classList.remove('hidden');
            container.innerHTML = options.map(option => {
                if (variantType === 'color') {
                    return `<button class="w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: ${String(option).toLowerCase()}" data-vm-variant-type="color" data-value="${option}"></button>`;
                }
                return `<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors text-dark" data-vm-variant-type="${variantType}" data-value="${option}">${option}</button>`;
            }).join('');
        }

        function highlightMissingVariantUIForModal(missingTypes = []) {
            try {
                missingTypes.forEach(type => {
                    const labelEl = document.querySelector(`#vm-${type}-options label`);
                    const wrapper = document.getElementById(`vm-${type}-options`);
                    if (wrapper) wrapper.classList.remove('hidden');
                    if (labelEl) labelEl.classList.add('text-red-600', 'animate-pulse');
                });
            } catch (err) { console.log('Variant modal highlight failed:', err); }
        }

        // Delegate clicks inside the modal to handle variant selection
        document.getElementById('variant-modal-options').addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-vm-variant-type]');
            if (!btn || !currentVariantModal) return;
            const { vmVariantType } = { vmVariantType: btn.dataset.vmVariantType };
            const value = btn.dataset.value;
            const container = btn.parentElement;
            container.querySelectorAll('button').forEach(b => b.classList.remove(vmVariantType === 'color' ? 'color-variant-active' : 'variant-btn-active'));
            btn.classList.add(vmVariantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            currentVariantModal.selected[vmVariantType] = value;
            const labelEl = document.querySelector(`#vm-${vmVariantType}-options label`);
            if (labelEl) labelEl.classList.remove('text-red-600', 'animate-pulse');
        });

        // Confirm buttons inside modal
        document.getElementById('vm-add-btn').addEventListener('click', async () => {
            if (!currentVariantModal) return;
            const product = (productsData || []).find(p => p.id === currentVariantModal.productId);
            const required = product ? getRequiredVariants(product) : [];
            const missing = required.filter(t => !currentVariantModal.selected[t]);
            if (missing.length > 0) {
                showToast('toast-select-variant', false);
                highlightMissingVariantUIForModal(missing);
                return;
            }
            // Copy to global selection and add
            selectedVariants = { ...currentVariantModal.selected };
            try { await addToCartInDb(currentVariantModal.productId, false); } catch (e) { console.log(e); }
            closeVariantModal();
        });
        document.getElementById('vm-buy-btn').addEventListener('click', async () => {
            if (!currentVariantModal) return;
            const product = (productsData || []).find(p => p.id === currentVariantModal.productId);
            const required = product ? getRequiredVariants(product) : [];
            const missing = required.filter(t => !currentVariantModal.selected[t]);
            if (missing.length > 0) {
                showToast('toast-select-variant', false);
                highlightMissingVariantUIForModal(missing);
                return;
            }
            selectedVariants = { ...currentVariantModal.selected };
            try {
                await addToCartInDb(currentVariantModal.productId, false);
                closeVariantModal();
                openPaymentModal();
            } catch (e) { console.log(e); }
        });
        // --- END Variant Selection Modal Logic ---

        function generateRandomOrderId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function handlePlaceOrder() {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to place an order.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }

            // Ensure we have a shipping address: prefer selected saved address, else fallback to legacy fields
            let shippingAddress = null;
            const addrs = Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
            if (addrs.length > 0) {
                if (!selectedShippingAddress) {
                    const def = getDefaultAddress(addrs);
                    selectedShippingAddress = def || addrs[0] || null;
                }
                shippingAddress = selectedShippingAddress;
            } else if (currentUserData?.location && currentUserData?.mobile) {
                shippingAddress = {
                    id: 'legacy',
                    name: currentUser.displayName || 'Customer',
                    mobile: currentUserData.mobile,
                    line1: currentUserData.location,
                    city: '',
                    area: '',
                    isDefault: true,
                };
            } else {
                showToast('Please add a shipping address in your profile.', false);
                closePaymentModal();
                openDrawer('profile-drawer');
                try { openManageAddresses(); } catch (_) {}
                return;
            }
            
            const mainPayment = document.querySelector('input[name="main-payment"]:checked').value;
            let finalPaymentMethod = mainPayment;
            
            if (mainPayment === 'Mobile Banking') {
                const subPayment = document.querySelector('input[name="sub-payment"]:checked');
                if (!subPayment) {
                    showToast('Please select a mobile banking option.', false);
                    return;
                }
                finalPaymentMethod = subPayment.value;
            }
            
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const totalAmount = subtotal + deliveryCharge - discountAmount;
            
            const orderData = {
                orderId: generateRandomOrderId(),
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userEmail: currentUser.email,
                // Keep legacy fields for backward compatibility but prefer shippingAddress for fulfillment
                userLocation: shippingAddress?.line1 || currentUserData.location || '',
                userMobile: shippingAddress?.mobile || currentUserData.mobile || '',
                shippingAddress: shippingAddress ? {
                    id: shippingAddress.id,
                    name: shippingAddress.name || currentUser.displayName || '',
                    mobile: shippingAddress.mobile || '',
                    line1: shippingAddress.line1 || '',
                    line2: shippingAddress.line2 || '',
                    city: shippingAddress.city || '',
                    area: shippingAddress.area || '',
                    isDefault: !!shippingAddress.isDefault,
                } : null,
                items: Array.from(localCartCache.values()),
                subtotal: subtotal,
                deliveryCharge: deliveryCharge,
                discount: discountAmount,
                couponCode: appliedCouponCode || null,
                totalAmount: totalAmount,
                paymentMethod: finalPaymentMethod,
                status: "Pending",
                createdAt: serverTimestamp()
            };

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                await addDoc(collection(db, "orders"), orderData);

                const updates = { cart: {} };
                if (appliedCouponCode) {
                    updates.usedCoupons = arrayUnion(appliedCouponCode);
                }
                await updateDoc(userDocRef, updates);
                
                discountAmount = 0;
                appliedCouponCode = null;

                closePaymentModal();
                closeDrawer();
                
                let instructionKey = '';
                 if (finalPaymentMethod === 'Bkash') {
                    instructionKey = 'payment-instruction-bkash';
                } else if (finalPaymentMethod === 'Nagad') {
                    instructionKey = 'payment-instruction-nagad';
                } else {
                     instructionKey = 'payment-instruction-cod';
                }
                const instructionText = translations[currentLanguage][instructionKey].replace('{amount}', totalAmount.toFixed(2));
                DOMElements.paymentInstruction.textContent = instructionText;
                DOMElements.orderSuccessModal.classList.remove('hidden');
                DOMElements.orderSuccessModal.classList.add('flex');

            } catch (error) {
                console.error("Error placing order: ", error);
                showToast('order-placed-fail', false);
            }
        }
        
        // --- COUPON LOGIC ---
        async function fetchAndRenderCoupons() {
            const couponListEl = document.getElementById('coupons-list');
            const couponListElPage = document.getElementById('cart-page-coupons-list');
            if (!couponListEl && !couponListElPage) return;

            const loaderHtml = `<div class="col-span-full text-center py-4"><div class="loader mx-auto"></div></div>`;
            if (couponListEl) couponListEl.innerHTML = loaderHtml;
            if (couponListElPage) couponListElPage.innerHTML = loaderHtml;

            if (!currentUser || currentUser.isAnonymous) {
                const loginHtml = `<p class="text-center text-gray-500">Please log in to see available coupons.</p>`;
                if (couponListEl) couponListEl.innerHTML = loginHtml;
                if (couponListElPage) couponListElPage.innerHTML = loginHtml;
                return;
            }

            try {
                const couponsRef = collection(db, "coupons");
                // Fetch all coupons without filtering by 'isActive' since it might not be present, relying on client-side expiry check
                const querySnapshot = await getDocs(couponsRef); 
                allCoupons = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    code: doc.data().code || doc.id // Ensure code field exists
                }));

                const now = new Date();
                const usableCoupons = allCoupons.filter(coupon => {
                    const expiryDate = coupon.expiryDate ? new Date(coupon.expiryDate) : null;
                    const hasExpired = expiryDate && expiryDate < now;
                    // Check if coupon is active/not expired (assuming if isActive isn't present, it's considered active if not expired)
                    const isActive = coupon.isActive === undefined ? true : coupon.isActive; 
                    
                    return isActive && !hasExpired;
                });

                if (usableCoupons.length === 0) {
                    const emptyHtml = `<p class="text-center text-gray-500">No active coupons available right now.</p>`;
                    if (couponListEl) couponListEl.innerHTML = emptyHtml;
                    if (couponListElPage) couponListElPage.innerHTML = emptyHtml;
                    return;
                }

                let couponsHtml = usableCoupons.map(coupon => {
                    const code = coupon.code || '';
                    return `
                        <div class="p-2 sm:p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-dashed border-theme-pink/50">
                            <div class="flex items-center justify-between gap-2">
                                <button onclick="copyToClipboard(this, '${code}')" class="text-sm sm:text-base font-bold bg-theme-blue text-white px-3 py-1 rounded-full hover:bg-theme-purple transition-colors">
                                    ${code}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                if (couponListEl) couponListEl.innerHTML = couponsHtml;
                if (couponListElPage) couponListElPage.innerHTML = couponsHtml;

            } catch (error) {
                console.error("Error fetching coupons:", error);
                const errHtml = `<p class="text-center text-red-500">Error loading coupons.</p>`;
                if (couponListEl) couponListEl.innerHTML = errHtml;
                if (couponListElPage) couponListElPage.innerHTML = errHtml;
            }
        }

        function copyToClipboard(button, text) {
            if (!text || navigator.clipboard === undefined) {
                 // Fallback for older browsers
                 showToast("Could not copy. Browser unsupported.", false);
                 return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = translations[currentLanguage]['copied'];
                showToast('Coupon copied!', true);
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast("Copy failed.", false);
            });
        }
        window.copyToClipboard = copyToClipboard;
        
        async function handleApplyCoupon(e) {
            e.preventDefault();
            const drawerInput = DOMElements.couponInput;
            const pageInput = document.getElementById('cart-page-coupon-input');
            const raw = (pageInput && pageInput.value ? pageInput.value : (drawerInput ? drawerInput.value : '')) || '';
            const couponCode = raw.trim().toUpperCase();
            if (!couponCode) return;

            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to use coupons.', false);
                return;
            }

            // Query coupon by 'code' field to support arbitrary document IDs
            const couponQuery = query(collection(db, 'coupons'), where('code', '==', couponCode));
            const couponQuerySnap = await getDocs(couponQuery);

            if (couponQuerySnap.empty) {
                showToast('toast-coupon-invalid', false);
                return;
            }

            const couponData = couponQuerySnap.docs[0].data();
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (subtotal < (couponData.minSpend || 0)) {
                const message = translations[currentLanguage]['toast-coupon-min-purchase'].replace('{amount}', couponData.minSpend);
                showToast(message, false);
                return;
            }

            if (currentUserData.usedCoupons && currentUserData.usedCoupons.includes(couponCode)) {
                showToast('toast-coupon-used', false);
                return;
            }
            
            // Check expiry date (Client-side validation as Firebase doesn't support complex queries in rules)
            const expiryDate = couponData.expiryDate ? new Date(couponData.expiryDate) : null;
            const now = new Date();
            if (expiryDate && expiryDate < now) {
                showToast('toast-coupon-invalid', false); // Invalid/expired coupon message
                return;
            }
            
            // Check isActive (if present)
            if (couponData.isActive === false) {
                 showToast('toast-coupon-invalid', false); // Inactive coupon message
                 return;
            }

            if (couponData.type === 'percentage') {
                const percent = Number(couponData.value) || 0;
                discountAmount = Math.max(0, (subtotal * percent) / 100);
            } else if (couponData.type === 'fixed') {
                const fixed = Number(couponData.value ?? couponData.discountValue) || 0;
                discountAmount = Math.min(fixed, subtotal);
            } else {
                discountAmount = 0;
            }
            
            appliedCouponCode = couponCode;
            // Clear inputs for better UX
            if (drawerInput) drawerInput.value = '';
            if (pageInput) pageInput.value = '';
            showToast('toast-coupon-applied');
            await updateCartUI();
        }

        // --- GLOBAL FUNCTIONS for onclick ---
        window.renderAllProducts = () => {
            resetFiltersOnCategoryChange(false);
            updateCategoryHeader(null, null);
            renderProducts(productsData);
            showPage('home-page');
            scrollToElement('top-category-strip');
        };
        window.filterProducts = (category) => {
            resetFiltersOnCategoryChange(false);
            const canonical = resolveCategoryId(category);
            const filtered = productsData.filter(p => matchesCategoryName(p.category, canonical));
            updateCategoryHeader(canonical, null);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('top-category-strip');
        };
        window.filterSubCategory = (category, subCategory) => {
            const canonical = resolveCategoryId(category);
            const resolvedSub = resolveSubCategoryValue(canonical, subCategory);
            const filtered = productsData.filter(p => matchesCategoryName(p.category, canonical) && matchesSubCategoryName(p.subCategory, canonical, resolvedSub));
            updateCategoryHeader(canonical, resolvedSub);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        };
        window.showOffers = () => {
            const offers = productsData.filter(p => p.isOffer);
            updateCategoryHeader('Offers', null); // Use 'Offers' as a temporary category name
            renderProducts(offers);
            showPage('home-page');
            scrollToElement('products');
        };
        
        function performSearch() {
            const qDesktop = DOMElements.searchInput ? DOMElements.searchInput.value : '';
            const qMobile = DOMElements.searchInputMobile ? DOMElements.searchInputMobile.value : '';
            const query = String(qDesktop || qMobile || '').trim().toLowerCase();
            if (!query) { hideSearchResults(); return; }
            const base = Array.isArray(productsData) ? productsData : [];
            const filtered = base.filter(p => {
                const name = (p?.name || '').toLowerCase();
                const brand = (p?.brand || '').toLowerCase();
                const cat = (p?.category || '').toLowerCase();
                const sub = (p?.subCategory || '').toLowerCase();
                return name.includes(query) || brand.includes(query) || cat.includes(query) || sub.includes(query);
            });
            hideSearchResults();
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        }

        function handleImageZoom(e) {
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPercent = (x / container.offsetWidth) * 100;
            const yPercent = (y / container.offsetHeight) * 100;
            container.style.setProperty('--x-pos', `${xPercent}%`);
            container.style.setProperty('--y-pos', `${yPercent}%`);
        }
        
        async function fetchUserOrders() {
             if (!currentUser || currentUser.isAnonymous) {
                DOMElements.ordersList.innerHTML = `<p class="text-center text-gray-500">Please log in to see your orders.</p>`;
                return;
            }
            DOMElements.ordersList.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, where("userId", "==", currentUser.uid));
                
                onSnapshot(q, (querySnapshot) => {
                    userOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    userOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); // Sort by newest first
                    renderOrders();
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                DOMElements.ordersList.innerHTML = `<p class="text-center text-red-500">Could not load orders.</p>`;
            }
        }
        
        function renderOrders() {
            const container = DOMElements.ordersList;
            if(!container) return;

            if (userOrders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">You haven't placed any orders yet.</p>`;
                return;
            }

            const statuses = ['Pending', 'Confirmed', 'Shipped', 'Out for delivery', 'Delivered'];
            // Helper to normalize status strings (handles case, hyphens, underscores, extra spaces)
            const normalizeStatus = (str) => (str || '')
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[-_]/g, ' ')
                .replace(/\s+/g, ' ');
            const normalizedStatuses = statuses.map(s => normalizeStatus(s));
            
            const renderTrackerSteps = (order) => {
                const status = normalizeStatus(order?.status || 'N/A');
                if (status === 'cancelled') return '';

                const currentStatusIndex = normalizedStatuses.indexOf(status);

                const stepDetails = {
                    pending: {
                        title: 'Order Received',
                        description: 'We\'ve received your order and will verify the details shortly.',
                        icon: 'fa-receipt'
                    },
                    confirmed: {
                        title: 'Order Confirmed',
                        description: 'Our team confirmed the order and is preparing your package.',
                        icon: 'fa-clipboard-check'
                    },
                    shipped: {
                        title: 'Shipped',
                        description: 'Your package left the warehouse and is with the courier partner.',
                        icon: 'fa-box-open'
                    },
                    'out for delivery': {
                        title: 'Out for Delivery',
                        description: 'A delivery executive is on the way to your location.',
                        icon: 'fa-truck-fast'
                    },
                    delivered: {
                        title: 'Delivered',
                        description: 'The parcel reached you successfully. Enjoy your purchase!',
                        icon: 'fa-house-user'
                    }
                };

                const parseToDate = (val) => {
                    try {
                        if (!val) return null;
                        if (typeof val?.toDate === 'function') return val.toDate();
                        if (typeof val === 'number') {
                            const ms = val < 1e12 ? val * 1000 : val;
                            return new Date(ms);
                        }
                        if (typeof val === 'object' && typeof val.seconds === 'number') {
                            return new Date(val.seconds * 1000);
                        }
                        if (typeof val === 'string') {
                            const d = new Date(val);
                            return isNaN(d.getTime()) ? null : d;
                        }
                    } catch {}
                    return null;
                };

                const resolveStepDate = (o, stepName) => {
                    if (!o) return null;
                    const norm = normalizeStatus(stepName);
                    const camel = norm.replace(/\s+(.)/g, (m, g1) => g1.toUpperCase());
                    const pascal = camel.charAt(0).toUpperCase() + camel.slice(1);
                    const upper = stepName.toUpperCase();
                    const candidates = [
                        o?.statusTimestamps?.[norm], o?.statusTimestamps?.[stepName], o?.statusTimestamps?.[camel], o?.statusTimestamps?.[pascal],
                        o?.[`${camel}At`], o?.[`${pascal}At`], o?.[`${norm}At`], o?.[`${stepName}At`],
                        o?.[norm], o?.[camel], o?.[pascal], o?.[stepName], o?.[upper],
                    ];
                    if (norm === 'pending') candidates.push(o?.createdAt);
                    if (norm === 'delivered') {
                        candidates.push(
                            o?.deliveredAt, o?.deliveredTime, o?.deliveredOn, o?.deliveredDate, o?.deliveryCompletedAt, o?.completedAt,
                            o?.delivered_at, o?.deliveredTimestamp, o?.deliveredDateTime
                        );
                    }
                    candidates.push(
                        o?.delivery?.[`${camel}At`], o?.delivery?.[camel], o?.delivery?.deliveredAt,
                        o?.timeline?.[`${camel}At`], o?.timeline?.[camel], o?.timeline?.deliveredAt
                    );

                    const findInHistory = (arr) => {
                        if (!Array.isArray(arr)) return null;
                        for (const entry of arr) {
                            const st = normalizeStatus(entry?.status || entry?.state || entry?.label);
                            if (st === norm) return entry.timestamp || entry.time || entry.at || entry.date || entry.when;
                        }
                        return null;
                    };
                    candidates.push(findInHistory(o?.statusHistory));
                    candidates.push(findInHistory(o?.statusLogs));
                    candidates.push(findInHistory(o?.logs));

                    for (const candidate of candidates) {
                        const parsed = parseToDate(candidate);
                        if (parsed instanceof Date && !isNaN(parsed.getTime())) return parsed;
                    }
                    return null;
                };

                let html = `<div class="tracker-step-container">`;

                statuses.forEach((step, index) => {
                    const normalizedStep = normalizeStatus(step);
                    const detail = stepDetails[normalizedStep] || { title: step, description: '' };
                    const stepDate = resolveStepDate(order, step);
                    let stepDateHtml = '';
                    if (stepDate instanceof Date && !isNaN(stepDate.getTime())) {
                        const datePart = stepDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                        const timePart = stepDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                        stepDateHtml = `<p class="tracker-date">${datePart} &bull; ${timePart}</p>`;
                    }

                    const isStepComplete = currentStatusIndex > index || (currentStatusIndex >= normalizedStatuses.length - 1 && normalizedStep === 'delivered' && status === 'delivered');
                    const isCurrentStep = !isStepComplete && ((currentStatusIndex === index) || (currentStatusIndex < 0 && index === 0));
                    const stateClass = isStepComplete ? 'tracker-node--complete' : (isCurrentStep ? 'tracker-node--current' : 'tracker-node--upcoming');
                    const iconClass = detail.icon || 'fa-circle';
                    const iconHtml = `<i class="fas ${iconClass}"></i>`;
                    const completionBadge = isStepComplete ? '<span class="tracker-badge"><i class="fas fa-check"></i></span>' : '';
                    const subtitleHtml = detail.description ? `<p class="tracker-subtitle">${detail.description}</p>` : '';
                    const connectorHtml = index === statuses.length - 1 ? '' : '<span class="tracker-line"></span>';

                    html += `
                        <div class="tracker-node ${stateClass}">
                            <div class="tracker-node__indicator">
                                <span class="tracker-circle">${iconHtml}${completionBadge}</span>
                                ${connectorHtml}
                            </div>
                            <div class="tracker-content">
                                <p class="tracker-title">${detail.title}</p>
                                ${subtitleHtml}
                                ${stepDateHtml}
                            </div>
                        </div>`;
                });

                html += '</div>';
                return html;
            }

            container.innerHTML = userOrders.map(order => {
                const rawStatus = order.status || 'N/A';
                const status = normalizeStatus(rawStatus);
                const orderDate = order.createdAt?.toDate().toLocaleDateString('en-GB');
                const orderTime = order.createdAt?.toDate().toLocaleTimeString('en-US');
                const isCancelled = status === 'cancelled';
                const canCancel = status === 'pending';

                // Derive expected/estimated delivery time from multiple possible fields
                const deliveryValue = order.expectedDelivery || order.deliveryTime || order.delivery_date || order.deliveryDate || order.eta;
                let expectedDeliveryHtml = '';
                if (deliveryValue) {
                    let dStr = '';
                    try {
                        if (typeof deliveryValue?.toDate === 'function') {
                            dStr = deliveryValue.toDate().toLocaleString();
                        } else if (typeof deliveryValue === 'number') {
                            const ms = deliveryValue < 1e12 ? deliveryValue * 1000 : deliveryValue;
                            dStr = new Date(ms).toLocaleString();
                        } else if (typeof deliveryValue === 'object' && typeof deliveryValue.seconds === 'number') {
                            dStr = new Date(deliveryValue.seconds * 1000).toLocaleString();
                        } else if (typeof deliveryValue === 'string') {
                            dStr = deliveryValue;
                        }
                    } catch {}
                    if (dStr) {
                        expectedDeliveryHtml = `<p class="text-xs text-gray-600 mt-1">Estimated Delivery: ${dStr}</p>`;
                    }
                }

                // Show actual delivered timestamp when status is delivered
                let deliveredTimeHtml = '';
                if (status === 'delivered') {
                    // Helper to parse various timestamp shapes into a Date
                    const parseToDate = (val) => {
                        try {
                            if (!val) return null;
                            if (typeof val?.toDate === 'function') return val.toDate(); // Firestore Timestamp
                            if (typeof val === 'number') {
                                const ms = val < 1e12 ? val * 1000 : val;
                                return new Date(ms);
                            }
                            if (typeof val === 'object' && typeof val.seconds === 'number') {
                                return new Date(val.seconds * 1000);
                            }
                            if (typeof val === 'string') {
                                const d = new Date(val);
                                return isNaN(d.getTime()) ? null : d;
                            }
                        } catch {}
                        return null;
                    };

                    // Resolve delivered timestamp from many possible shapes/fields
                    const resolveDeliveredTs = (o) => {
                        let v = (
                            o.deliveredAt || o.deliveredTime || o.deliveredOn || o.deliveredDate ||
                            o.deliveryCompletedAt || o.completedAt ||
                            (o.statusTimestamps && (o.statusTimestamps.delivered || o.statusTimestamps.Delivered || o.statusTimestamps.deliveredAt || o.statusTimestamps.DeliveredAt)) ||
                            o.delivery_date_delivered || o.deliveryAt || o.delivery_time ||
                            o.delivered_at || o.deliveredTimestamp || o.deliveredDateTime
                        );
                        if (!v && o.delivery) {
                            v = o.delivery.deliveredAt || o.delivery.deliveredTime || o.delivery.delivered_on || o.delivery.delivered;
                        }
                        if (!v && o.timeline) {
                            v = o.timeline.deliveredAt || o.timeline.delivered || o.timeline.delivered_on;
                        }
                        const findInHistory = (arr) => {
                            if (!Array.isArray(arr)) return null;
                            for (const e of arr) {
                                const st = (e?.status || e?.state || e?.label || '').toString().trim().toLowerCase().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
                                if (st === 'delivered') {
                                    return e.timestamp || e.time || e.at || e.date || e.when;
                                }
                            }
                            return null;
                        };
                        if (!v) v = findInHistory(o.statusHistory);
                        if (!v) v = findInHistory(o.statusLogs);
                        if (!v) v = findInHistory(o.logs);
                        if (!v && o.updatedAt) v = o.updatedAt; // last resort fallback when marked delivered
                        const dObj = parseToDate(v);
                        return dObj ? dObj : (typeof v === 'string' ? v : null);
                    };

                    const resolved = resolveDeliveredTs(order);
                    if (resolved instanceof Date) {
                        const dDate = resolved.toLocaleDateString('en-GB');
                        const dTime = resolved.toLocaleTimeString('en-US');
                        deliveredTimeHtml = `<p class=\"text-xs text-green-700 mt-1 text-right self-end\">Delivered on: ${dDate} at ${dTime}</p>`;
                    } else if (typeof resolved === 'string' && resolved) {
                        deliveredTimeHtml = `<p class=\"text-xs text-green-700 mt-1 text-right self-end\">Delivered on: ${resolved}</p>`;
                    }
                }

                // Use theme colors for status badges
                let statusBgClass = 'bg-gray-500';
                if (status === 'delivered') { statusBgClass = 'bg-green-500'; }
                else if (status === 'cancelled') { statusBgClass = 'bg-red-500'; }
                else if (status === 'shipped' || status === 'out for delivery') { statusBgClass = 'bg-theme-blue'; }
                else if (status === 'confirmed' || status === 'pending') { statusBgClass = 'bg-yellow-500'; }
                
                const statusTextColor = 'text-white';
                
                // Helper to resolve a productId from various possible item shapes
                const resolveProductId = (it) => {
                    try {
                        const candidates = [
                            it.productId, it.productID, it.product_id, it.id, it.pid, it._id, it.docId, it.productDocId
                        ].filter(Boolean);
                        if (Array.isArray(productsData) && productsData.length) {
                            for (const cand of candidates) {
                                if (productsData.some(p => p.id === cand)) return cand;
                            }
                            // Match by SKU if present
                            if (it.sku) {
                                const pSku = productsData.find(p => (p.sku || p.SKU) && ((p.sku || p.SKU) === it.sku));
                                if (pSku) return pSku.id;
                            }
                            // Match by modelID if present
                            if (it.modelID) {
                                const modelNorm = String(it.modelID).trim().toLowerCase();
                                const pModel = productsData.find(p => String(p.modelID || '').trim().toLowerCase() === modelNorm);
                                if (pModel) return pModel.id;
                            }
                            // Last resort: match by exact name
                            if (it.name) {
                                const nameNorm = String(it.name).trim().toLowerCase();
                                const matches = productsData.filter(p => String(p.name || '').trim().toLowerCase() === nameNorm);
                                if (matches.length === 1) return matches[0].id;
                            }
                        }
                    } catch {}
                    return it?.productId || null;
                };

                const itemRows = (order.items || []).map(item => {
                    // Variants text
                    let variants = '';
                    if (item.size || item.color || item.storage) {
                        const parts = [];
                        if (item.size) parts.push(`Size: ${item.size}`);
                        if (item.color) parts.push(`Color: ${item.color}`);
                        if (item.storage) parts.push(`Storage: ${item.storage}`);
                        variants = ` [${parts.join(', ')}]`;
                    }

                    const title = `${item.name || 'Product'}${variants} (x${item.quantity || 1})`;
                    const imgSrc = item.image || 'https://placehold.co/80x80/ccc/000?text=Image';
                    const resolvedProductId = resolveProductId(item);
                    const fallbackSkuEnc = encodeURIComponent(item.sku || '');
                    const fallbackModelEnc = encodeURIComponent(item.modelID || item.modelId || '');
                    const fallbackNameEnc = encodeURIComponent(item.name || '');
                    const priceText = `৳${((item.price || 0) * (item.quantity || 0)).toFixed(2)}`;

                    const titleHtml = `<button class="order-item-open text-left text-base text-gray-800 dark:text-gray-200 hover:underline" data-product-id="${resolvedProductId || ''}" data-sku="${item.sku || ''}" data-model="${item.modelID || item.modelId || ''}" data-name="${item.name || ''}">${title}</button>`;

                    const imageHtml = `<img src="${imgSrc}" alt="${item.name || 'Product'}" class="order-item-open w-14 h-14 rounded-lg object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';" data-product-id="${resolvedProductId || ''}" data-sku="${item.sku || ''}" data-model="${item.modelID || item.modelId || ''}" data-name="${item.name || ''}">`;

                    return `
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 py-3">
                            <div class="flex items-center gap-3 min-w-0">
                                ${imageHtml}
                                <div class="flex flex-col min-w-0">
                                    <div class="break-words">${titleHtml}</div>
                                </div>
                            </div>
                            <p class="font-semibold text-sm sm:text-base text-price-black dark:text-gray-100">${priceText}</p>
                        </div>
                    `;
                }).join('');
                
                const invoiceLabel = resolveLocalizedString('download-invoice');
                const invoiceButton = status === 'delivered' 
                    ? `<button class="download-invoice-btn bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition-colors" data-order-id="${order.id}">${invoiceLabel}</button>`
                    : '';

                // Final Card structure based on user image
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100">
                        <!-- Top Header Row -->
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3">
                            <div>
                                <p class="font-bold text-lg text-theme-purple">Order ID: <span class="text-purple-600">${order.orderId}</span></p>
                                <p class="text-xs text-gray-500 mt-1">Placed on: ${orderDate} at ${orderTime}</p>
                                ${status === 'delivered' ? '' : expectedDeliveryHtml}
                            </div>
                            <div class="flex flex-col items-end w-full md:w-auto">
                                 <p class="font-bold text-xl text-theme-blue mb-1 text-right self-end">৳${order.totalAmount.toFixed(2)}</p>
                                 <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusBgClass} ${statusTextColor} uppercase self-end">
                                    ${rawStatus}
                                 </span>
                                 ${deliveredTimeHtml}
                            </div>
                        </div>

                        ${isCancelled ? 
                            `<div class="text-center text-red-500 font-bold p-4 bg-red-100 rounded-lg mt-4">Order Cancelled</div>`
                            : renderTrackerSteps(order)
                        }

                        <!-- Items List -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="font-bold text-base mb-2">Items:</h4>
                            <div class="space-y-1">
                                ${itemRows}
                            </div>
                        </div>

                        <!-- Footer: Actions -->
                        <div class="mt-4 flex flex-col sm:flex-row gap-3 sm:justify-between sm:items-center">
                            <div></div>
                            <div class="flex gap-3 justify-end">
                                ${canCancel ? `<button class="cancel-order-btn bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition-colors" data-order-id="${order.id}">Cancel Order</button>` : ''}
                                ${invoiceButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Wire up cancel buttons
            container.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.getAttribute('data-order-id');
                    showConfirmModal('Are you sure you want to cancel this order?', 'Cancel Order', async () => {
                        try {
                            const orderRef = doc(db, 'orders', orderId);
                            const snap = await getDoc(orderRef);
                            if (!snap.exists()) {
                                showToast('Order not found', false);
                                return;
                            }
                            const normalize = (s) => (s || '').toString().trim().toLowerCase().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
                            const currentStatus = normalize(snap.data().status);
                            if (currentStatus !== 'pending') {
                                showToast('Order can no longer be cancelled', false);
                                return;
                            }
                            await updateDoc(orderRef, { status: 'Cancelled' });
                            showToast('Order cancelled successfully');
                        } catch (err) {
                            console.error('Cancel order failed:', err);
                            showToast('Failed to cancel order', false);
                        }
                    });
                });
            });

            // Delegated handler for opening product from order list
            container.addEventListener('click', async (e) => {
                const trigger = e.target.closest('.order-item-open');
                if (!trigger) return;
                const pid = trigger.getAttribute('data-product-id') || '';
                const sku = trigger.getAttribute('data-sku') || '';
                const model = trigger.getAttribute('data-model') || '';
                const name = trigger.getAttribute('data-name') || '';
                await showProductDetails(pid, encodeURIComponent(sku), encodeURIComponent(model), encodeURIComponent(name));
            });
        }

        // --- Emergency Chat Logic ---

        function handleEmergencyChatClick() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast(translations[currentLanguage]['chat-unauthorized'], false);
                openDrawer('profile-drawer');
                return;
            }
            closeDrawer();
            showPage('emergency-chat-page');
            // Starts listening to chat once on the page
        }
        
        async function handleEmergencyChat() {
            if (!currentUser || currentUser.isAnonymous) return;

            const chatId = currentUser.uid;
            const chatDocRef = doc(db, 'live_chats', chatId);
            const messagesCollectionRef = collection(chatDocRef, 'messages');

            // Atomically ensure chat doc exists, update lastActive, and send a single welcome message once.
            await runTransaction(db, async (tx) => {
                const snap = await tx.get(chatDocRef);
                const nowFields = { lastActive: serverTimestamp() };
                const baseDoc = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email || 'User',
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                };

                if (!snap.exists()) {
                    // First-time chat: create doc and send the welcome message with the flag in the same transaction
                    tx.set(chatDocRef, { ...baseDoc, welcomeMessageSent: true });
                    const welcomeRef = doc(messagesCollectionRef);
                    tx.set(welcomeRef, {
                        text: "অভিনন্দন! আমাদের সাথে যোগাযোগ করার জন্য ধন্যবাদ। অনুগ্রহ করে অপেক্ষা করুন, অ্যাডমিন শীঘ্রই আপনার বার্তার উত্তর দেবেন।",
                        senderId: "admin",
                        senderName: "Admin",
                        timestamp: serverTimestamp()
                    });
                } else {
                    // Existing chat: bump lastActive and send welcome only if not already sent
                    const data = snap.data() || {};
                    const alreadySent = data.welcomeMessageSent === true;
                    if (!alreadySent) {
                        tx.update(chatDocRef, { ...nowFields, welcomeMessageSent: true });
                        const welcomeRef = doc(messagesCollectionRef);
                        tx.set(welcomeRef, {
                            text: "অভিনন্দন! আমাদের সাথে যোগাযোগ করার জন্য ধন্যবাদ। অনুগ্রহ করে অপেক্ষা করুন, অ্যাডমিন শীঘ্রই আপনার বার্তার উত্তর দেবেন।",
                            senderId: "admin",
                            senderName: "Admin",
                            timestamp: serverTimestamp()
                        });
                    } else {
                        tx.update(chatDocRef, nowFields);
                    }
                }
            });

            DOMElements.chatMessages.innerHTML = `<p class="text-center text-gray-500">Loading messages...</p>`;

            // Set up real-time listener for messages
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                let messagesHtml = '';
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // If the latest message is from the admin, mark previous user messages as seen
                const latestMessage = messages.length > 0 ? messages[messages.length - 1] : null;
                if (latestMessage && latestMessage.senderId === 'admin') {
                    const unseenUserMessages = messages.filter(msg => msg.senderId === currentUser.uid && !msg.isSeen);
                    if (unseenUserMessages.length > 0) {
                        const batch = writeBatch(db);
                        const messagesCollectionRef = collection(db, 'live_chats', currentUser.uid, 'messages');
                        unseenUserMessages.forEach(msg => {
                            const msgRef = doc(messagesCollectionRef, msg.id);
                            batch.update(msgRef, { isSeen: true });
                        });
                        batch.commit().catch(e => console.error("Failed to batch update seen status:", e));
                    }
                }

                messages.forEach(msg => {
                    const isUser = msg.senderId === currentUser.uid;
                    const senderName = isUser ? 'You' : (msg.senderName || 'Admin');
                    const time = msg.timestamp?.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) || '';
                    
                    let seenStatusHtml = '';
                    if (isUser && msg.isSeen) {
                        seenStatusHtml = `<span class="text-xs ml-2 text-blue-200">✓ Seen</span>`;
                    }

                    messagesHtml += `
                        <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${isUser ? 'bg-theme-blue text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-dark rounded-tl-none border'}">
                                <p class="text-xs font-semibold ${isUser ? 'text-blue-200' : 'text-theme-purple'} mb-1">${senderName}</p>
                                <p class="text-sm">${msg.text}</p>
                                <div class="text-right text-xs mt-1 ${isUser ? 'text-blue-300' : 'text-gray-500'}">
                                    <span>${time}</span>
                                    ${seenStatusHtml}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                DOMElements.chatMessages.innerHTML = messagesHtml;
                // Scroll to bottom
                DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;
            }, (error) => {
                console.error("Error listening to messages:", error);
                DOMElements.chatMessages.innerHTML = `<p class="text-center text-red-500">Error loading chat history.</p>`;
            });
        }
        
        const forbiddenWords = [
            // Bengali slang/abusive words
            'sala', 'hala', 'bainchod', 'banchod', 'magi', 'khanki', 'chudir vai', 'kutta', 
            'haramjada', 'shoytaner baccha', 'chagol', 'gadha', 'bokachoda', 'boka',
            'bal', 'khankir pola', 'maderchod', 'chodnar po', 'halar po', 'doner bal',

            // English slang/abusive words
            'fuck', 'fucker', 'fucking', 'bitch', 'asshole', 'dick', 'pussy', 'cunt', 'shit', 'motherfucker',
            'bastard', 'damn', 'hell', 'son of a bitch', 'idiot', 'stupid', 'slang'
        ];

        async function sendChatMessage(e) {
            e.preventDefault();
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) return;

            const text = DOMElements.chatInput.value.trim();
            if (!text) return;

            DOMElements.chatError.textContent = '';
            
            // --- Slang word filter ---
            const lowerCaseText = text.toLowerCase();
            const containsForbiddenWord = forbiddenWords.some(word => lowerCaseText.includes(word));

            if (containsForbiddenWord) {
                showToast('toast-abusive-language', false);
                return; // Stop the function here
            }
            // --- End of slang word filter ---
            
            const chatId = currentUser.uid;
            const messagesCollectionRef = collection(db, 'live_chats', chatId, 'messages');

            try {
                await addDoc(messagesCollectionRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'User',
                    timestamp: serverTimestamp(),
                    isSeen: false // Mark new messages as not seen initially
                });
                
                // Update parent chat doc with latest message metadata
                await updateDoc(doc(db, 'live_chats', chatId), {
                    lastActive: serverTimestamp(),
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    lastSender: "user",
                    isReadByAdmin: false, // notify admin
                    userName: currentUser.displayName || currentUser.email || 'User'
                });

                DOMElements.chatInput.value = ''; // Clear input
                
            } catch (error) {
                console.error("Error sending message:", error);
                DOMElements.chatError.textContent = "Failed to send message.";
            }
        }

        // --- Invoice Generation Logic (jsPDF) ---
        
        async function downloadInvoice(orderDocId) {
            const order = userOrders.find(o => o.id === orderDocId);
            if (!order) {
                showToast('invoice-missing-order', false);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let marginX = 20;
            let y = 15;
            
            doc.setFont("helvetica", "normal"); 
            
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(74, 123, 237); // theme-blue
            doc.text("TangailBuzz", marginX, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text("Your trusted online shop for quality products. | +8801863205976", marginX, y); 
            y += 10;
            
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(51);
            doc.text("SALES INVOICE", pageWidth - marginX, y, { align: "right" });
            y += 8;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Order ID: ${order.orderId}`, pageWidth - marginX, y, { align: "right" });
            y += 6;

            const date = order.createdAt?.toDate().toLocaleDateString('en-GB') || 'N/A';
            doc.text(`Date: ${date}`, pageWidth - marginX, y, { align: "right" });
            y += 10;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(106, 13, 173); // theme-purple
            doc.text("Bill To:", marginX, y);
            y += 7;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Name: ${order.userName || 'N/A'}`, marginX, y);
            y += 5;
            doc.text(`Mobile: ${order.userMobile || 'N/A'}`, marginX, y);
            y += 5;
            
            const addressText = `Address: ${order.userLocation || 'N/A'}`;
            const addressLines = doc.splitTextToSize(addressText, pageWidth - (2 * marginX)); 
            doc.text(addressLines, marginX, y);
            y += (addressLines.length * 5) + 5; 
            
            y += 5;

            const tableColumn = ["Product Name", "Variant", "Price", "Qty", "Total"];
            const tableRows = [];

            const items = order.items || [];
            items.forEach(item => {
                let variantString = '';
                if (item.size) variantString += `Size: ${item.size} `;
                if (item.color) variantString += `Color: ${item.color} `;
                if (item.storage) variantString += `Storage: ${item.storage} `;
                
                tableRows.push([
                    item.name,
                    variantString.trim(),
                    `BDT ${Number(item.price).toFixed(2)}`,
                    item.quantity,
                    `BDT ${Number(item.price * item.quantity).toFixed(2)}`
                ]);
            });

            doc.autoTable({ 
                head: [tableColumn],
                body: tableRows,
                startY: y,
                margin: { left: marginX, right: marginX },
                theme: 'striped',
                headStyles: { fillColor: [74, 123, 237], textColor: 255, font: "helvetica", fontStyle: "bold" },
                columnStyles: {
                    0: { cellWidth: 65, font: "helvetica", fontStyle: "normal" },
                    1: { cellWidth: 35, font: "helvetica", fontStyle: "normal" },
                    2: { halign: 'right', cellWidth: 25, font: "helvetica", fontStyle: "normal" },
                    3: { halign: 'center', cellWidth: 15, font: "helvetica", fontStyle: "normal" },
                    4: { halign: 'right', fontStyle: 'bold', cellWidth: 30, font: "helvetica", fontStyle: "bold" },
                },
                styles: { fontSize: 9, cellPadding: 2, font: "helvetica" },
                didDrawPage: function(data) {
                    y = data.cursor.y;
                }
            });

            y = doc.autoTable.previous.finalY + 10;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            
            const totalSummaryX = pageWidth - marginX - 50; 

            doc.text("Subtotal:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.subtotal.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;
            
            doc.text("Delivery Charge:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.deliveryCharge.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;

            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(totalSummaryX, y - 2, pageWidth - marginX, y - 2);
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(229, 54, 122); // theme-pink
            doc.text("TOTAL AMOUNT:", totalSummaryX, y + 4, { align: "right" });
            doc.text(`BDT ${order.totalAmount.toFixed(2)}`, pageWidth - marginX, y + 4, { align: "right" });
            y += 15;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text(`Payment Method: ${order.paymentMethod}`, marginX, y);
            y += 5;
            doc.text("Thank you for shopping with TangailBuzz!", pageWidth - marginX, y, { align: "right" });

            doc.save(`Invoice_${order.orderId}.pdf`);
            showToast('invoice-download-success');
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Initial Firebase Authentication Bootstrap
            await initialAuthBootstrap();
            
            // 1.5 Apply Theme Preference
            const storedTheme = localStorage.getItem('theme');
            applyDarkMode(storedTheme || 'light');
            
            // 2. Load Product/Banner Data
            // Initialize language from storage
            setLanguage(currentLanguage, { silent: true, persist: false, force: true });
            try {
                setupLanguageControls();
            } catch (error) {
                console.error('Language control setup failed:', error);
            }
            setupHeaderShortcuts();
            setupMobileFooterNav();
            setupProfileQuickActions();
            DOMElements.productList.innerHTML = `<div class="loader"></div>`;
            await fetchProductsFromFirestore();
            await fetchBannersFromFirestore();
            await fetchRightPromoFromFirestore();
            // Recompute cart totals and mirror UI now that product data is available
            try { await updateCartUI(); } catch (_) {}
            
            // 3. Attach Event Listeners
            DOMElements.loginBtn.addEventListener('click', handleGoogleLogin);
            if (DOMElements.loginFacebookBtn) DOMElements.loginFacebookBtn.addEventListener('click', handleFacebookLogin);
            DOMElements.logoutBtn.addEventListener('click', handleLogout); 
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.registerForm.addEventListener('submit', handleRegister);
            if (DOMElements.resetForm) DOMElements.resetForm.addEventListener('submit', handlePasswordReset);
            DOMElements.checkoutBtn.addEventListener('click', openPaymentModal);
            DOMElements.confirmOrderBtn.addEventListener('click', handlePlaceOrder);
            DOMElements.couponForm.addEventListener('submit', handleApplyCoupon);
            
            // Confirmation Modal Listeners
            DOMElements.confirmOkBtn.addEventListener('click', handleConfirmClick);
            DOMElements.confirmCancelBtn.addEventListener('click', handleCancelClick);
            
            // Emergency Contact Button
            if(DOMElements.emergencyContactBtn) DOMElements.emergencyContactBtn.addEventListener('click', handleEmergencyChatClick);
            if(DOMElements.chatForm) DOMElements.chatForm.addEventListener('submit', sendChatMessage);
            // Header shortcuts already wired in setupHeaderShortcuts()

            if(document.getElementById('my-orders-btn')) document.getElementById('my-orders-btn').addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.myOrdersBtnProfile) DOMElements.myOrdersBtnProfile.addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.deleteAccountBtn) DOMElements.deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            if(DOMElements.closeSuccessModalBtn) DOMElements.closeSuccessModalBtn.addEventListener('click', () => {
                 DOMElements.orderSuccessModal.classList.add('hidden');
                 DOMElements.orderSuccessModal.classList.remove('flex');
                 showPage('my-orders-page');
            });
             if(DOMElements.editProfileForm) DOMElements.editProfileForm.addEventListener('submit', handleProfileUpdate);


            DOMElements.editProfileBtn.addEventListener('click', () => {
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.remove('hidden');
                DOMElements.editPhotoPreview.src = currentUser.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.editNameInput.value = currentUser.displayName || '';
                DOMElements.editMobileInput.value = currentUserData?.mobile || '';
                DOMElements.editLocationInput.value = currentUserData?.location || '';
                // Clear any previous remove flag
                delete DOMElements.editPhotoInput.dataset.remove;
            });

            DOMElements.cancelEditBtn.addEventListener('click', () => {
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
                if (DOMElements.profileDrawerTitle) {
                    DOMElements.profileDrawerTitle.dataset.lang = 'your-account';
                    updateTextContent();
                }
            });

            // Remove Photo handler
            const removeBtn = document.getElementById('remove-photo-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    DOMElements.editPhotoInput.value = '';
                    DOMElements.editPhotoInput.dataset.remove = 'true';
                    DOMElements.editPhotoPreview.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                });
            }

            if (DOMElements.authTabs && DOMElements.authTabs.length > 0) {
                DOMElements.authTabs.forEach((tab) => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        toggleAuthForms(tab.dataset?.authTab || 'login');
                    });
                });
            }

            toggleAuthForms(currentAuthForm);

            DOMElements.showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('register');
            });

            // Cart page: coupon + checkout wiring
            const cartPageCouponForm = document.getElementById('cart-page-coupon-form');
            if (cartPageCouponForm) cartPageCouponForm.addEventListener('submit', handleApplyCoupon);
            const cartPageCheckoutBtn = document.getElementById('cart-page-checkout-btn');
            if (cartPageCheckoutBtn) cartPageCheckoutBtn.addEventListener('click', openPaymentModal);
            DOMElements.showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('login');
            });
            if (DOMElements.showResetLink) DOMElements.showResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('reset'); });
            if (DOMElements.showLoginFromResetLink) DOMElements.showLoginFromResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });

            document.querySelectorAll('input[name="main-payment"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mobileOptions = document.getElementById('mobile-banking-options');
                    if (e.target.value === 'Mobile Banking') {
                        mobileOptions.classList.remove('hidden');
                        mobileOptions.querySelector('input[value="Bkash"]').checked = true;
                    } else {
                        mobileOptions.classList.add('hidden');
                    }
                });
            });

            DOMElements.searchButton.addEventListener('click', performSearch);
            DOMElements.searchInput.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            // Live search suggestions
            if (DOMElements.searchInput) DOMElements.searchInput.addEventListener('input', handleSearchSuggestions);
            if (DOMElements.searchInputMobile) DOMElements.searchInputMobile.addEventListener('input', handleSearchSuggestions);
            if (DOMElements.searchButton) DOMElements.searchButton.addEventListener('click', hideSearchResults);
            if (DOMElements.searchButtonMobile) DOMElements.searchButtonMobile.addEventListener('click', hideSearchResults);
            DOMElements.searchButtonMobile.addEventListener('click', performSearch);
            DOMElements.searchInputMobile.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            // Hide suggestions when clicking outside of search areas
            document.addEventListener('click', (e) => {
                const inDesktop = e.target.closest('#search-input') || e.target.closest('#search-results-desktop') || e.target.closest('#search-button');
                const inMobile = e.target.closest('#search-input-mobile') || e.target.closest('#search-results-mobile') || e.target.closest('#search-button-mobile');
                if (!inDesktop && !inMobile) hideSearchResults();
            });
            
            document.getElementById('hamburger-btn').addEventListener('click', () => openDrawer('nav-drawer'));
            
            document.addEventListener('click', handleProductCardClick); // Delegated click handler
            document.getElementById('product-options').addEventListener('click', handleVariantSelection);
            document.getElementById('product-image-container').addEventListener('mousemove', handleImageZoom);
            
            // Review Form Listeners
            document.getElementById('rating-stars').addEventListener('click', handleStarClick);
            document.getElementById('review-form').addEventListener('submit', submitReview);

            // --- Invoice Button Delegation ---
            document.addEventListener('click', (e) => {
                const target = e.target.closest('.download-invoice-btn');
                if (target) {
                    const orderId = target.dataset.orderId;
                    downloadInvoice(orderId);
                }
            });
            // --- END Invoice Button Delegation ---

            // --- Wishlist Remove Delegation ---
            document.addEventListener('click', async (e) => {
                const removeBtn = e.target.closest('.remove-from-wishlist');
                if (!removeBtn) return;
                const pid = removeBtn.getAttribute('data-product-id');
                await toggleWishlistInDb(pid);
                updateWishlistUI();
            });
            // --- END Wishlist Remove Delegation ---
            
            const detailsPage = document.getElementById('product-details-page');
            detailsPage.querySelector('#add-to-cart-details').addEventListener('click', (e) => addToCartInDb(e.target.dataset.productId, false));
            detailsPage.querySelector('.buy-now').addEventListener('click', (e) => {
                const productId = detailsPage.querySelector('#add-to-cart-details').dataset.productId;
                // Pre-check variants and guide the user if any required option is missing
                const product = (productsData || []).find(p => p.id === productId);
                const required = product ? getRequiredVariants(product) : [];
                const missing = required.filter(t => !selectedVariants[t]);
                if (missing.length > 0) {
                    showToast('toast-select-variant', false);
                    highlightMissingVariantUI(missing);
                    return;
                }
                addToCartInDb(productId).then(() => {
                   openPaymentModal();
                }).catch(err => {
                   if (String(err || '').toLowerCase().includes('variant')) {
                       showToast('toast-select-variant', false);
                       highlightMissingVariantUI(required);
                   }
                   console.log("Could not proceed to buy now:", err);
                });
            });
            detailsPage.querySelector('#wishlist-details').addEventListener('click', (e) => toggleWishlistInDb(e.target.closest('.wishlist').dataset.productId));
        });

        function initializeSlider() {
            const slides = DOMElements.slidesContainer.children;
            if (slides.length === 0) return;
            const slideCount = slides.length;
            let currentSlide = 0;
            let autoSlideInterval;

            DOMElements.indicatorContainer.innerHTML = '';
            
            for(let i = 0; i < slideCount; i++) {
                const indicator = document.createElement('button');
                indicator.className = 'w-3 h-3 rounded-full bg-gray-400 transition-all';
                indicator.addEventListener('click', () => goToSlide(i));
                DOMElements.indicatorContainer.appendChild(indicator);
            }

            const updateSlider = () => {
                DOMElements.slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
                Array.from(DOMElements.indicatorContainer.children).forEach((ind, i) => {
                    ind.classList.toggle('bg-white', i === currentSlide);
                    ind.classList.toggle('bg-gray-400', i !== currentSlide);
                });
            };

            const goToSlide = (slideIndex) => {
                currentSlide = slideIndex;
                updateSlider();
                resetInterval();
            };

            const resetInterval = () => {
                clearInterval(autoSlideInterval);
                autoSlideInterval = setInterval(() => {
                    currentSlide = (currentSlide + 1) % slideCount;
                    updateSlider();
                }, 4000);
            };

            DOMElements.nextBtn.addEventListener('click', () => goToSlide((currentSlide + 1) % slideCount));
            DOMElements.prevBtn.addEventListener('click', () => goToSlide((currentSlide - 1 + slideCount) % slideCount));

            updateSlider();
            resetInterval();
        }
        
    </script>

</body>
</html>
