<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TangailBuzz - Online Shopping</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS custom theme configuration
        tailwind.config = {
            // ENABLE DARK MODE VIA CLASS TOGGLE
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3a86ff',
                        secondary: '#ff006e',
                        accent: '#8338ec',
                        light: '#f8f9fa',
                        dark: '#212529',
                        success: '#28a745',
                        'theme-purple': '#6a0dad',
                        'theme-pink': '#e5367a',
                        'theme-blue': '#4a7bed',
                        'theme-light': '#f5f7fa',
                        'price-black': '#000000',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'Noto Sans Bengali', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1s ease-in-out',
                        'slide-in-up': 'slideInUp 0.8s ease-out',
                        'spin': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                          spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                }
            }
        }
    </script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for invoice generation (Placeholder - implementation pending) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom styles for toast notifications and other minor tweaks */
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        .variant-btn-active {
            border-color: #3a86ff !important;
            background-color: #e0eaff !important;
            color: #3a86ff !important;
            font-weight: 600 !important;
        }
        .color-variant-active {
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3a86ff; /* Custom ring effect */
        }
        /* Simple loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .loader-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .active-lang {
            text-decoration: underline;
            text-underline-offset: 4px;
            color: #f8f9fa;
        }
        /* Drawer & Modal Styles */
        .drawer-overlay, .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .drawer {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .drawer.left {
             transform: translateX(-100%);
        }
        .drawer.active {
            transform: translateX(0);
        }
        /* CSS variables used by JS for image zoom */
        #product-image-container:hover #product-image {
            transform-origin: var(--x-pos) var(--y-pos);
            transform: scale(2);
        }

        /* Custom CSS for Progress Tracker (Final Fix for Image Alignment) */
        /* Core Flex Container */
        .tracker-step-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 10px; /* Small padding inside the card to push start/end points slightly from edge */
        }
        /* Style for the space between nodes (which holds the line) */
        .tracker-connector {
            flex-grow: 1; /* Takes all remaining space */
            display: flex;
            align-items: center;
            justify-content: center; /* Center the line element */
            height: 32px; /* Maintain vertical space */
            margin-top: 12px; /* Align with circle top margin */
        }
        .tracker-connector-line {
            height: 4px;
            width: 100%; /* Line fills connector space */
            background-color: #d1d5db; /* Grey line */
        }
        .tracker-connector.active .tracker-connector-line {
            background-color: #34d399; /* Green line */
        }
        
        /* Style for the nodes (circles and text) */
        .tracker-node {
            position: relative;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            text-align: center;
            /* Use a fixed, small width for each step to control spacing */
            width: 70px; 
            /* Push the text label slightly left/right for first/last node labels to align them under the circle */
        }
        .tracker-circle {
            width: 32px;
            height: 32px;
            margin-top: 12px;
        }
        .rating-star:hover, .rating-star.selected {
            color: #fca311; /* Amber/Yellow for selection/hover */
        }
        /* Mobile-friendly vertical tracker layout */
        @media (max-width: 640px) {
            .tracker-step-container {
                flex-direction: column;
                align-items: stretch;
                padding: 0 6px;
            }
            .tracker-node {
                width: auto;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                text-align: left;
            }
            .tracker-circle {
                width: 28px;
                height: 28px;
                margin-top: 4px;
            }
            .tracker-node p {
                margin: 0;
                font-size: 11px;
            }
            .tracker-connector {
                width: 4px;
                height: 32px;
                margin: 4px 0 4px 14px; /* align under the circle */
                justify-content: flex-start;
            }
            .tracker-connector-line {
                width: 4px;
                height: 100%;
            }
        }
        
    </style>
</head>
<body class="bg-theme-light text-dark font-sans leading-relaxed transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
    
    <!-- Blocked User Banner -->
    <div id="blocked-account-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white text-center p-3 z-[9999] font-semibold"></div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-20 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform translate-x-[150%] opacity-0">
        <p id="toast-message">Item added to cart!</p>
    </div>


    <!-- Header Section -->
    <header class="bg-gradient-to-r from-theme-blue to-theme-purple text-white py-4 sticky top-0 z-40 shadow-2xl">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <!-- Left side: Hamburger (mobile) and Logo -->
            <div class="flex items-center space-x-4">
                 <!-- Hamburger Menu for Mobile -->
                <button id="hamburger-btn" class="md:hidden text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center text-3xl font-bold transform hover:scale-105 transition-transform cursor-pointer" onclick="renderAllProducts()">
                    <img src="https://raw.githubusercontent.com/tangailbuzzbd-svg/TangailBuzz-Picture-/main/MD%20EOUSUF%20ALI%20BACK-1_upscaled.png" alt="TangailBuzz Logo" class="h-12 w-auto mr-2">
                    <span class="hidden sm:inline">TangailBuzz</span>
                </div>
            </div>

            <!-- Center: Navigation (Desktop) -->
            <nav class="hidden md:flex">
                <ul class="flex items-center space-x-6">
                    <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="home">হোম</a></li>
                    <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="products">পণ্য</a></li>
                    <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="categories">ক্যাটাগরি</a></li>
                    <li><a href="javascript:void(0);" onclick="showOffers()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="offers">অফার</a></li>
                </ul>
            </nav>

            <!-- Right side: Actions -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <!-- Search -->
                <div class="hidden md:block relative flex-grow md:flex-grow-0 rounded-full overflow-hidden shadow-md">
                    <input type="text" id="search-input" placeholder="পণ্য খুঁজুন..." class="w-full pl-6 pr-12 py-2 text-dark outline-none focus:ring-2 focus:ring-theme-pink rounded-full text-sm">
                    <button id="search-button" class="absolute right-0 top-0 h-full bg-theme-pink text-white px-4 hover:bg-theme-purple transition-colors">
                        <i class="fas fa-search"></i>
                    </button>
                </div>

                <!-- Language change option -->
                <div class="flex items-center space-x-2 text-white font-semibold text-sm">
                    <a href="javascript:void(0);" id="lang-bn-btn" onclick="setLanguage('bn')" class="hover:text-theme-pink transition-colors">বাংলা</a>
                    <span class="text-gray-400">|</span>
                    <a href="javascript:void(0);" id="lang-en-btn" onclick="setLanguage('en')" class="hover:text-theme-pink transition-colors">English</a>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="text-white text-xl p-2 rounded-full hover:bg-white hover:text-theme-blue transition-colors" aria-label="Toggle Dark Mode">
                    <i class="fas fa-sun" id="dark-mode-icon"></i>
                </button>
                
                <div id="profile-icon" class="relative transform hover:scale-110 transition-transform cursor-pointer" onclick="openDrawer('profile-drawer')">
                    <i class="fas fa-user-circle text-white text-2xl"></i>
                </div>
                <div class="relative transform hover:scale-110 transition-transform cursor-pointer" onclick="showPage('wishlist-page')">
                    <i class="fas fa-heart text-white text-2xl"></i>
                    <span id="wishlist-count-badge" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                </div>
                <div class="relative transform hover:scale-110 transition-transform cursor-pointer" onclick="openDrawer('cart-drawer')">
                    <i class="fas fa-shopping-cart text-white text-2xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </div>
            </div>
        </div>
        <!-- Search bar for mobile -->
        <div class="md:hidden mt-4 px-4">
            <div class="relative w-full rounded-full overflow-hidden shadow-md">
                <input type="text" id="search-input-mobile" placeholder="পণ্য খুঁজুন..." class="w-full pl-6 pr-12 py-2 text-dark outline-none focus:ring-2 focus:ring-theme-pink rounded-full text-sm">
                <button id="search-button-mobile" class="absolute right-0 top-0 h-full bg-theme-pink text-white px-4 hover:bg-theme-purple transition-colors">
                    <i class="fas fa-search"></i>
                    </button>
            </div>
        </div>
    </header>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeDrawer()"></div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-theme-purple" data-lang="payment-method">Select Payment Method</h3>
                <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="payment-options" class="space-y-4">
                <!-- Main Payment Options -->
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Mobile Banking" class="w-5 h-5 accent-theme-blue">
                    <span class="ml-4 font-semibold" data-lang="mobile-banking">Mobile Banking</span>
                </label>
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Cash on Delivery" class="w-5 h-5 accent-theme-blue" checked>
                    <span class="ml-4 font-semibold" data-lang="cod">Cash on Delivery</span>
                </label>

                <!-- Sub Payment Options for Mobile Banking (hidden by default) -->
                <div id="mobile-banking-options" class="hidden pl-8 space-y-3 pt-3">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Bkash" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Bkash</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Nagad" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Nagad</span>
                    </label>
                </div>
            </div>
            <div class="mt-8">
                <button id="confirm-order-btn" class="w-full bg-theme-pink text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg" data-lang="confirm-order">Confirm Order</button>
            </div>
        </div>
    </div>
    
    <!-- Order Success Modal -->
    <div id="order-success-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[110] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
             <div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-4xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-6" data-lang="order-placed-success">Your order has been placed successfully!</h3>
            <p id="payment-instruction" class="mt-4 text-gray-600"></p>
            <div class="mt-8">
                <button id="close-success-modal" class="w-full bg-theme-blue text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (Replaces window.confirm) -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[120] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl text-center">
            <h3 id="confirm-title" class="text-2xl font-bold text-red-600 mb-4">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-600">Are you sure you want to proceed?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-full font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-full font-semibold hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Mobile Navigation Drawer (Left) -->
    <div id="nav-drawer" class="drawer left fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg z-50 p-6">
        <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        <h3 class="text-2xl font-bold text-theme-purple mb-8">Menu</h3>
        <nav>
            <ul class="space-y-4">
                <li><a href="javascript:void(0);" onclick="renderAllProducts(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="home">হোম</a></li>
                <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="products">পণ্য</a></li>
                <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="categories">ক্যাটাগরি</a></li>
                <li><a href="javascript:void(0);" onclick="showOffers(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="offers">অফার</a></li>
            </ul>
        </nav>
    </div>

    <!-- Cart Drawer (Right) -->
    <div id="cart-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-2xl font-bold text-theme-purple" data-lang="cart">আপনার কার্ট</h3>
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
        </div>
        <div id="cart-items" class="p-6 space-y-6 flex-grow overflow-y-auto">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        <div id="cart-summary" class="p-6 border-t space-y-2">
            
            <!-- Available Coupons Section moved inside cart drawer -->
            <div id="coupon-details-container">
                <h4 class="text-lg font-bold text-theme-purple mb-3" data-lang="available-coupons">উপলব্ধ কুপন</h4>
                <div id="coupons-list" class="space-y-3 mb-4">
                    <!-- Coupons will be dynamically loaded here -->
                    <div class="col-span-full text-center py-4">
                        <div class="loader mx-auto"></div>
                    </div>
                </div>
            </div>
            
            <!-- Summary -->
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="subtotal">Subtotal:</span>
                <span id="cart-subtotal" class="text-dark">৳0.00</span>
            </div>
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="delivery-charge">Delivery Charge:</span>
                <span id="delivery-charge" class="text-dark">৳0.00</span>
            </div>
            <div id="discount-row" class="hidden flex justify-between items-center text-md font-medium text-green-600">
                <span data-lang="discount">Discount:</span>
                <span id="cart-discount"></span>
            </div>
            <div class="flex justify-between items-center text-xl font-semibold border-t pt-2 mt-2">
                <span data-lang="total">Total:</span>
                <span id="cart-total" class="text-theme-blue">৳0.00</span>
            </div>
             <!-- Coupon Form -->
            <div class="mt-4">
                <form id="coupon-form" class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="coupon-input" placeholder="Enter Coupon Code" class="flex-grow px-3 py-2 text-sm sm:text-base border rounded-full focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white" data-lang-placeholder="coupon-placeholder">
                    <button type="submit" id="apply-coupon-btn" class="bg-theme-blue text-white px-4 py-2 text-sm sm:text-base rounded-full font-semibold hover:bg-theme-purple transition-colors" data-lang="apply-coupon">Apply</button>
                </form>
            </div>
            <button id="checkout-btn" class="w-full bg-theme-pink text-white py-4 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg mt-4" data-lang="checkout">চেকআউট করুন</button>
        </div>
    </div>
    
    <!-- Profile Drawer (Right) -->
    <div id="profile-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 overflow-y-auto">
        <div class="p-6 text-center relative">
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h3 id="profile-drawer-title" class="text-3xl font-bold text-theme-purple mb-8" data-lang="your-account">আপনার অ্যাকাউন্ট</h3>
            
            <div class="space-y-4">
                <!-- Logged OUT state -->
                <div id="auth-options">
                    <!-- Login Form -->
                    <form id="login-form" class="space-y-4 text-left">
                        <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Login</button>
                        <div class="flex justify-between text-sm">
                            <a href="#" id="show-reset-form" class="text-theme-blue hover:underline">Forgot password?</a>
                            <span></span>
                        </div>
                        <p class="text-center text-sm">Don't have an account? <a href="#" id="show-register-form" class="text-theme-blue hover:underline">Register</a></p>
                    </form>

                    <!-- Reset Password Form (hidden by default) -->
                    <form id="reset-form" class="hidden space-y-4 text-left">
                        <p class="text-sm text-gray-600">Enter your account email. We'll send a link to reset your password.</p>
                        <input type="email" id="reset-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Send reset link</button>
                        <p class="text-center text-sm">Remembered it? <a href="#" id="show-login-from-reset" class="text-theme-blue hover:underline">Back to login</a></p>
                    </form>

                    <!-- Register Form (hidden by default) -->
                    <form id="register-form" class="hidden space-y-4 text-left">
                        <input type="text" id="register-name" placeholder="Full Name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="tel" id="register-mobile" placeholder="Mobile Number" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="text" id="register-location" placeholder="Location" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Register</button>
                        <p class="text-center text-sm">Already have an account? <a href="#" id="show-login-form" class="text-theme-blue hover:underline">Login</a></p>
                    </form>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    
                    <button id="login-google-btn" class="w-full py-3 px-6 bg-white border border-gray-300 text-gray-700 rounded-full font-bold hover:bg-gray-100 transition-colors shadow-lg flex items-center justify-center">
                        <i class="fab fa-google mr-2 text-xl"></i>
                        <span data-lang="signin-google">Sign in with Google</span>
                    </button>
                    <button id="login-facebook-btn" class="mt-3 w-full py-3 px-6 bg-[#1877F2] text-white rounded-full font-bold hover:bg-[#165FDB] transition-colors shadow-lg flex items-center justify-center">
                        <i class="fab fa-facebook mr-2 text-xl"></i>
                        <span>Continue with Facebook</span>
                    </button>
                     <p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
                </div>

                <!-- Logged IN state -->
                <div id="user-profile-view" class="hidden">
                    <!-- User Info Section -->
                    <div class="space-y-2 mb-8">
                        <img id="user-photo" src="" alt="User Photo" class="w-24 h-24 rounded-full mx-auto shadow-xl object-cover border-4 border-theme-purple/30">
                        <p id="user-name" class="mt-4 text-xl font-bold text-theme-purple"></p>
                        <p id="user-email" class="text-sm text-gray-500"></p>
                        <div class="flex items-center justify-center space-x-1 text-sm mt-2">
                             <p id="user-mobile" class="text-sm text-gray-600"></p>
                        </div>
                        <div class="flex items-center justify-center space-x-1 text-sm">
                            <p id="user-location" class="text-sm text-gray-600"></p>
                        </div>
                    </div>

                    <!-- Button Actions Group -->
                    <div class="space-y-4">
                        
                        <!-- My Orders (Theme Blue) -->
                        <button id="my-orders-btn-profile" class="w-full py-3 bg-theme-blue text-white rounded-xl font-semibold hover:bg-theme-purple transition-colors shadow-md flex items-center justify-between px-4" data-lang="my-orders">
                            <span><i class="fas fa-box-open mr-3"></i> My Orders</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>

                        <!-- Emergency Contact (Theme Pink) -->
                        <button id="emergency-contact-btn" class="w-full py-3 bg-theme-pink text-white rounded-xl font-semibold hover:bg-theme-purple transition-colors shadow-md flex items-center justify-between px-4" data-lang="emergency-contact">
                            <span><i class="fas fa-headset mr-3"></i> Emergency Contact</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                        
                        <!-- Edit Profile (Grey/Secondary) -->
                        <button id="edit-profile-btn" class="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors shadow-md flex items-center justify-between px-4">
                            <span><i class="fas fa-user-edit mr-3"></i> Edit Profile</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                        
                        <!-- Logout (Prominent) -->
                         <button id="logout-btn" class="w-full py-3 bg-theme-pink text-white rounded-xl font-semibold hover:bg-theme-purple transition-colors shadow-lg mt-8 flex items-center justify-between px-4" data-lang="logout">
                            <span><i class="fas fa-sign-out-alt mr-3"></i> লগআউট</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>

                        <!-- Delete Account (Danger, Separate) -->
                        <button id="delete-account-btn" class="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors shadow-md flex items-center justify-center mt-4">
                             <i class="fas fa-trash-alt mr-2"></i> Delete Account
                        </button>

                    </div>
                </div>
                 <!-- Edit Profile Form -->
                <form id="edit-profile-form" class="hidden text-left space-y-4">
                    <div class="text-center">
                         <img id="edit-photo-preview" src="" alt="Profile Photo Preview" class="w-24 h-24 rounded-full mx-auto shadow-lg object-cover mb-2">
                         <input type="file" id="edit-photo-input" accept="image/*" class="text-sm w-full">
                         <button type="button" id="remove-photo-btn" class="mt-2 px-4 py-2 text-sm rounded-full border border-red-400 text-red-600 hover:bg-red-50 transition-colors">Remove Photo</button>
                    </div>
                    <div>
                        <label for="edit-name-input" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="edit-name-input" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                    <div>
                        <label for="edit-mobile-input" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                        <input type="text" id="edit-mobile-input" placeholder="e.g., 01xxxxxxxxx" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="edit-location-input" class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" id="edit-location-input" placeholder="e.g., Dhaka, Bangladesh" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button type="button" id="cancel-edit-btn" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">Cancel</button>
                        <button type="submit" id="save-profile-btn" class="w-full py-2 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors flex items-center justify-center">
                            <span class="btn-text">Save Changes</span>
                            <div class="loader-small hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Main Content Container -->
    <main id="main-content-container">

        <!-- Home Page -->
        <div id="home-page" class="page">
            <!-- Banner Section -->
            <section class="container mx-auto px-4 py-8">
                <div id="banner-slider" class="relative overflow-hidden w-full rounded-2xl shadow-xl">
                    <!-- Slides Container -->
                    <div id="slides-container" class="flex transition-transform duration-500 ease-in-out">
                       <!-- Banners will be loaded from Firebase here -->
                    </div>
                    
                    <!-- Slider Navigation Buttons -->
                    <button id="prev-btn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button id="next-btn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <!-- Slider Indicators -->
                    <div id="slider-indicators" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                        <!-- Indicators are dynamically generated -->
                    </div>
                </div>
            </section>
        
            <!-- Featured Products Section -->
            <section id="products" class="container mx-auto px-4 py-16">
                <!-- NEW: Breadcrumb and Sub-Category Header -->
                <div id="category-header" class="mb-8 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md border dark:border-gray-700">
                    <div id="breadcrumb" class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        <a href="javascript:void(0);" onclick="renderAllProducts()" class="text-theme-blue hover:underline" data-lang="all-products">সকল পণ্য</a>
                        <span id="category-path"></span>
                    </div>
                    <h2 id="current-category-title" class="text-3xl md:text-4xl font-bold mb-4 text-theme-purple text-center" data-lang="featured-products">বৈশিষ্ট্যযুক্ত পণ্য</h2>
                    <div id="subcategory-buttons" class="flex flex-wrap gap-3 justify-center">
                        <!-- Sub-category buttons will appear here -->
                    </div>
                </div>
                <!-- END NEW: Breadcrumb and Sub-Category Header -->

                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 min-h-[300px] flex justify-center items-center">
                    <div class="loader"></div>
                </div>
            </section>

            <!-- Categories Section -->
            <section id="categories" class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="shop-by-category">ক্যাটাগরি অনুসারে কেনাকাটা করুন</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-8">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('electronics')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-mobile-alt"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-electronics">ইলেকট্রনিক্স</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('fashion')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-tshirt"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-fashion">ফ্যাশন</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('home-garden')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-home"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-home-garden">হোম অ্যান্ড গার্ডেন</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('health-beauty')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-health-beauty">স্বাস্থ্য ও সৌন্দর্য</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('sports')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-dumbbell"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-sports">খেলাধুলা ও আউটডোর</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('books')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-books">বই ও স্টেশনারি</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('kids')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-baby"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-kids">বাচ্চা ও খেলনা</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('cars')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-car-side"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-cars">গাড়ি ও বাইক</h3>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="bg-gray-200 dark:bg-gray-800 py-16">
                <div class="container mx-auto px-4">
                    <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="why-choose-us">আমাদেরকে কেন বেছে নিবেন</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-truck"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-delivery-title">দ্রুত ডেলিভারি</h3>
                            <p class="text-gray-600" data-lang="feature-delivery-desc">আমরা ২-৩ কার্যদিবসের মধ্যে আপনার দোরগোড়ায় পণ্য পৌঁছে দিই।</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-shield-alt"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-payment-title">নিরাপদ পেমেন্ট</h3>
                            <p class="text-gray-600" data-lang="feature-payment-desc">আপনার নিরাপত্তা ও গোপনীয়তার জন্য সকল লেনদেন এনক্রিপ্টেড।</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-undo"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-return-title">সহজ রিটার্ন</h3>
                            <p class="text-gray-600" data-lang="feature-return-desc">পছন্দ না হলে ৩০ দিনের মধ্যে পণ্য ফেরত দিন এবং সম্পূর্ণ মূল্য ফেরত পান।</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-headset"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-support-title">২৪/৭ সাপোর্ট</h3>
                            <p class="text-gray-600" data-lang="feature-support-desc">আমাদের গ্রাহক সহায়তা দল দিনরাত আপনার জন্য উপলব্ধ।</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- About Us Page -->
        <div id="about-us-page" class="hidden page">
             <section id="about-us" class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">আমাদের সম্পর্কে</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-8">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz একটি বিশ্বস্ত অনলাইন শপিং প্ল্যাটফর্ম যা সাশ্রয়ী মূল্যে মানসম্মত পণ্য সরবরাহ করতে প্রতিশ্রুতিবদ্ধ। আমরা গ্রাহকদের একটি সহজ এবং আনন্দদায়ক কেনাকাটার অভিজ্ঞতা দিতে বদ্ধপরিকর। আমাদের লক্ষ্য হল সকলের কাছে সেরা পণ্য পৌঁছে দেওয়া, যাতে তারা ঘরে বসেই তাদের পছন্দের জিনিস কিনতে পারেন।
                    </p>
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8 md:gap-12 p-6 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-inner">
                        <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true" alt="Md Eousuf Ali" class="w-32 h-32 rounded-full object-cover shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold text-theme-purple mb-2">প্রতিষ্ঠাতা: MD EOUSUF ALI</h3>
                            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">
                                Md Eousuf Ali, TangailBuzz-এর স্বপ্নদ্রষ্টা এবং প্রতিষ্ঠাতা। ডিজিটাল প্ল্যাটফর্মের মাধ্যমে বাংলাদেশের মানুষের কাছে উন্নত মানের পণ্য পৌঁছে দেওয়ার লক্ষ্য নিয়ে তিনি এই যাত্রা শুরু করেন। তাঁর দূরদর্শিতা এবং কঠোর পরিশ্রম TangailBuzz-কে আজকের অবস্থানে এনেছে।
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Product Details Page -->
        <div id="product-details-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl">
                    <button onclick="renderAllProducts()" class="mb-6 px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> <span data-lang="back-to-products">সকল পণ্যে ফিরে যান</span>
                    </button>
                    <div class="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
                        <!-- Main Product Image & Thumbnails -->
                        <div class="w-full lg:w-1/2 flex flex-col items-center space-y-4">
                             <div id="product-image-container" class="relative w-full rounded-2xl shadow-lg overflow-hidden">
                                 <!-- Mouse events for handleImageZoom use 'var(--x-pos)' and 'var(--y-pos)' set in JS/CSS -->
                                <img id="product-image" class="w-full h-full object-cover transition-transform duration-200 ease-out" src="" alt="Product Image">
                            </div>
                            <!-- Thumbnail Images -->
                            <div id="thumbnail-container" class="flex space-x-2 overflow-x-auto w-full justify-center">
                                <!-- Thumbnails will be added here dynamically -->
                            </div>
                        </div>
                        <div class="w-full lg:w-1/2 space-y-4">
                            <h2 id="product-title-details" class="text-3xl md:text-4xl font-bold text-theme-purple"></h2>
                            <p id="product-brand-details" class="text-sm text-gray-500"></p>
                            <!-- NEW: Product Model ID Display -->
                            <p id="product-model-details" class="text-sm text-gray-600 font-medium flex items-center">
                                <i class="fas fa-tag mr-2"></i> 
                                <span id="model-text"></span>
                            </p>
                            <!-- END NEW: Product Model ID Display -->
                            <!-- NEW: Warranty Display below Brand/Model -->
                            <p id="product-warranty-details" class="text-sm text-green-600 font-semibold flex items-center">
                                <!-- Icon and Text updated via JS -->
                                <i class="fas fa-shield-alt mr-2"></i> 
                                <span id="warranty-text"></span>
                            </p>
                            <!-- END NEW: Warranty Display -->
                            <div class="flex items-center text-sm my-1">
                                <div id="product-rating-details" class="text-sm mr-1"></div>
                                <div id="product-stars-details" class="flex items-center"></div>
                                <div id="product-rating-count-details" class="text-xs text-gray-500 ml-2"></div>
                            </div>
                            <div id="product-price-details" class="flex items-center space-x-2"></div>
                            
                            <!-- Variants: Size, Storage, Color -->
                            <div id="product-options" class="space-y-4">
                                <div id="size-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="size">সাইজ:</label>
                                    <div class="flex flex-wrap gap-2" id="size-variants-container"></div>
                                </d>
                                <div id="storage-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="storage">স্টোরেজ:</label>
                                    <div class="flex flex-wrap gap-2" id="storage-variants-container"></div>
                                </d>
                                <div id="color-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="color">রঙ:</label>
                                    <div class="flex flex-wrap gap-2" id="color-variants-container"></div>
                                </d>
                            </div>
                            
                            <!-- Return policy and secure payments -->
                            <div id="product-info-details" class="space-y-2 text-gray-600">
                                <!-- Details will be rendered here dynamically -->
                            </div>

                            <div class="flex flex-col space-y-4 mt-6">
                                <button id="add-to-cart-details" class="add-to-cart bg-theme-blue text-white py-3 px-6 rounded-full hover:bg-theme-purple transition-colors shadow-lg" data-lang="add-to-cart">কার্টে যোগ করুন</button>
                                <button class="buy-now bg-white border border-theme-blue text-theme-blue py-3 px-6 rounded-full hover:bg-gray-100 transition-colors shadow-lg" data-lang="buy-now">এখনই কিনুন</button>
                                <button id="wishlist-details" class="wishlist text-gray-400 hover:text-theme-pink text-3xl transition-colors self-start"><i class="far fa-heart"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-description">পণ্যের বিবরণ</h3>
                        <p id="product-full-description" class="text-gray-700 dark:text-gray-300 leading-relaxed mt-4"></p>
                    </div>
                    
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-specifications">পণ্যের স্পেসিফিকেশন</h3>
                        <div id="product-specifications" class="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl mt-4"></div>
                    </div>

                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-reviews">পণ্যের রিভিউ</h3>
                        <div id="product-reviews" class="space-y-4 mt-4"></div>
                        
                        <!-- NEW: Review Submission Form -->
                        <div class="mt-8 p-6 bg-gray-100 dark:bg-gray-700 rounded-xl shadow-inner">
                            <h4 class="text-xl font-bold text-theme-blue mb-4" data-lang="write-a-review">একটি রিভিউ দিন</h4>
                            <form id="review-form">
                                <input type="hidden" id="review-product-id" name="productId">
                                <div id="review-login-prompt" class="text-center p-4 border border-red-300 bg-red-50 text-red-700 rounded-lg hidden">
                                    <p data-lang="review-login-prompt">অনুগ্রহ করে লগইন করুন রিভিউ দেওয়ার জন্য।</p>
                                </div>
                                <div id="review-controls">
                                    <div class="mb-4">
                                        <label class="block text-sm font-semibold mb-2" data-lang="your-rating">আপনার রেটিং:</label>
                                        <div id="rating-stars" class="flex text-2xl space-x-1">
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="1"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="2"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="3"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="4"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="5"></i>
                                            <input type="hidden" id="review-rating" name="rating" required value="0">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="review-comment" class="block text-sm font-semibold mb-2" data-lang="your-comment">আপনার মন্তব্য:</label>
                                        <textarea id="review-comment" name="comment" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-800" required></textarea>
                                    </div>
                                    <button type="submit" id="submit-review-btn" class="bg-theme-pink text-white py-2 px-6 rounded-full font-bold hover:bg-theme-purple transition-colors" data-lang="submit-review">রিভিউ জমা দিন</button>
                                </div>
                            </form>
                        </div>
                        <!-- END NEW: Review Submission Form -->
                    </div>
                </div>
            </section>
        </div>

        <!-- Wishlist Page -->
        <div id="wishlist-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="your-wishlist">আপনার উইশলিস্ট</h2>
                <div id="wishlist-items" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                    <!-- Wishlist items will be dynamically inserted here -->
                </div>
            </section>
        </div>
        
        <!-- My Orders Page -->
        <div id="my-orders-page" class="hidden page">
             <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="my-orders">My Orders</h2>
                <div id="orders-list" class="space-y-8">
                    <!-- Orders will be dynamically inserted here -->
                </div>
             </section>
        </div>
        
        <!-- Emergency Chat Page -->
        <div id="emergency-chat-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-xl max-w-2xl mx-auto flex flex-col h-[70vh]">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 class="text-2xl font-bold text-theme-purple">জরুরী যোগাযোগ</h2>
                        <button onclick="showPage('home-page')" class="text-theme-blue hover:text-theme-pink transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Chat Messages Container -->
                    <div id="chat-messages" class="flex-grow overflow-y-auto space-y-4 p-4 mb-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-center text-gray-500">Loading chat...</p>
                    </div>
                    
                    <!-- Chat Input Form -->
                    <form id="chat-form" class="flex space-x-3">
                        <input type="text" id="chat-input" placeholder="আপনার বার্তা লিখুন..." class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700" required>
                        <button type="submit" id="send-chat-btn" class="bg-theme-blue text-white w-12 h-12 rounded-full hover:bg-theme-purple transition-colors shadow-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <p id="chat-error" class="text-red-500 text-xs mt-2"></p>
                </div>
            </section>
        </div>


        <!-- FAQ Page -->
        <div id="faq-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">সচরাচর জিজ্ঞাসিত প্রশ্নাবলী (FAQ)</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমি কীভাবে অর্ডার করব?</h3>
                        <p class="text-gray-700 dark:text-gray-300">আপনার পছন্দের পণ্যটি নির্বাচন করুন, 'কার্টে যোগ করুন' বাটনে ক্লিক করুন এবং আপনার অর্ডারটি সম্পন্ন করতে চেকআউট প্রক্রিয়া অনুসরণ করুন।</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">ডেলিভারি হতে কত সময় লাগে?</h3>
                        <p class="text-gray-700 dark:text-gray-300">সাধারণত আমরা ২-৩ কার্যদিবসের মধ্যে ডেলিভারি সম্পন্ন করি। তবে, নির্দিষ্ট এলাকার উপর ভিত্তি করে কিছুটা সময় বেশিও লাগতে পারে।</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমি কি ক্যাশ অন ডেলিভারি (COD) পেমেন্ট করতে পারব?</h3>
                        <p class="text-gray-700 dark:text-gray-300">হ্যাঁ, আমরা ক্যাশ অন ডেলিভারি (COD) এবং অনলাইন পেমেন্ট উভয়ই গ্রহণ করি।</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">আমার অর্ডার ট্র্যাক করার উপায় কী?</h3>
                        <p class="text-gray-700 dark:text-gray-300">আপনার অর্ডার নিশ্চিত হলে, আমরা আপনাকে একটি ট্র্যাকিং নম্বর সহ একটি ইমেল পাঠাব। আপনি আমাদের ওয়েবসাইটে সেই ট্র্যাকিং নম্বর ব্যবহার করে আপনার অর্ডার ট্র্যাক করতে পারবেন।</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Return Policy Page -->
        <div id="return-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">রিটার্ন নীতি</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        যদি আপনি আপনার কেনা পণ্যে অসন্তুষ্ট হন, তবে আপনি ডেলিভারির ৩০ দিনের মধ্যে এটি ফেরত দিতে পারবেন। পণ্যটি অব্যবহৃত এবং এর মূল প্যাকেজিংয়ে থাকতে হবে।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">ফেরতের প্রক্রিয়া:</h3>
                    <ol class="list-decimal list-inside text-gray-700 dark:text-gray-300 space-y-2">
                        <li>গ্রাহক সেবার সাথে যোগাযোগ করুন এবং ফেরতের কারণ জানান।</li>
                        <li>আমাদের দল আপনার অনুরোধ পর্যালোচনা করবে এবং একটি রিটার্ন নম্বর প্রদান করবে।</li>
                        <li>নির্ধারিত ঠিকানায় পণ্যটি সঠিকভাবে প্যাকিং করে ফেরত পাঠান।</li>
                        <li>পণ্যটি আমাদের হাতে পৌঁছানোর পর, আমরা আপনার টাকা ফেরত দেওয়ার প্রক্রিয়া শুরু করব।</li>
                    </ol>
                </div>
            </section>
        </div>

        <!-- Shipping Info Page -->
        <div id="shipping-info-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">শিপিং তথ্য</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <h3 class="text-xl font-bold text-theme-purple">ডেলিভারি সময়:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        শহরের মধ্যে: ২-৩ কার্যদিবস <br>
                        শহরের বাইরে: ৫-৭ কার্যদিবস
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">শিপিং খরচ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ডেলিভারি খরচ আপনার এলাকার উপর নির্ভর করে ভিন্ন হতে পারে। অর্ডার করার সময় চেকআউট পেজে সঠিক খরচ দেখতে পাবেন।
                    </p>
                </div>
            </section>
        </div>

        <!-- Privacy Policy Page -->
        <div id="privacy-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">গোপনীয়তা নীতি</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz আপনার ব্যক্তিগত তথ্যের গোপনীয়তা রক্ষা করতে প্রতিশ্রুতিবদ্ধ। আমরা আপনার ব্যক্তিগত তথ্য শুধুমাত্র আপনার অর্ডার প্রক্রিয়া করা এবং আমাদের পরিষেবা উন্নত করার জন্য ব্যবহার করি।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">তথ্য সংগ্রহ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আমরা আপনার নাম, ঠিকানা, ইমেল এবং ফোন নম্বর সংগ্রহ করি যখন আপনি একটি অ্যাকাউন্ট তৈরি করেন বা একটি অর্ডার দেন।
                    </p>
                </div>
            </section>
        </div>

        <!-- Terms and Conditions Page -->
        <div id="terms-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">শর্তাবলী</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz ব্যবহার করে, আপনি নিম্নলিখিত শর্তাবলীতে সম্মত হন।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">অ্যাকাউন্ট ব্যবহার:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আপনার অ্যাকাউন্টের তথ্যের গোপনীয়তা রক্ষা করার জন্য আপনি সম্পূর্ণরূপে দায়ী।
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">পণ্যের বিবরণ:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        আমরা ওয়েবসাইটে পণ্যের সঠিক বিবরণ সরবরাহ করার চেষ্টা করি। তবে, কোনো ভুল বা অমিল হলে আমরা তার জন্য দায়ী থাকব না।
                    </p>
                </div>
            </section>
        </div>


    </main> <!-- End Main Content Container -->

    <!-- Footer -->
    <footer class="bg-dark text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <!-- Column 1 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">TangailBuzz</h3>
                    <p class="text-gray-400 text-sm">সাশ্রয়ী মূল্যে মানসম্মত পণ্যের জন্য আপনার বিশ্বস্ত অনলাইন কেনাকাটার গন্তব্য।</p>
                    <div class="flex gap-4 mt-4">
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <!-- Column 2 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">গুরুত্বপূর্ণ লিঙ্ক</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="hover:text-theme-pink transition-colors">হোম</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('products')" class="hover:text-theme-pink transition-colors">পণ্য</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('categories')" class="hover:text-theme-pink transition-colors">ক্যাটাগরি</a></li>
                        <li><a href="javascript:void(0);" onclick="showOffers()" class="hover:text-theme-pink transition-colors">অফার</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('about-us-page')" class="hover:text-theme-pink transition-colors">আমাদের সম্পর্কে</a></li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">গ্রাহক সেবা</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="showPage('faq-page')" class="hover:text-theme-pink transition-colors">FAQ</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('return-policy-page')" class="hover:text-theme-pink transition-colors">রিটার্ন নীতি</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('shipping-info-page')" class="hover:text-theme-pink transition-colors">শিপিং তথ্য</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('privacy-policy-page')" class="hover:text-theme-pink transition-colors">গোপনীয়তা নীতি</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('terms-page')" class="hover:text-theme-pink transition-colors">শর্তাবলী</a></li>
                    </ul>
                </div>

                <!-- Column 4 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">যোগাযোগ করুন</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                         <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-theme-pink"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=Tangail+Sadar" target="_blank" rel="noopener noreferrer" class="hover:text-theme-pink transition-colors">tangail sadar, tangail</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-2 text-theme-pink"></i>
                            <a href="tel:+8801863205976" class="hover:text-theme-pink transition-colors">+8801863205976</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-theme-pink"></i>
                            <a href="mailto:tangailbuzz.bd@gmail.com" class="hover:text-theme-pink transition-colors">tangailbuzz.bd@gmail.com</a>
                        </li>
                    </ul>
                </div>
            </div>

             <div class="mt-8 pt-8 border-t border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-center">We Accept</h3>
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/unnamed.webp?raw=true" alt="bKash" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/nagad.jpg?raw=true" alt="Nagad" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/rocket.png?raw=true" alt="Rocket" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/surecash.png?raw=true" alt="SureCash" class="h-8 object-contain">
                </div>
            </div>

             <div class="text-center pt-8 border-t border-gray-700 mt-8">
                <p class="text-gray-400 text-xs">&copy; ২০২৪ TangailBuzz। সর্বস্বত্ব সংরক্ষিত।</p>
             </div>
        </div>
    </footer>

    <!-- Firebase SDK Scripts (Modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, FacebookAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, deleteUser, signInWithCustomToken, signInAnonymously, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider, reauthenticateWithPopup, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, updateDoc, increment, deleteField, collection, addDoc, serverTimestamp, getDocs, writeBatch, query, where, arrayUnion, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // Use the global Firebase config and auth token provided by the environment
        window.appId = typeof __app_id !== 'undefined' ? __app_id.replace(/\//g, '_') : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyBIRNr3X-_xOHQ6ITW3pXgqgcjhP2xEEEA",
            authDomain: "tangailbuzz47.firebaseapp.com",
            projectId: "tangailbuzz47",
            storageBucket: "tangailbuzz47.firebasestorage.app",
            messagingSenderId: "1017968115713",
            appId: "1:1017968115713:web:967a0e13107d8816b44000",
            measurementId: "G-7HYDCZTN2H"
        };
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let currentUserData = null; // To hold Firestore data for the user
        let userOrders = [];
        let userDocUnsubscribe = () => {};
        let currentLanguage = 'bn';
        let localCartCache = new Map();
        let localWishlistCache = new Set();
        let productsData = []; // Will be populated from Firestore
        let currentDisplayedProducts = [];
        let selectedVariants = {};
        let discountAmount = 0;
        let appliedCouponCode = null;
        let confirmResolver = null; // Used for the custom confirmation modal
        let chatUnsubscribe = () => {}; // For real-time chat updates
        let allCoupons = []; // Stores all active coupon data
        
        // --- Category Tracking State ---
        let currentCategory = null; // Tracks current main category filter
        let currentSubCategory = null; // Tracks current sub category filter
        // --- End Category Tracking State ---
        
        // --- User Blocking Logic ---
        let isCurrentUserBlocked = false;
        let unsubscribeUserStatus = () => {};

        const translations = {
            en: {
                'deliver-to': 'Deliver to', 'home': 'Home', 'products': 'Products', 'categories': 'Categories', 'offers': 'Offers', 'search-placeholder': 'Search for products...', 'featured-products': 'Featured Products', 'shop-by-category': 'Shop by Category', 'cat-electronics': 'Electronics', 'cat-fashion': 'Fashion', 'cat-home-garden': 'Home & Garden', 'cat-health-beauty': 'Health & Beauty', 'cat-sports': 'Sports & Outdoors', 'cat-books': 'Books & Stationery', 'cat-kids': 'Kids & Toys', 'cat-cars': 'Cars & Bikes', 'why-choose-us': 'Why Choose Us', 'feature-delivery-title': 'Fast Delivery', 'feature-delivery-desc': 'We deliver to your doorstep within 2-3 business days.', 'feature-payment-title': 'Secure Payment', 'feature-payment-desc': 'All transactions are encrypted for your security and privacy.', 'feature-return-title': 'Easy Returns', 'feature-return-desc': 'Return products within 30 days for a full refund if you\'re not satisfied.', 'feature-support-title': '24/7 Support', 'feature-support-desc': 'Our customer support team is available for you day and night.', 'add-to-cart': 'Add to Cart', 'added-to-cart': 'Added!', 'no-products': 'No products found matching your criteria.', 'back-to-products': 'Back to All Products', 'returnable': '30-Day Returnable', 'not-returnable': 'Not Returnable', 'secure-payments': 'Secure Payments', 'size': 'Size:', 'storage': 'Storage:', 'color': 'Color:', 'product-description': 'Product Description', 'product-specifications': 'Product Specifications', 'specifications': 'Specification', 'value': 'Value', 'no-specs': 'No specifications available for this product.', 'product-reviews': 'Product Reviews', 'no-reviews': 'There are no reviews for this product yet.', 'cart': 'Your Cart', 'cart-empty': 'Your cart is empty.', 'total': 'Total:', 'checkout': 'Checkout', 'your-wishlist': 'Your Wishlist', 'wishlist-empty': 'Your wishlist is empty. Add some products!', 'your-account': 'Your Account', 'signin-google': 'Sign in with Google', 'logout': 'Logout', 'toast-cart-added': 'Product added to cart!', 'toast-wishlist-added': 'Product added to wishlist!', 'toast-wishlist-removed': 'Product removed from wishlist!', 'toast-login-success': 'Successfully logged in!', 'toast-logout-success': 'Successfully logged out!',
                'toast-register-success': 'Account created successfully!', 'login': 'Login', 'register': 'Register Account', 'toast-select-variant': 'Please select all required options!', 'payment-method': 'Select Payment Method', 'cod': 'Cash on Delivery', 'online-payment': 'Online Payment', 'confirm-order': 'Confirm Order', 'order-placed-success': 'Your order has been placed successfully!', 'order-placed-fail': 'Failed to place order. Please try again.', 'cart-is-empty': 'Your cart is empty. Cannot checkout.', 'mobile-banking': 'Mobile Banking', 'payment-instruction-bkash': 'Please send {amount} Taka to this Bkash number: +8801863205976 from your app.', 'payment-instruction-nagad': 'Please send {amount} Taka to this Nagad number: +8801863205976 from your app.', 'payment-instruction-cod': 'Our delivery person will collect the payment upon delivery.', 'profile-updated': 'Profile updated successfully!', 'profile-update-fail': 'Failed to update profile.', 'toast-storage-permission-error': 'Storage permission denied. Check Firebase rules.', 'toast-update-profile': 'Please update your location and mobile number in your profile before ordering.', 'emergency-contact': 'Emergency Contact', 'message-sent': 'Message sent successfully!', 'out-of-stock': 'Out of Stock', 'toast-out-of-stock': 'Sorry, this product is currently out of stock.', 'subtotal': 'Subtotal', 'delivery-charge': 'Delivery Charge', 'my-orders': 'My Orders',
                'delete-account-confirm': 'Are you sure you want to delete your account? This action cannot be undone. All data will be lost.',
                'account-deleted': 'Your account has been successfully deleted.',
                'delete-account-failed': 'Failed to delete account. Please try again.',
                'confirm-delete-title': '⚠️ Permanently Delete Account',
                'chat-unauthorized': 'Please log in to start a conversation with the admin.',
                'chat-send': 'Send',
                'chat-placeholder': 'Type your message...',
                'toast-abusive-language': 'Abusive language is not allowed.',
                'account-blocked': 'Your account is blocked. You cannot place orders or send messages.',
                'account-blocked-banner': 'Your account has been blocked by an administrator. Please contact support.',
                'toast-account-blocked-action': 'Action failed: Your account is blocked.',
                'coupon-placeholder': 'Enter Coupon Code', 'apply-coupon': 'Apply', 'discount': 'Discount',
                'toast-coupon-applied': 'Coupon applied successfully!', 'toast-coupon-invalid': 'Invalid or expired coupon code.',
                'toast-coupon-used': 'You have already used this coupon.', 'toast-coupon-min-purchase': 'Minimum purchase of ৳{amount} required.',
                'warranty': '{text} Warranty', // Updated key for text string
                'no-warranty': 'No Warranty', // Updated key
                'model-id': 'Product ID: {id}', // FIX: Changed 'Model:' to 'Product ID:'
                'available-coupons': 'Available Coupons', 'min-spend': 'Min Spend', 'discount-value': 'Discount', 'tap-to-copy': 'Tap to Copy', 'copied': 'Copied!',
                'all-products': 'All Products',
                'current-category-title': '{category}',
                'sub-category-filter': 'Filter by Sub-Category:',
                'write-a-review': 'Write a Review',
                'your-rating': 'Your Rating:',
                'your-comment': 'Your Comment:',
                'submit-review': 'Submit Review',
                'review-login-prompt': 'Please log in to submit a review.',
                'review-success': 'Review submitted successfully! Thank you.',
                'review-failed': 'Failed to submit review. Please try again.',
            },
            bn: {
                'deliver-to': 'ডেলিভারি লোকেশন', 'home': 'হোম', 'products': 'পণ্য', 'categories': 'ক্যাটাগরি', 'offers': 'অফার', 'search-placeholder': 'পণ্য খুঁজুন...', 'featured-products': 'বৈশিষ্ট্যযুক্ত পণ্য', 'shop-by-category': 'ক্যাটাগরি অনুসারে কেনাকাটা করুন', 'cat-electronics': 'ইলেকট্রনিক্স', 'cat-fashion': 'ফ্যাশন', 'cat-home-garden': 'হোম অ্যান্ড গার্ডেন', 'cat-health-beauty': 'স্বাস্থ্য ও সৌন্দর্য', 'cat-sports': 'খেলাধুলা ও আউটডোর', 'cat-books': 'বই ও স্টেশনারি', 'cat-kids': 'বাচ্চা ও খেলনা', 'cat-cars': 'গাড়ি ও বাইক', 'why-choose-us': 'আমাদেরকে কেন বেছে নিবেন', 'feature-delivery-title': 'দ্রুত ডেলিভারি', 'feature-delivery-desc': 'আমরা ২-৩ কার্যদিবসের মধ্যে আপনার দোরগোড়ায় পণ্য পৌঁছে দিই।', 'feature-payment-title': 'নিরাপদ পেমেন্ট', 'feature-payment-desc': 'আপনার নিরাপত্তা ও গোপনীয়তার জন্য সকল লেনদেন এনক্রিপ্টেড।', 'feature-return-title': 'সহজ রিটার্ন', 'feature-return-desc': 'পছন্দ না হলে ৩০ দিনের মধ্যে পণ্য ফেরত দিন এবং সম্পূর্ণ মূল্য ফেরত পান।', 'feature-support-title': '২৪/৭ সাপোর্ট', 'feature-support-desc': 'আমাদের গ্রাহক সহায়তা দল দিনরাত আপনার জন্য উপলব্ধ।', 'add-to-cart': 'কার্টে যোগ করুন', 'added-to-cart': 'যোগ হয়েছে!', 'no-products': 'আপনার অনুসন্ধানের সাথে মেলে এমন কোনো পণ্য পাওয়া যায়নি।', 'back-to-products': 'সকল পণ্যে ফিরে যান', 'returnable': '৩০-দিনের মধ্যে ফেরতযোগ্য', 'not-returnable': 'ফেরতযোগ্য নয়', 'secure-payments': 'নিরাপদ পেমেন্ট', 'size': 'সাইজ:', 'storage': 'স্টোরেজ:', 'color': 'রঙ:', 'product-description': 'পণ্যের বিবরণ', 'product-specifications': 'পণ্যের স্পেসিফিকেশন', 'specifications': 'স্পেসিফিকেশন', 'value': 'মান', 'no-specs': 'এই পণ্যের জন্য কোন স্পেসিফিকেশন উপলব্ধ নেই।', 'product-reviews': 'পণ্যের রিভিউ', 'no-reviews': 'এই পণ্যের জন্য এখনো কোনো রিভিউ নেই।', 'cart': 'আপনার কার্ট', 'cart-empty': 'আপনার কার্ট খালি।', 'total': 'মোট মূল্য:', 'checkout': 'চেকআউট করুন', 'your-wishlist': 'আপনার উইশলিস্ট', 'wishlist-empty': 'আপনার উইশলিস্ট খালি। কিছু পণ্য যোগ করুন!', 'your-account': 'আপনার অ্যাকাউন্ট', 'signin-google': 'Google দিয়ে সাইন ইন করুন', 'logout': 'লগআউট', 'toast-cart-added': 'পণ্য কার্টে যোগ করা হয়েছে!', 'toast-wishlist-added': 'পণ্য উইশলিস্টে যোগ করা হয়েছে!', 'toast-wishlist-removed': 'পণ্য উইশলিস্ট থেকে সরানো হয়েছে!', 'toast-login-success': 'সফলভাবে লগইন হয়েছে!', 'toast-logout-success': 'সফলভাবে লগআউট হয়েছে!',
                'toast-register-success': 'অ্যাকাউন্ট সফলভাবে তৈরি হয়েছে!', 'login': 'লগইন', 'register': 'অ্যাকাউন্ট রেজিস্টার', 'toast-select-variant': 'অনুগ্রহ করে সব অপশন সিলেক্ট করুন!', 'payment-method': 'পেমেন্ট পদ্ধতি নির্বাচন করুন', 'cod': 'ক্যাশ অন ডেলিভারি', 'online-payment': 'অনলাইন পেমেন্ট', 'confirm-order': 'অর্ডার কনফার্ম করুন', 'order-placed-success': 'আপনার অর্ডারটি সফলভাবে সম্পন্ন হয়েছে!', 'order-placed-fail': 'অর্ডার করতে ব্যর্থ হয়েছে। আবার চেষ্টা করুন।', 'cart-is-empty': 'আপনার কার্ট খালি। চেকআউট করা সম্ভব নয়।', 'mobile-banking': 'মোবাইল ব্যাংকিং', 'payment-instruction-bkash': 'অনুগ্রহ করে আপনার অ্যাপ থেকে এই বিকাশ নম্বরে ৳{amount} পাঠান: +8801863205976।', 'payment-instruction-nagad': 'অনুগ্রহ করে আপনার অ্যাপ থেকে এই নগদ নম্বরে ৳{amount} পাঠান: +8801863205976।', 'payment-instruction-cod': 'আমাদের ডেলিভারি প্রতিনিধি পণ্য পৌঁছানোর সময় আপনার থেকে টাকা সংগ্রহ করবে।', 'profile-updated': 'প্রোফাইল সফলভাবে আপডেট হয়েছে!', 'profile-update-fail': 'প্রোফাইল আপডেট করতে ব্যর্থ হয়েছে।', 'toast-storage-permission-error': 'স্টোরেজ পারমিশন সমস্যা। অনুগ্রহ করে Firebase রুলস চেক করুন।', 'toast-update-profile': 'অর্ডার করার পূর্বে অনুগ্রহ করে আপনার প্রোফাইলে ঠিকানা ও মোবাইল নম্বর আপডেট করুন।', 'emergency-contact': 'জরুরী যোগাযোগ', 'message-sent': 'আপনার বার্তা সফলভাবে পাঠানো হয়েছে!', 'out-of-stock': 'স্টক শেষ', 'toast-out-of-stock': 'দুঃখিত, এই পণ্যটি বর্তমানে স্টক আউট।', 'subtotal': 'মোট', 'delivery-charge': 'ডেলিভারি চার্জ', 'my-orders': 'আমার অর্ডার',
                'delete-account-confirm': 'আপনি কি নিশ্চিত যে আপনি আপনার অ্যাকাউন্টটি মুছে ফেলতে চান? এই কাজটি ফিরিয়ে আনা যাবে না। আপনার সমস্ত ডেটা হারানো হবে।',
                'account-deleted': 'আপনার অ্যাকাউন্ট সফলভাবে মুছে ফেলা হয়েছে।',
                'delete-account-failed': 'অ্যাকাউন্ট মুছে ফেলার চেষ্টা ব্যর্থ হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।',
                'confirm-delete-title': '⚠️ স্থায়ীভাবে অ্যাকাউন্ট মুছুন',
                'chat-unauthorized': 'অ্যাডমিনের সাথে কথা বলার জন্য দয়া করে লগইন করুন।',
                'chat-send': 'পাঠান',
                'chat-placeholder': 'আপনার বার্তা লিখুন...',
                'toast-abusive-language': 'আপত্তিকর ভাষা ব্যবহার করা যাবে না।',
                'account-blocked': 'আপনার অ্যাকাউন্ট ব্লক করা হয়েছে। আপনি অর্ডার বা মেসেজ করতে পারবেন না।',
                'toast-account-blocked-action': 'Action failed: Your account is blocked.',
                'coupon-placeholder': 'কুপন কোড লিখুন', 'apply-coupon': 'প্রয়োগ', 'discount': 'ডিসকাউন্ট',
                'toast-coupon-applied': 'কুপন সফলভাবে প্রয়োগ করা হয়েছে!', 'toast-coupon-invalid': 'অবৈধ বা মেয়াদোত্তীর্ণ কুপন কোড।',
                'toast-coupon-used': 'আপনি ইতিমধ্যে এই কুপন ব্যবহার করেছেন।', 'toast-coupon-min-purchase': 'এই কুপনটি ব্যবহার করতে সর্বনিম্ন ৳{amount} কেনাকাটা করতে হবে।',
                'warranty': '{text} ওয়ারেন্টি', // Updated key for text string
                'no-warranty': 'কোনো ওয়ারেন্টি নেই', // Updated key
                'model-id': 'প্রোডাক্ট আইডি: {id}', // FIX: Changed 'মডেল আইডি:' to 'প্রোডাক্ট আইডি:'
                'available-coupons': 'উপলব্ধ কুপন', 'min-spend': 'সর্বনিম্ন খরচ', 'discount-value': 'ডিসকাউন্ট', 'tap-to-copy': 'কপি করুন', 'copied': 'কপি হয়েছে!',
                'all-products': 'সকল পণ্য',
                'current-category-title': '{category} ক্যাটাগরি',
                'sub-category-filter': 'সাব-ক্যাটাগরি অনুযায়ী ফিল্টার করুন:',
                'write-a-review': 'একটি রিভিউ দিন',
                'your-rating': 'আপনার রেটিং:',
                'your-comment': 'আপনার মন্তব্য:',
                'submit-review': 'রিভিউ জমা দিন',
                'review-login-prompt': 'অনুগ্রহ করে রিভিউ দেওয়ার জন্য লগইন করুন।',
                'review-success': 'রিভিউ সফলভাবে জমা দেওয়া হয়েছে! ধন্যবাদ।',
                'review-failed': 'রিভিউ জমা দিতে ব্যর্থ হয়েছে। অনুগ্রহ করে আবার চেষ্টা করুন।',
            }
        };

        const DOMElements = {
            toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'), productList: document.getElementById('product-list'), cartCount: document.getElementById('cart-count'), cartItems: document.getElementById('cart-items'), cartSubtotal: document.getElementById('cart-subtotal'), deliveryCharge: document.getElementById('delivery-charge'), cartTotal: document.getElementById('cart-total'), wishlistItems: document.getElementById('wishlist-items'), authOptions: document.getElementById('auth-options'), 
            userProfileView: document.getElementById('user-profile-view'), userPhoto: document.getElementById('user-photo'), userName: document.getElementById('user-name'), userEmail: document.getElementById('user-email'), userMobile: document.getElementById('user-mobile'), userLocation: document.getElementById('user-location'),
            loginBtn: document.getElementById('login-google-btn'), loginFacebookBtn: document.getElementById('login-facebook-btn'), logoutBtn: document.getElementById('logout-btn'), 
            editProfileBtn: document.getElementById('edit-profile-btn'), editProfileForm: document.getElementById('edit-profile-form'), saveProfileBtn: document.getElementById('save-profile-btn'), cancelEditBtn: document.getElementById('cancel-edit-btn'),
            myOrdersBtnProfile: document.getElementById('my-orders-btn-profile'), 
            ordersList: document.getElementById('orders-list'),
            editPhotoPreview: document.getElementById('edit-photo-preview'), editPhotoInput: document.getElementById('edit-photo-input'), editNameInput: document.getElementById('edit-name-input'), editMobileInput: document.getElementById('edit-mobile-input'), editLocationInput: document.getElementById('edit-location-input'),
            searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), searchInputMobile: document.getElementById('search-input-mobile'), searchButtonMobile: document.getElementById('search-button-mobile'), slidesContainer: document.getElementById('slides-container'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), indicatorContainer: document.getElementById('slider-indicators'), drawerOverlay: document.getElementById('drawer-overlay'),
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), showRegisterLink: document.getElementById('show-register-form'), showLoginLink: document.getElementById('show-login-form'), authError: document.getElementById('auth-error'), profileDrawerTitle: document.getElementById('profile-drawer-title'),
            resetForm: document.getElementById('reset-form'), resetEmail: document.getElementById('reset-email'), showResetLink: document.getElementById('show-reset-form'), showLoginFromResetLink: document.getElementById('show-login-from-reset'),
            paymentModal: document.getElementById('payment-modal'), checkoutBtn: document.getElementById('checkout-btn'), confirmOrderBtn: document.getElementById('confirm-order-btn'),
            orderSuccessModal: document.getElementById('order-success-modal'), paymentInstruction: document.getElementById('payment-instruction'), closeSuccessModalBtn: document.getElementById('close-success-modal'),
            discountRow: document.getElementById('discount-row'),
            cartDiscount: document.getElementById('cart-discount'),
            deleteAccountBtn: document.getElementById('delete-account-btn'),
            
            // Confirmation Modal Elements
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),

            // Chat Elements
            emergencyContactBtn: document.getElementById('emergency-contact-btn'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            chatError: document.getElementById('chat-error'),
            
            // Blocked User Banner
            blockedBanner: document.getElementById('blocked-account-banner'),

            // Coupon Elements
            couponForm: document.getElementById('coupon-form'),
            couponInput: document.getElementById('coupon-input'),
            applyCouponBtn: document.getElementById('apply-coupon-btn'),
            
            // Dark Mode Elements
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            darkModeIcon: document.getElementById('dark-mode-icon'),

            // New Category Elements
            categoryHeader: document.getElementById('category-header'),
            breadcrumb: document.getElementById('breadcrumb'),
            categoryPath: document.getElementById('category-path'),
            currentCategoryTitle: document.getElementById('current-category-title'),
            subcategoryButtons: document.getElementById('subcategory-buttons'),
        };
        
        // --- Dark Mode Logic ---

        function applyDarkMode(mode) {
            const html = document.documentElement;
            const isDark = mode === 'dark';
            
            if (isDark) {
                html.classList.add('dark');
                DOMElements.darkModeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.remove('dark');
                DOMElements.darkModeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleDarkMode() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyDarkMode(currentTheme === 'light' ? 'dark' : 'light');
        }
        window.toggleDarkMode = toggleDarkMode;

        
        // --- UI & RENDERING ---

        function showToast(messageKey, isSuccess = true) {
            const message = translations[currentLanguage][messageKey] || messageKey;
            DOMElements.toastMessage.textContent = message;
            DOMElements.toast.className = `fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform transition-transform duration-500 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            DOMElements.toast.classList.remove('translate-x-[150%]', 'opacity-0');
            DOMElements.toast.classList.add('translate-x-0', 'opacity-100');

            setTimeout(() => {
                DOMElements.toast.classList.remove('translate-x-0', 'opacity-100');
                DOMElements.toast.classList.add('translate-x-[150%]', 'opacity-0');
            }, 3000);
        }
        window.showToast = showToast; // Exported for external use
        
        // --- Blocked UI Functions ---
        function showBlockedUI(messageKey) {
            const banner = DOMElements.blockedBanner;
            if (banner) {
                banner.textContent = translations[currentLanguage][messageKey] || messageKey;
                banner.classList.remove('hidden');
                // Adjust header margin to not overlap
                document.querySelector('header').style.marginTop = `${banner.offsetHeight}px`;
            }
            // Disable critical action buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = true;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = true;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = true;
        }
        
        function hideBlockedUI() {
            const banner = DOMElements.blockedBanner;
            if (banner && !banner.classList.contains('hidden')) {
                banner.classList.add('hidden');
                 document.querySelector('header').style.marginTop = `0px`;
            }
             // Re-enable buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = false;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = false;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = false;
        }


        function updateTextContent() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                if (translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                if (translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });
            DOMElements.searchInput.placeholder = translations[currentLanguage]['search-placeholder'];
            DOMElements.searchInputMobile.placeholder = translations[currentLanguage]['search-placeholder'];
            DOMElements.chatInput.placeholder = translations[currentLanguage]['chat-placeholder'];
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('lang-bn-btn').classList.toggle('active-lang', lang === 'bn');
            document.getElementById('lang-en-btn').classList.toggle('active-lang', lang === 'en');
            updateTextContent();
            renderProducts(currentDisplayedProducts); // Re-render products with new language
            const detailsPage = document.getElementById('product-details-page');
            if(!detailsPage.classList.contains('hidden')) {
                const addToCartBtn = document.getElementById('add-to-cart-details');
                const productId = addToCartBtn ? addToCartBtn.dataset.productId : null;
                if(productId) showProductDetails(productId);
            }
        }
        window.setLanguage = setLanguage;

        function showPage(pageId) {
            // Stop chat listener when leaving the chat page
            if (pageId !== 'emergency-chat-page') {
                chatUnsubscribe(); 
            } else if (currentUser && !currentUser.isAnonymous) {
                // Start chat listener when entering chat page
                handleEmergencyChat();
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                if (pageId === 'wishlist-page') {
                    renderWishlistItems();
                } else if (pageId === 'my-orders-page'){
                    fetchUserOrders();
                } else if (pageId === 'home-page' && currentDisplayedProducts.length === 0) {
                     renderProducts(productsData);
                }
            }
            window.scrollTo(0, 0);
        }
        window.showPage = showPage; // Exported to global scope

        function scrollToElement(elementId) {
            document.getElementById(elementId)?.scrollIntoView({ behavior: 'smooth' });
        }
        window.scrollToElement = scrollToElement;

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += `<i class="fas fa-star text-yellow-400"></i>`;
            if (halfStar) starsHtml += `<i class="fas fa-star-half-alt text-yellow-400"></i>`;
            for (let i = 0; i < 5 - fullStars - (halfStar ? 1 : 0); i++) starsHtml += `<i class="far fa-star text-gray-300"></i>`;
            return starsHtml;
        }

        function renderProducts(productsToRender) {
            currentDisplayedProducts = productsToRender;
            DOMElements.productList.innerHTML = '';
            if (productsToRender.length === 0) {
                 DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">${translations[currentLanguage]['no-products']}</p>`;
                 return;
            }
            const fragment = document.createDocumentFragment();
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                const isWished = localWishlistCache.has(product.id);
                const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
                const imageUrl = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';
                const price = product.price || 0;
                
                let priceHtml = `<span class="text-xl font-bold text-price-black">৳${product.price.toFixed(2)}</span>`;
                let offerSticker = '';
                
                // CHECK if the product is on offer
                if (product.isOffer && product.originalPrice > product.price) {
                    const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-xl font-bold text-price-black">৳${product.price.toFixed(2)}</span>
                            <span class="text-sm text-gray-400 line-through">৳${product.originalPrice.toFixed(2)}</span>
                             <span class="text-xs font-bold text-red-500">(-${discountPercent}%)</span>
                        </div>`;
                    offerSticker = `<div class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-md">OFFER</div>`;
                }

                const isOutOfStock = Number(product.stock) <= 0;
                const cartButtonText = isOutOfStock ? translations[currentLanguage]['out-of-stock'] : translations[currentLanguage]['add-to-cart'];
                const cartButtonClasses = isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-theme-blue hover:bg-theme-purple';
                const cartButtonDisabled = isOutOfStock ? 'disabled' : '';

                productCard.className = 'product-card relative bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden transform transition-transform hover:-translate-y-2 hover:shadow-2xl flex flex-col';
                productCard.dataset.productId = product.id;
                productCard.innerHTML = `
                    <div class="relative">
                        ${offerSticker}
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image';">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                         <h3 class="product-title font-semibold text-lg text-dark mb-2 cursor-pointer h-12 overflow-hidden">${product.name}</h3>
                         <div class="flex items-center text-sm mb-2">
                            ${renderStars(product.rating || 0)}
                            <span class="text-xs text-gray-500 ml-2">(${product.ratingCount || 0})</span>
                        </div>
                        <div class="mt-auto">
                            <div class="mt-2 mb-4">${priceHtml}</div>
                            <div class="flex items-center justify-between">
                                <button class="add-to-cart text-white py-2 px-4 rounded-full transition-colors shadow-lg ${cartButtonClasses}" ${cartButtonDisabled} data-product-id="${product.id}">${cartButtonText}</button>
                                <button class="wishlist text-2xl transition-colors" data-product-id="${product.id}"><i class="${heartClass} fa-heart"></i></button>
                            </div>
                        </div>
                    </div>`;
                fragment.appendChild(productCard);
            });
            DOMElements.productList.appendChild(fragment);
            // If viewing all products, show the featured header
            if (currentCategory === null && currentSubCategory === null) {
                DOMElements.currentCategoryTitle.dataset.lang = 'featured-products';
                DOMElements.currentCategoryTitle.textContent = translations[currentLanguage]['featured-products'];
            }
            // Removed redundant updateCategoryHeader call, which caused the error when dataset was accessed from null.
        }

        // --- CATEGORY & SUB-CATEGORY LOGIC ---

        function updateCategoryHeader(category, subCategory = null) {
            const categoryName = category ? translations[currentLanguage][`cat-${category}`] || category.charAt(0).toUpperCase() + category.slice(1) : '';
            const subCategoryName = subCategory ? subCategory.charAt(0).toUpperCase() + subCategory.slice(1) : '';
            
            currentCategory = category;
            currentSubCategory = subCategory;
            
            let title = translations[currentLanguage]['featured-products'];
            
            if (category) {
                title = subCategoryName ? subCategoryName : categoryName;
            }

            DOMElements.currentCategoryTitle.textContent = title;
            DOMElements.currentCategoryTitle.dataset.lang = category ? (subCategory ? 'N/A' : 'current-category-title') : 'featured-products';

            // Update Breadcrumb
            let breadcrumbHtml = `<a href="javascript:void(0);" onclick="renderAllProducts()" class="text-theme-blue hover:underline">${translations[currentLanguage]['all-products']}</a>`;
            
            if (category) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <a href="javascript:void(0);" onclick="filterProducts('${category}')" class="text-theme-blue hover:underline">${categoryName}</a>`;
            }
            if (subCategory) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <span class="font-semibold text-dark dark:text-gray-100">${subCategoryName}</span>`;
            }
            DOMElements.categoryPath.innerHTML = breadcrumbHtml;
            
            // Render subcategory buttons if a main category is selected
            if (category && !subCategory) {
                renderSubCategories(category);
            } else {
                DOMElements.subcategoryButtons.innerHTML = '';
            }
        }
        
        function renderSubCategories(category) {
            // Get all unique subcategories for the current category
            const subCategories = productsData
                .filter(p => p.category === category && p.subCategory)
                .map(p => p.subCategory)
                .filter((value, index, self) => self.indexOf(value) === index) // Unique values
                .sort();

            let buttonsHtml = '';

            if (subCategories.length > 0) {
                 buttonsHtml = subCategories.map(subCat => {
                    const subCatName = subCat.charAt(0).toUpperCase() + subCat.slice(1);
                    const isActive = currentSubCategory === subCat ? 'variant-btn-active bg-theme-blue/30' : '';
                    return `<button class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold rounded-full hover:bg-gray-300 transition-colors ${isActive}" onclick="filterSubCategory('${category}', '${subCat}')">
                        ${subCatName}
                    </button>`;
                 }).join('');
                 
                 // Add an 'All' button for the current category
                 const allActive = currentSubCategory === null ? 'variant-btn-active bg-theme-blue/30' : '';
                 const categoryName = translations[currentLanguage][`cat-${category}`] || category.charAt(0).toUpperCase() + category.slice(1);
                 buttonsHtml = `<button class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold rounded-full hover:bg-gray-300 transition-colors ${allActive}" onclick="filterProducts('${category}')" data-lang="all-in-category">${categoryName} (সকল)</button>` + buttonsHtml;
            } 

            DOMElements.subcategoryButtons.innerHTML = buttonsHtml;
            // Ensure language is updated for the new 'All' button
            updateTextContent();
        }

        // Action when clicking a main category (e.g., Electronics)
        window.filterProducts = (category) => {
            const filtered = productsData.filter(p => p.category === category);
            
            updateCategoryHeader(category, null); // Set only main category
            renderProducts(filtered); 
            
            showPage('home-page');
            scrollToElement('products');
        };

        // Action when clicking a sub-category button (e.g., Mobile)
        window.filterSubCategory = (category, subCategory) => {
            const filtered = productsData.filter(p => p.category === category && p.subCategory === subCategory);
            
            updateCategoryHeader(category, subCategory); // Set main and sub category
            renderProducts(filtered); 
            
            showPage('home-page');
            scrollToElement('products');
        };
        
        // --- END CATEGORY & SUB-CATEGORY LOGIC ---
        
        // --- REVIEW LOGIC ---
        
        // Global state to track selected rating
        let currentRating = 0;
        
        function setupReviewForm(productId) {
            const form = document.getElementById('review-form');
            const loginPrompt = document.getElementById('review-login-prompt');
            const reviewControls = document.getElementById('review-controls');
            const ratingStars = document.getElementById('rating-stars');
            const ratingInput = document.getElementById('review-rating');

            if (!currentUser || currentUser.isAnonymous) {
                loginPrompt.classList.remove('hidden');
                reviewControls.classList.add('hidden');
                return;
            }

            loginPrompt.classList.add('hidden');
            reviewControls.classList.remove('hidden');
            
            document.getElementById('review-product-id').value = productId;
            currentRating = 0;
            ratingInput.value = 0;
            updateStarDisplay(ratingStars, 0);

            // Clear previous comment if any
            document.getElementById('review-comment').value = '';
        }

        function handleStarClick(e) {
            const star = e.target.closest('.rating-star');
            if (!star) return;

            const rating = parseInt(star.dataset.rating);
            currentRating = rating;
            document.getElementById('review-rating').value = rating;
            updateStarDisplay(star.parentElement, rating);
        }

        function updateStarDisplay(container, rating) {
            Array.from(container.children).forEach(star => {
                if (star.classList.contains('rating-star')) {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= rating) {
                        star.classList.remove('far', 'text-gray-400');
                        star.classList.add('fas', 'selected');
                    } else {
                        star.classList.remove('fas', 'selected');
                        star.classList.add('far', 'text-gray-400');
                    }
                }
            });
        }
        
        async function submitReview(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;

            const productId = document.getElementById('review-product-id').value;
            const rating = parseInt(document.getElementById('review-rating').value);
            const comment = document.getElementById('review-comment').value.trim();

            if (rating === 0 || comment.length < 5) {
                showToast('Please provide a rating and a valid comment (min 5 chars).', false);
                return;
            }

            const productDocRef = doc(db, 'products', productId);
            const productSnap = await getDoc(productDocRef);
            
            if (!productSnap.exists()) {
                showToast('Product not found in database.', false);
                return;
            }

            const productData = productSnap.data();
            const existingReviews = productData.reviews || [];
            const currentRatingCount = productData.ratingCount || 0;
            const currentTotalRating = (productData.rating * currentRatingCount) || 0; // rating is already average

            const newReview = {
                author: currentUser.displayName || currentUser.email || 'Anonymous',
                rating: rating,
                comment: comment,
                // FIX: Changed serverTimestamp() to new Date() as it's inside arrayUnion
                timestamp: new Date() 
            };

            const newRatingCount = currentRatingCount + 1;
            const newTotalRating = currentTotalRating + rating;
            const newAverageRating = newTotalRating / newRatingCount;

            try {
                await updateDoc(productDocRef, {
                    reviews: arrayUnion(newReview),
                    rating: parseFloat(newAverageRating.toFixed(1)), // Keep 1 decimal place
                    ratingCount: newRatingCount
                });
                
                // Manually update the local product data (in productsData array) for immediate UI refresh
                const productIndex = productsData.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    productsData[productIndex].reviews = [...existingReviews, newReview];
                    productsData[productIndex].rating = parseFloat(newAverageRating.toFixed(1));
                    productsData[productIndex].ratingCount = newRatingCount;
                }
                
                // Re-render product details with new data
                showProductDetails(productId);
                showToast('review-success', true);
                
            } catch (error) {
                console.error("Error submitting review:", error);
                showToast('review-failed', false);
            }
        }
        
        // --- END REVIEW LOGIC ---


        function handleProductCardClick(e) {
            const target = e.target;
            const productCard = target.closest('.product-card');
            if (!productCard) return;

            const productId = productCard.dataset.productId;
            
            if (target.closest('.add-to-cart')) {
                addToCartInDb(productId, true).catch(err => console.log(err));
            } else if (target.closest('.wishlist')) {
                toggleWishlistInDb(productId);
            } else if (target.closest('img') || target.closest('.product-title')) {
                showProductDetails(productId);
            }
        }
        
        function showProductDetails(productId) {
            selectedVariants = {};
            const product = productsData.find(p => p.id === productId);
            if (!product) return;

            const detailsPage = document.getElementById('product-details-page');
            if(!detailsPage) return;
            
            // Populate product details
            const isWished = localWishlistCache.has(product.id);
            const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
            
            const productTitleEl = detailsPage.querySelector('#product-title-details');
            if (productTitleEl) productTitleEl.textContent = product.name || "Product Name";
            
            const productBrandEl = detailsPage.querySelector('#product-brand-details');
            if (productBrandEl) productBrandEl.textContent = product.brand || "Brand";

            // --- Model ID Logic ---
            const productModelEl = detailsPage.querySelector('#product-model-details');
            const modelID = product.modelID || null; 

            if (productModelEl) {
                let displayModelID = '';
                if (modelID && modelID.trim() !== '') {
                    displayModelID = translations[currentLanguage]['model-id'].replace('{id}', modelID);
                    productModelEl.classList.remove('hidden');
                } else {
                    productModelEl.classList.add('hidden');
                }
                // FIX: Use translation key string and replace {id} with modelID
                productModelEl.querySelector('#model-text').textContent = translations[currentLanguage]['model-id'].replace('{id}', modelID);
            }
            // --- END Model ID Logic ---

            // --- Warranty Logic (remains as string fetch) ---
            const productWarrantyEl = detailsPage.querySelector('#product-warranty-details');
            const warrantyTextFromDB = product.warrantyText || null; 

            if (productWarrantyEl) {
                let displayWarranty = translations[currentLanguage]['no-warranty'];
                let isWarrantyPresent = false;
                
                if (warrantyTextFromDB && warrantyTextFromDB.trim() !== '') {
                    displayWarranty = translations[currentLanguage]['warranty'].replace('{text}', warrantyTextFromDB);
                    isWarrantyPresent = true;
                }
                
                productWarrantyEl.querySelector('#warranty-text').textContent = displayWarranty;
                
                if (isWarrantyPresent) {
                    productWarrantyEl.classList.add('text-green-600');
                    productWarrantyEl.classList.remove('text-red-500');
                } else {
                    productWarrantyEl.classList.add('text-red-500');
                    productWarrantyEl.classList.remove('text-green-600');
                }
            }
            // --- END Warranty Logic ---


            const productImageEl = detailsPage.querySelector('#product-image');
            if (productImageEl) productImageEl.src = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';

            const productRatingEl = detailsPage.querySelector('#product-rating-details');
            if (productRatingEl) productRatingEl.textContent = product.rating || 0;

            const productStarsEl = detailsPage.querySelector('#product-stars-details');
            if (productStarsEl) productStarsEl.innerHTML = renderStars(product.rating || 0);

            const productRatingCountEl = detailsPage.querySelector('#product-rating-count-details');
            if (productRatingCountEl) productRatingCountEl.textContent = `(${product.ratingCount || 0})`;
            
            const addToCartBtn = detailsPage.querySelector('#add-to-cart-details');
            if (addToCartBtn) addToCartBtn.dataset.productId = productId;
            
            const wishlistBtn = detailsPage.querySelector('#wishlist-details');
            if (wishlistBtn) wishlistBtn.dataset.productId = productId;

            const wishlistIcon = detailsPage.querySelector('#wishlist-details i');
            if (wishlistIcon) wishlistIcon.className = `${heartClass} fa-heart`;

            const productDescriptionEl = detailsPage.querySelector('#product-full-description');
            if (productDescriptionEl) productDescriptionEl.textContent = product.fullDescription || product.description || 'No detailed description available.';


            const isOutOfStock = Number(product.stock) <= 0;
            const buyNowBtn = detailsPage.querySelector('.buy-now');

            if (isOutOfStock) {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['out-of-stock'];
                    addToCartBtn.disabled = true;
                    addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.remove('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = true;
                    buyNowBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.remove('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            } else {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['add-to-cart'];
                    addToCartBtn.disabled = false;
                    addToCartBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.add('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = false;
                    buyNowBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.add('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            }

            renderThumbnails(product.thumbnails || []);
            renderSpecifications(product.specifications || {});
            renderReviews(product.reviews || []);
            renderPriceDetails(product);
            renderInfoDetails(product);
            renderAllVariants(product);
            setupReviewForm(productId); // Setup review form

            showPage('product-details-page');
            updateTextContent();
        }

        function renderThumbnails(thumbnails) {
            const container = document.getElementById('thumbnail-container');
            container.innerHTML = thumbnails.map(src => 
                `<img src="${src}" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:ring-2 hover:ring-theme-pink transition-all" onclick="document.getElementById('product-image').src='${src}'">`
            ).join('');
        }
        
        function renderSpecifications(specifications) {
            const container = document.getElementById('product-specifications');
            if (!container) return;
            if (!specifications || Object.keys(specifications).length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-specs">${translations[currentLanguage]['no-specs']}</p>`;
                return;
            }

            container.innerHTML = `
                <table class="w-full text-left text-sm">
                    <tbody>
                        ${Object.entries(specifications).map(([key, value]) => `
                            <tr class="border-b">
                                <td class="py-2 pr-4 font-semibold text-gray-700 dark:text-gray-200">${key.charAt(0).toUpperCase() + key.slice(1)}</td>
                                <td class="py-2 text-gray-600 dark:text-gray-300">${value}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderReviews(reviews) {
            const container = document.getElementById('product-reviews');
            if (!container) return;
            if (!reviews || reviews.length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-reviews">${translations[currentLanguage]['no-reviews']}</p>`;
                return;
            }

            container.innerHTML = reviews.map(review => {
                // Check if timestamp is a Firestore Timestamp object (has toDate()) or a native Date object
                let dateString = 'N/A';
                if (review.timestamp?.toDate) {
                     dateString = review.timestamp.toDate().toLocaleDateString('en-GB');
                } else if (review.timestamp instanceof Date) {
                    dateString = review.timestamp.toLocaleDateString('en-GB');
                }

                return `
                    <div class="border-b pb-4">
                        <div class="flex items-center mb-2">
                            <div class="flex items-center mr-4">
                                ${renderStars(review.rating)}
                            </div>
                            <p class="font-bold text-gray-800">${review.author || 'Anonymous'}</p>
                            <span class="text-xs text-gray-500 ml-auto">${dateString}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300">${review.comment || ''}</p>
                    </div>
                `;
            }).join('');
        }

        function renderPriceDetails(product) {
            const priceElement = document.getElementById('product-price-details');
            const price = product.price || 0;
            
            // CHECK if the product is on offer (same logic as renderProducts)
            if (product.isOffer && product.originalPrice > product.price) {
                const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                priceElement.innerHTML = `
                    <div class="flex items-baseline gap-2 flex-wrap">
                        <span class="text-2xl font-bold text-price-black">৳${price.toFixed(2)}</span>
                        <span class="text-lg text-gray-400 line-through">৳${product.originalPrice.toFixed(2)}</span>
                        <span class="text-sm font-bold text-red-500">(-${discountPercent}%)</span>
                    </div>`;
            } else {
                // If not on offer, only show the main price (which is stored in product.price in this case)
                priceElement.innerHTML = `<span class="text-2xl font-bold text-price-black">৳${price.toFixed(2)}</span>`;
            }
        }

        function renderInfoDetails(product) {
            const infoDetails = document.getElementById('product-info-details');
            const returnableText = product.isReturnable ? translations[currentLanguage]['returnable'] : translations[currentLanguage]['not-returnable'];
            const returnableIcon = product.isReturnable ? 'fas fa-undo text-green-500' : 'fas fa-ban text-red-500';
            infoDetails.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="${returnableIcon}"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">${returnableText}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-lock text-green-500"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300" data-lang="secure-payments">${translations[currentLanguage]['secure-payments']}</span>
                </div>`;
        }

        function renderAllVariants(product) {
            renderVariantOptions('size', product.sizes);
            renderVariantOptions('storage', product.storage);
            renderVariantOptions('color', product.colors);
        }

        function renderVariantOptions(variantType, options) {
            const containerDiv = document.getElementById(`${variantType}-options`);
            if (!options || options.length === 0) {
                containerDiv.classList.add('hidden');
                return;
            }
            containerDiv.classList.remove('hidden');
            const container = document.getElementById(`${variantType}-variants-container`);
            container.innerHTML = options.map(option => {
                if(variantType === 'color') {
                    return `<button class="w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: ${option.toLowerCase()}" data-variant-type="color" data-value="${option}"></button>`;
                }
                return `<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors text-dark" data-variant-type="${variantType}" data-value="${option}">${option}</button>`;
            }).join('');
        }

        function handleVariantSelection(e) {
            const button = e.target.closest('button[data-variant-type]');
            if (!button) return;

            const { variantType, value } = button.dataset;
            const container = button.parentElement;
            
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.remove(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            });
            button.classList.add(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            
            selectedVariants[variantType] = value;
        }

        // --- Firestore Database Logic ---
        
        async function fetchProductsFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                productsData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // Robustly check for offer flag and prices (camelCase or lowercase)
                    const hasOffer = data.isOnOffer === true || data.isonoffer === true;
                    const mainPrice = Number(data.mainPrice || data.mainprice) || 0;
                    const offerPrice = Number(data.offerPrice || data.offerprice) || 0;

                    // An offer is valid only if the flag is set, prices are positive, and the offer is a discount.
                    const isValidOffer = hasOffer && mainPrice > 0 && offerPrice > 0 && offerPrice < mainPrice;
                    
                    // NEW LOGIC: Use model1 if present, otherwise try model, otherwise use the Firestore document ID
                    const modelID = data.model1 || data.model || doc.id; 

                    return {
                        id: doc.id,
                        modelID: modelID, // NEW: Fetch Model ID
                        name: data.name || "No Name Provided",
                        brand: data.brand || "No Brand",
                        price: isValidOffer ? offerPrice : mainPrice,
                        originalPrice: isValidOffer ? mainPrice : null,
                        isOffer: isValidOffer,
                        rating: data.rating || 0,
                        ratingCount: data.ratingCount || 0,
                        image: data.imageUrl || '',
                        imageUrl: data.imageUrl || '',
                        description: data.details || '',
                        fullDescription: data.details || '',
                        category: data.category || 'general',
                        subCategory: data.subCategory || null, // NEW: Fetch subCategory
                        isReturnable: data.isRefundable === true,
                        specifications: data.specification || {},
                        reviews: data.reviews || [],
                        thumbnails: data.thumbnails || [],
                        sizes: data.variants && typeof data.variants.size === 'string' ? data.variants.size.split(',').map(s => s.trim()) : (Array.isArray(data.sizes) ? data.sizes : []),
                        storage: data.storage || [],
                        colors: data.variants && typeof data.variants.color === 'string' ? data.variants.color.split(',').map(c => c.trim()) : (Array.isArray(data.colors) ? data.colors : []),
                        stock: data.stock !== undefined ? Number(data.stock) : 1,
                        warrantyText: data.warranty || null // Use the fetched string field
                    };
                });
                if (productsData.length === 0) {
                    DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found in the database.</p>`;
                } else {
                     renderProducts(productsData);
                }
            } catch (error) {
                console.error("Error fetching products from Firestore: ", error);
                DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products. Check console for details.</p>`;
            }
        }
        
        async function fetchBannersFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "banners"));
                const banners = querySnapshot.docs.map(doc => doc.data());
                banners.sort((a, b) => (a.order || 0) - (b.order || 0)); // Sort banners by order

                DOMElements.slidesContainer.innerHTML = '';
                banners.forEach(banner => {
                    const slide = document.createElement('div');
                    slide.className = 'w-full flex-shrink-0 aspect-[3/1]';
                    const link = banner.url || banner.link || banner.href || '';
                    if (link) {
                        const isExternal = /^https?:\/\//i.test(link);
                        slide.innerHTML = `
                            <a href="${link}" ${isExternal ? 'target="_blank" rel="noopener"' : ''} class="block w-full h-full">
                                <img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover" />
                            </a>`;
                    } else {
                        slide.innerHTML = `<img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover">`;
                    }
                    DOMElements.slidesContainer.appendChild(slide);
                });

                initializeSlider(); 
            } catch (error) {
                console.error("Error fetching banners:", error);
                initializeSlider(); // Initialize slider even if fetch fails to handle static/empty state
            }
        }

        function setupFirestoreListeners(user) {
            userDocUnsubscribe();

            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, 'users', user.uid);
                
                userDocUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        setDoc(userDocRef, { email: user.email, name: user.displayName, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', isBlocked: false }, { merge: true });
                        currentUserData = { cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false };
                        return;
                    }
                    const data = docSnap.data() || {};
                    currentUserData = data;
                    
                    // --- Check Block Status ---
                    isCurrentUserBlocked = data.isBlocked || false;
                    if (isCurrentUserBlocked) {
                        showBlockedUI('account-blocked-banner');
                    } else {
                        hideBlockedUI();
                    }
                    // --- End Check Block Status ---

                    updateProfileModalUI(user, data);

                    localWishlistCache.clear();
                    const wishlistData = data.wishlist || {};
                    Object.keys(wishlistData).forEach(productId => {
                        if (wishlistData[productId]) {
                           localWishlistCache.add(productId);
                        }
                    });
                    updateWishlistUI();

                    localCartCache.clear();
                    const cartData = data.cart || {};
                    Object.keys(cartData).forEach(cartItemId => {
                        localCartCache.set(cartItemId, cartData[cartItemId]);
                    });
                    updateCartUI();
                }, (error) => {
                    console.error("Error in snapshot listener:", error);
                });
            } else {
                currentUserData = null;
                isCurrentUserBlocked = false; // Reset block status on logout
                hideBlockedUI();
                localCartCache.clear();
                localWishlistCache.clear();
                updateCartUI();
                updateWishlistUI();
                updateProfileModalUI(null);
            }
        }
        
        function getRequiredVariants(product) {
            const required = [];
            if (product.sizes && product.sizes.length > 0) required.push('size');
            if (product.storage && product.storage.length > 0) required.push('storage');
            if (product.colors && product.colors.length > 0) required.push('color');
            return required;
        }

        async function addToCartInDb(productId, fromCard = false) {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return Promise.reject("User is blocked");
            }
            if (!currentUser || currentUser.isAnonymous) { 
                showToast("Please log in to manage your cart.", false); 
                openDrawer('profile-drawer'); 
                return Promise.reject("User not logged in"); 
            }
            const product = productsData.find(p => p.id === productId);
            if (!product) return Promise.reject("Product not found");
            
            if (Number(product.stock) <= 0) {
                showToast('toast-out-of-stock', false);
                return Promise.reject("Product is out of stock");
            }
            
            const requiredVariants = getRequiredVariants(product);
            
            if (fromCard && requiredVariants.length > 0) {
                 showProductDetails(productId);
                 showToast('toast-select-variant', false);
                 return Promise.reject("Variants not selected");
            }
            
            for(const variant of requiredVariants) {
                if (!selectedVariants[variant]) {
                    showToast('toast-select-variant', false);
                    return Promise.reject("Variants not selected");
                }
            }

            const sortedVariantKeys = Object.keys(selectedVariants).sort();
            const variantString = sortedVariantKeys.map(key => `_${key.charAt(0).toUpperCase()}:${selectedVariants[key]}`).join('');
            const cartItemId = productId + variantString;
            
            const userDocRef = doc(db, 'users', currentUser.uid);
            
            try {
                const currentItem = localCartCache.get(cartItemId);
                if (currentItem) {
                    await updateDoc(userDocRef, { [`cart.${cartItemId}.quantity`]: increment(1) });
                } else {
                    const newItemData = {
                        productId: product.id || '',
                        name: product.name || 'Unknown Product',
                        price: product.price || 0,
                        image: product.imageUrl || product.image || 'https://placehold.co/80x80/ccc/000?text=Image',
                        quantity: 1,
                        ...selectedVariants
                    };
                    await setDoc(userDocRef, { cart: { [cartItemId]: newItemData } }, { merge: true });
                }
                showToast('toast-cart-added');
                return Promise.resolve();
            } catch (error) {
                 console.error("Error adding to cart: ", error);
                 showToast("Error: Could not add to cart", false);
                 return Promise.reject(error);
            }
        }
        
        async function removeFromCart(cartItemId) {
            if (!currentUser || currentUser.isAnonymous) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            try {
                await updateDoc(userDocRef, {
                    [`cart.${cartItemId}`]: deleteField()
                });
            } catch (error) {
                console.error("Error removing from cart: ", error);
            }
        }
        window.removeFromCart = removeFromCart;

        async function updateQuantity(cartItemId, change) {
            if (!currentUser || currentUser.isAnonymous) return;
            const currentQuantity = localCartCache.get(cartItemId)?.quantity || 0;
            if (currentQuantity + change <= 0) {
                await removeFromCart(cartItemId);
            } else {
                const userDocRef = doc(db, 'users', currentUser.uid);
                try {
                    await updateDoc(userDocRef, {
                        [`cart.${cartItemId}.quantity`]: increment(change)
                    });
                } catch (error) {
                     console.error("Error updating quantity: ", error);
                }
            }
        }
        window.updateQuantity = updateQuantity;
        
        async function toggleWishlistInDb(productId) {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) { showToast("Please log in to manage your wishlist.", false); openDrawer('profile-drawer'); return; }
            const userDocRef = doc(db, 'users', currentUser.uid);
            const isWished = localWishlistCache.has(productId);

            try {
                if (isWished) {
                    await updateDoc(userDocRef, { [`wishlist.${productId}`]: deleteField() });
                } else {
                    await setDoc(userDocRef, { wishlist: { [productId]: true } }, { merge: true });
                }
                showToast(isWished ? 'toast-wishlist-removed' : 'toast-wishlist-added', true);
            } catch (error) {
                console.error("Error updating wishlist: ", error);
                showToast("Error: Could not update wishlist", false);
            }
        }
        
        async function updateCartUI() {
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + ((item.price || 0) * (item.quantity || 0)), 0);
            
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const total = subtotal + deliveryCharge - discountAmount;
            
            DOMElements.cartSubtotal.textContent = `৳${subtotal.toFixed(2)}`;
            
            if (discountAmount > 0) {
                DOMElements.discountRow.classList.remove('hidden');
                DOMElements.cartDiscount.textContent = `- ৳${discountAmount.toFixed(2)}`;
            } else {
                 DOMElements.discountRow.classList.add('hidden');
            }
            
            DOMElements.deliveryCharge.textContent = `৳${deliveryCharge.toFixed(2)}`;
            DOMElements.cartTotal.textContent = `৳${total.toFixed(2)}`;

            const totalItems = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
            DOMElements.cartCount.textContent = totalItems;
            renderCartItems();
        }

       async function getDeliveryCharge(subtotal) {
            if (!currentUser || !currentUserData) return 0;
            
            const ordersRef = collection(db, "orders");
            // NOTE: We rely on client-side sorting instead of Firestore orderBy for simplicity/index avoidance
            const q = query(ordersRef, where("userId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            const isFirstOrder = querySnapshot.empty;
            
            const location = (currentUserData.location || "").toLowerCase();
            const isInTangail = location.includes("tangail");

            if (isInTangail) {
                return isFirstOrder && subtotal > 500 ? 0 : 100;
            } else {
                return isFirstOrder && subtotal > 1000 ? 0 : 200;
            }
        }

        function renderCartItems() {
            if (!currentUser || currentUser.isAnonymous) {
                DOMElements.cartItems.innerHTML = `<p class="text-center text-gray-500">Please log in to see your cart.</p>`;
                return;
            }
            
            let cartHtml = '';
            
            if(localCartCache.size === 0){
                DOMElements.cartItems.innerHTML = `<p data-lang="cart-empty" class="text-center text-gray-500">${translations[currentLanguage]['cart-empty']}</p>`;
            } else {
                for (const [cartItemId, item] of localCartCache.entries()) {
                    // Build variants text
                    let variantsHtml = '<div class="text-[11px] text-gray-500 mt-0.5">';
                    if (item.size) variantsHtml += `Size: ${item.size} `;
                    if (item.color) variantsHtml += `Color: ${item.color} `;
                    if (item.storage) variantsHtml += `Storage: ${item.storage} `;
                    variantsHtml += '</div>';

                    // Try to enrich with product data for discount/original price
                    const productRef = productsData?.find(p => p.id === item.productId);
                    const hasDiscount = !!(productRef && productRef.isOffer && productRef.originalPrice && productRef.originalPrice > (productRef.price || item.price || 0));
                    const discountPercent = hasDiscount ? Math.round(((productRef.originalPrice - (productRef.price || item.price || 0)) / productRef.originalPrice) * 100) : 0;

                    let priceHtml = '';
                    if (hasDiscount) {
                        priceHtml = `
                            <div class="flex items-baseline gap-2 flex-wrap mt-1">
                                <span class="text-base sm:text-md font-bold text-price-black">৳${(item.price || 0).toFixed(2)}</span>
                                <span class="text-xs text-gray-400 line-through">৳${Number(productRef.originalPrice).toFixed(2)}</span>
                                <span class="text-[10px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded">-${discountPercent}%</span>
                            </div>`;
                    } else {
                        priceHtml = `<div class="mt-1"><span class="text-base sm:text-md font-bold text-price-black">৳${(item.price || 0).toFixed(2)}</span></div>`;
                    }

                    // Compose each cart row (mobile-first, Temu-like compact)
                    cartHtml += `
                        <div class="rounded-2xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 p-3 sm:p-4 shadow-sm">
                            <div class="flex gap-3">
                                <img src="${item.image || 'https://placehold.co/80x80/ccc/000?text=Image'}" alt="${item.name}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-[15px] sm:text-base font-semibold text-theme-purple leading-tight break-words">${item.name}</h4>
                                    ${variantsHtml}
                                    ${priceHtml}
                                </div>
                                <button onclick="removeFromCart('${cartItemId}')" class="text-red-500 hover:text-red-600 ml-1 self-start"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQuantity('${cartItemId}', -1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                                    <span class="w-8 text-center text-dark">${item.quantity}</span>
                                    <button onclick="updateQuantity('${cartItemId}', 1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                                </div>
                                <div class="text-[12px] text-gray-500">৳${((item.price || 0) * (item.quantity || 0)).toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }
                DOMElements.cartItems.innerHTML = cartHtml;
            }
        }
        
        function updateWishlistUI() {
            renderProducts(currentDisplayedProducts);
            if (!document.getElementById('wishlist-page').classList.contains('hidden')) {
                renderWishlistItems();
            }
        }

        function renderWishlistItems() {
            DOMElements.wishlistItems.innerHTML = '';
            if (localWishlistCache.size === 0) {
                DOMElements.wishlistItems.innerHTML = `<p class="col-span-full text-center text-gray-500" data-lang="wishlist-empty">${translations[currentLanguage]['wishlist-empty']}</p>`;
                return;
            }
            const wishedProducts = productsData.filter(p => localWishlistCache.has(p.id));
            
            const tempContainer = document.createElement('div');
            // Temporarily re-assign productList to render into our temp container
            const originalProductList = DOMElements.productList;
            DOMElements.productList = tempContainer;
            renderProducts(wishedProducts);
            DOMElements.wishlistItems.innerHTML = tempContainer.innerHTML;
            DOMElements.productList = originalProductList; // Reset to original
        }

        // --- AUTHENTICATION ---
        
        async function initialAuthBootstrap() {
            if (window.initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, window.initialAuthToken);
                } catch (error) {
                    console.warn("Custom token sign-in failed. Anonymous sign-in attempt skipped due to potential auth restrictions. Error:", error);
                }
            } else {
                console.log("No initial auth token provided. Skipping anonymous sign-in attempt to avoid errors.");
            }
        }
        
        onAuthStateChanged(auth, user => {
             // Stop listening for previous user's block status
            unsubscribeUserStatus();
            
            if (user && !user.isAnonymous) {
                currentUser = user;
                const userRef = doc(db, 'users', user.uid);
                // Backfill createdAt if missing
                getDoc(userRef).then(snap => {
                    if (snap.exists() && !snap.data()?.createdAt) {
                        updateDoc(userRef, { createdAt: serverTimestamp() }).catch(() => {});
                    }
                }).catch(() => {});
                
                // Listen for real-time changes to the user's block status
                unsubscribeUserStatus = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        isCurrentUserBlocked = userData.isBlocked || false;

                        if (isCurrentUserBlocked) {
                            showBlockedUI('account-blocked-banner');
                        } else {
                            hideBlockedUI();
                        }
                    }
                });

                setupFirestoreListeners(user);
            } else if (user && user.isAnonymous) {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            } else {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            }
        });

        function updateProfileModalUI(user, data = null) {
            const userData = data || currentUserData;
            if (user && !user.isAnonymous) {
                DOMElements.authOptions.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userPhoto.src = user.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.userName.textContent = user.displayName || 'User';
                DOMElements.userEmail.textContent = user.email;
                DOMElements.userMobile.textContent = userData?.mobile ? `📱 ${userData.mobile}` : '';
                DOMElements.userLocation.textContent = userData?.location ? `📍 ${userData.location}` : '';

            } else {
                DOMElements.authOptions.classList.remove('hidden');
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
            }
        }
        
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
             if (!docSnap.exists()) {
                 await setDoc(userDocRef, { email: user.email, name: user.displayName, photoURL: user.photoURL, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', isBlocked: false, createdAt: serverTimestamp() });
             } else if (!docSnap.data()?.createdAt) {
                 await updateDoc(userDocRef, { createdAt: serverTimestamp() });
             }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error("Google sign-in error", error);
                if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = "This domain is not authorized. Please add it in your Firebase console.";
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleFacebookLogin() {
            const provider = new FacebookAuthProvider();
            // Optional: request additional scopes
            // provider.addScope('public_profile');
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    await setDoc(userDocRef, { email: user.email || '', name: user.displayName || 'Facebook User', photoURL: user.photoURL || '', cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', isBlocked: false, createdAt: serverTimestamp() });
                } else if (!docSnap.data()?.createdAt) {
                    await updateDoc(userDocRef, { createdAt: serverTimestamp() });
                }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error('Facebook sign-in error', error);
                if (error.code === 'auth/account-exists-with-different-credential') {
                    DOMElements.authError.textContent = 'An account already exists with the same email. Please sign in with the provider you used previously.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = 'This domain is not authorized for Facebook login. Add it in your Firebase console Auth settings.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // Re-authenticate anonymously to maintain connection
                await signInAnonymously(auth);
                closeDrawer();
                showToast('toast-logout-success');
            } catch (error) {
                console.error("Logout error", error);
            }
        }

        function toggleAuthForms(formToShow) {
            DOMElements.authError.textContent = '';
            // Hide all
            DOMElements.loginForm.classList.add('hidden');
            DOMElements.registerForm.classList.add('hidden');
            if (DOMElements.resetForm) DOMElements.resetForm.classList.add('hidden');

            if (formToShow === 'register') {
                DOMElements.registerForm.classList.remove('hidden');
                DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['register'] || 'Register';
            } else if (formToShow === 'reset') {
                if (DOMElements.resetForm) {
                    // Prefill email from login form if present
                    const loginEmail = document.getElementById('login-email')?.value || '';
                    if (loginEmail) DOMElements.resetEmail.value = loginEmail;
                    DOMElements.resetForm.classList.remove('hidden');
                    DOMElements.profileDrawerTitle.textContent = 'Reset Password';
                } else {
                    // fallback to login
                    DOMElements.loginForm.classList.remove('hidden');
                    DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['login'] || 'Login';
                }
            } else {
                DOMElements.loginForm.classList.remove('hidden');
                DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['login'] || 'Login';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = DOMElements.registerForm.querySelector('#register-name').value;
            const mobile = DOMElements.registerForm.querySelector('#register-mobile').value;
            const location = DOMElements.registerForm.querySelector('#register-location').value;
            const email = DOMElements.registerForm.querySelector('#register-email').value;
            const password = DOMElements.registerForm.querySelector('#register-password').value;
            DOMElements.authError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                const userDocRef = doc(db, 'users', userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, name, mobile, location, cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false, createdAt: serverTimestamp() });

                closeDrawer();
                showToast('toast-register-success', true); 
            } catch (error) {
                DOMElements.authError.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            // FIX: Corrected DOMEElements to DOMElements
            const email = DOMElements.loginForm.querySelector('#login-email').value;
            const password = DOMElements.loginForm.querySelector('#login-password').value;
            DOMElements.authError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                 // Better messaging for common cases
                 if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                     try {
                         const methods = await fetchSignInMethodsForEmail(auth, email);
                         if (!methods || methods.length === 0) {
                             // No account exists for this email
                             DOMElements.authError.textContent = currentLanguage === 'bn'
                                 ? "আপনার কোন অ্যাকাউন্ট নেই। অনুগ্রহ করে একটি অ্যাকাউন্ট তৈরি করুন।"
                                 : "You don't have an account. Please create one.";
                         } else {
                             // Account exists but password is wrong or signed up with provider
                             if (methods.includes('password')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "পাসওয়ার্ড সঠিক নয়। অনুগ্রহ করে আবার চেষ্টা করুন।"
                                     : "Incorrect password. Please try again.";
                             } else if (methods.includes('google.com') || methods.includes('facebook.com')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "আপনি সোশ্যাল লগইন দিয়ে সাইন আপ করেছেন। অনুগ্রহ করে সেই প্রোভাইডার দিয়ে লগইন করুন।"
                                     : "This email is registered via social login. Please sign in with that provider.";
                             } else {
                                 DOMElements.authError.textContent = error.message;
                             }
                         }
                     } catch (e2) {
                         DOMElements.authError.textContent = currentLanguage === 'bn'
                             ? "লগইন করতে ব্যর্থ হয়েছে। অনুগ্রহ করে তথ্যগুলো যাচাই করুন।"
                             : "Login failed. Please verify your details.";
                     }
                 } else if (error.code === 'auth/user-not-found') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "আপনার কোন অ্যাকাউন্ট নেই। অনুগ্রহ করে একটি অ্যাকাউন্ট তৈরি করুন।"
                         : "You don't have an account. Please create one.";
                 } else if (error.code === 'auth/invalid-email') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "ইমেইল ঠিকানা সঠিক নয়।"
                         : "Invalid email address.";
                 } else {
                     DOMElements.authError.textContent = error.message;
                 }
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            try {
                const email = DOMElements.resetEmail.value.trim();
                DOMElements.authError.textContent = '';
                if (!email) {
                    DOMElements.authError.textContent = 'Please enter your email.';
                    return;
                }
                await sendPasswordResetEmail(auth, email);
                showToast('Password reset email sent! Check your inbox.');
                // Navigate back to login
                toggleAuthForms('login');
            } catch (error) {
                console.error('Password reset error', error);
                if (error.code === 'auth/invalid-email') {
                    DOMElements.authError.textContent = 'Invalid email address.';
                } else if (error.code === 'auth/user-not-found') {
                    DOMElements.authError.textContent = 'No user found with this email.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function reauthenticateForSensitiveAction() {
            // Try to reauthenticate depending on the provider
            const user = auth.currentUser;
            if (!user) throw new Error('No authenticated user');
            const providerId = user.providerData?.[0]?.providerId;

            try {
                if (providerId === 'google.com') {
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'facebook.com') {
                    const provider = new FacebookAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'password') {
                    // Prompt the user for their password
                    const email = user.email;
                    const password = prompt('Please re-enter your password to confirm deletion:');
                    if (!password) throw new Error('Reauthentication cancelled.');
                    const credential = EmailAuthProvider.credential(email, password);
                    await reauthenticateWithCredential(user, credential);
                } else {
                    // Default: try Google popup if available, else fail
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                }
                return true;
            } catch (e) {
                console.error('Reauthentication failed:', e);
                return false;
            }
        }

        async function handleDeleteAccountConfirmed() {
            if (!currentUser) return;
            const user = currentUser;

            const attemptDelete = async () => {
                // 1. Delete Firestore user document
                const userDocRef = doc(db, 'users', user.uid);
                await deleteDoc(userDocRef).catch(() => {}); // tolerate if already missing

                // 2. Delete profile photo from Storage (if exists)
                if (user.photoURL) {
                    const storageRef = ref(storage, `profileImages/${user.uid}`);
                    await deleteObject(storageRef).catch(e => console.log("No profile image found to delete or storage permission denied.", e));
                }

                // 3. Delete the user from Firebase Auth
                await deleteUser(user);
            };

            try {
                await attemptDelete();
                // Show success immediately if delete succeeded, regardless of anon sign-in
                showToast('account-deleted', true);
                closeDrawer();
                // Best-effort: sign in anonymously (do not impact success)
                signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
            } catch (error) {
                console.error("Error deleting account:", error);
                if (error.code === 'auth/requires-recent-login') {
                    const ok = await reauthenticateForSensitiveAction();
                    if (ok) {
                        try {
                            await attemptDelete();
                            showToast('account-deleted', true);
                            closeDrawer();
                            signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
                            return;
                        } catch (e2) {
                            console.error('Delete after reauth failed:', e2);
                        }
                    }
                }
                showToast('delete-account-failed', false);
            }
        }
        
        function handleDeleteAccount() {
            if (!currentUser || currentUser.isAnonymous) return;
            
            showConfirmModal(
                translations[currentLanguage]['delete-account-confirm'],
                translations[currentLanguage]['confirm-delete-title'],
                handleDeleteAccountConfirmed
            );
        }
        
        async function handleProfileUpdate(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;
            
            const saveBtn = DOMElements.saveProfileBtn;
            saveBtn.querySelector('.btn-text').classList.add('hidden');
            saveBtn.querySelector('.loader-small').classList.remove('hidden');
            saveBtn.disabled = true;

            const newName = DOMElements.editNameInput.value;
            const newMobile = DOMElements.editMobileInput.value;
            const newLocation = DOMElements.editLocationInput.value;
            const photoFile = DOMElements.editPhotoInput.files[0];
            const wantRemovePhoto = DOMElements.editPhotoInput.dataset.remove === 'true';

            const authUpdateData = {};
            const firestoreUpdateData = {};

            if (newName !== currentUser.displayName) {
                authUpdateData.displayName = newName;
                firestoreUpdateData.name = newName;
            }
            if (newMobile !== (currentUserData.mobile || '')) {
                firestoreUpdateData.mobile = newMobile;
            }
            if (newLocation !== (currentUserData.location || '')) {
                firestoreUpdateData.location = newLocation;
            }

            try {
                if (photoFile) {
                    const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                    await uploadBytes(storageRef, photoFile);
                    const downloadURL = await getDownloadURL(storageRef);
                    authUpdateData.photoURL = downloadURL;
                    firestoreUpdateData.photoURL = downloadURL;
                } else if (wantRemovePhoto) {
                    // Remove profile image from Storage and clear URLs
                    try {
                        const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                        await deleteObject(storageRef);
                    } catch (e) {
                        console.log('No profile image to delete or permission denied.', e);
                    }
                    authUpdateData.photoURL = null;
                    firestoreUpdateData.photoURL = deleteField();
                }

                if (Object.keys(authUpdateData).length > 0) {
                    await updateProfile(auth.currentUser, authUpdateData);
                }

                if (Object.keys(firestoreUpdateData).length > 0) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userDocRef, firestoreUpdateData);
                }
                
                // Reset file input and remove flag, update profile avatar preview
                DOMElements.editPhotoInput.value = '';
                delete DOMElements.editPhotoInput.dataset.remove;
                if (authUpdateData.photoURL === null) {
                    // Removed photo
                    DOMElements.userPhoto.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                } else if (authUpdateData.photoURL) {
                    DOMElements.userPhoto.src = authUpdateData.photoURL;
                }
                showToast('profile-updated');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');

            } catch(error) {
                console.error("Full error object:", error);
                let errorMessageKey = 'profile-update-fail';
                 if (error.code && error.code.includes('storage/unauthorized')) {
                    errorMessageKey = 'toast-storage-permission-error'; 
                }
                showToast(errorMessageKey, false);
            } finally {
                saveBtn.querySelector('.btn-text').classList.remove('hidden');
                saveBtn.querySelector('.loader-small').classList.add('hidden');
                saveBtn.disabled = false;
            }
        }

        // --- DRAWER & MODAL LOGIC ---
        function openDrawer(drawerId) {
            closeDrawer(); // Stop chat listener when closing drawers
            
            const drawer = document.getElementById(drawerId);
            if (drawer) {
                if (drawerId === 'profile-drawer') {
                    if (!currentUser || currentUser.isAnonymous) {
                       toggleAuthForms('login');
                    } else {
                       DOMElements.profileDrawerTitle.dataset.lang = "your-account";
                       DOMElements.userProfileView.classList.remove('hidden');
                       DOMElements.editProfileForm.classList.add('hidden');
                       updateTextContent();
                    }
                }
                DOMElements.drawerOverlay.classList.remove('hidden');
                drawer.classList.add('active');
                if(drawerId === 'cart-drawer') {
                    updateCartUI();
                    fetchAndRenderCoupons(); // Load coupons when cart is opened
                }
            }
        }
        window.openDrawer = openDrawer;

        function closeDrawer() {
            DOMElements.drawerOverlay.classList.add('hidden');
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('active'));
            chatUnsubscribe(); // Ensure chat listener stops when drawer closes
        }
        window.closeDrawer = closeDrawer;

        // Custom Confirmation Modal
        function showConfirmModal(message, title, onConfirm) {
            DOMElements.confirmTitle.textContent = title;
            DOMElements.confirmMessage.textContent = message;
            DOMElements.confirmationModal.classList.remove('hidden');
            DOMElements.confirmationModal.classList.add('flex');

            confirmResolver = onConfirm;
        }

        function closeConfirmModal() {
            DOMElements.confirmationModal.classList.add('hidden');
            DOMElements.confirmationModal.classList.remove('flex');
            confirmResolver = null;
        }
        
        function handleConfirmClick() {
            if (confirmResolver) {
                confirmResolver();
            }
            closeConfirmModal();
        }

        function handleCancelClick() {
            closeConfirmModal();
        }

        function openPaymentModal() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to check out.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }
             if (!currentUserData?.location || !currentUserData?.mobile) {
                showToast('toast-update-profile', false);
                openDrawer('profile-drawer');
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.remove('hidden');
                return;
            }
            closeDrawer();
            DOMElements.paymentModal.classList.remove('hidden');
            DOMElements.paymentModal.classList.add('flex');
        }

        function closePaymentModal() {
            DOMElements.paymentModal.classList.add('hidden');
            DOMElements.paymentModal.classList.remove('flex');
        }
        window.closePaymentModal = closePaymentModal;
        
        function generateRandomOrderId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function handlePlaceOrder() {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to place an order.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }

            if (!currentUserData?.location || !currentUserData?.mobile) {
                showToast('toast-update-profile', false);
                closePaymentModal();
                openDrawer('profile-drawer');
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.remove('hidden');
                return;
            }
            
            const mainPayment = document.querySelector('input[name="main-payment"]:checked').value;
            let finalPaymentMethod = mainPayment;
            
            if (mainPayment === 'Mobile Banking') {
                const subPayment = document.querySelector('input[name="sub-payment"]:checked');
                if (!subPayment) {
                    showToast('Please select a mobile banking option.', false);
                    return;
                }
                finalPaymentMethod = subPayment.value;
            }
            
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const totalAmount = subtotal + deliveryCharge - discountAmount;
            
            const orderData = {
                orderId: generateRandomOrderId(),
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userEmail: currentUser.email,
                userLocation: currentUserData.location,
                userMobile: currentUserData.mobile,
                items: Array.from(localCartCache.values()),
                subtotal: subtotal,
                deliveryCharge: deliveryCharge,
                discount: discountAmount,
                couponCode: appliedCouponCode || null,
                totalAmount: totalAmount,
                paymentMethod: finalPaymentMethod,
                status: "Pending",
                createdAt: serverTimestamp()
            };

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                await addDoc(collection(db, "orders"), orderData);

                const updates = { cart: {} };
                if (appliedCouponCode) {
                    updates.usedCoupons = arrayUnion(appliedCouponCode);
                }
                await updateDoc(userDocRef, updates);
                
                discountAmount = 0;
                appliedCouponCode = null;

                closePaymentModal();
                closeDrawer();
                
                let instructionKey = '';
                 if (finalPaymentMethod === 'Bkash') {
                    instructionKey = 'payment-instruction-bkash';
                } else if (finalPaymentMethod === 'Nagad') {
                    instructionKey = 'payment-instruction-nagad';
                } else {
                     instructionKey = 'payment-instruction-cod';
                }
                const instructionText = translations[currentLanguage][instructionKey].replace('{amount}', totalAmount.toFixed(2));
                DOMElements.paymentInstruction.textContent = instructionText;
                DOMElements.orderSuccessModal.classList.remove('hidden');
                DOMElements.orderSuccessModal.classList.add('flex');

            } catch (error) {
                console.error("Error placing order: ", error);
                showToast('order-placed-fail', false);
            }
        }
        
        // --- COUPON LOGIC ---
        async function fetchAndRenderCoupons() {
            const couponListEl = document.getElementById('coupons-list');
            if (!couponListEl) return;

            couponListEl.innerHTML = `<div class="col-span-full text-center py-4"><div class="loader mx-auto"></div></div>`;
            
            if (!currentUser || currentUser.isAnonymous) {
                couponListEl.innerHTML = `<p class="text-center text-gray-500">Please log in to see available coupons.</p>`;
                return;
            }

            try {
                const couponsRef = collection(db, "coupons");
                // Fetch all coupons without filtering by 'isActive' since it might not be present, relying on client-side expiry check
                const querySnapshot = await getDocs(couponsRef); 
                allCoupons = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    code: doc.data().code || doc.id // Ensure code field exists
                }));

                const now = new Date();
                const usableCoupons = allCoupons.filter(coupon => {
                    const expiryDate = coupon.expiryDate ? new Date(coupon.expiryDate) : null;
                    const hasExpired = expiryDate && expiryDate < now;
                    // Check if coupon is active/not expired (assuming if isActive isn't present, it's considered active if not expired)
                    const isActive = coupon.isActive === undefined ? true : coupon.isActive; 
                    
                    return isActive && !hasExpired;
                });

                if (usableCoupons.length === 0) {
                    couponListEl.innerHTML = `<p class="text-center text-gray-500">No active coupons available right now.</p>`;
                    return;
                }

                let couponsHtml = usableCoupons.map(coupon => {
                    // Use 'value' for fixed discount amount, as seen in the firebase screenshot
                    const discountValue = coupon.type === 'fixed' ? (coupon.value || 0) : (coupon.discountValue || 0);
                    
                    const discountText = coupon.type === 'percentage' 
                        ? `${coupon.value}% OFF` 
                        : `৳${discountValue.toFixed(0)} Fixed Discount`;
                    
                    return `
                        <div class="p-2 sm:p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-dashed border-theme-pink/50">
                            <div class="flex items-center justify-between gap-2">
                                <div class="min-w-0">
                                    <p class="text-xs font-semibold text-gray-600 dark:text-gray-300 truncate" title="${discountText}" data-lang="discount-value">${translations[currentLanguage]['discount-value']}: ${discountText}</p>
                                    <p class="text-[11px] text-gray-500">${translations[currentLanguage]['min-spend']}: ৳${(coupon.minSpend || 0).toFixed(0)}</p>
                                    <p class="text-[11px] text-red-500">Expires: ${coupon.expiryDate || 'N/A'}</p>
                                </div>
                                <button onclick="copyToClipboard(this, '${coupon.code}')" class="text-[11px] sm:text-xs font-bold bg-theme-blue text-white px-2 py-1 rounded-full hover:bg-theme-purple transition-colors flex-shrink-0" data-lang="tap-to-copy">
                                    ${coupon.code}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                couponListEl.innerHTML = couponsHtml;

            } catch (error) {
                console.error("Error fetching coupons:", error);
                couponListEl.innerHTML = `<p class="text-center text-red-500">Error loading coupons.</p>`;
            }
        }

        function copyToClipboard(button, text) {
            if (!text || navigator.clipboard === undefined) {
                 // Fallback for older browsers
                 showToast("Could not copy. Browser unsupported.", false);
                 return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = translations[currentLanguage]['copied'];
                showToast('Coupon copied!', true);
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast("Copy failed.", false);
            });
        }
        window.copyToClipboard = copyToClipboard;
        
        async function handleApplyCoupon(e) {
            e.preventDefault();
            const couponCode = DOMElements.couponInput.value.trim().toUpperCase();
            if (!couponCode) return;

            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to use coupons.', false);
                return;
            }

            // Query coupon by 'code' field to support arbitrary document IDs
            const couponQuery = query(collection(db, 'coupons'), where('code', '==', couponCode));
            const couponQuerySnap = await getDocs(couponQuery);

            if (couponQuerySnap.empty) {
                showToast('toast-coupon-invalid', false);
                return;
            }

            const couponData = couponQuerySnap.docs[0].data();
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (subtotal < (couponData.minSpend || 0)) {
                const message = translations[currentLanguage]['toast-coupon-min-purchase'].replace('{amount}', couponData.minSpend);
                showToast(message, false);
                return;
            }

            if (currentUserData.usedCoupons && currentUserData.usedCoupons.includes(couponCode)) {
                showToast('toast-coupon-used', false);
                return;
            }
            
            // Check expiry date (Client-side validation as Firebase doesn't support complex queries in rules)
            const expiryDate = couponData.expiryDate ? new Date(couponData.expiryDate) : null;
            const now = new Date();
            if (expiryDate && expiryDate < now) {
                showToast('toast-coupon-invalid', false); // Invalid/expired coupon message
                return;
            }
            
            // Check isActive (if present)
            if (couponData.isActive === false) {
                 showToast('toast-coupon-invalid', false); // Inactive coupon message
                 return;
            }

            if (couponData.type === 'percentage') {
                const percent = Number(couponData.value) || 0;
                discountAmount = Math.max(0, (subtotal * percent) / 100);
            } else if (couponData.type === 'fixed') {
                const fixed = Number(couponData.value ?? couponData.discountValue) || 0;
                discountAmount = Math.min(fixed, subtotal);
            } else {
                discountAmount = 0;
            }
            
            appliedCouponCode = couponCode;
            showToast('toast-coupon-applied');
            await updateCartUI();
        }

        // --- GLOBAL FUNCTIONS for onclick ---
        window.renderAllProducts = () => {
            updateCategoryHeader(null, null); // Reset header to All Products
            renderProducts(productsData);
            showPage('home-page');
        };
        window.filterProducts = (category) => {
            const filtered = productsData.filter(p => p.category === category);
            updateCategoryHeader(category, null);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        };
        window.filterSubCategory = (category, subCategory) => {
            const filtered = productsData.filter(p => p.category === category && p.subCategory === subCategory);
            updateCategoryHeader(category, subCategory);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        };
        window.showOffers = () => {
            const offers = productsData.filter(p => p.isOffer);
            updateCategoryHeader('Offers', null); // Use 'Offers' as a temporary category name
            renderProducts(offers);
            showPage('home-page');
            scrollToElement('products');
        };
        
        function performSearch() {
            const query = DOMElements.searchInput.value.toLowerCase() || DOMElements.searchInputMobile.value.toLowerCase();
            const filtered = productsData.filter(p => p.name.toLowerCase().includes(query) || p.brand.toLowerCase().includes(query));
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        }

        function handleImageZoom(e) {
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPercent = (x / container.offsetWidth) * 100;
            const yPercent = (y / container.offsetHeight) * 100;
            container.style.setProperty('--x-pos', `${xPercent}%`);
            container.style.setProperty('--y-pos', `${yPercent}%`);
        }
        
        async function fetchUserOrders() {
             if (!currentUser || currentUser.isAnonymous) {
                DOMElements.ordersList.innerHTML = `<p class="text-center text-gray-500">Please log in to see your orders.</p>`;
                return;
            }
            DOMElements.ordersList.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, where("userId", "==", currentUser.uid));
                
                onSnapshot(q, (querySnapshot) => {
                    userOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    userOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); // Sort by newest first
                    renderOrders();
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                DOMElements.ordersList.innerHTML = `<p class="text-center text-red-500">Could not load orders.</p>`;
            }
        }
        
        function renderOrders() {
            const container = DOMElements.ordersList;
            if(!container) return;

            if (userOrders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">You haven't placed any orders yet.</p>`;
                return;
            }

            const statuses = ['Pending', 'Confirmed', 'Shipped', 'Out for delivery', 'Delivered'];
            // Helper to normalize status strings (handles case, hyphens, underscores, extra spaces)
            const normalizeStatus = (str) => (str || '')
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[-_]/g, ' ')
                .replace(/\s+/g, ' ');
            const normalizedStatuses = statuses.map(s => normalizeStatus(s));
            
            const renderTrackerSteps = (orderStatus) => {
                const status = normalizeStatus(orderStatus || 'N/A');
                if (status === 'cancelled') return '';
                
                const currentStatusIndex = normalizedStatuses.indexOf(status);
                
                let html = '';
                
                // Use a standard flex container to lay out nodes and connectors
                html += `<div class="tracker-step-container w-full pt-4 pb-4">`;

                // Render nodes and connectors
                statuses.forEach((step, index) => {
                    const isStepComplete = currentStatusIndex >= index;
                    const connectorActive = currentStatusIndex > index; // Connector between this step and next is active only if we've progressed past this step
                    const isLastStep = index === statuses.length - 1;
                    
                    const circleClass = isStepComplete ? 'bg-green-500 border-green-500 text-white' : 'bg-white dark:bg-gray-700 border-gray-400 text-gray-500';
                    const labelColor = isStepComplete ? 'text-gray-700 dark:text-gray-100' : 'text-gray-500';
                    
                    // Render Node (Circle + Label)
                    html += `
                        <div class="tracker-node">
                            <div class="tracker-circle rounded-full border-2 flex items-center justify-center ${circleClass} shadow-md relative z-10">
                                <i class="fas fa-check text-xs"></i>
                            </div>
                            <p class="text-xs mt-2 ${labelColor}">${step}</p>
                        </div>`;
                    
                    // Render Connector Line (Appears between nodes)
                    if (!isLastStep) {
                        const connectorClass = connectorActive ? 'active' : '';

                        // Connector line is rendered in the gap between two fixed-width tracker-node elements
                        html += `
                            <div class="tracker-connector ${connectorClass}">
                                <div class="tracker-connector-line"></div>
                            </div>`;
                    }
                });
                
                html += `</div>`; // Close tracker-step-container
                return html;
            }

            container.innerHTML = userOrders.map(order => {
                const rawStatus = order.status || 'N/A';
                const status = normalizeStatus(rawStatus);
                const orderDate = order.createdAt?.toDate().toLocaleDateString('en-GB');
                const orderTime = order.createdAt?.toDate().toLocaleTimeString('en-US');
                const isCancelled = status === 'cancelled';

                // Use theme colors for status badges
                let statusBgClass = 'bg-gray-500';
                if (status === 'delivered') { statusBgClass = 'bg-green-500'; }
                else if (status === 'cancelled') { statusBgClass = 'bg-red-500'; }
                else if (status === 'shipped' || status === 'out for delivery') { statusBgClass = 'bg-theme-blue'; }
                else if (status === 'confirmed' || status === 'pending') { statusBgClass = 'bg-yellow-500'; }
                
                const statusTextColor = 'text-white';
                
                const itemRows = (order.items || []).map(item => {
                    // Variants text
                    let variants = '';
                    if (item.size || item.color || item.storage) {
                        const parts = [];
                        if (item.size) parts.push(`Size: ${item.size}`);
                        if (item.color) parts.push(`Color: ${item.color}`);
                        if (item.storage) parts.push(`Storage: ${item.storage}`);
                        variants = ` [${parts.join(', ')}]`;
                    }

                    const title = `${item.name || 'Product'}${variants} (x${item.quantity || 1})`;
                    const imgSrc = item.image || 'https://placehold.co/80x80/ccc/000?text=Image';
                    const hasProduct = !!item.productId;
                    const priceText = `৳${((item.price || 0) * (item.quantity || 0)).toFixed(2)}`;

                    const titleHtml = hasProduct
                        ? `<button class="text-left text-base text-gray-800 dark:text-gray-200 hover:underline" onclick="showProductDetails('${item.productId}')">${title}</button>`
                        : `<span class="text-base text-gray-800 dark:text-gray-200">${title}</span>`;

                    const imageHtml = hasProduct
                        ? `<img src="${imgSrc}" alt="${item.name || 'Product'}" class="w-14 h-14 rounded-lg object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';" onclick="showProductDetails('${item.productId}')">`
                        : `<img src="${imgSrc}" alt="${item.name || 'Product'}" class="w-14 h-14 rounded-lg object-cover" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">`;

                    return `
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 py-3">
                            <div class="flex items-center gap-3 min-w-0">
                                ${imageHtml}
                                <div class="flex flex-col min-w-0">
                                    <div class="break-words">${titleHtml}</div>
                                </div>
                            </div>
                            <p class="font-semibold text-sm sm:text-base text-price-black dark:text-gray-100">${priceText}</p>
                        </div>
                    `;
                }).join('');
                
                const invoiceButton = status === 'delivered' 
                    ? `<button class="download-invoice-btn bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition-colors" data-order-id="${order.id}">Download Invoice</button>`
                    : '';

                // Final Card structure based on user image
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100">
                        <!-- Top Header Row -->
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3">
                            <div>
                                <p class="font-bold text-lg text-theme-purple">Order ID: <span class="text-purple-600">${order.orderId}</span></p>
                                <p class="text-xs text-gray-500 mt-1">Placed on: ${orderDate} at ${orderTime}</p>
                            </div>
                            <div class="flex flex-col md:items-end">
                                 <p class="font-bold text-xl text-theme-blue mb-1">৳${order.totalAmount.toFixed(2)}</p>
                                 <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusBgClass} ${statusTextColor} uppercase">
                                    ${rawStatus}
                                 </span>
                            </div>
                        </div>

                        ${isCancelled ? 
                            `<div class="text-center text-red-500 font-bold p-4 bg-red-100 rounded-lg mt-4">Order Cancelled</div>`
                            : renderTrackerSteps(order.status)
                        }

                        <!-- Items List -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="font-bold text-base mb-2">Items:</h4>
                            <div class="space-y-1">
                                ${itemRows}
                            </div>
                        </div>

                        <!-- Footer: Invoice Button -->
                        <div class="mt-4 flex justify-end">
                            ${invoiceButton}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Emergency Chat Logic ---

        function handleEmergencyChatClick() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast(translations[currentLanguage]['chat-unauthorized'], false);
                openDrawer('profile-drawer');
                return;
            }
            closeDrawer();
            showPage('emergency-chat-page');
            // Starts listening to chat once on the page
        }
        
        async function handleEmergencyChat() {
            if (!currentUser || currentUser.isAnonymous) return;

            const chatId = currentUser.uid;
            const chatDocRef = doc(db, 'live_chats', chatId);
            const messagesCollectionRef = collection(chatDocRef, 'messages');
            
            // Initialize chat doc if it doesn't exist
            const chatDocSnap = await getDoc(chatDocRef);
            if (!chatDocSnap.exists()) {
                await setDoc(chatDocRef, {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email,
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp()
                });
            } else {
                await updateDoc(chatDocRef, { lastActive: serverTimestamp() });
            }
            
            // Check if this is the first interaction to send a welcome message.
            const firstMessageQuery = query(messagesCollectionRef, limit(1));
            const firstMessageSnapshot = await getDocs(firstMessageQuery);
            if (firstMessageSnapshot.empty) {
                // No messages exist, so add the welcome message from the admin.
                await addDoc(messagesCollectionRef, {
                    text: "অভিনন্দন! আমাদের সাথে যোগাযোগ করার জন্য ধন্যবাদ। অনুগ্রহ করে অপেক্ষা করুন, অ্যাডমিন শীঘ্রই আপনার বার্তার উত্তর দেবেন।",
                    senderId: "admin",
                    senderName: "Admin",
                    timestamp: serverTimestamp()
                });
            }

            DOMElements.chatMessages.innerHTML = `<p class="text-center text-gray-500">Loading messages...</p>`;
            
            // Set up real-time listener for messages
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                let messagesHtml = '';
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // If the latest message is from the admin, mark previous user messages as seen
                const latestMessage = messages.length > 0 ? messages[messages.length - 1] : null;
                if (latestMessage && latestMessage.senderId === 'admin') {
                    const unseenUserMessages = messages.filter(msg => msg.senderId === currentUser.uid && !msg.isSeen);
                    if (unseenUserMessages.length > 0) {
                        const batch = writeBatch(db);
                        const messagesCollectionRef = collection(db, 'live_chats', currentUser.uid, 'messages');
                        unseenUserMessages.forEach(msg => {
                            const msgRef = doc(messagesCollectionRef, msg.id);
                            batch.update(msgRef, { isSeen: true });
                        });
                        batch.commit().catch(e => console.error("Failed to batch update seen status:", e));
                    }
                }

                messages.forEach(msg => {
                    const isUser = msg.senderId === currentUser.uid;
                    const senderName = isUser ? 'You' : (msg.senderName || 'Admin');
                    const time = msg.timestamp?.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) || '';
                    
                    let seenStatusHtml = '';
                    if (isUser && msg.isSeen) {
                        seenStatusHtml = `<span class="text-xs ml-2 text-blue-200">✓ Seen</span>`;
                    }

                    messagesHtml += `
                        <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${isUser ? 'bg-theme-blue text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-dark rounded-tl-none border'}">
                                <p class="text-xs font-semibold ${isUser ? 'text-blue-200' : 'text-theme-purple'} mb-1">${senderName}</p>
                                <p class="text-sm">${msg.text}</p>
                                <div class="text-right text-xs mt-1 ${isUser ? 'text-blue-300' : 'text-gray-500'}">
                                    <span>${time}</span>
                                    ${seenStatusHtml}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                DOMElements.chatMessages.innerHTML = messagesHtml;
                // Scroll to bottom
                DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;
            }, (error) => {
                console.error("Error listening to messages:", error);
                DOMElements.chatMessages.innerHTML = `<p class="text-center text-red-500">Error loading chat history.</p>`;
            });
        }
        
        const forbiddenWords = [
            // Bengali slang/abusive words
            'sala', 'hala', 'bainchod', 'banchod', 'magi', 'khanki', 'chudir vai', 'kutta', 
            'haramjada', 'shoytaner baccha', 'chagol', 'gadha', 'bokachoda', 'boka',
            'bal', 'khankir pola', 'maderchod', 'chodnar po', 'halar po', 'doner bal',

            // English slang/abusive words
            'fuck', 'fucker', 'fucking', 'bitch', 'asshole', 'dick', 'pussy', 'cunt', 'shit', 'motherfucker',
            'bastard', 'damn', 'hell', 'son of a bitch', 'idiot', 'stupid', 'slang'
        ];

        async function sendChatMessage(e) {
            e.preventDefault();
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) return;

            const text = DOMElements.chatInput.value.trim();
            if (!text) return;

            DOMElements.chatError.textContent = '';
            
            // --- Slang word filter ---
            const lowerCaseText = text.toLowerCase();
            const containsForbiddenWord = forbiddenWords.some(word => lowerCaseText.includes(word));

            if (containsForbiddenWord) {
                showToast('toast-abusive-language', false);
                return; // Stop the function here
            }
            // --- End of slang word filter ---
            
            const chatId = currentUser.uid;
            const messagesCollectionRef = collection(db, 'live_chats', chatId, 'messages');

            try {
                await addDoc(messagesCollectionRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'User',
                    timestamp: serverTimestamp(),
                    isSeen: false // Mark new messages as not seen initially
                });
                
                // Update parent chat doc
                await updateDoc(doc(db, 'live_chats', chatId), { lastActive: serverTimestamp() });

                DOMElements.chatInput.value = ''; // Clear input
                
            } catch (error) {
                console.error("Error sending message:", error);
                DOMElements.chatError.textContent = "Failed to send message.";
            }
        }

        // --- Invoice Generation Logic (jsPDF) ---
        
        async function downloadInvoice(orderDocId) {
            const order = userOrders.find(o => o.id === orderDocId);
            if (!order) {
                showToast("Error: Order data not found for invoice.", false);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let marginX = 20;
            let y = 15;
            
            doc.setFont("helvetica", "normal"); 
            
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(74, 123, 237); // theme-blue
            doc.text("TangailBuzz", marginX, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text("Your trusted online shop for quality products. | +8801863205976", marginX, y); 
            y += 10;
            
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(51);
            doc.text("SALES INVOICE", pageWidth - marginX, y, { align: "right" });
            y += 8;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Order ID: ${order.orderId}`, pageWidth - marginX, y, { align: "right" });
            y += 6;

            const date = order.createdAt?.toDate().toLocaleDateString('en-GB') || 'N/A';
            doc.text(`Date: ${date}`, pageWidth - marginX, y, { align: "right" });
            y += 10;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(106, 13, 173); // theme-purple
            doc.text("Bill To:", marginX, y);
            y += 7;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Name: ${order.userName || 'N/A'}`, marginX, y);
            y += 5;
            doc.text(`Mobile: ${order.userMobile || 'N/A'}`, marginX, y);
            y += 5;
            
            const addressText = `Address: ${order.userLocation || 'N/A'}`;
            const addressLines = doc.splitTextToSize(addressText, pageWidth - (2 * marginX)); 
            doc.text(addressLines, marginX, y);
            y += (addressLines.length * 5) + 5; 
            
            y += 5;

            const tableColumn = ["Product Name", "Variant", "Price", "Qty", "Total"];
            const tableRows = [];

            const items = order.items || [];
            items.forEach(item => {
                let variantString = '';
                if (item.size) variantString += `Size: ${item.size} `;
                if (item.color) variantString += `Color: ${item.color} `;
                if (item.storage) variantString += `Storage: ${item.storage} `;
                
                tableRows.push([
                    item.name,
                    variantString.trim(),
                    `BDT ${Number(item.price).toFixed(2)}`,
                    item.quantity,
                    `BDT ${Number(item.price * item.quantity).toFixed(2)}`
                ]);
            });

            doc.autoTable({ 
                head: [tableColumn],
                body: tableRows,
                startY: y,
                margin: { left: marginX, right: marginX },
                theme: 'striped',
                headStyles: { fillColor: [74, 123, 237], textColor: 255, font: "helvetica", fontStyle: "bold" },
                columnStyles: {
                    0: { cellWidth: 65, font: "helvetica", fontStyle: "normal" },
                    1: { cellWidth: 35, font: "helvetica", fontStyle: "normal" },
                    2: { halign: 'right', cellWidth: 25, font: "helvetica", fontStyle: "normal" },
                    3: { halign: 'center', cellWidth: 15, font: "helvetica", fontStyle: "normal" },
                    4: { halign: 'right', fontStyle: 'bold', cellWidth: 30, font: "helvetica", fontStyle: "bold" },
                },
                styles: { fontSize: 9, cellPadding: 2, font: "helvetica" },
                didDrawPage: function(data) {
                    y = data.cursor.y;
                }
            });

            y = doc.autoTable.previous.finalY + 10;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            
            const totalSummaryX = pageWidth - marginX - 50; 

            doc.text("Subtotal:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.subtotal.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;
            
            doc.text("Delivery Charge:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.deliveryCharge.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;

            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(totalSummaryX, y - 2, pageWidth - marginX, y - 2);
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(229, 54, 122); // theme-pink
            doc.text("TOTAL AMOUNT:", totalSummaryX, y + 4, { align: "right" });
            doc.text(`BDT ${order.totalAmount.toFixed(2)}`, pageWidth - marginX, y + 4, { align: "right" });
            y += 15;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text(`Payment Method: ${order.paymentMethod}`, marginX, y);
            y += 5;
            doc.text("Thank you for shopping with TangailBuzz!", pageWidth - marginX, y, { align: "right" });

            doc.save(`Invoice_${order.orderId}.pdf`);
            showToast("Invoice downloaded successfully!");
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Initial Firebase Authentication Bootstrap
            await initialAuthBootstrap();
            
            // 1.5 Apply Theme Preference
            const storedTheme = localStorage.getItem('theme');
            applyDarkMode(storedTheme || 'light');
            
            // 2. Load Product/Banner Data
            setLanguage('bn');
            DOMElements.productList.innerHTML = `<div class="loader"></div>`;
            await fetchProductsFromFirestore();
            await fetchBannersFromFirestore();
            
            // 3. Attach Event Listeners
            DOMElements.loginBtn.addEventListener('click', handleGoogleLogin);
            if (DOMElements.loginFacebookBtn) DOMElements.loginFacebookBtn.addEventListener('click', handleFacebookLogin);
            DOMElements.logoutBtn.addEventListener('click', handleLogout); 
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.registerForm.addEventListener('submit', handleRegister);
            if (DOMElements.resetForm) DOMElements.resetForm.addEventListener('submit', handlePasswordReset);
            DOMElements.checkoutBtn.addEventListener('click', openPaymentModal);
            DOMElements.confirmOrderBtn.addEventListener('click', handlePlaceOrder);
            DOMElements.couponForm.addEventListener('submit', handleApplyCoupon);
            
            // Dark Mode Toggle Listener
            if (DOMElements.darkModeToggle) {
                DOMElements.darkModeToggle.addEventListener('click', toggleDarkMode);
            }
            
            // Confirmation Modal Listeners
            DOMElements.confirmOkBtn.addEventListener('click', handleConfirmClick);
            DOMElements.confirmCancelBtn.addEventListener('click', handleCancelClick);
            
            // Emergency Contact Button
            if(DOMElements.emergencyContactBtn) DOMElements.emergencyContactBtn.addEventListener('click', handleEmergencyChatClick);
            if(DOMElements.chatForm) DOMElements.chatForm.addEventListener('submit', sendChatMessage);

            if(document.getElementById('my-orders-btn')) document.getElementById('my-orders-btn').addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.myOrdersBtnProfile) DOMElements.myOrdersBtnProfile.addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.deleteAccountBtn) DOMElements.deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            if(DOMElements.closeSuccessModalBtn) DOMElements.closeSuccessModalBtn.addEventListener('click', () => {
                 DOMElements.orderSuccessModal.classList.add('hidden');
                 DOMElements.orderSuccessModal.classList.remove('flex');
                 showPage('my-orders-page');
            });
             if(DOMElements.editProfileForm) DOMElements.editProfileForm.addEventListener('submit', handleProfileUpdate);


            DOMElements.editProfileBtn.addEventListener('click', () => {
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.remove('hidden');
                DOMElements.editPhotoPreview.src = currentUser.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.editNameInput.value = currentUser.displayName || '';
                DOMElements.editMobileInput.value = currentUserData?.mobile || '';
                DOMElements.editLocationInput.value = currentUserData?.location || '';
                // Clear any previous remove flag
                delete DOMElements.editPhotoInput.dataset.remove;
            });

            DOMElements.cancelEditBtn.addEventListener('click', () => {
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
            });

            // Remove Photo handler
            const removeBtn = document.getElementById('remove-photo-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    DOMElements.editPhotoInput.value = '';
                    DOMElements.editPhotoInput.dataset.remove = 'true';
                    DOMElements.editPhotoPreview.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                });
            }

            DOMElements.showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('register');
            });
            DOMElements.showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('login');
            });
            if (DOMElements.showResetLink) DOMElements.showResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('reset'); });
            if (DOMElements.showLoginFromResetLink) DOMElements.showLoginFromResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });

            document.querySelectorAll('input[name="main-payment"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mobileOptions = document.getElementById('mobile-banking-options');
                    if (e.target.value === 'Mobile Banking') {
                        mobileOptions.classList.remove('hidden');
                        mobileOptions.querySelector('input[value="Bkash"]').checked = true;
                    } else {
                        mobileOptions.classList.add('hidden');
                    }
                });
            });

            DOMElements.searchButton.addEventListener('click', performSearch);
            DOMElements.searchInput.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            DOMElements.searchButtonMobile.addEventListener('click', performSearch);
            DOMElements.searchInputMobile.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            
            document.getElementById('hamburger-btn').addEventListener('click', () => openDrawer('nav-drawer'));
            
            document.addEventListener('click', handleProductCardClick); // Delegated click handler
            document.getElementById('product-options').addEventListener('click', handleVariantSelection);
            document.getElementById('product-image-container').addEventListener('mousemove', handleImageZoom);
            
            // Review Form Listeners
            document.getElementById('rating-stars').addEventListener('click', handleStarClick);
            document.getElementById('review-form').addEventListener('submit', submitReview);

            // --- Invoice Button Delegation ---
            document.addEventListener('click', (e) => {
                const target = e.target.closest('.download-invoice-btn');
                if (target) {
                    const orderId = target.dataset.orderId;
                    downloadInvoice(orderId);
                }
            });
            // --- END Invoice Button Delegation ---
            
            const detailsPage = document.getElementById('product-details-page');
            detailsPage.querySelector('#add-to-cart-details').addEventListener('click', (e) => addToCartInDb(e.target.dataset.productId, false));
            detailsPage.querySelector('.buy-now').addEventListener('click', (e) => {
                const productId = detailsPage.querySelector('#add-to-cart-details').dataset.productId;
                addToCartInDb(productId).then(() => {
                   openPaymentModal();
                }).catch(err => {
                   console.log("Could not proceed to buy now:", err);
                });
            });
            detailsPage.querySelector('#wishlist-details').addEventListener('click', (e) => toggleWishlistInDb(e.target.closest('.wishlist').dataset.productId));
        });

        function initializeSlider() {
            const slides = DOMElements.slidesContainer.children;
            if (slides.length === 0) return;
            const slideCount = slides.length;
            let currentSlide = 0;
            let autoSlideInterval;

            DOMElements.indicatorContainer.innerHTML = '';
            
            for(let i = 0; i < slideCount; i++) {
                const indicator = document.createElement('button');
                indicator.className = 'w-3 h-3 rounded-full bg-gray-400 transition-all';
                indicator.addEventListener('click', () => goToSlide(i));
                DOMElements.indicatorContainer.appendChild(indicator);
            }

            const updateSlider = () => {
                DOMElements.slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
                Array.from(DOMElements.indicatorContainer.children).forEach((ind, i) => {
                    ind.classList.toggle('bg-white', i === currentSlide);
                    ind.classList.toggle('bg-gray-400', i !== currentSlide);
                });
            };

            const goToSlide = (slideIndex) => {
                currentSlide = slideIndex;
                updateSlider();
                resetInterval();
            };

            const resetInterval = () => {
                clearInterval(autoSlideInterval);
                autoSlideInterval = setInterval(() => {
                    currentSlide = (currentSlide + 1) % slideCount;
                    updateSlider();
                }, 4000);
            };

            DOMElements.nextBtn.addEventListener('click', () => goToSlide((currentSlide + 1) % slideCount));
            DOMElements.prevBtn.addEventListener('click', () => goToSlide((currentSlide - 1 + slideCount) % slideCount));

            updateSlider();
            resetInterval();
        }
        
    </script>
</body>
</html>
